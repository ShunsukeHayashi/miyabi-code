# ==============================================================================
# Miyabi Docker Compose - Rust Edition
# ==============================================================================
# Purpose: Multi-service orchestration for Miyabi autonomous agent platform
# Target: Mac mini SSH access + self-hosted runner environment
# Author: Shunsuke Hayashi
# Version: 2.0 (Rust Edition)
# ==============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Main Service: Miyabi Agent Runtime (Rust Edition)
  # ===========================================================================
  miyabi-agent:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime  # Use 'development' for dev environment
    image: miyabi-agent:latest
    container_name: miyabi-agent
    restart: unless-stopped

    environment:
      # GitHub Configuration
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - GITHUB_REPOSITORY_OWNER=${GITHUB_REPOSITORY_OWNER}

      # Rust Configuration
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-0}

      # Device Identifier
      - DEVICE_IDENTIFIER=${DEVICE_IDENTIFIER:-mac-mini-docker}

      # Optional: Agent execution parameters
      # - AGENT_TYPE=coordinator
      # - ISSUE_NUMBER=${ISSUE_NUMBER}
      # - CONCURRENCY=${CONCURRENCY:-1}

    volumes:
      # Mount .claude directory (Agent prompts, commands)
      - ./.claude:/app/.claude:ro

      # Mount logs
      - ./logs:/app/logs

      # Mount AI working directory (for agent state)
      - agent-data:/app/.ai

      # Git configuration (for Worktree operations)
      - ~/.gitconfig:/home/miyabi/.gitconfig:ro
      - ~/.ssh:/home/miyabi/.ssh:ro

    networks:
      - miyabi-network

    healthcheck:
      test: ["CMD", "miyabi", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits (適切に調整)
    deploy:
      resources:
        limits:
          cpus: '4.0'      # Rust並列ビルド用に増量
          memory: 4G       # Rustコンパイル用に増量
        reservations:
          cpus: '1.0'
          memory: 1G

  # ===========================================================================
  # Development Service: Miyabi Agent Development Environment
  # ===========================================================================
  miyabi-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    image: miyabi-dev:latest
    container_name: miyabi-dev
    restart: "no"  # 開発環境は手動起動

    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - RUST_LOG=debug
      - RUST_BACKTRACE=1

    volumes:
      # ソースコード全体をマウント（ホットリロード）
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/app/target

    networks:
      - miyabi-network

    # インタラクティブモード
    stdin_open: true
    tty: true

    command: ["bash"]

    profiles:
      - development

  # ===========================================================================
  # Optional: PostgreSQL (Agent state persistence)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: miyabi-postgres
    restart: unless-stopped

    environment:
      - POSTGRES_DB=miyabi
      - POSTGRES_USER=miyabi
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-miyabi_secure_password_change_me}

    volumes:
      - postgres-data:/var/lib/postgresql/data

    networks:
      - miyabi-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U miyabi"]
      interval: 10s
      timeout: 5s
      retries: 5

    profiles:
      - with-database

  # ===========================================================================
  # Optional: Redis (Agent coordination & caching)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: miyabi-redis
    restart: unless-stopped

    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-miyabi_redis_password}

    volumes:
      - redis-data:/data

    networks:
      - miyabi-network

    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-miyabi_redis_password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    profiles:
      - with-cache

  # ===========================================================================
  # Optional: Monitoring with Prometheus
  # ===========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: miyabi-prometheus
    restart: unless-stopped

    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

    ports:
      - "9090:9090"

    networks:
      - miyabi-network

    profiles:
      - monitoring

  # ===========================================================================
  # Optional: Grafana (Metrics visualization)
  # ===========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: miyabi-grafana
    restart: unless-stopped

    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}

    volumes:
      - grafana-data:/var/lib/grafana

    ports:
      - "3000:3000"

    networks:
      - miyabi-network

    profiles:
      - monitoring

  # ===========================================================================
  # Optional: Claudable (AI-driven Next.js app builder)
  # ===========================================================================
  claudable:
    build:
      context: .
      dockerfile: docker/claudable/Dockerfile
    image: miyabi-claudable:latest
    container_name: miyabi-claudable
    restart: unless-stopped

    environment:
      # Claude Code API (used by Claudable)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Optional: Claudable API authentication
      - CLAUDABLE_API_KEY=${CLAUDABLE_API_KEY:-}

      # Node.js environment
      - NODE_ENV=development

    volumes:
      # Persist generated projects
      - claudable-generated:/app/generated

      # Persist SQLite database
      - claudable-data:/app/apps/api/data

    ports:
      # Frontend (Next.js) - Using 3001 to avoid conflict with Grafana
      - "3001:3000"

      # Backend API (FastAPI)
      - "8080:8080"

    networks:
      - miyabi-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    profiles:
      - claudable

# =============================================================================
# Networks
# =============================================================================
networks:
  miyabi-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =============================================================================
# Volumes
# =============================================================================
volumes:
  agent-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  claudable-generated:
    driver: local
  claudable-data:
    driver: local
  # Development caches
  cargo-cache:
    driver: local
  cargo-git:
    driver: local
  target-cache:
    driver: local

# =============================================================================
# 使用例:
#
# 1. 本番環境起動（最小構成）:
#    docker-compose up -d miyabi-agent
#
# 2. データベース付き起動:
#    docker-compose --profile with-database up -d
#
# 3. キャッシュ付き起動:
#    docker-compose --profile with-cache up -d
#
# 4. 開発環境起動:
#    docker-compose --profile development up miyabi-dev
#
# 5. モニタリング付き起動:
#    docker-compose --profile monitoring up -d
#
# 6. Claudable起動（フロントエンド生成）:
#    docker-compose --profile claudable up -d
#    # Frontend: http://localhost:3001
#    # API: http://localhost:8080
#    # API Docs: http://localhost:8080/docs
#
# 7. 全サービス起動:
#    docker-compose --profile with-database --profile with-cache --profile monitoring --profile claudable up -d
#
# 8. SSH経由での起動（Mac mini）:
#    ssh user@mac-mini "cd /path/to/miyabi && docker-compose up -d"
#
# 9. ログ確認:
#    docker-compose logs -f miyabi-agent
#    docker-compose logs -f claudable
#
# 10. Agent実行（ワンショット）:
#     docker-compose run --rm miyabi-agent miyabi agent run coordinator --issue 270
#
# 11. Claudable API疎通テスト:
#     curl http://localhost:8080/health
#
# 12. 停止:
#     docker-compose down
#
# 13. 完全クリーンアップ（ボリューム削除）:
#     docker-compose down -v
#
# =============================================================================
