{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Agents Store",
  "description": "Miyabi Agent実行履歴とステータス管理",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "スキーマバージョン"
    },
    "last_updated": {
      "type": "string",
      "format": "date-time",
      "description": "最終更新日時 (ISO 8601)"
    },
    "agents": {
      "type": "object",
      "patternProperties": {
        "^[A-Za-z]+Agent$": {
          "$ref": "#/definitions/AgentData"
        }
      },
      "description": "Agent名をキーとしたAgent data"
    }
  },
  "required": ["version", "last_updated", "agents"],
  "definitions": {
    "AgentData": {
      "type": "object",
      "properties": {
        "agent_id": {
          "type": "string",
          "description": "Agent ID (例: CoordinatorAgent)"
        },
        "character_name": {
          "type": "string",
          "description": "キャラクター名 (例: カンナ)"
        },
        "status": {
          "type": "string",
          "enum": ["idle", "running", "success", "failed", "error"],
          "description": "現在のステータス"
        },
        "last_execution": {
          "$ref": "#/definitions/ExecutionRecord"
        },
        "execution_history": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ExecutionRecord"
          },
          "maxItems": 100,
          "description": "過去100件の実行履歴"
        },
        "statistics": {
          "$ref": "#/definitions/Statistics"
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "追加メタデータ"
        }
      },
      "required": ["agent_id", "character_name", "status"]
    },
    "ExecutionRecord": {
      "type": "object",
      "properties": {
        "execution_id": {
          "type": "string",
          "format": "uuid",
          "description": "実行ID (UUID)"
        },
        "issue_number": {
          "type": "integer",
          "minimum": 1,
          "description": "対象Issue番号"
        },
        "start_time": {
          "type": "string",
          "format": "date-time",
          "description": "開始日時"
        },
        "end_time": {
          "type": "string",
          "format": "date-time",
          "description": "終了日時"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "実行時間 (ミリ秒)"
        },
        "status": {
          "type": "string",
          "enum": ["success", "failed", "error", "timeout"],
          "description": "実行ステータス"
        },
        "exit_code": {
          "type": "integer",
          "description": "終了コード"
        },
        "error_message": {
          "type": "string",
          "description": "エラーメッセージ (失敗時)"
        },
        "worktree_path": {
          "type": "string",
          "description": "Worktreeパス"
        },
        "artifacts": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "生成された成果物のパス"
        },
        "logs": {
          "type": "object",
          "properties": {
            "stdout": {
              "type": "string",
              "description": "標準出力ログ"
            },
            "stderr": {
              "type": "string",
              "description": "標準エラーログ"
            },
            "log_file": {
              "type": "string",
              "description": "ログファイルパス"
            }
          }
        }
      },
      "required": ["execution_id", "start_time", "status"]
    },
    "Statistics": {
      "type": "object",
      "properties": {
        "total_executions": {
          "type": "integer",
          "minimum": 0,
          "description": "総実行回数"
        },
        "success_count": {
          "type": "integer",
          "minimum": 0,
          "description": "成功回数"
        },
        "failed_count": {
          "type": "integer",
          "minimum": 0,
          "description": "失敗回数"
        },
        "error_count": {
          "type": "integer",
          "minimum": 0,
          "description": "エラー回数"
        },
        "success_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "成功率 (0.0-1.0)"
        },
        "avg_duration_ms": {
          "type": "number",
          "minimum": 0,
          "description": "平均実行時間 (ミリ秒)"
        },
        "last_success_time": {
          "type": "string",
          "format": "date-time",
          "description": "最終成功日時"
        },
        "last_failure_time": {
          "type": "string",
          "format": "date-time",
          "description": "最終失敗日時"
        }
      },
      "required": ["total_executions", "success_count", "failed_count", "error_count", "success_rate"]
    }
  }
}
