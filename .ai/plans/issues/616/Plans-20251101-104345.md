# Plans for Issue #616

**Title**: feat: TUIç‰ˆWorktreeçŠ¶æ…‹è¡¨ç¤ºã®å®Ÿè£… (miyabi status --tui)

**URL**: https://github.com/customer-cloud/miyabi-private/issues/616

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #616

- **ID**: `task-616-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #616

- **ID**: `task-616-impl`
- **Type**: Feature
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-616-analysis

**Description**: # TUIç‰ˆWorktreeçŠ¶æ…‹è¡¨ç¤ºã®å®Ÿè£…

**Parent Issue**: #612 (Epic: KAMUI 4Dè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆ)
**Phase**: Phase 2 - å¯è¦–åŒ–
**Priority**: ğŸ“Š P2-Medium
**Estimated Time**: 5-7 days

## ğŸ“‹ æ¦‚è¦

ratatuiã‚’ä½¿ç”¨ã—ãŸãƒªãƒƒãƒãªã‚¿ãƒ¼ãƒŸãƒŠãƒ«UIã§ã€WorktreeçŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å¯è¦–åŒ–ã™ã‚‹ã€‚KAMUI 4Dã®3Då¯è¦–åŒ–ã‚’TUIç‰ˆã¨ã—ã¦CLIã§å†ç¾ã—ã€è¤‡æ•°Worktreeã®ä¸¦åˆ—å®Ÿè¡ŒçŠ¶æ³ã‚’ç›´æ„Ÿçš„ã«æŠŠæ¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™

`miyabi status --tui` ã‚³ãƒãƒ³ãƒ‰ã§ä»¥ä¸‹ã®æƒ…å ±ã‚’å¯¾è©±çš„ã«è¡¨ç¤ºï¼š

- å…¨Worktreeã®çŠ¶æ…‹ï¼ˆActive/Idle/Orphanedï¼‰
- å„Worktreeã®å®Ÿè¡Œä¸­Agent
- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡
- å®Ÿè¡Œæ™‚é–“
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆ1ç§’é–“éš”ï¼‰
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã«ã‚ˆã‚‹Worktreeé¸æŠãƒ»æ“ä½œ

## ğŸ“Š è¦ä»¶

### å¿…é ˆè¦ä»¶

- [ ] ratatuiã«ã‚ˆã‚‹TUIå®Ÿè£…
- [ ] Worktreeãƒªã‚¹ãƒˆè¡¨ç¤º
  - çŠ¶æ…‹ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆâœ… Active, â¸ï¸ Idle, âš ï¸ Orphanedï¼‰
  - Issueç•ªå·ã€ãƒ–ãƒ©ãƒ³ãƒå
  - å®Ÿè¡ŒAgentå
  - çµŒéæ™‚é–“ã€ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆ1ç§’é–“éš”ï¼‰
- [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
  - `â†‘â†“` - Worktreeé¸æŠ
  - `Enter` - è©³ç´°è¡¨ç¤º
  - `d` - å‰Šé™¤
  - `r` - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
  - `q` - çµ‚äº†
- [ ] Worktreeè©³ç´°è¡¨ç¤ºãƒ‘ãƒãƒ«
  - Git status
  - æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ
  - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦ä»¶

- [ ] ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒè¨­å®š
- [ ] ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ï¼ˆActive/Idle/Allï¼‰
- [ ] ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆæ™‚é–“/ã‚µã‚¤ã‚º/Issueç•ªå·ï¼‰
- [ ] çµ±è¨ˆæƒ…å ±ãƒ‘ãƒãƒ«

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Rust 2021 Edition
- **UI Framework**: ratatui (æ—§tui-rs)
- **ä¾å­˜**:
  - `ratatui` - TUIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
  - `crossterm` - ã‚¿ãƒ¼ãƒŸãƒŠãƒ«åˆ¶å¾¡
  - `tokio` - éåŒæœŸå‡¦ç†
  - `chrono` - æ™‚åˆ»è¡¨ç¤º

## ğŸ“ è¨­è¨ˆ

### TUIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Miyabi Worktree Status (Press 'q' to quit)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Active Worktrees (2):                                       â”‚
â”‚ âœ… issue-270 â”‚ task/feature-270 â”‚ CoordinatorAgent â”‚ 1.2GB â”‚
â”‚ âœ… issue-271 â”‚ task/bug-271     â”‚ CodeGenAgent     â”‚ 980MB â”‚
â”‚                                                             â”‚
â”‚ Idle Worktrees (1):                                         â”‚
â”‚ â¸ï¸  issue-269 â”‚ task/refactor-269â”‚ ReviewAgent      â”‚ 1.5GB â”‚
â”‚                                                             â”‚
â”‚ Orphaned Worktrees (1):                                     â”‚
â”‚ âš ï¸  issue-268 â”‚ task/feature-268 â”‚ [Unknown]        â”‚ 2.1GB â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Details: issue-270                                          â”‚
â”‚   Status:    Running (15m 32s)                              â”‚
â”‚   Agent:     CoordinatorAgent                               â”‚
â”‚   Branch:    task/feature-270                               â”‚
â”‚   Modified:  3 files changed                                â”‚
â”‚   Last:      feat: add worktree management                  â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â†‘â†“] Select | [Enter] Details | [d] Delete | [r] Refresh   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rustå®Ÿè£…

```rust
// crates/miyabi-cli/src/tui/worktree_status.rs

use ratatui::{
    backend::CrosstermBackend,
    layout::{Constraint, Direction, Layout},
    style::{Color, Style},
    widgets::{Block, Borders, List, ListItem, Paragraph},
    Terminal,
};
use crossterm::{
    event::{self, Event, KeyCode},
    terminal::{enable_raw_mode, EnterAlternateScreen},
};

pub struct WorktreeStatusTui {
    state_manager: WorktreeStateManager,
    selected_index: usize,
    worktrees: Vec<WorktreeState>,
}

impl WorktreeStatusTui {
    pub fn new(state_manager: WorktreeStateManager) -> Self {
        Self {
            state_manager,
            selected_index: 0,
            worktrees: Vec::new(),
        }
    }

    pub async fn run(&mut self) -> Result<()> {
        enable_raw_mode()?;
        let mut stdout = io::stdout();
        execute!(stdout, EnterAlternateScreen)?;
        
        let backend = CrosstermBackend::new(stdout);
        let mut terminal = Terminal::new(backend)?;

        loop {
            // WorktreeçŠ¶æ…‹ã‚’æ›´æ–°
            self.worktrees = self.state_manager.scan_worktrees()?;
            
            // UIæç”»
            terminal.draw(|f| self.ui(f))?;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
            if self.handle_events().await? {
                break; // çµ‚äº†
            }
            
            tokio::time::sleep(Duration::from_secs(1)).await;
        }

        disable_raw_mode()?;
        execute!(terminal.backend_mut(), LeaveAlternateScreen)?;
        terminal.show_cursor()?;

        Ok(())
    }

    fn ui(&self, f: &mut Frame) {
        let chunks = Layout::default()
            .direction(Direction::Vertical)
            .constraints([
                Constraint::Length(3),      // ãƒ˜ãƒƒãƒ€ãƒ¼
                Constraint::Min(10),        // Worktreeãƒªã‚¹ãƒˆ
                Constraint::Length(8),      // è©³ç´°ãƒ‘ãƒãƒ«
                Constraint::Length(3),      // ãƒ•ãƒƒã‚¿ãƒ¼
            ])
            .split(f.area());

        // ãƒ˜ãƒƒãƒ€ãƒ¼
        let header = Paragraph::new("Miyabi Worktree Status")
            .block(Block::bordered().title("Status"));
        f.render_widget(header, chunks[0]);

        // Worktreeãƒªã‚¹ãƒˆ
        let items: Vec<ListItem> = self.worktrees
            .iter()
            .map(|wt| {
                let icon = match wt.status {
                    WorktreeStatus::Active => "âœ…",
                    WorktreeStatus::Idle => "â¸ï¸",
                    WorktreeStatus::Orphaned => "âš ï¸",
                    _ => "â“",
                };
                let content = format!(
                    "{} {} â”‚ {} â”‚ {} â”‚ {}",
                    icon,
                    wt.issue_number.map_or("N/A".to_string(), |n| format!("issue-{}", n)),
                    wt.branch,
                    wt.agent.as_deref().unwrap_or("[Unknown]"),
                    format_bytes(wt.disk_usage)
                );
                ListItem::new(content)
            })
            .collect();

        let list = List::new(items)
            .block(Block::bordered().title("Worktrees"))
            .highlight_style(Style::default().bg(Color::DarkGray));
        f.render_stateful_widget(list, chunks[1], &mut self.list_state);

        // è©³ç´°ãƒ‘ãƒãƒ«
        if let Some(selected_wt) = self.worktrees.get(self.selected_index) {
            let details = format!(
                "Details: {}\n  Status:  {:?}\n  Agent:   {}\n  Branch:  {}",
                selected_wt.issue_number.map_or("N/A".to_string(), |n| format!("issue-{}", n)),
                selected_wt.status,
                selected_wt.agent.as_deref().unwrap_or("[Unknown]"),
                selected_wt.branch
            );
            let details_widget = Paragraph::new(details)
                .block(Block::bordered().title("Details"));
            f.render_widget(details_widget, chunks[2]);
        }

        // ãƒ•ãƒƒã‚¿ãƒ¼
        let footer = Paragraph::new("[â†‘â†“] Select | [Enter] Details | [d] Delete | [q] Quit")
            .block(Block::bordered());
        f.render_widget(footer, chunks[3]);
    }

    async fn handle_events(&mut self) -> Result<bool> {
        if event::poll(Duration::from_millis(100))? {
            if let Event::Key(key) = event::read()? {
                match key.code {
                    KeyCode::Char('q') => return Ok(true), // çµ‚äº†
                    KeyCode::Up => {
                        if self.selected_index > 0 {
                            self.selected_index -= 1;
                        }
                    }
                    KeyCode::Down => {
                        if self.selected_index < self.worktrees.len() - 1 {
                            self.selected_index += 1;
                        }
                    }
                    KeyCode::Char('d') => {
                        // å‰Šé™¤ç¢ºèª
                        self.delete_selected_worktree().await?;
                    }
                    KeyCode::Char('r') => {
                        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                        self.worktrees = self.state_manager.scan_worktrees()?;
                    }
                    _ => {}
                }
            }
        }
        Ok(false)
    }
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_render_worktree_list() {
        // Worktreeãƒªã‚¹ãƒˆæç”»
    }

    #[test]
    fn test_keyboard_navigation() {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
    }

    #[test]
    fn test_worktree_selection() {
        // Worktreeé¸æŠ
    }
}
```

## ğŸ“Š æˆåŠŸæ¡ä»¶

- [ ] `miyabi status --tui` ã§TUIãŒèµ·å‹•ã™ã‚‹
- [ ] Worktreeãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãŒå‹•ä½œã™ã‚‹ï¼ˆ1ç§’é–“éš”ï¼‰
- [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

## ğŸ”„ Dependencies

- **Depends on**: #613, #615 (Phase 1å®Œäº†)

---

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

### 3. Add tests for #616

- **ID**: `task-616-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-616-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #616

- **ID**: `task-616-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-616-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-616-analysis` - Analyze requirements for #616

### Level 1 (Parallel Execution)

- `task-616-impl` - Implement solution for #616

### Level 2 (Parallel Execution)

- `task-616-test` - Add tests for #616

### Level 3 (Parallel Execution)

- `task-616-review` - Review code quality for #616

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_616_analysis["Analyze requirements for #616"]
    task_616_impl["Implement solution for #616"]
    task_616_test["Add tests for #616"]
    task_616_review["Review code quality for #616"]
    task_616_analysis --> task_616_impl
    task_616_impl --> task_616_test
    task_616_test --> task_616_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-11-01 10:43:45 UTC*
