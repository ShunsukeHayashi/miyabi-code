# Plans for Issue #519

**Title**: refactor: Deduplicate ConfigLoader across commands (Phase 1-1)

**URL**: https://github.com/customer-cloud/miyabi-private/issues/519

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #519

- **ID**: `task-519-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #519

- **ID**: `task-519-impl`
- **Type**: Refactor
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-519-analysis

**Description**: ## ğŸ“‹ æ¦‚è¦

`agent.rs` ã¨ `parallel.rs` ã§é‡è¤‡ã—ã¦ã„ã‚‹è¨­å®šãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’çµ±åˆã—ã¾ã™ã€‚

**å®Ÿè¡Œãƒ•ãƒ­ãƒ¼æ”¹å–„ææ¡ˆ**: Phase 1-4 Config Management ã®å®Ÿè£…

## ğŸ¯ ç›®çš„

- ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸›: 140è¡Œ â†’ å…±é€šåŒ–
- ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°: è¨­å®šãƒ­ãƒ¼ãƒ‰1å›ã®ã¿ï¼ˆ`OnceCell`ä½¿ç”¨ï¼‰
- ä¿å®ˆæ€§å‘ä¸Š: è¨­å®šãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€å…ƒç®¡ç†

## ğŸ“ ã‚¿ã‚¹ã‚¯

### å®Ÿè£…
- [ ] `crates/miyabi-cli/src/config.rs` æ–°è¦ä½œæˆ
- [ ] `ConfigLoader` æ§‹é€ ä½“å®Ÿè£…
  - [ ] `global()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆSingletonï¼‰
  - [ ] `load()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ä»˜ãï¼‰
  - [ ] `get_github_token()` çµ±åˆ
  - [ ] `parse_git_remote()` çµ±åˆ
- [ ] `crates/miyabi-cli/src/commands/agent.rs:161-300` ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
  - [ ] `load_config()` ã‚’ `ConfigLoader::global().load()` ã«ç½®æ›
  - [ ] é‡è¤‡ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤
- [ ] `crates/miyabi-cli/src/commands/parallel.rs:267-376` ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
  - [ ] `load_config()` ã‚’ `ConfigLoader::global().load()` ã«ç½®æ›
  - [ ] é‡è¤‡ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤

### ãƒ†ã‚¹ãƒˆ
- [ ] `config.rs` ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆè¿½åŠ 
  - [ ] `test_config_loader_caching()`
  - [ ] `test_github_token_from_env()`
  - [ ] `test_github_token_from_gh_cli()`
  - [ ] `test_parse_git_remote_https()`
  - [ ] `test_parse_git_remote_ssh()`

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] `config.rs` ã«docã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
- [ ] `CHANGELOG.md` æ›´æ–°

## âœ… æˆåŠŸåŸºæº–

- [ ] `cargo check` ã‚¨ãƒ©ãƒ¼ 0ä»¶
- [ ] `cargo clippy` è­¦å‘Š 0ä»¶
- [ ] `cargo test` å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼
- [ ] ã‚³ãƒ¼ãƒ‰è¡Œæ•°å‰Šæ¸›: 140è¡Œ â†’ 80è¡Œï¼ˆç´„43%å‰Šæ¸›ï¼‰

## ğŸ“Š æœŸå¾…åŠ¹æœ

| æŒ‡æ¨™ | Before | After | æ”¹å–„ç‡ |
|-----|--------|-------|--------|
| é‡è¤‡ã‚³ãƒ¼ãƒ‰ | 140è¡Œ | 0è¡Œ | 100% |
| è¨­å®šãƒ­ãƒ¼ãƒ‰å›æ•° | Nå› | 1å› | ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚° |
| ä¿å®ˆæ€§ | 2ç®‡æ‰€ç®¡ç† | 1ç®‡æ‰€ç®¡ç† | 50% |

## ğŸ”— é–¢é€£

- **å®Ÿè£…è¨ˆç”»**: ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ•ãƒ­ãƒ¼æ”¹å–„ææ¡ˆ Phase 1-4
- **å„ªå…ˆåº¦**: Quick Winsï¼ˆ1é€±é–“ä»¥å†…å®Œäº†ç›®æ¨™ï¼‰
- **å·¥æ•°**: 0.5æ—¥

## ğŸ“‚ å®Ÿè£…ç®‡æ‰€

```
crates/miyabi-cli/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config.rs           # âœ… NEW
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ agent.rs        # ğŸ”§ REFACTOR L161-300
â”‚   â”‚   â””â”€â”€ parallel.rs     # ğŸ”§ REFACTOR L267-376
â”‚   â””â”€â”€ lib.rs              # ğŸ”§ pub mod config è¿½åŠ 
```

## ğŸš€ å®Ÿè£…ä¾‹

```rust
// crates/miyabi-cli/src/config.rs
use once_cell::sync::OnceCell;

pub struct ConfigLoader {
    cache: OnceCell<AgentConfig>,
}

impl ConfigLoader {
    pub fn global() -> &'static Self {
        static INSTANCE: OnceCell<ConfigLoader> = OnceCell::new();
        INSTANCE.get_or_init(|| ConfigLoader {
            cache: OnceCell::new(),
        })
    }

    pub fn load(&self) -> Result<AgentConfig> {
        self.cache.get_or_try_init(|| {
            let github_token = Self::get_github_token()?;
            let (repo_owner, repo_name) = Self::parse_git_remote()?;
            // ... è¨­å®šæ§‹ç¯‰
        }).cloned()
    }
}
```

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

### 3. Add tests for #519

- **ID**: `task-519-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-519-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #519

- **ID**: `task-519-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-519-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-519-analysis` - Analyze requirements for #519

### Level 1 (Parallel Execution)

- `task-519-impl` - Implement solution for #519

### Level 2 (Parallel Execution)

- `task-519-test` - Add tests for #519

### Level 3 (Parallel Execution)

- `task-519-review` - Review code quality for #519

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_519_analysis["Analyze requirements for #519"]
    task_519_impl["Implement solution for #519"]
    task_519_test["Add tests for #519"]
    task_519_review["Review code quality for #519"]
    task_519_analysis --> task_519_impl
    task_519_impl --> task_519_test
    task_519_test --> task_519_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-10-24 13:06:26 UTC*
