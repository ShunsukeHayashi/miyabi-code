# Plans for Issue #424

**Title**: ã€Testingã€‘miyabi-knowledge: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè£… - Docker Compose + E2Eãƒ†ã‚¹ãƒˆ

**URL**: https://github.com/customer-cloud/miyabi-private/issues/424

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #424

- **ID**: `task-424-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #424

- **ID**: `task-424-impl`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-424-analysis

**Description**: ## ğŸ“‹ æ¦‚è¦

å®Ÿéš›ã®Qdrantã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã—ãŸE2Eçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚
Docker Composeã§ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’è‡ªå‹•èµ·å‹•ã—ã€CI/CDã§å…¨ãƒ•ãƒ­ãƒ¼ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã§ã€æœ¬ç•ªç’°å¢ƒã§ã®ä¸å…·åˆã‚’æœªç„¶ã«é˜²ãã¾ã™ã€‚

**è¦ªIssue**: #421 (Phase 6)

## ğŸ¯ ç›®çš„

- **å®Ÿç’°å¢ƒãƒ†ã‚¹ãƒˆ**: ãƒ¢ãƒƒã‚¯ã§ã¯ãªãå®Ÿéš›ã®Qdrant + Ollamaã§ãƒ†ã‚¹ãƒˆ
- **CI/CDçµ±åˆ**: GitHub Actionsã§è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- **ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š**: 80%ä»¥ä¸Šã®ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆ
- **å›å¸°é˜²æ­¢**: æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®æ—¢å­˜æ©Ÿèƒ½ç ´å£Šã‚’é˜²æ­¢

## ğŸ”§ å®Ÿè£…å†…å®¹

### 1. Docker Compose ãƒ†ã‚¹ãƒˆç’°å¢ƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-knowledge/docker-compose.test.yml`

```yaml
version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:v1.15.0
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    command: serve
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 3s
      retries: 10

volumes:
  ollama_data:
```

**èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `crates/miyabi-knowledge/scripts/test-env.sh`

```bash
#!/bin/bash
set -e

echo "ğŸš€ Starting test environment..."

# Docker Composeèµ·å‹•
docker-compose -f docker-compose.test.yml up -d

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾…æ©Ÿ
echo "â³ Waiting for services to be healthy..."
timeout 60s bash -c 'until docker-compose -f docker-compose.test.yml ps | grep -q "(healthy)"; do sleep 2; done'

# Ollamaãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
echo "ğŸ“¥ Downloading Ollama model..."
docker-compose -f docker-compose.test.yml exec -T ollama ollama pull all-MiniLM-L6-v2

echo "âœ… Test environment ready!"
```

**åœæ­¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `crates/miyabi-knowledge/scripts/teardown-env.sh`

```bash
#!/bin/bash
docker-compose -f docker-compose.test.yml down -v
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-knowledge/tests/integration_tests.rs`

```rust
use miyabi_knowledge::{
    KnowledgeManager, KnowledgeConfig,
    searcher::{QdrantSearcher, SearchFilter},
};
use std::time::Duration;
use tokio::time::sleep;

// ãƒ†ã‚¹ãƒˆç”¨è¨­å®š
fn test_config() -> KnowledgeConfig {
    let mut config = KnowledgeConfig::default();
    config.vector_db.host = "localhost".to_string();
    config.vector_db.port = 6333;
    config.vector_db.collection = "test-knowledge".to_string();
    config.embeddings.endpoint = "http://localhost:11434".to_string();
    config
}

#[tokio::test]
#[ignore] // `cargo test --features integration-tests` ã§å®Ÿè¡Œ
async fn test_full_workflow() {
    // 1. ManageråˆæœŸåŒ–
    let config = test_config();
    let manager = KnowledgeManager::new(config.clone()).await.unwrap();

    // 2. ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚°ä½œæˆ
    create_sample_logs().await;

    // 3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
    let stats = manager.index_workspace("test-workspace").await.unwrap();
    assert!(stats.success > 0, "No entries indexed");

    // 4. æ¤œç´¢
    let searcher = QdrantSearcher::new(config.clone()).await.unwrap();
    let results = searcher
        .search("error handling in Rust", 10)
        .await
        .unwrap();
    
    assert!(!results.is_empty(), "No search results");
    assert!(results[0].score > 0.7, "Low relevance score");

    // 5. ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢
    let filter = SearchFilter::new()
        .with_agent("CodeGenAgent")
        .with_outcome("success");
    
    let filtered = searcher
        .search_filtered("agent execution", filter)
        .await
        .unwrap();
    
    assert!(!filtered.is_empty(), "No filtered results");
    
    // 6. çµ±è¨ˆå–å¾—
    let stats = searcher.get_statistics().await.unwrap();
    assert!(stats.total_entries > 0);

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    cleanup_test_data().await;
}

#[tokio::test]
#[ignore]
async fn test_concurrent_indexing() {
    let config = test_config();
    
    // 10å€‹ã®Workerã‚’ä¸¦åˆ—èµ·å‹•
    let mut handles = vec![];
    
    for i in 0..10 {
        let config_clone = config.clone();
        handles.push(tokio::spawn(async move {
            let manager = KnowledgeManager::new(config_clone).await.unwrap();
            let workspace = format!("test-workspace-{}", i);
            manager.index_workspace(&workspace).await.unwrap();
        }));
    }
    
    // å…¨Workerå®Œäº†å¾…æ©Ÿ
    for handle in handles {
        handle.await.unwrap();
    }
    
    // çµ±è¨ˆç¢ºèª
    let searcher = QdrantSearcher::new(config).await.unwrap();
    let stats = searcher.get_statistics().await.unwrap();
    assert!(stats.total_entries >= 10);
}

#[tokio::test]
#[ignore]
async fn test_incremental_indexing() {
    let config = test_config();
    let manager = KnowledgeManager::new(config.clone()).await.unwrap();

    // åˆå›ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
    create_sample_logs().await;
    let stats1 = manager.index_workspace("test-workspace").await.unwrap();
    let initial_count = stats1.success;

    // 2å›ç›®ï¼ˆå¤‰æ›´ãªã—ï¼‰
    let stats2 = manager.index_workspace("test-workspace").await.unwrap();
    assert_eq!(stats2.success, 0, "Should skip unchanged logs");

    // æ–°è¦ãƒ­ã‚°è¿½åŠ 
    add_new_log().await;
    let stats3 = manager.index_workspace("test-workspace").await.unwrap();
    assert_eq!(stats3.success, 1, "Should index only new log");

    // çµ±è¨ˆç¢ºèª
    let searcher = QdrantSearcher::new(config).await.unwrap();
    let stats = searcher.get_statistics().await.unwrap();
    assert_eq!(stats.total_entries, initial_count + 1);
}

#[tokio::test]
#[ignore]
async fn test_error_recovery() {
    let config = test_config();

    // Qdrantåœæ­¢
    stop_qdrant().await;

    // ManageråˆæœŸåŒ–å¤±æ•—ã‚’ç¢ºèª
    let result = KnowledgeManager::new(config.clone()).await;
    assert!(result.is_err(), "Should fail when Qdrant is down");

    // Qdrantå†èµ·å‹•
    start_qdrant().await;
    sleep(Duration::from_secs(5)).await;

    // å†æ¥ç¶šæˆåŠŸã‚’ç¢ºèª
    let result = KnowledgeManager::new(config).await;
    assert!(result.is_ok(), "Should reconnect after Qdrant restart");
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
async fn create_sample_logs() {
    let log_dir = std::path::Path::new(".ai/logs");
    tokio::fs::create_dir_all(log_dir).await.unwrap();
    
    let log_content = r#"
# Agent Execution Log

**Agent**: CodeGenAgent
**Issue**: #270
**Task**: Implement error handling
**Outcome**: success

## Summary
Implemented comprehensive error handling using Result types.
    "#;
    
    tokio::fs::write(
        log_dir.join("2025-10-22-codegen.md"),
        log_content
    ).await.unwrap();
}

async fn add_new_log() {
    // æ–°è¦ãƒ­ã‚°è¿½åŠ å®Ÿè£…
}

async fn cleanup_test_data() {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤
}

async fn stop_qdrant() {
    // Qdrantã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
}

async fn start_qdrant() {
    // Qdrantã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
}
```

### 3. GitHub Actions CI/CD

**ãƒ•ã‚¡ã‚¤ãƒ«**: `.github/workflows/knowledge-tests.yml`

```yaml
name: Knowledge Integration Tests

on:
  push:
    paths:
      - 'crates/miyabi-knowledge/**'
      - '.github/workflows/knowledge-tests.yml'
  pull_request:
    paths:
      - 'crates/miyabi-knowledge/**'

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Start Docker Compose
        run: |
          cd crates/miyabi-knowledge
          docker-compose -f docker-compose.test.yml up -d
          
      - name: Wait for services
        run: |
          timeout 60s bash -c 'until curl -f http://localhost:6333/healthz; do sleep 2; done'
          timeout 60s bash -c 'until curl -f http://localhost:11434/api/tags; do sleep 2; done'
          
      - name: Download Ollama model
        run: |
          docker exec $(docker ps -qf "name=ollama") ollama pull all-MiniLM-L6-v2
          
      - name: Run integration tests
        run: |
          cd crates/miyabi-knowledge
          cargo test --features integration-tests -- --ignored --test-threads=1
          
      - name: Stop Docker Compose
        if: always()
        run: |
          cd crates/miyabi-knowledge
          docker-compose -f docker-compose.test.yml down -v
      
      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs
          path: crates/miyabi-knowledge/tests/logs/
```

### 4. Cargo.toml feature flag

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-knowledge/Cargo.toml`

```toml
[features]
default = []
integration-tests = []

[dev-dependencies]
tokio-test = "0.4"
tempfile = "3.8"
wiremock = "0.6"  # API mocking
```

### 5. ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `.github/workflows/coverage.yml`

```yaml
name: Code Coverage

on:
  push:
    branches: [main]
  pull_request:

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
          
      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov
        
      - name: Generate coverage
        run: |
          cd crates/miyabi-knowledge
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
          
      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: crates/miyabi-knowledge/lcov.info
          flags: miyabi-knowledge
```

## âœ… æˆåŠŸåŸºæº–

- [ ] CI/CDã§çµ±åˆãƒ†ã‚¹ãƒˆãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆGitHub Actionsï¼‰
- [ ] å…¨çµ±åˆãƒ†ã‚¹ãƒˆãŒ60ç§’ä»¥å†…ã«å®Œäº†ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼‰
- [ ] ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šï¼ˆCodecovçµ±åˆï¼‰
- [ ] ä¸¦åˆ—å®Ÿè¡Œãƒ†ã‚¹ãƒˆãŒæ­£å¸¸å‹•ä½œï¼ˆ10 Workersï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼å›å¾©ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸å‹•ä½œï¼ˆQdrantå†èµ·å‹•ï¼‰
- [ ] `cargo test --features integration-tests` ã§ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œå¯èƒ½

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª

### 1. æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- [ ] å…¨ãƒ•ãƒ­ãƒ¼ï¼ˆindex â†’ search â†’ cleanupï¼‰
- [ ] ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢ï¼ˆAgent, Issue#, Outcomeï¼‰
- [ ] çµ±è¨ˆå–å¾—
- [ ] å¢—åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–

### 2. ä¸¦è¡Œæ€§ãƒ†ã‚¹ãƒˆ
- [ ] 10 Agentsä¸¦åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
- [ ] 100ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸¦åˆ—æ¤œç´¢
- [ ] åŒæ™‚Read/Writeæ“ä½œ

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
- [ ] Qdrantåœæ­¢æ™‚ã®å‹•ä½œ
- [ ] Ollamaåœæ­¢æ™‚ã®å‹•ä½œ
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- [ ] ä¸æ­£ãªãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] 10,000ã‚¨ãƒ³ãƒˆãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–æ™‚é–“ï¼ˆ< 5åˆ†ï¼‰
- [ ] æ¤œç´¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ï¼ˆ< 1ç§’ï¼‰
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼ˆ< 512MBï¼‰

## ğŸ“Š æ¨å®šå·¥æ•°

- **Dockerç’°å¢ƒæ§‹ç¯‰**: 1æ—¥
- **çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè£…**: 2æ—¥
- **CI/CDçµ±åˆ**: 1æ—¥
- **ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®š**: 0.5æ—¥
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: 0.5æ—¥

**åˆè¨ˆ**: 5æ—¥

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `crates/miyabi-knowledge/docker-compose.test.yml` - Dockerç’°å¢ƒ (æ–°è¦)
- `crates/miyabi-knowledge/tests/integration_tests.rs` - çµ±åˆãƒ†ã‚¹ãƒˆ (æ–°è¦)
- `.github/workflows/knowledge-tests.yml` - CI/CD (æ–°è¦)
- `.github/workflows/coverage.yml` - ã‚«ãƒãƒ¬ãƒƒã‚¸ (æ–°è¦)

## ğŸ“ æ³¨æ„äº‹é …

1. **ä¸¦åˆ—å®Ÿè¡Œ**: `--test-threads=1` ã§1ãƒ†ã‚¹ãƒˆãšã¤å®Ÿè¡Œï¼ˆQdrantã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç«¶åˆå›é¿ï¼‰
2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: å„ãƒ†ã‚¹ãƒˆ60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆCI/CDé«˜é€ŸåŒ–ï¼‰
3. **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: å„ãƒ†ã‚¹ãƒˆå¾Œã« `docker-compose down -v`ï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ å‰Šé™¤ï¼‰

---

**Parent Issue**: #421
**Phase**: Phase 6 - çµ±åˆãƒ†ã‚¹ãƒˆ
**Priority**: ğŸ“ P2-Medium
**Estimated**: 5æ—¥

### 3. Add tests for #424

- **ID**: `task-424-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-424-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #424

- **ID**: `task-424-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-424-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-424-analysis` - Analyze requirements for #424

### Level 1 (Parallel Execution)

- `task-424-impl` - Implement solution for #424

### Level 2 (Parallel Execution)

- `task-424-test` - Add tests for #424

### Level 3 (Parallel Execution)

- `task-424-review` - Review code quality for #424

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_424_analysis["Analyze requirements for #424"]
    task_424_impl["Implement solution for #424"]
    task_424_test["Add tests for #424"]
    task_424_review["Review code quality for #424"]
    task_424_analysis --> task_424_impl
    task_424_impl --> task_424_test
    task_424_test --> task_424_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-11-01 11:17:46 UTC*
