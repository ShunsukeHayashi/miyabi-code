# Plans for Issue #619

**Title**: feat: miyabi-kamui-bridge crateã®ä½œæˆ - KAMUI 4Dé€£æºãƒ–ãƒªãƒƒã‚¸

**URL**: https://github.com/customer-cloud/miyabi-private/issues/619

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #619

- **ID**: `task-619-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #619

- **ID**: `task-619-impl`
- **Type**: Feature
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-619-analysis

**Description**: # miyabi-kamui-bridge crateã®ä½œæˆ

**Parent Issue**: #612 (Epic: KAMUI 4Dè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆ)
**Phase**: Phase 3 - KAMUI 4Dçµ±åˆ
**Priority**: ğŸ“ P3-Low
**Estimated Time**: 7-10 days

## ğŸ“‹ æ¦‚è¦

Miyabiã¨KAMUI 4Dã‚’é€£æºã™ã‚‹ãƒ–ãƒªãƒƒã‚¸crateã‚’ä½œæˆã—ã€Miyabiã®å®Ÿè¡ŒçŠ¶æ³ã‚’KAMUI 4Dã§3Då¯è¦–åŒ–ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚TaskMetadataã€WorktreeçŠ¶æ…‹ã€Agentå®Ÿè¡Œæƒ…å ±ã‚’KAMUI 4D APIã¸é€ä¿¡ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™

ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ–ãƒªãƒƒã‚¸ã‚’å®Ÿè£…ï¼š

- Miyabiã‚¿ã‚¹ã‚¯ã‚’KAMUI 4Dã¸åŒæœŸ
- WorktreeçŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€ä¿¡
- Agentå®Ÿè¡ŒçŠ¶æ³ã®å…±æœ‰
- KAMUI 4Dã‹ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰å—ä¿¡ï¼ˆåŒæ–¹å‘é€šä¿¡ï¼‰

## ğŸ“Š è¦ä»¶

### å¿…é ˆè¦ä»¶

- [ ] `miyabi-kamui-bridge` crateä½œæˆ
- [ ] KAMUI 4D APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…
  - ã‚¿ã‚¹ã‚¯æƒ…å ±é€ä¿¡
  - WorktreeçŠ¶æ…‹é€ä¿¡
  - AgentçŠ¶æ…‹é€ä¿¡
- [ ] åŒæ–¹å‘é€šä¿¡
  - WebSocketæ¥ç¶š
  - ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- [ ] CLIçµ±åˆ
  - `miyabi work-on <issue> --visualize` ã§KAMUI 4Dé€£æº
  - `miyabi kamui connect` ã§æ¥ç¶šç¢ºç«‹

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦ä»¶

- [ ] KAMUI 4Dã‹ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
- [ ] èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Rust 2021 Edition
- **Crate**: `miyabi-kamui-bridge` (æ–°è¦)
- **ä¾å­˜**:
  - `reqwest` - HTTP client
  - `tokio-tungstenite` - WebSocket
  - `serde` - JSON serialization

## ğŸ“ è¨­è¨ˆ

### Crateæ§‹é€ 

```
crates/miyabi-kamui-bridge/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs                  # Public API
â”‚   â”œâ”€â”€ client.rs               # KAMUI 4D APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ websocket.rs            # WebSocketé€šä¿¡
â”‚   â”œâ”€â”€ sync.rs                 # ãƒ‡ãƒ¼ã‚¿åŒæœŸ
â”‚   â””â”€â”€ types.rs                # å‹å®šç¾©
â””â”€â”€ tests/
    â””â”€â”€ integration_test.rs
```

### APIè¨­è¨ˆ

```rust
// crates/miyabi-kamui-bridge/src/lib.rs

pub struct KamuiBridge {
    api_endpoint: String,
    ws_endpoint: String,
    client: reqwest::Client,
    ws_client: Option<WebSocketStream<MaybeTlsStream<TcpStream>>>,
}

impl KamuiBridge {
    pub async fn new(api_endpoint: String) -> Result<Self>;
    
    /// KAMUI 4Dã¸æ¥ç¶š
    pub async fn connect(&mut self) -> Result<()>;
    
    /// æ¥ç¶šã‚’åˆ‡æ–­
    pub async fn disconnect(&mut self) -> Result<()>;
    
    /// ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’é€ä¿¡
    pub async fn send_task_update(&self, task: &TaskMetadata) -> Result<()>;
    
    /// WorktreeçŠ¶æ…‹ã‚’é€ä¿¡
    pub async fn send_worktree_status(&self, status: &WorktreeState) -> Result<()>;
    
    /// AgentçŠ¶æ…‹ã‚’é€ä¿¡
    pub async fn send_agent_status(&self, status: &AgentStatus) -> Result<()>;
    
    /// ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ é–‹å§‹
    pub async fn start_event_stream(&mut self) -> Result<()>;
    
    /// ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
    pub async fn recv_event(&mut self) -> Result<KamuiEvent>;
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct KamuiTaskUpdate {
    pub id: String,
    pub issue_number: Option<u64>,
    pub title: String,
    pub status: String,
    pub worktree_path: Option<String>,
    pub branch_name: Option<String>,
    pub agent: Option<String>,
    pub progress: Option<f32>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum KamuiEvent {
    TaskCommand { task_id: String, command: String },
    RefreshRequest,
    Disconnect,
}
```

### KAMUI 4D APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
POST   /api/miyabi/tasks           # ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»æ›´æ–°
GET    /api/miyabi/tasks           # ã‚¿ã‚¹ã‚¯ä¸€è¦§å–å¾—
DELETE /api/miyabi/tasks/:id       # ã‚¿ã‚¹ã‚¯å‰Šé™¤

POST   /api/miyabi/worktrees       # WorktreeçŠ¶æ…‹é€ä¿¡
POST   /api/miyabi/agents          # AgentçŠ¶æ…‹é€ä¿¡

WS     /ws/miyabi                  # WebSocketã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ 
```

### CLIçµ±åˆ

```rust
// crates/miyabi-cli/src/commands/work_on.rs

#[derive(Debug, Parser)]
pub struct WorkOnCommand {
    issue_number: u64,
    
    #[arg(long)]
    visualize: bool,  // KAMUI 4Dé€£æº
}

impl WorkOnCommand {
    pub async fn execute(&self) -> Result<()> {
        // ... æ—¢å­˜ã®Worktreeä½œæˆãƒ­ã‚¸ãƒƒã‚¯ ...
        
        if self.visualize {
            let bridge = KamuiBridge::new("http://localhost:3000".to_string()).await?;
            bridge.connect().await?;
            
            // ã‚¿ã‚¹ã‚¯æƒ…å ±é€ä¿¡
            bridge.send_task_update(&task_metadata).await?;
            
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§çŠ¶æ…‹åŒæœŸé–‹å§‹
            tokio::spawn(async move {
                let mut interval = tokio::time::interval(Duration::from_secs(5));
                loop {
                    interval.tick().await;
                    // Worktree/AgentçŠ¶æ…‹ã‚’å®šæœŸé€ä¿¡
                }
            });
        }
        
        Ok(())
    }
}
```

### ä½¿ç”¨ä¾‹

```bash
# KAMUI 4Dã‚’èµ·å‹•
# /Applications/KAMUI-4D.app ã‚’é–‹ã

# Miyabiã‹ã‚‰æ¥ç¶š
miyabi kamui connect

# Issueä½œæ¥­é–‹å§‹ï¼ˆKAMUI 4Dã§å¯è¦–åŒ–ï¼‰
miyabi work-on 270 --visualize

# KAMUI 4Dä¸Šã§WorktreeçŠ¶æ…‹ãŒ3Dè¡¨ç¤ºã•ã‚Œã‚‹
# - è¤‡æ•°Worktreeã®ä¸¦åˆ—å®Ÿè¡ŒçŠ¶æ³
# - Agentå®Ÿè¡Œä¸­ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
# - Gitã‚°ãƒ©ãƒ•ã®çµ±åˆè¡¨ç¤º
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```rust
#[cfg(test)]
mod tests {
    #[tokio::test]
    async fn test_kamui_connect() {
        // KAMUI 4Dæ¥ç¶š
    }

    #[tokio::test]
    async fn test_send_task_update() {
        // ã‚¿ã‚¹ã‚¯æ›´æ–°é€ä¿¡
    }

    #[tokio::test]
    async fn test_websocket_event() {
        // WebSocketã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
    }
}
```

## ğŸ”— å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### KAMUI 4D APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ‹¡å¼µäºˆå®šï¼‰

KAMUI 4Dã®`src/main/api/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ–°è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ï¼š

```javascript
// KAMUI 4D: src/main/api/miyabi-api.js

router.post('/api/miyabi/tasks', async (req, res) => {
  const task = req.body;
  // ã‚¿ã‚¹ã‚¯ã‚’KAMUI 4Dã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ 
  globalTaskStore.addMiyabiTask(task);
  res.json({ success: true });
});
```

## ğŸ“Š æˆåŠŸæ¡ä»¶

- [ ] `miyabi kamui connect` ã§æ¥ç¶šç¢ºç«‹
- [ ] `miyabi work-on <issue> --visualize` ã§3Dè¡¨ç¤º
- [ ] ã‚¿ã‚¹ã‚¯æƒ…å ±ãŒKAMUI 4Dã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

## ğŸ”„ Dependencies

- **Depends on**: #613, #615 (Phase 1å®Œäº†)
- **Related**: KAMUI 4Då´ã®APIå®Ÿè£…ãŒå¿…è¦

---

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

### 3. Add tests for #619

- **ID**: `task-619-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-619-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #619

- **ID**: `task-619-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-619-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-619-analysis` - Analyze requirements for #619

### Level 1 (Parallel Execution)

- `task-619-impl` - Implement solution for #619

### Level 2 (Parallel Execution)

- `task-619-test` - Add tests for #619

### Level 3 (Parallel Execution)

- `task-619-review` - Review code quality for #619

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_619_analysis["Analyze requirements for #619"]
    task_619_impl["Implement solution for #619"]
    task_619_test["Add tests for #619"]
    task_619_review["Review code quality for #619"]
    task_619_analysis --> task_619_impl
    task_619_impl --> task_619_test
    task_619_test --> task_619_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-10-30 17:47:30 UTC*
