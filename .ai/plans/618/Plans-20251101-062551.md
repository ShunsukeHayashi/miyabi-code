# Plans for Issue #618

**Title**: feat: Agentå®Ÿè¡ŒçŠ¶æ…‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º - ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°TUI

**URL**: https://github.com/customer-cloud/miyabi-private/issues/618

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #618

- **ID**: `task-618-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #618

- **ID**: `task-618-impl`
- **Type**: Feature
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-618-analysis

**Description**: # Agentå®Ÿè¡ŒçŠ¶æ…‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º

**Parent Issue**: #612 (Epic: KAMUI 4Dè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆ)
**Phase**: Phase 2 - å¯è¦–åŒ–
**Priority**: ğŸ“Š P2-Medium
**Estimated Time**: 5-7 days

## ğŸ“‹ æ¦‚è¦

å®Ÿè¡Œä¸­ã®Agentã®çŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹TUIã‚’å®Ÿè£…ã™ã‚‹ã€‚21å€‹ã®Agentã®å®Ÿè¡ŒçŠ¶æ³ã€é€²æ—ã€ãƒ­ã‚°å‡ºåŠ›ã‚’è¦–è¦šçš„ã«è¿½è·¡ã—ã€ä¸¦åˆ—å®Ÿè¡Œã®åŠ¹ç‡ã‚’æœ€å¤§åŒ–ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™

`miyabi agent monitor` ã‚³ãƒãƒ³ãƒ‰ã§ä»¥ä¸‹ã‚’å®Ÿç¾ï¼š

- å…¨Agentï¼ˆ21å€‹ï¼‰ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’ä¸€è¦§è¡¨ç¤º
- å®Ÿè¡Œä¸­Agentã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—
- ãƒ­ã‚°å‡ºåŠ›ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º
- CPU/ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã®ç›£è¦–
- Agenté–“ã®ä¾å­˜é–¢ä¿‚ã®å¯è¦–åŒ–

## ğŸ“Š è¦ä»¶

### å¿…é ˆè¦ä»¶

- [ ] AgentçŠ¶æ…‹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
  - 21å€‹ã®AgentçŠ¶æ…‹ï¼ˆIdle/Running/Completed/Failedï¼‰
  - å®Ÿè¡Œæ™‚é–“ã€é€²æ—ç‡
  - å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIssueç•ªå·
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆ0.5ç§’é–“éš”ï¼‰
- [ ] ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
  - é¸æŠã—ãŸAgentã®ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
  - ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆInfo/Warn/Errorï¼‰
  - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½
- [ ] ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–
  - CPUä½¿ç”¨ç‡
  - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
  - ãƒ‡ã‚£ã‚¹ã‚¯I/O
- [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
  - `â†‘â†“` - Agenté¸æŠ
  - `Enter` - ãƒ­ã‚°è¡¨ç¤º
  - `k` - Agentåœæ­¢ï¼ˆkillï¼‰
  - `r` - Agentå†èµ·å‹•
  - `q` - çµ‚äº†

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦ä»¶

- [ ] Agentä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å±¥æ­´ã‚°ãƒ©ãƒ•
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ï¼ˆã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ï¼‰
- [ ] ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Rust 2021 Edition
- **ä¾å­˜**:
  - `ratatui` - TUIæç”»
  - `tokio` - éåŒæœŸå‡¦ç†
  - `sysinfo` - ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±å–å¾—
  - `tracing` - ãƒ­ã‚°ç®¡ç†

## ğŸ“ è¨­è¨ˆ

### TUIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Miyabi Agent Monitor (Press 'q' to quit)         CPU: 45%    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Coding Agents (7):                                            â”‚
â”‚ âœ… CoordinatorAgent    â”‚ issue-270 â”‚ Running â”‚ 15m 32s â”‚ 2.1GBâ”‚
â”‚ âœ… CodeGenAgent        â”‚ issue-271 â”‚ Running â”‚  8m 45s â”‚ 1.8GBâ”‚
â”‚ â¸ï¸  ReviewAgent         â”‚ -         â”‚ Idle    â”‚    -    â”‚   -  â”‚
â”‚ â¸ï¸  IssueAgent          â”‚ -         â”‚ Idle    â”‚    -    â”‚   -  â”‚
â”‚ â¸ï¸  PRAgent             â”‚ -         â”‚ Idle    â”‚    -    â”‚   -  â”‚
â”‚ â¸ï¸  DeploymentAgent     â”‚ -         â”‚ Idle    â”‚    -    â”‚   -  â”‚
â”‚ â¸ï¸  RefresherAgent      â”‚ -         â”‚ Idle    â”‚    -    â”‚   -  â”‚
â”‚                                                               â”‚
â”‚ Business Agents (14):                                         â”‚
â”‚ â¸ï¸  AIEntrepreneurAgent â”‚ -         â”‚ Idle    â”‚    -    â”‚   -  â”‚
â”‚ ... (collapsed, press 'e' to expand)                          â”‚
â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Agent Logs: CoordinatorAgent (issue-270)                      â”‚
â”‚ [INFO ] 10:30:15 - Starting task decomposition...            â”‚
â”‚ [INFO ] 10:30:17 - Analyzing dependencies...                 â”‚
â”‚ [INFO ] 10:30:20 - Created 3 sub-tasks                       â”‚
â”‚ [DEBUG] 10:30:21 - Assigned to: CodeGenAgent, ReviewAgent    â”‚
â”‚ [INFO ] 10:30:25 - Monitoring sub-task progress...           â”‚
â”‚ [WARN ] 10:30:30 - CodeGenAgent: high memory usage           â”‚
â”‚ [INFO ] 10:30:32 - Sub-task 1/3 completed                    â”‚
â”‚ â–¼ (scrollable)                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â†‘â†“] Select | [Enter] Logs | [k] Kill | [r] Restart | [q] Quitâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AgentçŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```rust
// crates/miyabi-agents/src/monitor.rs

#[derive(Debug, Clone)]
pub struct AgentStatus {
    pub name: String,
    pub agent_type: AgentType,
    pub state: AgentState,
    pub issue_number: Option<u64>,
    pub started_at: Option<DateTime<Utc>>,
    pub elapsed: Option<Duration>,
    pub memory_usage: u64,
    pub cpu_usage: f32,
    pub progress: Option<f32>,  // 0.0 - 1.0
    pub last_log: Option<String>,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum AgentState {
    Idle,
    Running,
    Waiting,     // ä¾å­˜é–¢ä¿‚å¾…ã¡
    Completed,
    Failed,
    Killed,
}

#[derive(Debug, Clone, Copy)]
pub enum AgentType {
    Coordinator,
    CodeGen,
    Review,
    Issue,
    PR,
    Deployment,
    Refresher,
    // Business Agents
    AIEntrepreneur,
    ProductConcept,
    // ...
}

pub struct AgentMonitor {
    statuses: HashMap<String, AgentStatus>,
    log_buffer: Arc<Mutex<Vec<LogEntry>>>,
}

impl AgentMonitor {
    pub fn new() -> Self;
    
    /// å…¨AgentçŠ¶æ…‹ã‚’å–å¾—
    pub async fn get_all_statuses(&self) -> Vec<AgentStatus>;
    
    /// ç‰¹å®šAgentã®ãƒ­ã‚°ã‚’å–å¾—
    pub async fn get_agent_logs(&self, agent_name: &str, limit: usize) -> Vec<LogEntry>;
    
    /// AgentçŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆå†…éƒ¨ï¼‰
    pub(crate) async fn update_status(&self, agent_name: &str, status: AgentStatus);
    
    /// Agentã‚’åœæ­¢
    pub async fn kill_agent(&self, agent_name: &str) -> Result<()>;
    
    /// Agentã‚’å†èµ·å‹•
    pub async fn restart_agent(&self, agent_name: &str) -> Result<()>;
}

#[derive(Debug, Clone)]
pub struct LogEntry {
    pub timestamp: DateTime<Utc>,
    pub level: LogLevel,
    pub message: String,
    pub agent_name: String,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum LogLevel {
    Debug,
    Info,
    Warn,
    Error,
}
```

### TUIå®Ÿè£…

```rust
// crates/miyabi-cli/src/tui/agent_monitor.rs

pub struct AgentMonitorTui {
    monitor: Arc<AgentMonitor>,
    selected_index: usize,
    selected_agent: Option<String>,
    log_scroll_offset: usize,
    show_business_agents: bool,
}

impl AgentMonitorTui {
    pub async fn run(&mut self) -> Result<()> {
        enable_raw_mode()?;
        let mut terminal = Terminal::new(CrosstermBackend::new(io::stdout()))?;

        loop {
            terminal.draw(|f| self.ui(f))?;
            
            if self.handle_events().await? {
                break;
            }
            
            tokio::time::sleep(Duration::from_millis(500)).await;
        }

        Ok(())
    }

    fn ui(&self, f: &mut Frame) {
        let chunks = Layout::default()
            .direction(Direction::Vertical)
            .constraints([
                Constraint::Length(3),      // ãƒ˜ãƒƒãƒ€ãƒ¼
                Constraint::Percentage(40), // Agentä¸€è¦§
                Constraint::Percentage(50), // ãƒ­ã‚°ãƒ‘ãƒãƒ«
                Constraint::Length(3),      // ãƒ•ãƒƒã‚¿ãƒ¼
            ])
            .split(f.area());

        // ãƒ˜ãƒƒãƒ€ãƒ¼
        let cpu_usage = self.get_system_cpu_usage();
        let header = Paragraph::new(format!("Miyabi Agent Monitor (CPU: {:.1}%)", cpu_usage))
            .block(Block::bordered());
        f.render_widget(header, chunks[0]);

        // Agentä¸€è¦§
        let statuses = self.monitor.get_all_statuses().await;
        let agent_items: Vec<ListItem> = statuses
            .iter()
            .filter(|s| {
                if !self.show_business_agents {
                    matches!(s.agent_type, AgentType::Coordinator | /* other coding agents */)
                } else {
                    true
                }
            })
            .map(|status| {
                let icon = match status.state {
                    AgentState::Running => "âœ…",
                    AgentState::Idle => "â¸ï¸",
                    AgentState::Failed => "âŒ",
                    AgentState::Completed => "âœ”ï¸",
                    _ => "â“",
                };
                let content = format!(
                    "{} {:20} â”‚ {:9} â”‚ {:8} â”‚ {:7} â”‚ {}",
                    icon,
                    status.name,
                    status.issue_number.map_or("-".to_string(), |n| format!("issue-{}", n)),
                    format!("{:?}", status.state),
                    status.elapsed.map_or("-".to_string(), |d| format_duration(d)),
                    format_bytes(status.memory_usage)
                );
                ListItem::new(content)
            })
            .collect();

        let agent_list = List::new(agent_items)
            .block(Block::bordered().title("Agents"))
            .highlight_style(Style::default().bg(Color::DarkGray));
        f.render_widget(agent_list, chunks[1]);

        // ãƒ­ã‚°ãƒ‘ãƒãƒ«
        if let Some(agent_name) = &self.selected_agent {
            let logs = self.monitor.get_agent_logs(agent_name, 100).await;
            let log_items: Vec<ListItem> = logs
                .iter()
                .skip(self.log_scroll_offset)
                .take(chunks[2].height as usize)
                .map(|log| {
                    let color = match log.level {
                        LogLevel::Error => Color::Red,
                        LogLevel::Warn => Color::Yellow,
                        LogLevel::Info => Color::Green,
                        LogLevel::Debug => Color::Gray,
                    };
                    let content = format!(
                        "[{:5}] {} - {}",
                        format!("{:?}", log.level).to_uppercase(),
                        log.timestamp.format("%H:%M:%S"),
                        log.message
                    );
                    ListItem::new(content).style(Style::default().fg(color))
                })
                .collect();

            let log_list = List::new(log_items)
                .block(Block::bordered().title(format!("Agent Logs: {}", agent_name)));
            f.render_widget(log_list, chunks[2]);
        }

        // ãƒ•ãƒƒã‚¿ãƒ¼
        let footer = Paragraph::new("[â†‘â†“] Select | [Enter] Logs | [k] Kill | [r] Restart | [q] Quit")
            .block(Block::bordered());
        f.render_widget(footer, chunks[3]);
    }
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_agent_status_tracking() {
        // AgentçŠ¶æ…‹è¿½è·¡
    }

    #[test]
    fn test_log_streaming() {
        // ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
    }

    #[test]
    fn test_agent_kill() {
        // Agentåœæ­¢
    }
}
```

## ğŸ“Š æˆåŠŸæ¡ä»¶

- [ ] `miyabi agent monitor` ã§AgentçŠ¶æ…‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãŒå‹•ä½œã™ã‚‹ï¼ˆ0.5ç§’é–“éš”ï¼‰
- [ ] ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒå‹•ä½œã™ã‚‹
- [ ] Agentåœæ­¢/å†èµ·å‹•ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

## ğŸ”„ Dependencies

- **Depends on**: #616 (TUIåŸºç›¤)

---

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

### 3. Add tests for #618

- **ID**: `task-618-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-618-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #618

- **ID**: `task-618-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-618-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-618-analysis` - Analyze requirements for #618

### Level 1 (Parallel Execution)

- `task-618-impl` - Implement solution for #618

### Level 2 (Parallel Execution)

- `task-618-test` - Add tests for #618

### Level 3 (Parallel Execution)

- `task-618-review` - Review code quality for #618

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_618_analysis["Analyze requirements for #618"]
    task_618_impl["Implement solution for #618"]
    task_618_test["Add tests for #618"]
    task_618_review["Review code quality for #618"]
    task_618_analysis --> task_618_impl
    task_618_impl --> task_618_test
    task_618_test --> task_618_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-11-01 06:25:51 UTC*
