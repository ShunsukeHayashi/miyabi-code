# Plans for Issue #620

**Title**: feat: KAMUI 4D API„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÊã°Âºµ - MiyabiÁµ±ÂêàAPI

**URL**: https://github.com/customer-cloud/miyabi-private/issues/620

---

## üìã Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: ‚úÖ No

## üìù Task Breakdown

### 1. Analyze requirements for #620

- **ID**: `task-620-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #620

- **ID**: `task-620-impl`
- **Type**: Feature
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-620-analysis

**Description**: # KAMUI 4D API„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÊã°Âºµ

**Parent Issue**: #612 (Epic: KAMUI 4DË®≠Ë®à„Éë„Çø„Éº„É≥Áµ±Âêà)
**Phase**: Phase 3 - KAMUI 4DÁµ±Âêà
**Priority**: üìù P3-Low
**Estimated Time**: 5-7 days

## üìã Ê¶ÇË¶Å

KAMUI 4D„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Å´MiyabiÂ∞ÇÁî®„ÅÆAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíËøΩÂä†„Åó„ÄÅMiyabi„Åã„Çâ„ÅÆ„Çø„Çπ„ÇØÊÉÖÂ†±„ÄÅWorktreeÁä∂ÊÖã„ÄÅAgentÂÆüË°åÁä∂Ê≥Å„ÇíÂèó‰ø°„ÉªË°®Á§∫„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã„ÄÇ

**Ê≥®ÊÑè**: „Åì„ÅÆIssue„ÅØKAMUI 4D„É™„Éù„Ç∏„Éà„É™„Åß„ÅÆ‰ΩúÊ•≠„Åß„ÅôÔºàMiyabi„É™„Éù„Ç∏„Éà„É™„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ

## üéØ ÁõÆÊ®ô

KAMUI 4D„Å´‰ª•‰∏ã„ÅÆAPI„ÇíËøΩÂä†Ôºö

- Miyabi„Çø„Çπ„ÇØÊÉÖÂ†±„ÅÆÂèó‰ø°„ÉªË°®Á§∫
- WorktreeÁä∂ÊÖã„ÅÆ3DÂèØË¶ñÂåñ
- AgentÂÆüË°åÁä∂Ê≥Å„ÅÆÁµ±ÂêàË°®Á§∫
- WebSocket„Å´„Çà„Çã„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞

## üìä Ë¶Å‰ª∂

### ÂøÖÈ†àË¶Å‰ª∂ÔºàKAMUI 4DÂÅ¥Ôºâ

- [ ] `/api/miyabi/tasks` „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
  - `POST` - „Çø„Çπ„ÇØ‰ΩúÊàê„ÉªÊõ¥Êñ∞
  - `GET` - „Çø„Çπ„ÇØ‰∏ÄË¶ßÂèñÂæó
  - `DELETE` - „Çø„Çπ„ÇØÂâäÈô§
- [ ] `/api/miyabi/worktrees` „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
  - `POST` - WorktreeÁä∂ÊÖãÊõ¥Êñ∞
  - `GET` - Worktree‰∏ÄË¶ßÂèñÂæó
- [ ] `/api/miyabi/agents` „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
  - `POST` - AgentÁä∂ÊÖãÊõ¥Êñ∞
  - `GET` - Agent‰∏ÄË¶ßÂèñÂæó
- [ ] `/ws/miyabi` WebSocket„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
  - „Ç§„Éô„É≥„Éà„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞
- [ ] UIÁµ±Âêà
  - Miyabi„Çø„Çπ„ÇØ„ÇíÂ∞ÇÁî®„Éë„Éç„É´„Å´Ë°®Á§∫
  - 3D„Ç∞„É©„Éï„Å´ WorktreeÁä∂ÊÖã„ÇíÂèçÊò†

### „Ç™„Éó„Ç∑„Éß„É≥Ë¶Å‰ª∂

- [ ] Miyabi„Ç≥„Éû„É≥„ÉâÈÄÅ‰ø°Ê©üËÉΩ
- [ ] Ë™çË®º„Éª„Çª„Ç≠„É•„É™„ÉÜ„Ç£
- [ ] „É≠„Ç∞Ë°®Á§∫„Éë„Éç„É´

## üõ†Ô∏è ÊäÄË°ì„Çπ„Çø„ÉÉ„ÇØ

- **Ë®ÄË™û**: JavaScript/TypeScript (Electron)
- **Framework**: Express.js
- **ÂÆüË£ÖÂ†¥ÊâÄ**: `KAMUI-4D/src/main/api/`

## üìê Ë®≠Ë®à

### API„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÂÆüË£Ö

```javascript
// KAMUI-4D/src/main/api/miyabi-api.js

const express = require('express');
const router = express.Router();

// „Ç∞„É≠„Éº„Éê„É´„Çπ„Éà„Ç¢ÔºàMiyabi„Çø„Çπ„ÇØ‰øùÂ≠òÔºâ
const miyabiTaskStore = {
  tasks: new Map(),
  worktrees: new Map(),
  agents: new Map(),
};

// „Çø„Çπ„ÇØ‰ΩúÊàê„ÉªÊõ¥Êñ∞
router.post('/api/miyabi/tasks', (req, res) => {
  const task = req.body;
  
  miyabiTaskStore.tasks.set(task.id, {
    ...task,
    updatedAt: new Date().toISOString(),
  });
  
  // WebSocket„Åß„É™„Ç¢„É´„Çø„Ç§„É†ÈÄöÁü•
  broadcastMiyabiUpdate('task-updated', task);
  
  res.json({ success: true, task });
});

// „Çø„Çπ„ÇØ‰∏ÄË¶ßÂèñÂæó
router.get('/api/miyabi/tasks', (req, res) => {
  const tasks = Array.from(miyabiTaskStore.tasks.values());
  res.json({ tasks });
});

// „Çø„Çπ„ÇØÂâäÈô§
router.delete('/api/miyabi/tasks/:id', (req, res) => {
  const { id } = req.params;
  miyabiTaskStore.tasks.delete(id);
  
  broadcastMiyabiUpdate('task-deleted', { id });
  
  res.json({ success: true });
});

// WorktreeÁä∂ÊÖãÊõ¥Êñ∞
router.post('/api/miyabi/worktrees', (req, res) => {
  const worktree = req.body;
  
  miyabiTaskStore.worktrees.set(worktree.path, {
    ...worktree,
    updatedAt: new Date().toISOString(),
  });
  
  broadcastMiyabiUpdate('worktree-updated', worktree);
  
  res.json({ success: true });
});

// AgentÁä∂ÊÖãÊõ¥Êñ∞
router.post('/api/miyabi/agents', (req, res) => {
  const agent = req.body;
  
  miyabiTaskStore.agents.set(agent.name, {
    ...agent,
    updatedAt: new Date().toISOString(),
  });
  
  broadcastMiyabiUpdate('agent-updated', agent);
  
  res.json({ success: true });
});

module.exports = router;
```

### WebSocketÁµ±Âêà

```javascript
// KAMUI-4D/src/main/websocket/miyabi-ws.js

const WebSocket = require('ws');

let miyabiWsClients = [];

function setupMiyabiWebSocket(wss) {
  wss.on('connection', (ws, req) => {
    if (req.url === '/ws/miyabi') {
      console.log('[Miyabi] WebSocket client connected');
      miyabiWsClients.push(ws);
      
      ws.on('close', () => {
        miyabiWsClients = miyabiWsClients.filter(client => client !== ws);
        console.log('[Miyabi] WebSocket client disconnected');
      });
      
      ws.on('message', (message) => {
        const event = JSON.parse(message);
        handleMiyabiEvent(event);
      });
    }
  });
}

function broadcastMiyabiUpdate(eventType, data) {
  const payload = JSON.stringify({ type: eventType, data });
  
  miyabiWsClients.forEach(client => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(payload);
    }
  });
}

function handleMiyabiEvent(event) {
  console.log('[Miyabi] Event received:', event);
  
  switch (event.type) {
    case 'task-status-request':
      // „Çø„Çπ„ÇØÁä∂ÊÖã„ÇíMiyabi„Å∏ÈÄÅ‰ø°
      break;
    case 'worktree-command':
      // Worktree„Ç≥„Éû„É≥„ÉâÂÆüË°å
      break;
  }
}

module.exports = {
  setupMiyabiWebSocket,
  broadcastMiyabiUpdate,
};
```

### UIÁµ±ÂêàÔºàReactÔºâ

```javascript
// KAMUI-4D/src/renderer/components/MiyabiPanel.jsx

import React, { useEffect, useState } from 'react';

function MiyabiPanel() {
  const [tasks, setTasks] = useState([]);
  const [worktrees, setWorktrees] = useState([]);

  useEffect(() => {
    // Miyabi„Çø„Çπ„ÇØÂèñÂæó
    fetch('/api/miyabi/tasks')
      .then(res => res.json())
      .then(data => setTasks(data.tasks));

    // WebSocketÊé•Á∂ö
    const ws = new WebSocket('ws://localhost:3000/ws/miyabi');
    
    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      
      if (message.type === 'task-updated') {
        setTasks(prev => {
          const index = prev.findIndex(t => t.id === message.data.id);
          if (index >= 0) {
            const updated = [...prev];
            updated[index] = message.data;
            return updated;
          }
          return [...prev, message.data];
        });
      }
    };

    return () => ws.close();
  }, []);

  return (
    <div className="miyabi-panel">
      <h2>Miyabi Tasks</h2>
      <div className="task-list">
        {tasks.map(task => (
          <div key={task.id} className="task-card">
            <div className="task-status">{task.status}</div>
            <div className="task-title">{task.title}</div>
            <div className="task-agent">{task.agent || 'N/A'}</div>
            <div className="task-progress">
              <progress value={task.progress || 0} max="1" />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

export default MiyabiPanel;
```

## üß™ „ÉÜ„Çπ„Éà„Ç±„Éº„Çπ

```javascript
// KAMUI-4D/tests/miyabi-api.test.js

describe('Miyabi API', () => {
  test('POST /api/miyabi/tasks should create task', async () => {
    const task = {
      id: 'issue-270',
      title: 'Test task',
      status: 'running',
    };
    
    const response = await fetch('/api/miyabi/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(task),
    });
    
    const data = await response.json();
    expect(data.success).toBe(true);
  });

  test('WebSocket should broadcast updates', (done) => {
    const ws = new WebSocket('ws://localhost:3000/ws/miyabi');
    
    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      expect(message.type).toBe('task-updated');
      done();
    };
  });
});
```

## üìä ÊàêÂäüÊù°‰ª∂

- [ ] API„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅåÊ≠£„Åó„ÅèÂãï‰Ωú„Åô„Çã
- [ ] WebSocket„Åß„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞„Åï„Çå„Çã
- [ ] KAMUI 4D UI„Å´Miyabi„Çø„Çπ„ÇØ„ÅåË°®Á§∫„Åï„Çå„Çã
- [ ] 3D„Ç∞„É©„Éï„Å´WorktreeÁä∂ÊÖã„ÅåÂèçÊò†„Åï„Çå„Çã
- [ ] „Éâ„Ç≠„É•„É°„É≥„Éà„ÅåÊõ¥Êñ∞„Åï„Çå„Çã

## üîÑ Dependencies

- **Depends on**: „Å™„ÅóÔºàÁã¨Á´ã„Åó„Å¶ÂÆüË£ÖÂèØËÉΩÔºâ
- **Related**: #619 (miyabi-kamui-bridge)

---

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

**Note**: „Åì„ÅÆIssue„ÅØKAMUI 4D„É™„Éù„Ç∏„Éà„É™ (`kamui4d-editor`) „ÅßÂÆüË£Ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

### 3. Add tests for #620

- **ID**: `task-620-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-620-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #620

- **ID**: `task-620-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-620-test

**Description**: Run quality checks and code review

## üîÑ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-620-analysis` - Analyze requirements for #620

### Level 1 (Parallel Execution)

- `task-620-impl` - Implement solution for #620

### Level 2 (Parallel Execution)

- `task-620-test` - Add tests for #620

### Level 3 (Parallel Execution)

- `task-620-review` - Review code quality for #620

## üìä Dependency Graph

```mermaid
graph TD
    task_620_analysis["Analyze requirements for #620"]
    task_620_impl["Implement solution for #620"]
    task_620_test["Add tests for #620"]
    task_620_review["Review code quality for #620"]
    task_620_analysis --> task_620_impl
    task_620_impl --> task_620_test
    task_620_test --> task_620_review
```

## ‚è±Ô∏è Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-10-30 17:47:31 UTC*
