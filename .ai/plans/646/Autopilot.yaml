# Autopilot Plan for Issue #646
# Version: 1.0.0
# Purpose: GitHub Token Setup Screenå®Ÿè£…
# Reference: miyabi_def/variables/workflows.yaml

autopilot:
  # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  version: "1.0.0"
  issue_number: 646
  title: "[Phase 3.2] åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ - GitHub Tokenè¨­å®š"
  created_at: "2025-10-31T23:00:00+09:00"

  # å®Ÿè¡Œè¨­å®š
  execution:
    mode: "dry-run"  # æœ€åˆã¯dry-runã§ãƒ†ã‚¹ãƒˆ
    timeout: 1800  # 30åˆ†
    max_retries: 2
    abort_on_failure: true

  # Worktreeè¨­å®š
  worktree:
    enabled: true
    branch_prefix: "autopilot/issue-"
    cleanup_on_success: true
    cleanup_on_failure: false  # ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ä¿æŒ

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  security:
    mask_secrets: true
    allowed_env_vars:
      - "GITHUB_TOKEN"
      - "ANTHROPIC_API_KEY"
      - "DEVICE_IDENTIFIER"
    block_network: false  # LLMä½¿ç”¨ã®ãŸã‚
    sandbox_mode: false

  # ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©
  steps:
    # Step 1: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - id: "step-1-setup"
      name: "ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
      type: "setup"
      commands:
        - "cd miyabi-desktop && pnpm install"
      expectations:
        - type: "exit_code"
          value: 0
        - type: "file_exists"
          value: "miyabi-desktop/node_modules/.bin/vite"
      on_failure: "abort"

    # Step 2: æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
    - id: "step-2-check-existing"
      name: "æ—¢å­˜å®Ÿè£…ç¢ºèª"
      type: "setup"
      commands:
        - "ls -la miyabi-desktop/src/components/"
        - "cat miyabi-desktop/src/App.tsx | grep -i setup || true"
      expectations:
        - type: "exit_code"
          value: 0
      on_failure: "continue"

    # Step 3: GitHubTokenSetup ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆï¼ˆdry-runãƒ¢ãƒ¼ãƒ‰ï¼‰
    - id: "step-3-create-component"
      name: "GitHubTokenSetup ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ"
      type: "codex_exec"
      commands:
        - "echo '[DRY-RUN] codex exec --full-auto --prompt \"Create GitHubTokenSetup.tsx component for miyabi-desktop setup wizard with token validation\"'"
      expectations:
        - type: "exit_code"
          value: 0
      post_commands:
        - "echo '[DRY-RUN] pnpm typecheck'"
        - "echo '[DRY-RUN] pnpm lint'"
      on_failure: "retry"

    # Step 4: App.tsxæ›´æ–°ï¼ˆdry-runãƒ¢ãƒ¼ãƒ‰ï¼‰
    - id: "step-4-update-app"
      name: "App.tsx ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ "
      type: "codex_exec"
      commands:
        - "echo '[DRY-RUN] codex exec --full-auto --prompt \"Add GitHubTokenSetup route to App.tsx\"'"
      expectations:
        - type: "exit_code"
          value: 0
      on_failure: "retry"

    # Step 5: TypeScriptãƒã‚§ãƒƒã‚¯ï¼ˆdry-runãƒ¢ãƒ¼ãƒ‰ï¼‰
    - id: "step-5-typecheck"
      name: "TypeScriptãƒã‚§ãƒƒã‚¯"
      type: "test"
      commands:
        - "echo '[DRY-RUN] cd miyabi-desktop && pnpm typecheck'"
      expectations:
        - type: "exit_code"
          value: 0
      on_failure: "abort"

    # Step 6: ã‚³ãƒ¼ãƒ‰æ•´å½¢ï¼ˆdry-runãƒ¢ãƒ¼ãƒ‰ï¼‰
    - id: "step-6-format"
      name: "ã‚³ãƒ¼ãƒ‰æ•´å½¢"
      type: "format"
      commands:
        - "echo '[DRY-RUN] cd miyabi-desktop && pnpm format'"
      expectations:
        - type: "exit_code"
          value: 0
      on_failure: "continue"

    # Step 7: ãƒ“ãƒ«ãƒ‰ç¢ºèªï¼ˆdry-runãƒ¢ãƒ¼ãƒ‰ï¼‰
    - id: "step-7-build"
      name: "ãƒ“ãƒ«ãƒ‰ç¢ºèª"
      type: "test"
      commands:
        - "echo '[DRY-RUN] cd miyabi-desktop && pnpm build'"
      expectations:
        - type: "exit_code"
          value: 0
      on_failure: "abort"

    # Step 8: PRä½œæˆï¼ˆdry-runãƒ¢ãƒ¼ãƒ‰ï¼‰
    - id: "step-8-create-pr"
      name: "PRä½œæˆ"
      type: "git"
      commands:
        - "echo '[DRY-RUN] git add .'"
        - "echo '[DRY-RUN] git commit -m \"feat(miyabi-desktop): implement GitHub Token setup screen\"'"
        - "echo '[DRY-RUN] git push -u origin HEAD'"
        - "echo '[DRY-RUN] gh pr create --title \"feat(miyabi-desktop): GitHub Token setup\" --body \"Implements #646\"'"
      expectations:
        - type: "exit_code"
          value: 0
      on_failure: "report"

  # ãƒ­ã‚°è¨­å®š
  logging:
    level: "debug"  # dry-runãªã®ã§è©³ç´°ãƒ­ã‚°
    output_dir: ".ai/logs/codex/autopilot"
    format: "text"  # ãƒ†ã‚¹ãƒˆæ®µéšã§ã¯textã§è¦‹ã‚„ã™ã
    capture_stdout: true
    capture_stderr: true

  # é€šçŸ¥è¨­å®š
  notifications:
    on_success:
      - type: "github_comment"
        template: |
          ## âœ… Autopilot DRY-RUN å®Œäº†

          **Issue**: #{{issue_number}}
          **Mode**: DRY-RUN (å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—)
          **Duration**: {{duration}}ç§’
          **Steps**: {{completed_steps}}/{{total_steps}}

          ### å®Ÿè¡Œãƒ­ã‚°
          - [è©³ç´°ãƒ­ã‚°]({{log_url}})
          - [ã‚µãƒãƒªãƒ¼]({{summary_url}})

          ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          - mode: "full-auto" ã«å¤‰æ›´ã—ã¦æœ¬ç•ªå®Ÿè¡Œ
          - ã¾ãŸã¯æ‰‹å‹•ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

          ğŸ¤– Generated with Autopilot Codex (DRY-RUN)

    on_failure:
      - type: "github_comment"
        template: |
          ## âŒ Autopilot DRY-RUN å¤±æ•—

          **Issue**: #{{issue_number}}
          **Mode**: DRY-RUN
          **Failed at**: {{failed_step}}
          **Error**: {{error_message}}

          ### ãƒ‡ãƒãƒƒã‚°æƒ…å ±
          - Worktree: {{worktree_path}}
          - Log: {{log_path}}

          ğŸ¤– Generated with Autopilot Codex (DRY-RUN)

      - type: "escalation"
        target: "TechLead"

  # ç›£æŸ»è¨­å®š
  audit:
    enabled: true
    check_worktree_cleanup: true
    validate_logs: true
    summary_required: true
