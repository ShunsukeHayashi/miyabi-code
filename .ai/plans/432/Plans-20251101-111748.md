# Plans for Issue #432

**Title**: ã€Featureã€‘miyabi-knowledge: å¢—åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ï¼ˆIncremental Indexingï¼‰ - Phase 2

**URL**: https://github.com/customer-cloud/miyabi-private/issues/432

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #432

- **ID**: `task-432-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #432

- **ID**: `task-432-impl`
- **Type**: Feature
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-432-analysis

**Description**: ## ğŸ“‹ æ¦‚è¦

æ—¢ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¸ˆã¿ã®ãƒ­ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€æ–°è¦ãƒ­ã‚°ã®ã¿ã‚’å‡¦ç†ã™ã‚‹å¢—åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

**è¦ªIssue**: #421 (Phase 2)
**ä¾å­˜Issue**: #422 (Phase 1å®Œäº† âœ…)

## ğŸ¯ ç›®çš„

- 2å›ç›®ä»¥é™ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã‚’**10å€ä»¥ä¸Šé«˜é€ŸåŒ–**
- å¤‰æ›´ã•ã‚ŒãŸãƒ­ã‚°ã®ã¿ã‚’è‡ªå‹•æ¤œå‡ºã—ã¦å†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸I/Oè² è·ã‚’å‰Šæ¸›

## ğŸ”§ å®Ÿè£…å†…å®¹

### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¸ˆã¿ãƒ­ã‚°è¿½è·¡

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-knowledge/src/cache.rs` (æ–°è¦ä½œæˆ)

```rust
use std::collections::HashMap;
use std::path::PathBuf;
use serde::{Serialize, Deserialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct IndexCache {
    /// ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ â†’ SHA256ãƒãƒƒã‚·ãƒ¥
    pub indexed_files: HashMap<PathBuf, String>,
    
    /// æœ€çµ‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    pub last_indexed_at: chrono::DateTime<chrono::Utc>,
    
    /// ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å
    pub workspace: String,
}

impl IndexCache {
    pub fn load_or_default(workspace: &str) -> Result<Self>;
    pub fn save(&self) -> Result<()>;
    pub fn is_indexed(&self, path: &PathBuf, hash: &str) -> bool;
    pub fn mark_indexed(&mut self, path: PathBuf, hash: String);
}
```

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `~/.cache/miyabi/knowledge/{workspace}.json`

### 2. ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥è¨ˆç®—

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-knowledge/src/hasher.rs` (æ–°è¦ä½œæˆ)

```rust
use sha2::{Sha256, Digest};
use std::path::Path;

pub fn hash_file<P: AsRef<Path>>(path: P) -> Result<String> {
    let content = std::fs::read(path)?;
    let mut hasher = Sha256::new();
    hasher.update(&content);
    Ok(format!("{:x}", hasher.finalize()))
}
```

### 3. å·®åˆ†æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-knowledge/src/indexer.rs` (æ‹¡å¼µ)

```rust
impl KnowledgeIndexer {
    /// å¢—åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ï¼ˆå¤‰æ›´ã•ã‚ŒãŸãƒ­ã‚°ã®ã¿ï¼‰
    pub async fn index_workspace_incremental(
        &self,
        workspace: &str,
    ) -> Result<IndexStats> {
        let cache = IndexCache::load_or_default(workspace)?;
        let log_files = self.collect_log_files()?;
        
        let mut to_index = Vec::new();
        for file in log_files {
            let hash = hash_file(&file)?;
            if !cache.is_indexed(&file, &hash) {
                to_index.push(file);
            }
        }
        
        tracing::info!(
            "Incremental index: {} of {} files need indexing",
            to_index.len(),
            log_files.len()
        );
        
        // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
        self.index_files(to_index).await
    }
}
```

### 4. CLIæ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-cli/src/commands/knowledge.rs` (æ‹¡å¼µ)

```rust
#[derive(Subcommand)]
pub enum KnowledgeCommand {
    // æ—¢å­˜ã‚³ãƒãƒ³ãƒ‰
    Search { ... },
    Stats { ... },
    Config { ... },
    
    // æ‹¡å¼µ
    Index {
        workspace: String,
        
        /// å¢—åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        #[arg(long, default_value = "true")]
        incremental: bool,
        
        /// å…¨ãƒ­ã‚°å†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
        #[arg(long)]
        full: bool,
    },
    
    /// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    ClearCache {
        /// ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆçœç•¥æ™‚ã¯å…¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
        workspace: Option<String>,
    },
}
```

**ä½¿ç”¨ä¾‹**:
```bash
# å¢—åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
miyabi knowledge index my-workspace

# å…¨ãƒ­ã‚°å†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
miyabi knowledge index my-workspace --full

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
miyabi knowledge clear-cache
miyabi knowledge clear-cache my-workspace
```

### 5. çµ±è¨ˆæƒ…å ±æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/miyabi-knowledge/src/types.rs` (æ‹¡å¼µ)

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct IndexStats {
    pub total_files: usize,
    pub indexed_files: usize,
    pub skipped_files: usize,  // æ–°è¦è¿½åŠ 
    pub success: usize,
    pub failed: usize,
    pub duration_secs: f64,
}
```

## âœ… æˆåŠŸåŸºæº–

- [ ] 2å›ç›®ä»¥é™ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ãŒ10å€ä»¥ä¸Šé«˜é€ŸåŒ–
  - åˆå›: 100ãƒ•ã‚¡ã‚¤ãƒ« â†’ 30ç§’
  - 2å›ç›®: 100ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰ â†’ 3ç§’ä»¥å†…
- [ ] 100ãƒ­ã‚°ä¸­1ãƒ­ã‚°å¤‰æ›´æ™‚ã€99ãƒ­ã‚°ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´ææ™‚ã‚‚æ­£å¸¸å‹•ä½œï¼ˆãƒ•ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
- [ ] `miyabi knowledge stats`ã«ã‚¹ã‚­ãƒƒãƒ—çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹

## ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®

### å˜ä½“ãƒ†ã‚¹ãƒˆ (`crates/miyabi-knowledge/tests/cache_tests.rs`)

- [ ] `test_index_cache_load_or_default()`
- [ ] `test_index_cache_save()`
- [ ] `test_index_cache_is_indexed()`
- [ ] `test_hash_file()`
- [ ] `test_hash_file_consistency()`

### çµ±åˆãƒ†ã‚¹ãƒˆ (`crates/miyabi-knowledge/tests/incremental_tests.rs`)

- [ ] `test_incremental_index_no_changes()` - å¤‰æ›´ãªã—æ™‚ã®ã‚¹ã‚­ãƒƒãƒ—
- [ ] `test_incremental_index_one_change()` - 1ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚
- [ ] `test_incremental_index_cache_corruption()` - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´ææ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- [ ] `test_incremental_index_new_workspace()` - æ–°è¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

- [ ] 1000ãƒ•ã‚¡ã‚¤ãƒ«åˆå›ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 5åˆ†ä»¥å†…
- [ ] 1000ãƒ•ã‚¡ã‚¤ãƒ«2å›ç›®ï¼ˆå¤‰æ›´ãªã—ï¼‰: 30ç§’ä»¥å†…
- [ ] 1000ãƒ•ã‚¡ã‚¤ãƒ«ä¸­10ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´: 1åˆ†ä»¥å†…

## ğŸ“Š æ¨å®šå·¥æ•°

- **è¨­è¨ˆ**: 0.5æ—¥
- **å®Ÿè£…**: 3æ—¥
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ : 1æ—¥
  - å·®åˆ†æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯: 1æ—¥
  - CLIæ‹¡å¼µ: 0.5æ—¥
  - çµ±è¨ˆæ‹¡å¼µ: 0.5æ—¥
- **ãƒ†ã‚¹ãƒˆä½œæˆ**: 1æ—¥
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**: 0.5æ—¥

**åˆè¨ˆ**: 5æ—¥

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **æ–°è¦ä½œæˆ**:
  - `crates/miyabi-knowledge/src/cache.rs`
  - `crates/miyabi-knowledge/src/hasher.rs`
  - `crates/miyabi-knowledge/tests/cache_tests.rs`
  - `crates/miyabi-knowledge/tests/incremental_tests.rs`

- **æ‹¡å¼µ**:
  - `crates/miyabi-knowledge/src/indexer.rs`
  - `crates/miyabi-knowledge/src/types.rs`
  - `crates/miyabi-cli/src/commands/knowledge.rs`
  - `crates/miyabi-knowledge/USER_GUIDE.md`

## ğŸ“ æ³¨æ„äº‹é …

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼**: JSONï¼ˆäººé–“å¯èª­ã€ãƒ‡ãƒãƒƒã‚°å®¹æ˜“ï¼‰
2. **ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: SHA256ï¼ˆè¡çªè€æ€§ã€æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´ææ™‚ã¯`tracing::warn!()`ã§ãƒ•ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
4. **ä¸¦è¡Œå®Ÿè¡Œ**: è¤‡æ•°ãƒ—ãƒ­ã‚»ã‚¹ã§ã®åŒæ™‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã¯æœªã‚µãƒãƒ¼ãƒˆï¼ˆPhase 3ã§å¯¾å¿œï¼‰

---

**Parent Issue**: #421
**Phase**: Phase 2 - å¢—åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
**Priority**: ğŸ”¥ P0-Critical
**Estimated**: 5æ—¥

### 3. Add tests for #432

- **ID**: `task-432-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-432-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #432

- **ID**: `task-432-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-432-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-432-analysis` - Analyze requirements for #432

### Level 1 (Parallel Execution)

- `task-432-impl` - Implement solution for #432

### Level 2 (Parallel Execution)

- `task-432-test` - Add tests for #432

### Level 3 (Parallel Execution)

- `task-432-review` - Review code quality for #432

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_432_analysis["Analyze requirements for #432"]
    task_432_impl["Implement solution for #432"]
    task_432_test["Add tests for #432"]
    task_432_review["Review code quality for #432"]
    task_432_analysis --> task_432_impl
    task_432_impl --> task_432_test
    task_432_test --> task_432_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-11-01 11:17:48 UTC*
