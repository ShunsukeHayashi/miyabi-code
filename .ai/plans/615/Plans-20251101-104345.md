# Plans for Issue #615

**Title**: feat: WorktreeçŠ¶æ…‹ç®¡ç†ã®å¼·åŒ– - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

**URL**: https://github.com/customer-cloud/miyabi-private/issues/615

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #615

- **ID**: `task-615-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #615

- **ID**: `task-615-impl`
- **Type**: Feature
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-615-analysis

**Description**: # WorktreeçŠ¶æ…‹ç®¡ç†ã®å¼·åŒ–

**Parent Issue**: #612 (Epic: KAMUI 4Dè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆ)
**Phase**: Phase 1 - åŸºç›¤æ•´å‚™
**Priority**: âš ï¸ P1-High
**Estimated Time**: 3-5 days

## ğŸ“‹ æ¦‚è¦

Git Worktreeã®çŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¿½è·¡ã—ã€è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€çŠ¶æ…‹åŒæœŸã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–ã™ã‚‹ã€‚KAMUI 4Dã®worktreeç®¡ç†è¨­è¨ˆã‚’å‚è€ƒã«ã€Miyabiã®ä¸¦åˆ—å®Ÿè¡Œç’°å¢ƒã‚’æœ€é©åŒ–ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™

ä»¥ä¸‹ã®æ©Ÿèƒ½ã§Worktreeç®¡ç†ã‚’å¼·åŒ–ï¼š

- WorktreeçŠ¶æ…‹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡
- ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- Worktreeã‚¨ãƒ©ãƒ¼ã®æ¤œå‡ºã¨è‡ªå‹•ä¿®å¾©
- å­¤ç«‹Worktreeã®æ¤œå‡ºã¨å‰Šé™¤
- WorktreeçŠ¶æ…‹ã¨`.miyabi/tasks/*.json`ã®åŒæœŸ

## ğŸ“Š è¦ä»¶

### å¿…é ˆè¦ä»¶

- [ ] WorktreeçŠ¶æ…‹ã®è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ 
  - Active/Idle/Stuck/OrphanedçŠ¶æ…‹ã®åˆ¤åˆ¥
  - æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ™‚åˆ»ã®è¨˜éŒ²
  - ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®æ¤œå‡º
- [ ] è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
  - ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã®è‡ªå‹•Worktreeå‰Šé™¤
  - å­¤ç«‹Worktreeã®å®šæœŸã‚¹ã‚­ãƒ£ãƒ³
  - `miyabi cleanup` ã‚³ãƒãƒ³ãƒ‰
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  - Worktreeãƒ­ãƒƒã‚¯ã®è§£é™¤
  - ç ´æã—ãŸWorktreeã®ä¿®å¾©
  - ä¸æ•´åˆã®è‡ªå‹•æ¤œå‡º
- [ ] çŠ¶æ…‹åŒæœŸ
  - WorktreeçŠ¶æ…‹ â†” TaskMetadataåŒæœŸ
  - GitçŠ¶æ…‹ã®ç›£è¦–

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦ä»¶

- [ ] Worktreeãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- [ ] å®¹é‡ç®¡ç†ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç›£è¦–ï¼‰
- [ ] Worktreeã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ©Ÿèƒ½

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Rust 2021 Edition
- **Crate**: `miyabi-worktree`
- **ä¾å­˜**: `git2`, `tokio`, `notify` (ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–)

## ğŸ“ è¨­è¨ˆ

### WorktreeçŠ¶æ…‹ç®¡ç†

```rust
// crates/miyabi-worktree/src/state.rs

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct WorktreeState {
    pub path: PathBuf,
    pub branch: String,
    pub issue_number: Option<u64>,
    pub status: WorktreeStatus,
    pub last_accessed: DateTime<Utc>,
    pub is_locked: bool,
    pub has_uncommitted_changes: bool,
    pub disk_usage: u64,
}

#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
pub enum WorktreeStatus {
    Active,      // ç¾åœ¨ä½¿ç”¨ä¸­
    Idle,        // å¾…æ©Ÿä¸­ï¼ˆæœ€è¿‘ä½¿ç”¨ï¼‰
    Stuck,       // ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆé•·æ™‚é–“å¿œç­”ãªã—ï¼‰
    Orphaned,    // å­¤ç«‹ï¼ˆå¯¾å¿œã™ã‚‹TaskMetadataãªã—ï¼‰
    Corrupted,   // ç ´æ
}

pub struct WorktreeStateManager {
    project_root: PathBuf,
    task_metadata_manager: TaskMetadataManager,
}

impl WorktreeStateManager {
    pub fn new(project_root: PathBuf) -> Result<Self>;
    
    /// å…¨Worktreeã®çŠ¶æ…‹ã‚’ã‚¹ã‚­ãƒ£ãƒ³
    pub fn scan_worktrees(&self) -> Result<Vec<WorktreeState>>;
    
    /// ç‰¹å®šWorktreeã®çŠ¶æ…‹ã‚’å–å¾—
    pub fn get_worktree_state(&self, path: &Path) -> Result<WorktreeState>;
    
    /// å­¤ç«‹Worktreeã‚’æ¤œå‡º
    pub fn find_orphaned_worktrees(&self) -> Result<Vec<WorktreeState>>;
    
    /// ã‚¹ã‚¿ãƒƒã‚¯ã—ãŸWorktreeã‚’æ¤œå‡º
    pub fn find_stuck_worktrees(&self, timeout: Duration) -> Result<Vec<WorktreeState>>;
    
    /// Worktreeã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    pub fn cleanup_worktree(&self, path: &Path) -> Result<()>;
    
    /// å…¨å­¤ç«‹Worktreeã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    pub fn cleanup_orphaned(&self) -> Result<usize>;
    
    /// Worktreeã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
    pub fn sync_with_metadata(&self) -> Result<()>;
}
```

### è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```rust
// crates/miyabi-worktree/src/cleanup.rs

pub struct WorktreeCleanupPolicy {
    pub delete_on_completion: bool,           // ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«å‰Šé™¤
    pub delete_orphaned_after: Duration,      // å­¤ç«‹Worktreeå‰Šé™¤ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    pub delete_idle_after: Duration,          // ã‚¢ã‚¤ãƒ‰ãƒ«Worktreeå‰Šé™¤ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    pub max_worktrees: Option<usize>,         // æœ€å¤§Worktreeæ•°
}

impl Default for WorktreeCleanupPolicy {
    fn default() -> Self {
        Self {
            delete_on_completion: true,
            delete_orphaned_after: Duration::from_secs(86400), // 24h
            delete_idle_after: Duration::from_secs(604800),    // 7 days
            max_worktrees: Some(10),
        }
    }
}

pub struct WorktreeCleanupManager {
    state_manager: WorktreeStateManager,
    policy: WorktreeCleanupPolicy,
}

impl WorktreeCleanupManager {
    pub fn new(state_manager: WorktreeStateManager, policy: WorktreeCleanupPolicy) -> Self;
    
    /// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
    pub async fn run_cleanup(&self) -> Result<CleanupReport>;
    
    /// å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹
    pub async fn start_periodic_cleanup(&self, interval: Duration);
}

#[derive(Debug)]
pub struct CleanupReport {
    pub deleted_worktrees: Vec<PathBuf>,
    pub freed_disk_space: u64,
    pub errors: Vec<String>,
}
```

### CLIã‚³ãƒãƒ³ãƒ‰

```bash
# WorktreeçŠ¶æ…‹è¡¨ç¤º
miyabi worktree status

# å­¤ç«‹Worktreeã®æ¤œå‡º
miyabi worktree scan --orphaned

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
miyabi cleanup

# å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã™ã¹ã¦å‰Šé™¤ï¼‰
miyabi cleanup --force --all

# ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå‰Šé™¤ã›ãšã«ç¢ºèªï¼‰
miyabi cleanup --dry-run
```

### CLIã‚³ãƒãƒ³ãƒ‰å‡ºåŠ›ä¾‹

```
$ miyabi worktree status

Worktree Status Report
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Active Worktrees (2):
  âœ… .worktrees/issue-270  [CoordinatorAgent]  Running  (1.2GB)
  âœ… .worktrees/issue-271  [CodeGenAgent]      Running  (980MB)

Idle Worktrees (1):
  â¸ï¸  .worktrees/issue-269  [ReviewAgent]       Idle     (1.5GB)
     Last accessed: 2 hours ago

Orphaned Worktrees (1):
  âš ï¸  .worktrees/issue-268  [Unknown]           Orphaned (2.1GB)
     No corresponding task metadata

Total: 4 worktrees, 5.8GB

Recommendations:
  - Cleanup orphaned worktree: miyabi cleanup --orphaned
  - Archive idle worktree: miyabi worktree archive issue-269
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_scan_worktrees() {
        // Worktreeã‚¹ã‚­ãƒ£ãƒ³
    }

    #[test]
    fn test_detect_orphaned_worktrees() {
        // å­¤ç«‹Worktreeæ¤œå‡º
    }

    #[test]
    fn test_cleanup_worktree() {
        // Worktreeã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    }

    #[test]
    fn test_sync_with_metadata() {
        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŒæœŸ
    }
}
```

## ğŸ”— å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### KAMUI 4Dè¨­è¨ˆ

```javascript
// git-worktree-task-system-design.md
worktree /path/to/main
HEAD abc1234
branch refs/heads/main

worktree /path/to/.worktrees/task-001
HEAD def5678
branch refs/heads/task/feature-001
```

### Miyabiæ—¢å­˜å®Ÿè£…

- `crates/miyabi-worktree/src/lib.rs` - WorktreeåŸºæœ¬æ“ä½œ
- `crates/miyabi-worktree/src/manager.rs` - Worktreeç®¡ç†

## ğŸ“Š æˆåŠŸæ¡ä»¶

- [ ] `miyabi worktree status` ã§WorktreeçŠ¶æ…‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å­¤ç«‹WorktreeãŒè‡ªå‹•æ¤œå‡ºã•ã‚Œã‚‹
- [ ] `miyabi cleanup` ã§å­¤ç«‹WorktreeãŒå‰Šé™¤ã•ã‚Œã‚‹
- [ ] ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«è‡ªå‹•çš„ã«WorktreeãŒå‰Šé™¤ã•ã‚Œã‚‹
- [ ] å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒé€šéã™ã‚‹
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

## ğŸ”„ Dependencies

- **Depends on**: #613 (ã‚¿ã‚¹ã‚¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–)
- **Blocks**: Phase 2ã®å¯è¦–åŒ–æ©Ÿèƒ½

---

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

### 3. Add tests for #615

- **ID**: `task-615-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-615-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #615

- **ID**: `task-615-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-615-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-615-analysis` - Analyze requirements for #615

### Level 1 (Parallel Execution)

- `task-615-impl` - Implement solution for #615

### Level 2 (Parallel Execution)

- `task-615-test` - Add tests for #615

### Level 3 (Parallel Execution)

- `task-615-review` - Review code quality for #615

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_615_analysis["Analyze requirements for #615"]
    task_615_impl["Implement solution for #615"]
    task_615_test["Add tests for #615"]
    task_615_review["Review code quality for #615"]
    task_615_analysis --> task_615_impl
    task_615_impl --> task_615_test
    task_615_test --> task_615_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-11-01 10:43:45 UTC*
