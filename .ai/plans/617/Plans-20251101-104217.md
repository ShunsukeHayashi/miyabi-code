# Plans for Issue #617

**Title**: feat: Gitå±¥æ­´ã‚°ãƒ©ãƒ•æç”»æ©Ÿèƒ½ - è¤‡æ•°ãƒ–ãƒ©ãƒ³ãƒã®çµ±åˆè¡¨ç¤º

**URL**: https://github.com/customer-cloud/miyabi-private/issues/617

---

## ğŸ“‹ Summary

- **Total Tasks**: 4
- **Estimated Duration**: 60 minutes
- **Execution Levels**: 4
- **Has Cycles**: âœ… No

## ğŸ“ Task Breakdown

### 1. Analyze requirements for #617

- **ID**: `task-617-analysis`
- **Type**: Docs
- **Assigned Agent**: IssueAgent
- **Priority**: 0
- **Estimated Duration**: 5 min

**Description**: Analyze issue requirements and create detailed specification

### 2. Implement solution for #617

- **ID**: `task-617-impl`
- **Type**: Feature
- **Assigned Agent**: CodeGenAgent
- **Priority**: 1
- **Estimated Duration**: 30 min
- **Dependencies**: task-617-analysis

**Description**: # Gitå±¥æ­´ã‚°ãƒ©ãƒ•æç”»æ©Ÿèƒ½

**Parent Issue**: #612 (Epic: KAMUI 4Dè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆ)
**Phase**: Phase 2 - å¯è¦–åŒ–
**Priority**: ğŸ“Š P2-Medium
**Estimated Time**: 5-7 days

## ğŸ“‹ æ¦‚è¦

è¤‡æ•°Worktreeã®ãƒ–ãƒ©ãƒ³ãƒã‚’çµ±åˆã—ãŸGitå±¥æ­´ã‚°ãƒ©ãƒ•ã‚’TUIã§è¡¨ç¤ºã™ã‚‹ã€‚KAMUI 4Dã®ã€ŒGitå±¥æ­´ã®çµ±åˆè¡¨ç¤ºã€æ©Ÿèƒ½ã‚’CLIç‰ˆã¨ã—ã¦å®Ÿè£…ã—ã€ä¸¦åˆ—å®Ÿè¡Œä¸­ã®å…¨ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’è¦–è¦šçš„ã«æŠŠæ¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™

`miyabi git-graph` ã‚³ãƒãƒ³ãƒ‰ã§ä»¥ä¸‹ã‚’å®Ÿç¾ï¼š

- å…¨Worktreeã®ãƒ–ãƒ©ãƒ³ãƒã‚’çµ±åˆã—ãŸå±¥æ­´ã‚°ãƒ©ãƒ•
- ã‚³ãƒŸãƒƒãƒˆé–“ã®è¦ªå­é–¢ä¿‚ã€ãƒãƒ¼ã‚¸ãƒã‚¤ãƒ³ãƒˆã‚’å¯è¦–åŒ–
- ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã®ãƒ¬ãƒ¼ãƒ³åˆ†ã‘
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †ã‚½ãƒ¼ãƒˆ
- ã‚³ãƒŸãƒƒãƒˆè©³ç´°ã®è¡¨ç¤º

## ğŸ“Š è¦ä»¶

### å¿…é ˆè¦ä»¶

- [ ] Gitå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
  - `git log --all --oneline --graph --pretty=format:...`
  - `git worktree list --porcelain`
  - å…¨ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
- [ ] ã‚°ãƒ©ãƒ•æç”»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
  - ãƒ¬ãƒ¼ãƒ³å‰²ã‚Šå½“ã¦ï¼ˆbranch lane algorithmï¼‰
  - ã‚³ãƒŸãƒƒãƒˆé–“ã®ã‚¨ãƒƒã‚¸æç”»
  - ãƒãƒ¼ã‚¸ãƒã‚¤ãƒ³ãƒˆã®è¡¨ç¤º
- [ ] TUIè¡¨ç¤º
  - ã‚³ãƒŸãƒƒãƒˆãƒªã‚¹ãƒˆï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰
  - ãƒ–ãƒ©ãƒ³ãƒãƒ¬ãƒ¼ãƒ³ï¼ˆè‰²åˆ†ã‘ï¼‰
  - ã‚³ãƒŸãƒƒãƒˆè©³ç´°ãƒ‘ãƒãƒ«
- [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
  - `â†‘â†“` - ã‚³ãƒŸãƒƒãƒˆé¸æŠ
  - `Enter` - è©³ç´°è¡¨ç¤º
  - `f` - ãƒ–ãƒ©ãƒ³ãƒãƒ•ã‚£ãƒ«ã‚¿
  - `q` - çµ‚äº†

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦ä»¶

- [ ] ãƒ–ãƒ©ãƒ³ãƒãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
- [ ] ä½œè€…ãƒ•ã‚£ãƒ«ã‚¿
- [ ] æ—¥ä»˜ç¯„å›²æŒ‡å®š
- [ ] ã‚°ãƒ©ãƒ•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆPNG/SVGï¼‰

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Rust 2021 Edition
- **ä¾å­˜**:
  - `git2` - Gitæ“ä½œ
  - `ratatui` - TUIæç”»
  - `tui-graph` (optional) - ã‚°ãƒ©ãƒ•æç”»
  - `petgraph` - ã‚°ãƒ©ãƒ•ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

## ğŸ“ è¨­è¨ˆ

### TUIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Miyabi Git History Graph                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ * main (HEAD)                                              â”‚
â”‚ â”‚                                                           â”‚
â”‚ â”‚ * issue-270 (CoordinatorAgent)                           â”‚
â”‚ â”‚ â”‚                                                         â”‚
â”‚ â”‚ â”‚ * issue-271 (CodeGenAgent)                             â”‚
â”‚ â”‚ â”‚ â”‚                                                       â”‚
â”‚ â”‚ â”‚ * fix: worktree state tracking                         â”‚
â”‚ â”‚ * â”‚ feat: add task metadata                              â”‚
â”‚ * â”‚ â”‚ docs: update README                                  â”‚
â”‚ â”‚\â”‚ â”‚                                                       â”‚
â”‚ â”‚ * â”‚ feat: agent config CLI                               â”‚
â”‚ â”‚  \â”‚                                                       â”‚
â”‚ *   * Merge branch 'issue-269'                             â”‚
â”‚ â”‚                                                           â”‚
â”‚ * feat: initial commit                                     â”‚
â”‚                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Commit: abc1234                                            â”‚
â”‚ Author: miyabi-bot                                         â”‚
â”‚ Date:   2025-10-29 10:30:00                                â”‚
â”‚ Branch: issue-270                                          â”‚
â”‚                                                            â”‚
â”‚ feat: add task metadata persistence                        â”‚
â”‚                                                            â”‚
â”‚ - Implement TaskMetadata struct                            â”‚
â”‚ - Add JSON serialization                                   â”‚
â”‚ - Create .miyabi/tasks/ directory                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â†‘â†“] Select | [Enter] Details | [f] Filter | [q] Quit     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Gitå±¥æ­´ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```rust
// crates/miyabi-git/src/graph.rs

#[derive(Debug, Clone)]
pub struct CommitNode {
    pub hash: String,
    pub short_hash: String,
    pub message: String,
    pub author: String,
    pub timestamp: DateTime<Utc>,
    pub parents: Vec<String>,
    pub refs: Vec<String>,  // ãƒ–ãƒ©ãƒ³ãƒåã€ã‚¿ã‚°
    pub lane: usize,        // è¡¨ç¤ºãƒ¬ãƒ¼ãƒ³ï¼ˆ0, 1, 2, ...ï¼‰
}

#[derive(Debug)]
pub struct GitGraph {
    pub commits: Vec<CommitNode>,
    pub branches: HashMap<String, String>,  // branch_name -> commit_hash
    pub worktrees: Vec<WorktreeInfo>,
}

impl GitGraph {
    pub fn new() -> Result<Self>;
    
    /// å…¨ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—
    pub fn load_history(&mut self, project_root: &Path) -> Result<()>;
    
    /// Worktreeæƒ…å ±ã‚’å–å¾—
    pub fn load_worktrees(&mut self, project_root: &Path) -> Result<()>;
    
    /// ã‚³ãƒŸãƒƒãƒˆã«ãƒ¬ãƒ¼ãƒ³ã‚’å‰²ã‚Šå½“ã¦
    pub fn assign_lanes(&mut self);
    
    /// ç‰¹å®šãƒ–ãƒ©ãƒ³ãƒã§ãƒ•ã‚£ãƒ«ã‚¿
    pub fn filter_by_branch(&self, branch: &str) -> Vec<CommitNode>;
}
```

### ãƒ¬ãƒ¼ãƒ³å‰²ã‚Šå½“ã¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```rust
// crates/miyabi-git/src/lane_assignment.rs

pub struct LaneAssigner {
    lanes: Vec<Option<String>>,  // lane_index -> current_branch
}

impl LaneAssigner {
    pub fn new() -> Self;
    
    /// ã‚³ãƒŸãƒƒãƒˆã«æœ€é©ãªãƒ¬ãƒ¼ãƒ³ã‚’å‰²ã‚Šå½“ã¦
    pub fn assign_lane(&mut self, commit: &CommitNode) -> usize;
    
    /// ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã®å‡¦ç†
    pub fn handle_merge(&mut self, commit: &CommitNode, parent_lanes: Vec<usize>) -> usize;
}
```

### TUIå®Ÿè£…

```rust
// crates/miyabi-cli/src/tui/git_graph.rs

pub struct GitGraphTui {
    graph: GitGraph,
    selected_index: usize,
    scroll_offset: usize,
}

impl GitGraphTui {
    pub async fn run(&mut self) -> Result<()> {
        enable_raw_mode()?;
        let mut terminal = Terminal::new(CrosstermBackend::new(io::stdout()))?;

        loop {
            terminal.draw(|f| self.ui(f))?;
            
            if self.handle_events().await? {
                break;
            }
        }

        Ok(())
    }

    fn ui(&self, f: &mut Frame) {
        let chunks = Layout::default()
            .direction(Direction::Vertical)
            .constraints([
                Constraint::Length(3),      // ãƒ˜ãƒƒãƒ€ãƒ¼
                Constraint::Min(10),        // ã‚°ãƒ©ãƒ•
                Constraint::Length(10),     // è©³ç´°
                Constraint::Length(3),      // ãƒ•ãƒƒã‚¿ãƒ¼
            ])
            .split(f.area());

        // ã‚°ãƒ©ãƒ•æç”»
        let graph_items: Vec<ListItem> = self.graph.commits
            .iter()
            .skip(self.scroll_offset)
            .take(chunks[1].height as usize)
            .map(|commit| {
                let graph_line = self.render_commit_graph(commit);
                ListItem::new(graph_line)
            })
            .collect();

        let graph = List::new(graph_items)
            .block(Block::bordered().title("Git History"));
        f.render_widget(graph, chunks[1]);

        // è©³ç´°ãƒ‘ãƒãƒ«
        if let Some(selected) = self.graph.commits.get(self.selected_index) {
            let details = format!(
                "Commit: {}\nAuthor: {}\nDate:   {}\n\n{}",
                selected.short_hash,
                selected.author,
                selected.timestamp.format("%Y-%m-%d %H:%M:%S"),
                selected.message
            );
            let details_widget = Paragraph::new(details)
                .block(Block::bordered().title("Details"));
            f.render_widget(details_widget, chunks[2]);
        }
    }

    fn render_commit_graph(&self, commit: &CommitNode) -> String {
        let mut line = String::new();
        
        // ãƒ¬ãƒ¼ãƒ³ã”ã¨ã«æç”»
        for lane_idx in 0..=commit.lane {
            if lane_idx == commit.lane {
                line.push_str("* ");
            } else {
                line.push_str("â”‚ ");
            }
        }
        
        // ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        line.push_str(&commit.message);
        
        // ãƒ–ãƒ©ãƒ³ãƒå
        if !commit.refs.is_empty() {
            line.push_str(&format!(" ({})", commit.refs.join(", ")));
        }
        
        line
    }
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_load_git_history() {
        // Gitå±¥æ­´èª­ã¿è¾¼ã¿
    }

    #[test]
    fn test_assign_lanes() {
        // ãƒ¬ãƒ¼ãƒ³å‰²ã‚Šå½“ã¦
    }

    #[test]
    fn test_render_graph() {
        // ã‚°ãƒ©ãƒ•æç”»
    }
}
```

## ğŸ”— å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### KAMUI 4Då®Ÿè£…

```javascript
// docs/git-worktree-task-system-design.md
git log --all --oneline --pretty=format:"%H|%s|%an|%ct|%P|%D" -n 100
git worktree list --porcelain
```

## ğŸ“Š æˆåŠŸæ¡ä»¶

- [ ] `miyabi git-graph` ã§Gitå±¥æ­´ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] è¤‡æ•°ãƒ–ãƒ©ãƒ³ãƒãŒçµ±åˆè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ¬ãƒ¼ãƒ³åˆ†ã‘ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] ã‚³ãƒŸãƒƒãƒˆè©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

## ğŸ”„ Dependencies

- **Depends on**: #616 (TUIåŸºç›¤)

---

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

### 3. Add tests for #617

- **ID**: `task-617-test`
- **Type**: Test
- **Assigned Agent**: CodeGenAgent
- **Priority**: 2
- **Estimated Duration**: 15 min
- **Dependencies**: task-617-impl

**Description**: Create comprehensive test coverage

### 4. Review code quality for #617

- **ID**: `task-617-review`
- **Type**: Refactor
- **Assigned Agent**: ReviewAgent
- **Priority**: 3
- **Estimated Duration**: 10 min
- **Dependencies**: task-617-test

**Description**: Run quality checks and code review

## ğŸ”„ Execution Plan (DAG Levels)

Tasks can be executed in parallel within each level:

### Level 0 (Parallel Execution)

- `task-617-analysis` - Analyze requirements for #617

### Level 1 (Parallel Execution)

- `task-617-impl` - Implement solution for #617

### Level 2 (Parallel Execution)

- `task-617-test` - Add tests for #617

### Level 3 (Parallel Execution)

- `task-617-review` - Review code quality for #617

## ğŸ“Š Dependency Graph

```mermaid
graph TD
    task_617_analysis["Analyze requirements for #617"]
    task_617_impl["Implement solution for #617"]
    task_617_test["Add tests for #617"]
    task_617_review["Review code quality for #617"]
    task_617_analysis --> task_617_impl
    task_617_impl --> task_617_test
    task_617_test --> task_617_review
```

## â±ï¸ Timeline Estimation

- **Sequential Execution**: 60 minutes (1.0 hours)
- **Parallel Execution (Critical Path)**: 10 minutes (0.2 hours)
- **Estimated Speedup**: 6.0x

---

*Generated by CoordinatorAgent on 2025-11-01 10:42:17 UTC*
