# Autopilot Plan Schema
# Version: 1.0.0
# Purpose: Codex/Claude Codeç„¡äººå®Ÿè¡Œãƒ—ãƒ©ãƒ³å®šç¾©
# Reference: miyabi_def/variables/workflows.yaml

autopilot:
  # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  version: "1.0.0"
  issue_number: 646  # GitHub Issueç•ªå·
  title: "Initial Setup Wizard - Welcome Screen"
  created_at: "2025-10-31T22:00:00+09:00"

  # å®Ÿè¡Œè¨­å®š
  execution:
    mode: "full-auto"  # full-auto | semi-auto | dry-run
    timeout: 3600  # ç§’å˜ä½ï¼ˆ1æ™‚é–“ï¼‰
    max_retries: 3
    abort_on_failure: true

  # Worktreeè¨­å®š
  worktree:
    enabled: true
    branch_prefix: "autopilot/issue-"
    cleanup_on_success: true
    cleanup_on_failure: false  # å¤±æ•—æ™‚ã¯ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚æ®‹ã™

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  security:
    mask_secrets: true
    allowed_env_vars:
      - "GITHUB_TOKEN"
      - "ANTHROPIC_API_KEY"
      - "DEVICE_IDENTIFIER"
    block_network: false  # LLMä½¿ç”¨æ™‚ã¯false
    sandbox_mode: false

  # ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆmiyabi_def/variables/workflows.yamlå½¢å¼ã‚’è¸è¥²ï¼‰
  steps:
    - id: "step-1"
      name: "ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
      type: "setup"
      commands:
        - "cargo build --release"
        - "pnpm install"
      expectations:
        - type: "exit_code"
          value: 0
        - type: "file_exists"
          value: "target/release/miyabi"
      rollback:
        - "cargo clean"
      on_failure: "abort"

    - id: "step-2"
      name: "Codexå®Ÿè¡Œ - Welcomeç”»é¢å®Ÿè£…"
      type: "codex_exec"
      commands:
        - "codex exec --full-auto --prompt 'Implement Welcome screen component for miyabi-desktop setup wizard'"
      expectations:
        - type: "file_exists"
          value: "miyabi-desktop/src/components/WelcomeScreen.tsx"
        - type: "contains"
          file: "miyabi-desktop/src/components/WelcomeScreen.tsx"
          value: "export default function WelcomeScreen"
      post_commands:
        - "pnpm typecheck"
        - "pnpm lint"
      on_failure: "retry"

    - id: "step-3"
      name: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
      type: "test"
      commands:
        - "pnpm test --run"
        - "cargo test --all"
      expectations:
        - type: "exit_code"
          value: 0
        - type: "output_contains"
          value: "test result: ok"
      on_failure: "report"

    - id: "step-4"
      name: "ã‚³ãƒ¼ãƒ‰æ•´å½¢"
      type: "format"
      commands:
        - "cargo fmt"
        - "pnpm format"
      expectations:
        - type: "exit_code"
          value: 0
      on_failure: "continue"

    - id: "step-5"
      name: "PRä½œæˆ"
      type: "git"
      commands:
        - "git add ."
        - "git commit -m 'feat(miyabi-desktop): implement Welcome screen for setup wizard\n\nCloses #646\n\nğŸ¤– Generated with Autopilot Codex'"
        - "git push -u origin HEAD"
        - "gh pr create --title 'feat(miyabi-desktop): Welcome screen' --body 'Implements #646\n\n## Changes\n- Add WelcomeScreen component\n- Add setup wizard routing\n\n## Tests\n- âœ… TypeScript checks pass\n- âœ… All tests pass\n\nğŸ¤– Generated with Autopilot Codex'"
      expectations:
        - type: "exit_code"
          value: 0
        - type: "output_contains"
          value: "https://github.com"
      on_failure: "report"

  # ãƒ­ã‚°è¨­å®š
  logging:
    level: "info"  # debug | info | warn | error
    output_dir: ".ai/logs/codex/autopilot"
    format: "json"  # json | text
    capture_stdout: true
    capture_stderr: true

  # é€šçŸ¥è¨­å®š
  notifications:
    on_success:
      - type: "github_comment"
        template: |
          ## âœ… Autopilotå®Ÿè¡Œå®Œäº†

          **Issue**: #{{issue_number}}
          **Duration**: {{duration}}
          **Steps**: {{completed_steps}}/{{total_steps}}

          ### å®Ÿè¡Œãƒ­ã‚°
          - [è©³ç´°ãƒ­ã‚°]({{log_url}})
          - [ã‚µãƒãƒªãƒ¼]({{summary_url}})

          ğŸ¤– Generated with Autopilot Codex

    on_failure:
      - type: "github_comment"
        template: |
          ## âŒ Autopilotå®Ÿè¡Œå¤±æ•—

          **Issue**: #{{issue_number}}
          **Failed at**: {{failed_step}}
          **Error**: {{error_message}}

          ### ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
          ```
          {{error_log}}
          ```

          ### å¯¾å¿œãŒå¿…è¦ã§ã™
          - Worktreeã¯ä¿æŒã•ã‚Œã¦ã„ã¾ã™: {{worktree_path}}
          - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°: {{log_path}}

          ğŸ¤– Generated with Autopilot Codex

      - type: "escalation"
        target: "TechLead"

  # ç›£æŸ»è¨­å®š
  audit:
    enabled: true
    check_worktree_cleanup: true
    validate_logs: true
    summary_required: true
