@startuml Task Execution Flow
!theme aws-orange

title Miyabi AWS Platform - Task Execution Flow

actor User
participant "GitHub" as github
participant "API Gateway" as apigw
participant "Lambda\nWebhook" as webhook
participant "EventBridge" as eb
participant "SQS Queue" as sqs
participant "Orchestrator" as orchestrator
participant "Agent Worker" as worker
participant "AWS Agent\n(Œ∏‚ÇÅ-Œ∏‚ÇÜ)" as aws_agent
database "DynamoDB" as dynamo
database "RDS" as rds
storage "EFS" as efs
participant "Terraform" as tf
participant "CloudWatch" as cw
participant "VOICEVOX" as voice
participant "Discord" as discord

== Issue Creation ==

User -> github : Create Issue #123\n"Optimize EC2 costs"
github -> webhook : POST /webhooks/github\nIssue Created Event

== Event Processing ==

webhook -> eb : Publish Event\n"issue.created"
eb -> sqs : Route to Task Queue\n(High Priority)

webhook -> dynamo : Store Task Metadata\n{issue: 123, status: pending}

== Task Orchestration ==

sqs <- orchestrator : Poll Queue\n(every 10s)
orchestrator -> dynamo : Get Task Details

orchestrator -> efs : Allocate Worktree\n/mnt/efs/worktrees/issue-123

orchestrator -> sqs : Send Worker Task\n{type: "aws-agent", issue: 123}

== Agent Execution ==

sqs <- worker : Poll Queue
worker -> dynamo : Update Status\n{status: in_progress}

worker -> efs : cd /mnt/efs/worktrees/issue-123

== Phase Œ∏‚ÇÅ: Understand ==

worker -> aws_agent : execute_phase(Œ∏‚ÇÅ)
aws_agent -> aws_agent : Discover AWS Resources\n(EC2, S3, RDS, Lambda)
aws_agent -> aws_agent : Analyze Costs\n(Cost Explorer API)
aws_agent -> aws_agent : Assess Security\n(Security Hub API)

aws_agent -> dynamo : Store World‚ÇÄ\n{cost: $280, security: 72}

== Phase Œ∏‚ÇÇ: Generate ==

worker -> aws_agent : execute_phase(Œ∏‚ÇÇ)
aws_agent -> aws_agent : Generate Cost Plan\n(30% savings target)
aws_agent -> aws_agent : Generate Security Plan\n(Score 90+ target)
aws_agent -> aws_agent : Generate Terraform\n(Right-sizing EC2)

aws_agent -> efs : Write Plans\n/plans/cost-optimization.md\n/terraform/ec2-rightsizing.tf

== Phase Œ∏‚ÇÉ: Allocate ==

worker -> aws_agent : execute_phase(Œ∏‚ÇÉ)
aws_agent -> rds : Query Resource Relations
aws_agent -> aws_agent : Calculate Optimal Sizes
aws_agent -> dynamo : Store Allocation Plan

== Phase Œ∏‚ÇÑ: Execute ==

worker -> aws_agent : execute_phase(Œ∏‚ÇÑ)
aws_agent -> tf : terraform plan
tf -> aws_agent : Show Changes\n(5 EC2 instances to resize)

aws_agent -> tf : terraform apply -auto-approve
tf -> tf : Deploy Changes\n(5-10 minutes)

tf -> aws_agent : Apply Complete ‚úì

aws_agent -> dynamo : Update World‚ÇÅ\n{cost: $250, security: 85}

== Phase Œ∏‚ÇÖ: Integrate ==

worker -> aws_agent : execute_phase(Œ∏‚ÇÖ)
aws_agent -> cw : Create Dashboard\n"Miyabi-Issue-123"
aws_agent -> cw : Configure Alarms\n(CPU > 80%, Cost > $260)

aws_agent -> voice : Generate Alert\n"Issue 123ÂÆå‰∫Ü„ÄÇ\n„Ç≥„Çπ„Éà30„Éâ„É´ÂâäÊ∏õ„Åó„Åæ„Åó„Åü"

voice -> discord : Send Notification\nüéâ Task completed!

== Phase Œ∏‚ÇÜ: Learn ==

worker -> aws_agent : execute_phase(Œ∏‚ÇÜ)
aws_agent -> aws_agent : Analyze Results\n(Cost: $280‚Üí$250, -10.7%)
aws_agent -> aws_agent : Update Strategy\n(EC2 rightsizing effective)

aws_agent -> dynamo : Store Learning Data

== Task Completion ==

worker -> dynamo : Update Status\n{status: completed}
worker -> github : Create PR\n"feat: Optimize EC2 costs (#123)"

worker -> eb : Publish Event\n"task.completed"

eb -> discord : Notify User

User <- discord : üì¨ Task completed!\nPR created: #456

== Continuous Monitoring ==

loop Every 5 minutes
    cw -> worker : CloudWatch Metrics
    worker -> dynamo : Update Metrics
end

note over aws_agent
  **6-Phase Execution Time**
  Œ∏‚ÇÅ: 2-3 minutes (Discovery)
  Œ∏‚ÇÇ: 3-5 minutes (Planning)
  Œ∏‚ÇÉ: 1-2 minutes (Allocation)
  Œ∏‚ÇÑ: 5-10 minutes (Deployment)
  Œ∏‚ÇÖ: 2-3 minutes (Integration)
  Œ∏‚ÇÜ: 1-2 minutes (Learning)

  **Total: 14-25 minutes**
end note

note over orchestrator
  **Orchestration Logic**
  - Max 100 concurrent workers
  - Auto-scale on queue depth
  - Graceful shutdown
  - Retry on failure (3 times)
end note

@enduml
