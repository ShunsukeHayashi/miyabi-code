@startuml State-Transitions
' çŠ¶æ…‹é·ç§»å›³: Miyabiå…¨ä½“ã®çŠ¶æ…‹ç®¡ç†

skinparam state {
  BackgroundColor<<Issue>> LightBlue
  BackgroundColor<<Agent>> LightGreen
  BackgroundColor<<Task>> LightYellow
  BackgroundColor<<Worktree>> LightCoral
  BackgroundColor<<PR>> LightCyan
  BackgroundColor<<Codex>> LightGoldenRodYellow
}

title **Miyabi - State Transition Diagram**\nå®Œå…¨è‡ªå¾‹å‹é–‹ç™ºãƒ•ãƒ­ãƒ¼ã®çŠ¶æ…‹ç®¡ç†

' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
' Issue State Machine
' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

state "Issue Lifecycle" as IssueLifecycle <<Issue>> {
  [*] --> Open : Issueä½œæˆ

  Open --> Triaged : Labelè‡ªå‹•æ¨è«–\n(IssueAgent)

  Triaged --> Assigned : Agentå‰²å½“\n(Orchestrator)

  Assigned --> InProgress : Agenté–‹å§‹

  InProgress --> Blocked : ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
  Blocked --> InProgress : è§£æ±º

  InProgress --> Review : Codeå®Œæˆ\nPRä½œæˆ

  Review --> Changes : ä¿®æ­£è¦æ±‚
  Changes --> Review : ä¿®æ­£å®Œäº†

  Review --> Approved : Reviewæ‰¿èª

  Approved --> Merged : PR Merge

  Merged --> Closed : Issueå®Œäº†

  Closed --> [*]

  Open --> Closed : é‡è¤‡/ç„¡åŠ¹
  Triaged --> Closed : ã‚­ãƒ£ãƒ³ã‚»ãƒ«
}

note right of IssueLifecycle
  **Issue Labels (57ä½“ç³»)**
  - feature/*, bug/*, refactor/*
  - priority/p0-p4
  - size/xs-xl
  - status/*
  - agent/*
  - org/*
end note

' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
' Agent State Machine
' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

state "Agent Lifecycle" as AgentLifecycle <<Agent>> {
  [*] --> Idle : Agentèµ·å‹•

  Idle --> Initializing : Taskå‰²å½“

  Initializing --> Ready : Contextèª­è¾¼å®Œäº†\nWorktreeä½œæˆ

  Ready --> Running : Taskå®Ÿè¡Œé–‹å§‹

  Running --> Waiting : ä¾å­˜å¾…ã¡\n(ä»–Agent)
  Waiting --> Running : ä¾å­˜è§£æ±º

  Running --> Suspended : ä¸­æ–­è¦æ±‚
  Suspended --> Running : å†é–‹

  Running --> Completed : æˆåŠŸ
  Running --> Failed : ã‚¨ãƒ©ãƒ¼

  Failed --> Retry : è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤\n(< 3å›)
  Retry --> Running

  Failed --> Escalated : æ‰‹å‹•ä»‹å…¥å¿…è¦
  Escalated --> Running : å•é¡Œè§£æ±º

  Completed --> Idle : æ¬¡Taskå¾…æ©Ÿ
  Failed --> Idle : ãƒªã‚»ãƒƒãƒˆ

  Idle --> [*] : Agentåœæ­¢
}

note right of AgentLifecycle
  **21 Agents**
  - Coding: 7 (CodeGen, Review, etc.)
  - Business: 14 (Marketing, Sales, etc.)

  **State Triggers**
  - tmux send-keys (Agenté–“é€šä¿¡)
  - GitHub webhook (Issue/PR events)
  - Timer (Refresher Agent)
end note

' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
' Task State Machine
' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

state "Task Lifecycle" as TaskLifecycle <<Task>> {
  [*] --> Pending : Taskç”Ÿæˆ

  Pending --> Queued : Queueè¿½åŠ 

  Queued --> Scheduled : Codexå‰²å½“\n(MUGEN/MAJIN)

  Scheduled --> Running : å®Ÿè¡Œé–‹å§‹

  Running --> Testing : Codeç”Ÿæˆå®Œäº†

  Testing --> Success : Testé€šé\n(cargo test)
  Testing --> Failed : Testå¤±æ•—

  Failed --> Debugging : ã‚¨ãƒ©ãƒ¼è§£æ
  Debugging --> Running : ä¿®æ­£å®Ÿè¡Œ

  Success --> Validated : Linté€šé\n(cargo clippy)
  Validated --> Failed : Lint Error

  Validated --> Completed : å…¨æ¤œè¨¼å®Œäº†

  Completed --> [*]
  Failed --> [*] : è«¦ã‚
}

note right of TaskLifecycle
  **Task Types**
  - Coding Task (Heavy â†’ MUGEN)
  - Issue/PR Task (Light â†’ MAJIN)
  - Business Task (Very Heavy â†’ MUGEN)

  **Parallel Execution**
  - Phase 1: 18 Codex (12+6)
  - Phase 2: 100 Codex
  - Phase 3: 200 Codex
end note

' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
' Worktree State Machine
' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

state "Worktree Lifecycle" as WorktreeLifecycle <<Worktree>> {
  [*] --> Creating : git worktree add

  Creating --> Active : Branchä½œæˆå®Œäº†

  Active --> Clean : å¤‰æ›´ãªã—
  Active --> Dirty : ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´

  Dirty --> Staged : git add

  Staged --> Committed : git commit

  Committed --> Pushed : git push

  Pushed --> PRCreated : gh pr create

  PRCreated --> Merged : PR merge

  Merged --> Removing : Cleanupé–‹å§‹

  Removing --> Removed : git worktree remove

  Removed --> [*]

  Active --> Removing : Taskå¤±æ•—\nCleanup
  Dirty --> Removing : Abort
  Staged --> Removing : Cancel
}

note right of WorktreeLifecycle
  **Worktree Strategy**
  - 1 Issue = 1 Worktree
  - ä¸¦åˆ—é–‹ç™ºã®åˆ†é›¢
  - è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

  **Worktree Locations**
  .worktrees/
  â”œâ”€â”€ issue-123/
  â”œâ”€â”€ issue-456/
  â””â”€â”€ phase1-18-codex-setup/
end note

' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
' PR State Machine
' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

state "PR Lifecycle" as PRLifecycle <<PR>> {
  [*] --> Draft : gh pr create --draft

  Draft --> Open : Ready for Review

  Open --> CI_Running : GitHub Actionsèµ·å‹•

  CI_Running --> CI_Failed : Testå¤±æ•—
  CI_Failed --> FixingCI : ä¿®æ­£Push
  FixingCI --> CI_Running

  CI_Running --> CI_Passed : TestæˆåŠŸ

  CI_Passed --> InReview : Reviewerå‰²å½“

  InReview --> ChangesRequested : ä¿®æ­£ä¾é ¼
  ChangesRequested --> Updating : ä¿®æ­£å®Ÿæ–½
  Updating --> InReview : Re-review

  InReview --> Approved : Reviewæ‰¿èª

  Approved --> Mergeable : Mergeå¯èƒ½

  Mergeable --> Merged : Squash & Merge

  Merged --> [*]

  Open --> Closed : PR Close\n(no merge)
  InReview --> Closed

  Closed --> [*]
}

note right of PRLifecycle
  **PR Conventions**
  - Conventional Commitså½¢å¼
  - Draft â†’ Open â†’ Merge
  - è‡ªå‹•CI/CD (GitHub Actions)
  - Self-hosted runners (MUGEN/MAJIN)

  **PR Template**
  ## Summary
  - 3 bullet points

  ## Test Plan
  - Checklist

  ğŸ¤– Generated with Claude Code
end note

' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
' Codex State Machine (New for 18-Codex Architecture)
' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

state "Codex Instance Lifecycle" as CodexLifecycle <<Codex>> {
  [*] --> Booting : npm install -g @openai/codex

  Booting --> Configured : API Keyè¨­å®š

  Configured --> Idle : tmux windowèµ·å‹•

  Idle --> Loading : Task fileèª­è¾¼

  Loading --> Executing : codex --stdinå®Ÿè¡Œ

  Executing --> API_Call : OpenAI API Request

  API_Call --> Rate_Limited : 429 Error
  Rate_Limited --> Waiting : Backoff
  Waiting --> API_Call : Retry

  API_Call --> Generating : Responseå—ä¿¡

  Generating --> Completed : Codeç”Ÿæˆå®Œäº†
  Generating --> Error : API Error

  Error --> Retry_Task : < 3å›
  Retry_Task --> Loading

  Error --> Failed_Task : >= 3å›

  Completed --> Idle : æ¬¡Taskå¾…æ©Ÿ
  Failed_Task --> Idle

  Idle --> Shutdown : Sessionçµ‚äº†
  Shutdown --> [*]
}

note right of CodexLifecycle
  **18 Codex Instances**
  - MUGEN: Codex 1-12 (12ä¸¦åˆ—)
  - MAJIN: Codex 13-18 (6ä¸¦åˆ—)

  **Monitoring**
  - CPUä½¿ç”¨ç‡ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ 
  - Memoryä½¿ç”¨é‡
  - API Rate Limitæ®‹
  - Taskå®Œäº†æ•°/å¤±æ•—æ•°
end note

' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
' Cross-State Interactions (è¤‡åˆçŠ¶æ…‹é·ç§»)
' â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

IssueLifecycle --> AgentLifecycle : Assign
AgentLifecycle --> TaskLifecycle : Generate Tasks
TaskLifecycle --> WorktreeLifecycle : Create Worktree
TaskLifecycle --> CodexLifecycle : Codexå®Ÿè¡Œ
WorktreeLifecycle --> PRLifecycle : Create PR
PRLifecycle --> IssueLifecycle : Close Issue

note bottom
  **çŠ¶æ…‹é·ç§»ã®é€£é–**
  Issueä½œæˆ â†’ Agentå‰²å½“ â†’ Taskç”Ÿæˆ â†’ Codexå®Ÿè¡Œ â†’ Codeç”Ÿæˆ â†’ Worktreeç®¡ç† â†’ PRä½œæˆ â†’ Merge â†’ Issueå®Œäº†

  **è‡ªå¾‹çš„åˆ¶å¾¡**
  å…¨ã¦ã®çŠ¶æ…‹é·ç§»ã¯è‡ªå‹•åŒ–ã•ã‚Œã¦ãŠã‚Šã€äººé–“ã®ä»‹å…¥ã¯æœ€å°é™ï¼ˆReview/Approve ã®ã¿ï¼‰
end note

@enduml
