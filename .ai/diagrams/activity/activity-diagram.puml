@startuml Activity-Diagram
' ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å›³: Miyabi å®Œå…¨è‡ªå¾‹å‹é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

title **Miyabi - Activity Diagram**\nå®Œå…¨è‡ªå¾‹å‹é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (Issue â†’ Code â†’ PR â†’ Merge)

|Developer|
start
:Create GitHub Issue;
note right
  **Issueä½œæˆ**
  - Title
  - Body (è©³ç´°èª¬æ˜)
  - Labels (57ä½“ç³»ã‹ã‚‰é¸æŠ)
  - Assignee (optional)
end note

|GitHub|
:Receive Issue Event;
:Trigger Webhook;

|Master Orchestrator\n(Local PC)|
:Receive Webhook Notification;
:Verify Webhook Signature;

if (Signature Valid?) then (yes)
  :Parse Issue Data;
  note right
    **Issueè§£æ**
    - Issue Number
    - Title, Body
    - Labels
    - Priority (p0-p4)
    - Size (xs-xl)
  end note
else (no)
  :Reject Request;
  stop
endif

:Select Appropriate Agent;
note right
  **Agenté¸æŠãƒ­ã‚¸ãƒƒã‚¯**
  - feature/* â†’ CodeGenAgent
  - bug/* â†’ ReviewAgent
  - refactor/* â†’ CodeGenAgent
  - docs/* â†’ DocumentationAgent
  - test/* â†’ TestAgent
  - business/* â†’ Business Agents (14ç¨®)
end note

|tmux Orchestra|
:Start tmux Session;
:Launch Agent Panes;
partition "Water Spider Monitoring" {
  :Monitor Agent Status;
  :Track Task Progress;
}

|Coordinator Agent|
:Analyze Task Complexity;

if (Heavy Task?) then (yes)
  |Codex Control|
  :Route to MUGEN\n(12 Codex);

  |MUGEN Sub-Orchestrator|
  :Create tmux: mugen-codex;
  partition "12ä¸¦åˆ—å®Ÿè¡Œ" {
    fork
      :Codex-1: Execute Task;
    fork again
      :Codex-2: Execute Task;
    fork again
      :Codex-3: Execute Task;
    fork again
      :Codex-4 to 12: Execute Tasks;
    end fork
  }
else (no - Light Task)
  |Codex Control|
  :Route to MAJIN\n(6 Codex);

  |MAJIN Sub-Orchestrator|
  :Create tmux: majin-codex;
  partition "6ä¸¦åˆ—å®Ÿè¡Œ" {
    fork
      :Codex-13: Execute Task;
    fork again
      :Codex-14: Execute Task;
    fork again
      :Codex-15 to 18: Execute Tasks;
    end fork
  }
endif

|Codex Instances|
:Read Task File (.md);
:Send to OpenAI API;

|OpenAI API|
:GPT-5 / o3 Processing;
if (Rate Limited?) then (yes)
  :Wait (Exponential Backoff);
  :Retry Request;
else (no)
  :Generate Response;
endif

|Agent Layer|
:Receive Generated Code;
:Apply Agent Logic;

partition "Agent Execution (21ç¨®)" {
  if (Agent Type?) then (Coding)
    :CodeGenAgent\nReviewAgent\nDeploymentAgent\netc.;
  else (Business)
    :SelfAnalysisAgent\nMarketResearchAgent\nPersonaAgent\netc.;
  endif
}

|Framework Layer|
:Use Miyabi Framework;
partition "Framework Components" {
  :miyabi-core;
  :miyabi-llm;
  :miyabi-github;
  :miyabi-worktree;
  :miyabi-knowledge;
  :etc. (15+ crates);
}

|Knowledge Base|
:Search Relevant Context;
partition "Knowledge Search" {
  :Qdrant Vector Search;
  :Context7 Library Docs;
  :Potpie Code Context;
}
:Retrieve Contextual Info;

|Git Worktree|
:Create Worktree;
:Checkout Branch;
note right
  **Worktree Strategy**
  - 1 Issue = 1 Worktree
  - Branch: issue-{number}
  - Location: .worktrees/issue-{number}/
end note

|Agent|
:Write Code to Worktree;
:Run Tests (cargo test);

if (Tests Pass?) then (yes)
  :Run Linter (cargo clippy);

  if (Lint Pass?) then (yes)
    :Format Code (cargo fmt);
  else (no)
    :Fix Lint Errors;
    :Re-run Linter;
  endif
else (no)
  :Debug & Fix Errors;
  :Re-run Tests;
  backward :Run Tests (cargo test);
endif

:Git Add Files;
:Git Commit;
note right
  **Commit Format**
  (Conventional Commits)

  feat: Add new feature
  fix: Fix bug
  refactor: Refactor code
  docs: Update docs
  test: Add tests

  ğŸ¤– Generated with Claude Code
  Co-Authored-By: Claude <noreply@anthropic.com>
end note

:Git Push to Remote;

|PR Agent|
:Create Pull Request;
note right
  **PR Template**
  ## Summary
  - 3 bullet points

  ## Test Plan
  - Checklist of TODOs

  ğŸ¤– Generated with Claude Code
end note

|GitHub|
:Open Draft PR;
:Mark as Ready for Review;

|GitHub Actions|
:Trigger CI/CD;
partition "Self-hosted Runners" {
  fork
    |MUGEN Runner|
    :cargo test --all;
    :cargo clippy --all;
    :cargo build --release;
  fork again
    |MAJIN Runner|
    :cargo test;
    :cargo fmt --check;
  end fork
}

if (CI/CD Pass?) then (yes)
  :Report Success to PR;
else (no)
  :Report Failure to PR;
  |Agent|
  :Fix CI/CD Issues;
  backward :Git Push to Remote;
endif

|Communication Services|
:Send Notifications;
partition "Multi-channel Notification" {
  fork
    :Lark Webhook\nPush Notification;
  fork again
    :Discord Webhook\nChannel Message;
  fork again
    :Telegram Bot\nDirect Message;
  end fork
}

|VOICEVOX|
:Generate Audio Guide;
:Convert Git Commits to Speech;
note right
  **ã‚†ã£ãã‚ŠéŸ³å£°ã‚¬ã‚¤ãƒ‰**
  - Git commitsè§£æ
  - Text-to-Speechå¤‰æ›
  - .wav ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
end note

|Developer|
:Review PR;

if (Approve?) then (yes)
  :Approve PR;

  |GitHub|
  :Merge PR (Squash);
  :Close Issue;

  |Worktree Manager|
  :Cleanup Worktree;
  :Remove Branch;

  |Communication Services|
  :Send Completion Notification;
  note right
    **å®Œäº†é€šçŸ¥**
    "Issue #XXX ãŒå®Œäº†ã—ã¾ã—ãŸï¼
    PR #YYY ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚
    Total time: 10-30 minutes"
  end note

  |Developer|
  :Receive Notification;
  stop
else (no - Changes Requested)
  :Request Changes;

  |Agent|
  :Read Review Comments;
  :Make Requested Changes;
  backward :Write Code to Worktree;
endif

@enduml
