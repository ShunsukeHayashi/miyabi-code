name: Test Self-Hosted Runner

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-self-hosted.yml'

jobs:
  test-environment:
    name: Test Runner Environment
    runs-on: [self-hosted, macOS, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: System Information
        run: |
          echo "ðŸ–¥ï¸ SYSTEM INFORMATION"
          echo "===================="
          echo "OS: $(uname -s)"
          echo "Kernel: $(uname -r)"
          echo "Architecture: $(uname -m)"
          echo "Hostname: $(hostname)"
          echo ""

      - name: Runner Information
        run: |
          echo "ðŸƒ RUNNER INFORMATION"
          echo "====================="
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner Arch: $RUNNER_ARCH"
          echo "Runner Temp: $RUNNER_TEMP"
          echo "Runner Tool Cache: $RUNNER_TOOL_CACHE"
          echo ""

      - name: Check Node.js
        run: |
          echo "ðŸ“¦ NODE.JS"
          echo "=========="
          if command -v node &> /dev/null; then
            echo "âœ… Node.js installed"
            echo "Version: $(node --version)"
            echo "Path: $(which node)"
          else
            echo "âŒ Node.js not found"
          fi
          echo ""

      - name: Check pnpm
        run: |
          echo "ðŸ“¦ PNPM"
          echo "======="
          if command -v pnpm &> /dev/null; then
            echo "âœ… pnpm installed"
            echo "Version: $(pnpm --version)"
            echo "Path: $(which pnpm)"
          else
            echo "âŒ pnpm not found"
            echo "Installing pnpm globally..."
            npm install -g pnpm
            echo "Version: $(pnpm --version)"
          fi
          echo ""

      - name: Check Rust
        run: |
          echo "ðŸ¦€ RUST"
          echo "======="
          if command -v cargo &> /dev/null; then
            echo "âœ… Rust installed"
            echo "rustc: $(rustc --version)"
            echo "cargo: $(cargo --version)"
            echo "Path: $(which cargo)"
          else
            echo "âŒ Rust not found"
          fi
          echo ""

      - name: Check Git
        run: |
          echo "ðŸ”§ GIT"
          echo "======"
          if command -v git &> /dev/null; then
            echo "âœ… Git installed"
            echo "Version: $(git --version)"
            echo "Path: $(which git)"
          else
            echo "âŒ Git not found"
          fi
          echo ""

      - name: Check Disk Space
        run: |
          echo "ðŸ’¾ DISK SPACE"
          echo "============="
          df -h
          echo ""

      - name: Check Memory
        run: |
          echo "ðŸ§  MEMORY"
          echo "========="
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            vm_stat
          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            free -h
          fi
          echo ""

      - name: Test pnpm & Node.js Setup
        uses: ./.github/actions/setup-pnpm

      - name: Verify pnpm installation
        run: |
          echo "âœ… VERIFICATION"
          echo "==============="
          pnpm --version
          node --version
          echo ""
          echo "âœ… All checks passed!"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Runner Type" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: $RUNNER_OS" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner**: Self-hosted (macOS ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Node.js: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… pnpm: $(pnpm --version)" >> $GITHUB_STEP_SUMMARY
          if command -v cargo &> /dev/null; then
            echo "- âœ… Rust: $(cargo --version)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: All systems operational âœ…" >> $GITHUB_STEP_SUMMARY
