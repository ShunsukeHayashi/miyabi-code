name: Codex Miyabi Smoke

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'crates/codex-miyabi/**'
      - 'crates/miyabi-integration/**'
      - 'scripts/smoke-codex-miyabi.sh'
      - 'docs/schemas/**'
      - 'README.md'
      - '.github/workflows/codex-miyabi-smoke.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'crates/codex-miyabi/**'
      - 'crates/miyabi-integration/**'
      - 'scripts/smoke-codex-miyabi.sh'
      - 'docs/schemas/**'
      - 'README.md'
      - '.github/workflows/codex-miyabi-smoke.yml'

jobs:
  smoke:
    runs-on: [self-hosted, macOS, arm64, miyabi-light]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          cache-key-prefix: codex-miyabi-smoke

      - name: Setup sccache
        uses: ./.github/actions/setup-sccache
        with:
          cache-key-prefix: codex-miyabi-smoke

      - name: Install jq (macOS)
        run: brew install jq

      - name: Run smoke script
        run: |
          set -euxo pipefail
          mkdir -p artifacts/codex-miyabi/${{ runner.os }}
          chmod +x scripts/smoke-codex-miyabi.sh
          # capture JSON outputs for artifact
          cargo run -q -p codex-miyabi -- status --json | tee artifacts/codex-miyabi/${{ runner.os }}/status.json | jq -e '.ok == true' >/dev/null
          out=$(cargo run -q -p codex-miyabi -- agent run --type coordinator --json || true)
          echo "$out" | tee artifacts/codex-miyabi/${{ runner.os }}/agent_run.json | jq -e '.ok == false and (.error|ascii_downcase|contains("not implemented"))' >/dev/null
          cargo run -q -p codex-miyabi -- worktree list --json | tee artifacts/codex-miyabi/${{ runner.os }}/worktree_list.json | jq -e 'type == "array"' >/dev/null
          cargo run -q -p codex-miyabi -- worktree create --issue 270 --json | tee artifacts/codex-miyabi/${{ runner.os }}/worktree_create.json | jq -e '.ok == true and .issue == 270' >/dev/null
          cargo run -q -p codex-miyabi -- worktree cleanup --issue 270 --json | tee artifacts/codex-miyabi/${{ runner.os }}/worktree_cleanup.json | jq -e '.ok == true and .issue == 270' >/dev/null
          echo "[miyabi] smoke OK (${ { runner.os } })"

      - name: Upload JSON artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-miyabi-json-macOS
          path: artifacts/codex-miyabi/${{ runner.os }}

      - name: Show sccache statistics
        if: always()
        uses: ./.github/actions/sccache-stats
