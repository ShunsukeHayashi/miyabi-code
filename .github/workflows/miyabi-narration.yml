name: ðŸŽ¤ Miyabié–‹ç™ºé€²æ— - ã‚†ã£ãã‚Šè§£èª¬éŸ³å£°ã‚¬ã‚¤ãƒ‰è‡ªå‹•ç”Ÿæˆ

on:
  # Pushãƒˆãƒªã‚¬ãƒ¼ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒï¼‰
  push:
    branches:
      - main
    paths:
      - 'crates/**'
      - 'tools/**'
      - '.github/workflows/miyabi-narration.yml'

  # æ—¥æ¬¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆJST 18:00 = UTC 09:00ï¼‰
  schedule:
    - cron: '0 9 * * *'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      days:
        description: 'éŽåŽ»Næ—¥åˆ†ã®commitsã‚’åŽé›†'
        required: false
        default: '3'
        type: string

env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.9.5'

jobs:
  generate-narration:
    name: éŸ³å£°ã‚¬ã‚¤ãƒ‰ç”Ÿæˆ
    runs-on: [self-hosted, macOS, arm64, miyabi-light]

    permissions:
      contents: read

    steps:
      # =====================================================
      # Phase 1: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # =====================================================
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆgit logç”¨ï¼‰

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ” Verify uv installation
        run: uv --version

      # =====================================================
      # Phase 2: VOICEVOX Engine ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆDockerï¼‰
      # =====================================================
      - name: ðŸ³ Pull VOICEVOX Engine Docker Image
        run: |
          docker pull voicevox/voicevox_engine:cpu-latest

      - name: ðŸš€ Start VOICEVOX Engine (Background)
        run: |
          docker run -d \
            --name voicevox-engine \
            -p 127.0.0.1:50021:50021 \
            voicevox/voicevox_engine:cpu-latest

          echo "â³ Waiting for VOICEVOX Engine to start..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:50021/version > /dev/null; then
              echo "âœ… VOICEVOX Engine is ready!"
              break
            fi
            sleep 2
          done

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          curl -s http://127.0.0.1:50021/version | jq .

      # =====================================================
      # Phase 3: å°æœ¬ç”Ÿæˆ
      # =====================================================
      - name: ðŸ“ Generate Script from Git Commits
        working-directory: tools
        run: |
          DAYS="${{ github.event.inputs.days || '3' }}"
          echo "ðŸ“Š Collecting commits from last $DAYS days..."

          python3 yukkuri-narration-generator.py --days "$DAYS"

          echo "âœ… Script generation completed"
          cat script.md

      # =====================================================
      # Phase 4: éŸ³å£°åˆæˆ
      # =====================================================
      - name: ðŸŽ¤ Synthesize Audio with VOICEVOX
        working-directory: tools
        run: |
          echo "ðŸŽ™ï¸ Starting audio synthesis..."

          # Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install requests

          python3 voicevox-synthesizer.py

          echo "âœ… Audio synthesis completed"
          ls -lh audio/

      # =====================================================
      # Phase 5: æˆæžœç‰©ã®æ•´ç†
      # =====================================================
      - name: ðŸ“¦ Organize Output
        working-directory: tools
        run: |
          mkdir -p narration-output
          mv script.md narration-output/
          mv voicevox_requests.json narration-output/
          mv audio narration-output/

          # ã‚µãƒžãƒªãƒ¼ç”Ÿæˆ
          cat > narration-output/SUMMARY.md << EOF
          # ðŸŽ¤ Miyabié–‹ç™ºé€²æ—ãƒ¬ãƒãƒ¼ãƒˆ

          **ç”Ÿæˆæ—¥æ™‚**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **å¯¾è±¡æœŸé–“**: éŽåŽ»${{ github.event.inputs.days || '3' }}æ—¥åˆ†

          ## ðŸ“Š çµ±è¨ˆæƒ…å ±

          - **éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $(ls narration-output/audio/*.wav 2>/dev/null | wc -l)
          - **åˆè¨ˆã‚µã‚¤ã‚º**: $(du -sh narration-output/audio 2>/dev/null | cut -f1 || echo "N/A")
          - **Commitæ•°**: $(git log --oneline --since="${{ github.event.inputs.days || '3' }} days ago" | wc -l)

          ## ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

          \`\`\`
          $(ls -lh narration-output/)
          \`\`\`

          ## ðŸŽ¬ ç”Ÿæˆã•ã‚ŒãŸå°æœ¬

          \`\`\`markdown
          $(cat narration-output/script.md)
          \`\`\`
          EOF

          cat narration-output/SUMMARY.md

      # =====================================================
      # Phase 6: GitHub Artifactsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # =====================================================
      - name: ðŸ“¤ Upload Narration Output
        uses: actions/upload-artifact@v4
        with:
          name: miyabi-narration-${{ github.run_number }}
          path: tools/narration-output/
          retention-days: 30

      # =====================================================
      # Phase 7: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      # =====================================================
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker stop voicevox-engine || true
          docker rm voicevox-engine || true

      # =====================================================
      # Phase 8: é€šçŸ¥ï¼ˆæˆåŠŸï¼‰
      # =====================================================
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "::notice title=ðŸŽ‰ Narration Generated::éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚"

      # =====================================================
      # Phase 9: é€šçŸ¥ï¼ˆå¤±æ•—ï¼‰
      # =====================================================
      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "::error title=âŒ Narration Failed::éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"

  # =====================================================
  # Job 2: ã‚µãƒžãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  # =====================================================
  post-summary:
    name: ã‚µãƒžãƒªãƒ¼æŠ•ç¨¿
    runs-on: [self-hosted, macOS, arm64, miyabi-light]
    needs: generate-narration
    if: success()

    steps:
      - name: ðŸ“ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: miyabi-narration-${{ github.run_number }}
          path: output

      - name: ðŸ“Š Create Summary
        run: |
          cat output/SUMMARY.md >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: [miyabi-narration-${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
