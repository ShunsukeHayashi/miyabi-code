name: ðŸ“Š Project Automation

# Unified Project Management workflow
# Replaces 5 separate workflows:
#   - project-sync.yml
#   - auto-add-to-project.yml
#   - project-pr-sync.yml
#   - update-project-status.yml
#   - project-update-fields.yml

on:
  issues:
    types: [opened, labeled, assigned, reopened, closed, edited, unlabeled]
  pull_request:
    types: [opened, ready_for_review, reopened, closed, review_requested, converted_to_draft]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue/PR number to update'
        required: false
        type: number

permissions:
  issues: write
  pull-requests: write
  repository-projects: write
  contents: read

jobs:
  # Job 1: Add Issues/PRs to Project
  add-to-project:
    runs-on: [self-hosted, macOS, arm64, miyabi-light]
    name: Add to Project
    if: github.event.action == 'opened'

    steps:
      - name: Add Issue/PR to Project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/ShunsukeHayashi/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Log Addition
        run: |
          echo "âœ… Added to Project"
          echo "   Type: ${{ github.event_name }}"
          echo "   Number: ${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "   Title: ${{ github.event.issue.title || github.event.pull_request.title }}"

  # Job 2: Update PR Status (for PRs only)
  update-pr-status:
    runs-on: [self-hosted, macOS, arm64, miyabi-light]
    name: Update PR Status
    if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review'

    steps:
      - name: Determine Status
        id: status
        run: |
          PR_STATE="${{ github.event.pull_request.state }}"
          PR_DRAFT="${{ github.event.pull_request.draft }}"
          EVENT_ACTION="${{ github.event.action }}"

          # Determine the target status
          if [ "$PR_STATE" == "closed" ] && [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            echo "status=Done" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          elif [ "$PR_STATE" == "closed" ]; then
            echo "status=Cancelled" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          elif [ "$PR_DRAFT" == "true" ]; then
            echo "status=In Progress" >> $GITHUB_OUTPUT
            echo "emoji=ðŸš§" >> $GITHUB_OUTPUT
          elif [ "$EVENT_ACTION" == "ready_for_review" ]; then
            echo "status=In Review" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ‘€" >> $GITHUB_OUTPUT
          elif [ "$PR_STATE" == "open" ]; then
            echo "status=In Progress" >> $GITHUB_OUTPUT
            echo "emoji=ðŸƒ" >> $GITHUB_OUTPUT
          else
            echo "status=Unknown" >> $GITHUB_OUTPUT
            echo "emoji=â“" >> $GITHUB_OUTPUT
          fi

      - name: Update Project Status via GraphQL
        uses: actions/github-script@v7
        env:
          PROJECT_NUMBER: 1
          GITHUB_OWNER: ${{ github.repository_owner }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectNumber = parseInt(process.env.PROJECT_NUMBER);
            const owner = process.env.GITHUB_OWNER;
            const prNumber = context.payload.pull_request.number;
            const targetStatus = '${{ steps.status.outputs.status }}';

            console.log(`ðŸ”„ Updating PR #${prNumber} status to: ${targetStatus}`);

            try {
              // Get Project ID and Status field ID
              const projectQuery = `
                query($owner: String!, $number: Int!) {
                  user(login: $owner) {
                    projectV2(number: $number) {
                      id
                      field(name: "Status") {
                        ... on ProjectV2SingleSelectField {
                          id
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectResult = await github.graphql(projectQuery, { owner, number: projectNumber });
              const projectId = projectResult.user.projectV2.id;
              const statusField = projectResult.user.projectV2.field;

              if (!statusField) {
                console.log('âš ï¸ Status field not found');
                return;
              }

              const statusOption = statusField.options.find(opt => opt.name === targetStatus);
              if (!statusOption) {
                console.log(`âš ï¸ Status option "${targetStatus}" not found`);
                return;
              }

              // Get PR's project item ID
              const prQuery = `
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    pullRequest(number: $number) {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project { id }
                        }
                      }
                    }
                  }
                }
              `;

              const prResult = await github.graphql(prQuery, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                number: prNumber
              });

              const projectItems = prResult.repository.pullRequest.projectItems.nodes;
              const projectItem = projectItems.find(item => item.project.id === projectId);

              if (!projectItem) {
                console.log('âš ï¸ PR not in project yet');
                return;
              }

              // Update status
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `;

              await github.graphql(updateMutation, {
                projectId,
                itemId: projectItem.id,
                fieldId: statusField.id,
                optionId: statusOption.id
              });

              console.log(`âœ… Updated PR #${prNumber} status to: ${targetStatus}`);

            } catch (error) {
              console.error('âŒ Failed to update project status:', error);
            }

  # Job 3: Update Custom Fields (for Issues and PRs)
  update-custom-fields:
    runs-on: [self-hosted, macOS, arm64, miyabi-light]
    name: Update Custom Fields
    if: |
      github.event.action == 'labeled' ||
      github.event.action == 'unlabeled' ||
      github.event.action == 'edited' ||
      github.event.action == 'closed' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Get Item Information
        id: info
        uses: actions/github-script@v7
        with:
          script: |
            const isIssue = context.eventName === 'issues' || context.payload.issue;
            const number = context.payload.issue?.number || context.payload.pull_request?.number || context.payload.inputs?.issue_number;

            let item;
            if (isIssue) {
              item = context.payload.issue || (await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number
              })).data;
            } else {
              item = context.payload.pull_request;
            }

            const labels = (item.labels || []).map(l => l.name);

            // Determine agent
            let agent = 'Unassigned';
            if (labels.some(l => l.includes('agent:coordinator'))) agent = 'CoordinatorAgent';
            else if (labels.some(l => l.includes('agent:codegen'))) agent = 'CodeGenAgent';
            else if (labels.some(l => l.includes('agent:review'))) agent = 'ReviewAgent';
            else if (labels.some(l => l.includes('agent:issue'))) agent = 'IssueAgent';
            else if (labels.some(l => l.includes('agent:pr'))) agent = 'PRAgent';
            else if (labels.some(l => l.includes('agent:deploy'))) agent = 'DeploymentAgent';

            // Determine priority
            let priority = 'P2-Medium';
            if (labels.some(l => l.includes('P0-Critical'))) priority = 'P0-Critical';
            else if (labels.some(l => l.includes('P1-High'))) priority = 'P1-High';
            else if (labels.some(l => l.includes('P3-Low'))) priority = 'P3-Low';

            // Determine state
            let state = 'Pending';
            if (labels.some(l => l.includes('state:analyzing'))) state = 'Analyzing';
            else if (labels.some(l => l.includes('state:implementing'))) state = 'Implementing';
            else if (labels.some(l => l.includes('state:reviewing'))) state = 'Reviewing';
            else if (labels.some(l => l.includes('state:done'))) state = 'Done';
            else if (labels.some(l => l.includes('state:blocked'))) state = 'Blocked';
            else if (item.state === 'closed') state = 'Done';

            core.setOutput('number', number);
            core.setOutput('agent', agent);
            core.setOutput('priority', priority);
            core.setOutput('state', state);

      - name: Log Field Updates
        run: |
          echo "ðŸ“Š Custom Fields Detected:"
          echo "   Number: ${{ steps.info.outputs.number }}"
          echo "   Agent: ${{ steps.info.outputs.agent }}"
          echo "   Priority: ${{ steps.info.outputs.priority }}"
          echo "   State: ${{ steps.info.outputs.state }}"
