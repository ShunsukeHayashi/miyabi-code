# ==============================================================================
# Miyabi Lambda CI/CD Pipeline
# ==============================================================================
#
# ÂåÖÊã¨ÁöÑ„Å™Lambda CI/CD„Éë„Ç§„Éó„É©„Ç§„É≥
# - Rust Lambda API (miyabi-web-api)
# - Python FastAPI Lambda (miyabi-app)
# - Ëá™Âãï„ÉÜ„Çπ„Éà„ÄÅ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≠„É£„É≥„ÄÅ„Éá„Éó„É≠„Ç§„É°„É≥„Éà
#
# Triggers:
#   - Push to main (Ëá™Âãï„Éá„Éó„É≠„Ç§)
#   - Pull Request (Ê§úË®º„ÅÆ„Åø)
#   - Manual dispatch (Á∑äÊÄ•„Éá„Éó„É≠„Ç§)
#
# ==============================================================================

name: Lambda CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'crates/miyabi-web-api/**'
      - 'openai-apps/miyabi-app/server/**'
      - '.github/workflows/lambda-ci-cd.yml'
      - 'deploy/terraform/**'

  pull_request:
    branches:
      - main
    paths:
      - 'crates/miyabi-web-api/**'
      - 'openai-apps/miyabi-app/server/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      skip_tests:
        description: 'Skip tests (emergency only)'
        type: boolean
        default: false
      deploy_rust:
        description: 'Deploy Rust Lambda'
        type: boolean
        default: true
      deploy_python:
        description: 'Deploy Python Lambda'
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always
  AWS_REGION: us-east-1
  RUST_LAMBDA_NAME: miyabi-api
  PYTHON_LAMBDA_NAME: miyabi-mcp-server

# ==============================================================================
# Jobs
# ==============================================================================

jobs:
  # ----------------------------------------------------------------------------
  # Job 1: Detect Changes
  # ----------------------------------------------------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust_changed: ${{ steps.filter.outputs.rust }}
      python_changed: ${{ steps.filter.outputs.python }}
      terraform_changed: ${{ steps.filter.outputs.terraform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'crates/miyabi-web-api/**'
            python:
              - 'openai-apps/miyabi-app/server/**'
            terraform:
              - 'deploy/terraform/**'

  # ----------------------------------------------------------------------------
  # Job 2: Test Rust Lambda
  # ----------------------------------------------------------------------------
  test-rust:
    name: Test Rust Lambda
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.rust_changed == 'true' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-rust-lambda-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-rust-lambda-

      - name: Check formatting
        run: cargo fmt --package miyabi-web-api -- --check

      - name: Run clippy
        run: cargo clippy --package miyabi-web-api --features lambda -- -D warnings

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: cargo test --package miyabi-web-api --lib --features lambda

      - name: Security audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # ----------------------------------------------------------------------------
  # Job 3: Test Python Lambda
  # ----------------------------------------------------------------------------
  test-python:
    name: Test Python Lambda
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.python_changed == 'true' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        working-directory: openai-apps/miyabi-app/server
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov black flake8 safety

      - name: Check formatting
        working-directory: openai-apps/miyabi-app/server
        run: black --check .

      - name: Lint
        working-directory: openai-apps/miyabi-app/server
        run: flake8 . --max-line-length=120 --extend-ignore=E203,W503

      - name: Security check
        working-directory: openai-apps/miyabi-app/server
        run: safety check -r requirements.txt || echo "::warning::Security vulnerabilities found"

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        working-directory: openai-apps/miyabi-app/server
        run: |
          if [ -d "tests" ]; then
            pytest tests/ --cov=. --cov-report=xml
          else
            echo "No tests directory found, skipping tests"
          fi

  # ----------------------------------------------------------------------------
  # Job 4: Build Rust Lambda
  # ----------------------------------------------------------------------------
  build-rust:
    name: Build Rust Lambda
    runs-on: ubuntu-latest
    needs: [detect-changes, test-rust]
    if: |
      always() &&
      (needs.detect-changes.outputs.rust_changed == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      (needs.test-rust.result == 'success' || needs.test-rust.result == 'skipped')
    outputs:
      artifact_name: ${{ steps.package.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-lambda
        uses: jaxxstorm/action-install-gh-release@v1.12.0
        with:
          repo: cargo-lambda/cargo-lambda
          platform: linux
          arch: x86_64

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-lambda-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Lambda (ARM64)
        run: |
          cargo lambda build \
            --release \
            --arm64 \
            --package miyabi-web-api \
            --bin lambda-api \
            --features lambda

      - name: Package Lambda
        id: package
        run: |
          mkdir -p dist/lambda
          cp target/lambda/lambda-api/bootstrap dist/lambda/
          cd dist/lambda
          zip -j rust-lambda.zip bootstrap

          ARTIFACT_NAME="rust-lambda-${{ github.sha }}-$(date +%Y%m%d%H%M%S)"
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact_name }}
          path: dist/lambda/rust-lambda.zip
          retention-days: 7

  # ----------------------------------------------------------------------------
  # Job 5: Build Python Lambda
  # ----------------------------------------------------------------------------
  build-python:
    name: Build Python Lambda
    runs-on: ubuntu-latest
    needs: [detect-changes, test-python]
    if: |
      always() &&
      (needs.detect-changes.outputs.python_changed == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      (needs.test-python.result == 'success' || needs.test-python.result == 'skipped')
    outputs:
      artifact_name: ${{ steps.package.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Package Lambda
        id: package
        run: |
          mkdir -p dist/lambda-python
          cd openai-apps/miyabi-app/server

          # Install dependencies to package directory
          pip install -r requirements.txt -t ../../../dist/lambda-python/

          # Copy source files
          cp -r *.py ../../../dist/lambda-python/

          # Create zip
          cd ../../../dist/lambda-python
          zip -r python-lambda.zip .

          ARTIFACT_NAME="python-lambda-${{ github.sha }}-$(date +%Y%m%d%H%M%S)"
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact_name }}
          path: dist/lambda-python/python-lambda.zip
          retention-days: 7

  # ----------------------------------------------------------------------------
  # Job 6: Deploy to AWS
  # ----------------------------------------------------------------------------
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [detect-changes, build-rust, build-python]
    if: |
      always() &&
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Deploy Rust Lambda
      - name: Download Rust Artifact
        if: |
          needs.build-rust.result == 'success' &&
          (inputs.deploy_rust != false)
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-rust.outputs.artifact_name }}
          path: dist/lambda/

      - name: Deploy Rust Lambda
        if: |
          needs.build-rust.result == 'success' &&
          (inputs.deploy_rust != false)
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          FUNCTION_NAME="${RUST_LAMBDA_NAME}-${ENV}"

          aws lambda update-function-code \
            --function-name ${FUNCTION_NAME} \
            --zip-file fileb://dist/lambda/rust-lambda.zip \
            --region ${{ env.AWS_REGION }}

          # Wait for update to complete
          aws lambda wait function-updated \
            --function-name ${FUNCTION_NAME} \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Rust Lambda deployed: ${FUNCTION_NAME}"

      # Deploy Python Lambda
      - name: Download Python Artifact
        if: |
          needs.build-python.result == 'success' &&
          (inputs.deploy_python != false)
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-python.outputs.artifact_name }}
          path: dist/lambda-python/

      - name: Deploy Python Lambda
        if: |
          needs.build-python.result == 'success' &&
          (inputs.deploy_python != false)
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          FUNCTION_NAME="${PYTHON_LAMBDA_NAME}-${ENV}"

          aws lambda update-function-code \
            --function-name ${FUNCTION_NAME} \
            --zip-file fileb://dist/lambda-python/python-lambda.zip \
            --region ${{ env.AWS_REGION }}

          # Wait for update to complete
          aws lambda wait function-updated \
            --function-name ${FUNCTION_NAME} \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Python Lambda deployed: ${FUNCTION_NAME}"

  # ----------------------------------------------------------------------------
  # Job 7: Health Check & Verification
  # ----------------------------------------------------------------------------
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Health Check Rust Lambda
        id: health-rust
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          FUNCTION_NAME="${RUST_LAMBDA_NAME}-${ENV}"

          # Get function URL or API Gateway endpoint
          # This is a placeholder - adjust based on your actual setup
          if aws lambda get-function --function-name ${FUNCTION_NAME} &>/dev/null; then
            echo "status=deployed" >> $GITHUB_OUTPUT

            # Invoke function for health check
            RESPONSE=$(aws lambda invoke \
              --function-name ${FUNCTION_NAME} \
              --payload '{"httpMethod":"GET","path":"/health"}' \
              --cli-binary-format raw-in-base64-out \
              /tmp/response.json 2>&1)

            if [ $? -eq 0 ]; then
              echo "‚úÖ Rust Lambda health check: OK"
              cat /tmp/response.json
            else
              echo "‚ö†Ô∏è Rust Lambda health check failed"
              echo "$RESPONSE"
            fi
          else
            echo "status=not_found" >> $GITHUB_OUTPUT
          fi

      - name: Health Check Python Lambda
        id: health-python
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          FUNCTION_NAME="${PYTHON_LAMBDA_NAME}-${ENV}"

          if aws lambda get-function --function-name ${FUNCTION_NAME} &>/dev/null; then
            echo "status=deployed" >> $GITHUB_OUTPUT

            # Invoke function for health check
            RESPONSE=$(aws lambda invoke \
              --function-name ${FUNCTION_NAME} \
              --payload '{}' \
              --cli-binary-format raw-in-base64-out \
              /tmp/response.json 2>&1)

            if [ $? -eq 0 ]; then
              echo "‚úÖ Python Lambda health check: OK"
              cat /tmp/response.json
            else
              echo "‚ö†Ô∏è Python Lambda health check failed"
              echo "$RESPONSE"
            fi
          else
            echo "status=not_found" >> $GITHUB_OUTPUT
          fi

  # ----------------------------------------------------------------------------
  # Job 8: Deployment Summary
  # ----------------------------------------------------------------------------
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-rust, build-python, deploy, verify]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# üöÄ Lambda CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Tests | ${{ needs.test-rust.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.test-python.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Build | ${{ needs.build-rust.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Build | ${{ needs.build-python.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment | ${{ needs.deploy.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verification | ${{ needs.verify.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rust Changed**: ${{ needs.detect-changes.outputs.rust_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Changed**: ${{ needs.detect-changes.outputs.python_changed }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Lambda functions have been successfully deployed to AWS." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi

  # ----------------------------------------------------------------------------
  # Job 9: Notify (Optional)
  # ----------------------------------------------------------------------------
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always() && (needs.deploy.result == 'success' || needs.deploy.result == 'failure')

    steps:
      - name: Notify Discord
        if: vars.DISCORD_WEBHOOK_URL
        run: |
          STATUS="${{ needs.deploy.result }}"
          if [ "$STATUS" == "success" ]; then
            COLOR="3066993"  # Green
            EMOJI="‚úÖ"
          else
            COLOR="15158332"  # Red
            EMOJI="‚ùå"
          fi

          curl -X POST "${{ vars.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"${EMOJI}"' Lambda Deployment '"${STATUS}"'",
                "description": "Environment: ${{ github.event.inputs.environment || 'dev' }}",
                "color": '"${COLOR}"',
                "fields": [
                  {
                    "name": "Commit",
                    "value": "${{ github.sha }}",
                    "inline": true
                  },
                  {
                    "name": "Actor",
                    "value": "${{ github.actor }}",
                    "inline": true
                  }
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'
