name: Daily Narration & YouTube Upload

on:
  schedule:
    # Run daily at 9:00 AM JST (00:00 UTC)
    - cron: '0 0 * * *'
  workflow_dispatch: # Manual trigger for testing

permissions:
  contents: read

jobs:
  narration:
    name: Generate Narration & Upload to YouTube
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 100 # Fetch last 100 commits for narration

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          cd tools
          pip3 install -r requirements.txt

      - name: Install system dependencies
        run: |
          brew install ffmpeg imagemagick

      - name: Setup VOICEVOX Engine (Mock Mode)
        id: voicevox
        run: |
          echo "ðŸ”§ Setting up VOICEVOX Engine..."

          # Clone VOICEVOX Engine
          git clone --depth 1 https://github.com/VOICEVOX/voicevox_engine.git ~/voicevox_engine
          cd ~/voicevox_engine

          # Install uv (Python package manager)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"

          # Install dependencies
          uv sync

          # Start engine in background (mock mode for CI)
          uv run run.py --enable_mock --host 127.0.0.1 --port 50021 &
          VOICEVOX_PID=$!
          echo "voicevox_pid=$VOICEVOX_PID" >> $GITHUB_OUTPUT

          # Wait for engine startup
          echo "â³ Waiting for VOICEVOX Engine to start..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:50021/version > /dev/null; then
              echo "âœ… VOICEVOX Engine started"
              break
            fi
            echo "   Attempt $i/30..."
            sleep 2
          done

          # Verify engine is running
          curl -s http://127.0.0.1:50021/version || exit 1

      - name: Generate narration
        id: narration
        env:
          DEVICE_IDENTIFIER: ${{ runner.name }}
        run: |
          cd tools

          echo "ðŸŽ¬ Generating narration..."
          ./miyabi-narrate.sh -d 1 -s -t -v

          # Set output variables
          VIDEO_PATH="./output/miyabi-progress.mp4"
          THUMBNAIL_PATH="./output/thumbnail.png"

          if [ -f "$VIDEO_PATH" ]; then
            echo "video_path=$VIDEO_PATH" >> $GITHUB_OUTPUT
            VIDEO_SIZE=$(du -h "$VIDEO_PATH" | cut -f1)
            echo "video_size=$VIDEO_SIZE" >> $GITHUB_OUTPUT
          else
            echo "âŒ Video file not found"
            exit 1
          fi

          if [ -f "$THUMBNAIL_PATH" ]; then
            echo "thumbnail_path=$THUMBNAIL_PATH" >> $GITHUB_OUTPUT
          fi

          # Count commits processed
          COMMIT_COUNT=$(git log --since="1 day ago" --oneline | wc -l | xargs)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          # Get video duration
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$VIDEO_PATH" 2>/dev/null || echo "0")
          DURATION_FORMATTED=$(printf "%02d:%02d" $((${DURATION%.*}/60)) $((${DURATION%.*}%60)))
          echo "duration=$DURATION_FORMATTED" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: narration-video-${{ github.run_number }}
          path: |
            tools/output/miyabi-progress.mp4
            tools/output/thumbnail.png
            tools/output/*.wav
          retention-days: 7

      - name: Authenticate with YouTube
        id: youtube_auth
        env:
          YOUTUBE_CREDENTIALS: ${{ secrets.YOUTUBE_CREDENTIALS }}
          YOUTUBE_TOKEN: ${{ secrets.YOUTUBE_TOKEN }}
        run: |
          cd tools

          # Save credentials from secrets
          echo "$YOUTUBE_CREDENTIALS" > credentials.json
          echo "$YOUTUBE_TOKEN" > token.json

          echo "âœ… YouTube credentials configured"

      - name: Upload to YouTube
        id: youtube_upload
        env:
          VIDEO_TITLE: "Miyabié–‹ç™ºé€²æ— $(date +%Y-%m-%d) - AIè‡ªå¾‹é–‹ç™ºã‚·ã‚¹ãƒ†ãƒ "
          VIDEO_DESCRIPTION: |
            AIè‡ªå¾‹é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ŒMiyabiã€ã®é–‹ç™ºé€²æ—ã‚’ã‚†ã£ãã‚ŠéœŠå¤¢ãƒ»é­”ç†æ²™ãŒè§£èª¬ã—ã¾ã™ï¼

            ðŸ“… é…ä¿¡æ—¥: $(date +%Y-%m-%d)
            ðŸ”§ å‡¦ç†ã‚³ãƒŸãƒƒãƒˆæ•°: ${{ steps.narration.outputs.commit_count }}
            â±ï¸ å‹•ç”»æ™‚é–“: ${{ steps.narration.outputs.duration }}

            ðŸ”— ãƒªãƒ³ã‚¯:
            - GitHub: https://github.com/ShunsukeHayashi/Miyabi
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://shunsukehayashi.github.io/Miyabi/

            #Miyabi #AI #è‡ªå¾‹é–‹ç™º #Rust #ã‚†ã£ãã‚Šè§£èª¬ #ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° #GitHub
        run: |
          cd tools

          echo "ðŸ“¤ Uploading to YouTube..."

          python3 youtube-upload.py \
            --file "${{ steps.narration.outputs.video_path }}" \
            --title "$VIDEO_TITLE" \
            --description "$VIDEO_DESCRIPTION" \
            --category 28 \
            --tags "Miyabi,AI,è‡ªå¾‹é–‹ç™º,Rust,ã‚†ã£ãã‚Šè§£èª¬,ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°,GitHub" \
            --thumbnail "${{ steps.narration.outputs.thumbnail_path }}" \
            --privacy public \
            > upload_result.txt

          # Extract video ID from output
          VIDEO_ID=$(grep "Video ID:" upload_result.txt | awk '{print $3}')
          VIDEO_URL="https://youtu.be/$VIDEO_ID"

          echo "video_id=$VIDEO_ID" >> $GITHUB_OUTPUT
          echo "video_url=$VIDEO_URL" >> $GITHUB_OUTPUT

          echo "âœ… Video uploaded: $VIDEO_URL"

      - name: Send Discord notification (Success)
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Daily Narration Published",
                "description": "Miyabié–‹ç™ºé€²æ— '"$(date +%Y-%m-%d)"' ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼",
                "url": "'"${{ steps.youtube_upload.outputs.video_url }}"'",
                "color": 5814783,
                "fields": [
                  {
                    "name": "ðŸ“Š Commits",
                    "value": "'"${{ steps.narration.outputs.commit_count }}"'",
                    "inline": true
                  },
                  {
                    "name": "â±ï¸ Duration",
                    "value": "'"${{ steps.narration.outputs.duration }}"'",
                    "inline": true
                  },
                  {
                    "name": "ðŸ“¦ Size",
                    "value": "'"${{ steps.narration.outputs.video_size }}"'",
                    "inline": true
                  },
                  {
                    "name": "ðŸŽ¬ Video",
                    "value": "[Watch on YouTube]('"${{ steps.youtube_upload.outputs.video_url }}"')"
                  }
                ],
                "footer": {
                  "text": "Miyabi Daily Narration Bot"
                },
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

      - name: Send Discord notification (Failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Daily Narration Failed",
                "description": "Miyabié–‹ç™ºé€²æ—ã®è‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Job",
                    "value": "'"${{ github.job }}"'"
                  },
                  {
                    "name": "Run ID",
                    "value": "[#'"${{ github.run_number }}"'](https://github.com/'"${{ github.repository }}"'/actions/runs/'"${{ github.run_id }}"')"
                  }
                ],
                "footer": {
                  "text": "Miyabi Daily Narration Bot"
                },
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

      - name: Cleanup
        if: always()
        run: |
          # Stop VOICEVOX Engine
          if [ -n "${{ steps.voicevox.outputs.voicevox_pid }}" ]; then
            kill ${{ steps.voicevox.outputs.voicevox_pid }} 2>/dev/null || true
          fi

          # Remove credentials
          rm -f tools/credentials.json tools/token.json

          echo "âœ… Cleanup complete"
