name: Task Execute - Claude Code Headless (AWS Self-Hosted)

# Water Spider Orchestrator - Task Execution Workflow
# AWS Self-Hosted Runner with Comprehensive Error Handling and Retry Logic

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'GitHub Issue number to execute'
        required: true
        type: string
      priority:
        description: 'Task priority (P0-P3)'
        required: false
        type: string
        default: 'P2-Medium'
      worktree_name:
        description: 'Git worktree name (auto-generated if empty)'
        required: false
        type: string
      max_runtime:
        description: 'Maximum runtime in minutes'
        required: false
        type: number
        default: 120
      max_retries:
        description: 'Maximum retry attempts on failure'
        required: false
        type: number
        default: 3

env:
  # Retry configuration
  RETRY_WAIT_SECONDS: 30
  RETRY_BACKOFF_MULTIPLIER: 2
  MAX_RETRY_WAIT_SECONDS: 300

jobs:
  execute-task:
    name: Execute Issue #${{ inputs.issue_number }}
    runs-on: [self-hosted, linux, aws, miyabi-worker]
    timeout-minutes: ${{ fromJSON(inputs.max_runtime) }}

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      # ============================================
      # Phase 0: Pre-flight Checks
      # ============================================
      
      - name: üîç Pre-flight Environment Check
        id: preflight
        continue-on-error: true
        run: |
          echo "=== Pre-flight Checks ==="
          echo "Runner: $(hostname)"
          echo "OS: $(uname -a)"
          echo "Disk Space: $(df -h / | tail -1)"
          echo "Memory: $(free -h | grep Mem:)"
          echo "Docker: $(docker --version 2>/dev/null || echo 'Not installed')"
          
          # Check required tools
          MISSING_TOOLS=()
          command -v git >/dev/null 2>&1 || MISSING_TOOLS+=("git")
          command -v curl >/dev/null 2>&1 || MISSING_TOOLS+=("curl")
          command -v gh >/dev/null 2>&1 || MISSING_TOOLS+=("gh")
          
          if [ ${#MISSING_TOOLS[@]} -ne 0 ]; then
            echo "‚ùå Missing tools: ${MISSING_TOOLS[*]}"
            echo "preflight_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Pre-flight checks passed"
          echo "preflight_failed=false" >> $GITHUB_OUTPUT

      - name: üö® Pre-flight Failure Recovery
        if: steps.preflight.outputs.preflight_failed == 'true'
        run: |
          echo "‚ö†Ô∏è Pre-flight check failed - attempting recovery"
          
          # Install missing tools if possible
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y git curl || true
          fi
          
          # Verify again
          if ! command -v git >/dev/null 2>&1; then
            echo "‚ùå Recovery failed - git still missing"
            exit 1
          fi
          
          echo "‚úÖ Recovery successful"

      # ============================================
      # Phase 1: Initialization with Retry
      # ============================================
      
      - name: üìã Workflow Information
        run: |
          echo "üéØ Executing Issue: #${{ inputs.issue_number }}"
          echo "‚ö° Priority: ${{ inputs.priority }}"
          echo "‚è±Ô∏è  Max Runtime: ${{ inputs.max_runtime }} minutes"
          echo "üîÑ Max Retries: ${{ inputs.max_retries }}"
          echo "üå≥ Worktree: ${{ inputs.worktree_name || format('issue-{0}', inputs.issue_number) }}"
          echo "üñ•Ô∏è  Runner: $(hostname)"

      - name: üîê Setup GitHub CLI (with Retry)
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            gh --version
            echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
            gh auth status

      - name: üìù Post Phase 1 Comment (Initializing)
        uses: nick-invision/retry@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 2
          max_attempts: 5
          retry_wait_seconds: 5
          command: |
            gh issue comment ${{ inputs.issue_number }} \
              --repo ${{ github.repository }} \
              --body "ü§ñ **Autonomous Execution Started** (AWS Self-Hosted)

            **Phase 1**: Initializing
            - Priority: ${{ inputs.priority }}
            - Runner: $(hostname)
            - Workflow: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - Max Retries: ${{ inputs.max_retries }}

            The Water Spider Orchestrator is now processing this task on AWS infrastructure..."

      # ============================================
      # Phase 2: Repository Setup with Error Handling
      # ============================================

      - name: üì¶ Checkout Repository (with Retry)
        id: checkout
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: ${{ fromJSON(inputs.max_retries) }}
          retry_wait_seconds: 30
          command: |
            # Clean any existing checkout
            rm -rf ./* .git || true
            
            # Clone with full history
            git clone --depth 0 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
            
            # Verify checkout
            git status
            echo "‚úÖ Repository checked out successfully"

      - name: üîß Setup Rust Toolchain (with Retry)
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            # Install rustup if not present
            if ! command -v rustup >/dev/null 2>&1; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source $HOME/.cargo/env
            fi
            
            # Update toolchain
            rustup update stable
            rustup default stable
            rustup component add rustfmt clippy
            
            # Verify installation
            rustc --version
            cargo --version
            echo "‚úÖ Rust toolchain ready"

      - name: üìÇ Setup Cargo Cache
        id: cargo_cache
        continue-on-error: true
        run: |
          # Create cache directory
          mkdir -p ~/.cargo/{registry,git}
          
          # Warm up cache
          cargo fetch || echo "‚ö†Ô∏è Cache warm-up failed (non-fatal)"
          
          echo "‚úÖ Cargo cache configured"

      - name: üå≥ Create Git Worktree (with Error Recovery)
        id: worktree
        continue-on-error: true
        run: |
          set -e
          
          WORKTREE_NAME="${{ inputs.worktree_name }}"
          if [ -z "$WORKTREE_NAME" ]; then
            WORKTREE_NAME="issue-${{ inputs.issue_number }}"
          fi

          BRANCH_NAME="feature/issue-${{ inputs.issue_number }}"
          WORKTREE_PATH=".worktrees/${WORKTREE_NAME}"

          # Clean existing worktree if present
          if [ -d "$WORKTREE_PATH" ]; then
            echo "‚ö†Ô∏è Existing worktree found - cleaning up"
            git worktree remove "$WORKTREE_PATH" --force || true
            rm -rf "$WORKTREE_PATH" || true
          fi

          # Delete existing branch if present
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

          # Create new worktree
          echo "Creating worktree: ${WORKTREE_PATH}"
          git worktree add -b "${BRANCH_NAME}" "${WORKTREE_PATH}" origin/main

          # Verify worktree
          if [ ! -d "$WORKTREE_PATH" ]; then
            echo "‚ùå Worktree creation failed"
            echo "worktree_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "worktree_path=${WORKTREE_PATH}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "worktree_failed=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Worktree created successfully"

      - name: üö® Worktree Failure Recovery
        if: steps.worktree.outputs.worktree_failed == 'true'
        run: |
          echo "‚ö†Ô∏è Worktree creation failed - attempting recovery"
          
          # Full cleanup
          git worktree prune
          rm -rf .worktrees/* || true
          
          # Retry with simple checkout
          BRANCH_NAME="feature/issue-${{ inputs.issue_number }}"
          git checkout -b "$BRANCH_NAME" origin/main || git checkout "$BRANCH_NAME"
          
          # Use current directory as worktree
          echo "worktree_path=." >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "‚úÖ Fallback to direct checkout successful"

      - name: üìù Post Phase 2 Comment (Worktree Created)
        uses: nick-invision/retry@v3
        if: steps.worktree.outputs.worktree_failed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            gh issue comment ${{ inputs.issue_number }} \
              --repo ${{ github.repository }} \
              --body "**Phase 2**: Worktree Setup ‚úÖ
            - Branch: \`${{ steps.worktree.outputs.branch_name }}\`
            - Path: \`${{ steps.worktree.outputs.worktree_path }}\`
            - Runner: $(hostname)"

      # ============================================
      # Phase 3: Autonomous Execution with Retry
      # ============================================

      - name: üì• Install Claude Code CLI (with Retry)
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "Installing Claude Code..."
            curl -fsSL https://raw.githubusercontent.com/anthropics/claude-code/main/install.sh | sh

            # Add to PATH
            export PATH="$HOME/.local/bin:$PATH"
            echo "$HOME/.local/bin" >> $GITHUB_PATH

            # Verify installation
            sleep 2
            claude --version || echo "‚ö†Ô∏è Claude version check failed (may be normal)"
            echo "‚úÖ Claude Code installed"

      - name: üîê Setup Claude API Key
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "‚ùå ANTHROPIC_API_KEY not set"
            exit 1
          fi
          echo "‚úÖ Claude API Key configured"

      - name: üìù Post Phase 3 Comment (Starting Execution)
        uses: nick-invision/retry@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            gh issue comment ${{ inputs.issue_number }} \
              --repo ${{ github.repository }} \
              --body "**Phase 3**: Starting Autonomous Execution üöÄ

            Claude Code is now analyzing and implementing the solution on AWS infrastructure..."

      - name: ü§ñ Execute Claude Code Headless (with Retry & Error Capture)
        id: claude_execute
        working-directory: ${{ steps.worktree.outputs.worktree_path }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e  # Don't exit on error - we handle it
          
          ISSUE_URL="https://github.com/${{ github.repository }}/issues/${{ inputs.issue_number }}"
          MAX_ATTEMPTS=${{ inputs.max_retries }}
          WAIT_SECONDS=${{ env.RETRY_WAIT_SECONDS }}
          
          echo "Executing: claude --headless --issue $ISSUE_URL"
          
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "=== Attempt $attempt/$MAX_ATTEMPTS ==="
            
            # Execute Claude Code
            claude --headless --issue "$ISSUE_URL" \
              --max-tokens 100000 \
              --context .claude/CLAUDE.md \
              > claude_output_${attempt}.log 2>&1
            
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Claude Code execution succeeded on attempt $attempt"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "attempts=$attempt" >> $GITHUB_OUTPUT
              cat claude_output_${attempt}.log
              exit 0
            else
              echo "‚ö†Ô∏è Attempt $attempt failed with exit code $EXIT_CODE"
              cat claude_output_${attempt}.log
              
              if [ $attempt -lt $MAX_ATTEMPTS ]; then
                # Exponential backoff
                BACKOFF=$((WAIT_SECONDS * (RETRY_BACKOFF_MULTIPLIER ** (attempt - 1))))
                if [ $BACKOFF -gt ${{ env.MAX_RETRY_WAIT_SECONDS }} ]; then
                  BACKOFF=${{ env.MAX_RETRY_WAIT_SECONDS }}
                fi
                
                echo "üîÑ Retrying in $BACKOFF seconds..."
                sleep $BACKOFF
              fi
            fi
          done
          
          # All attempts failed
          echo "‚ùå All $MAX_ATTEMPTS attempts failed"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "attempts=$MAX_ATTEMPTS" >> $GITHUB_OUTPUT
          
          # Save error logs
          cat claude_output_*.log > claude_full_error.log
          
          exit 1

      - name: üö® Claude Execution Failure Recovery
        if: failure() && steps.claude_execute.outputs.success != 'true'
        working-directory: ${{ steps.worktree.outputs.worktree_path }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚ö†Ô∏è Claude execution failed - analyzing error logs"
          
          # Extract error type
          if grep -q "API key" claude_full_error.log 2>/dev/null; then
            ERROR_TYPE="API Key Issue"
          elif grep -q "rate limit" claude_full_error.log 2>/dev/null; then
            ERROR_TYPE="Rate Limit"
          elif grep -q "timeout" claude_full_error.log 2>/dev/null; then
            ERROR_TYPE="Timeout"
          elif grep -q "network" claude_full_error.log 2>/dev/null; then
            ERROR_TYPE="Network Error"
          else
            ERROR_TYPE="Unknown Error"
          fi
          
          echo "üìä Error Type: $ERROR_TYPE"
          
          # Post detailed error to issue
          gh issue comment ${{ inputs.issue_number }} \
            --repo ${{ github.repository }} \
            --body "**Execution Failed** ‚ùå

          **Error Type**: $ERROR_TYPE
          **Attempts**: ${{ steps.claude_execute.outputs.attempts }}/${{ inputs.max_retries }}

          **Error Logs**:
          \`\`\`
          $(tail -50 claude_full_error.log 2>/dev/null || echo 'No logs available')
          \`\`\`

          **Recovery Actions**:
          - Task will be returned to queue
          - Orchestrator will retry with different configuration
          - Manual intervention may be required for persistent failures

          **Workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" || echo "‚ö†Ô∏è Failed to post error comment"

      # ============================================
      # Phase 4: Quality Checks with Error Handling
      # ============================================

      - name: üìù Post Phase 4 Comment (Execution Complete)
        if: steps.claude_execute.outputs.success == 'true'
        uses: nick-invision/retry@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            gh issue comment ${{ inputs.issue_number }} \
              --repo ${{ github.repository }} \
              --body "**Phase 4**: Execution Complete ‚úÖ (after ${{ steps.claude_execute.outputs.attempts }} attempt(s))

            Claude Code has finished processing. Reviewing changes..."

      - name: üìä Analyze Changes
        id: analyze
        if: steps.claude_execute.outputs.success == 'true'
        working-directory: ${{ steps.worktree.outputs.worktree_path }}
        run: |
          # Count changes
          FILES_CHANGED=$(git diff --name-only HEAD | wc -l | tr -d ' ')
          LINES_ADDED=$(git diff --numstat HEAD | awk '{sum+=$1} END {print sum+0}')
          LINES_DELETED=$(git diff --numstat HEAD | awk '{sum+=$2} END {print sum+0}')

          echo "files_changed=${FILES_CHANGED}" >> $GITHUB_OUTPUT
          echo "lines_added=${LINES_ADDED}" >> $GITHUB_OUTPUT
          echo "lines_deleted=${LINES_DELETED}" >> $GITHUB_OUTPUT

          # Check if there are changes
          if [ "$FILES_CHANGED" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
          echo "üìä Changes: $FILES_CHANGED files, +$LINES_ADDED -$LINES_DELETED lines"

      - name: üî® Run Tests (with Retry)
        if: steps.analyze.outputs.has_changes == 'true'
        uses: nick-invision/retry@v3
        working-directory: ${{ steps.worktree.outputs.worktree_path }}
        with:
          timeout_minutes: 30
          max_attempts: 2
          retry_wait_seconds: 60
          command: |
            echo "Running cargo test..."
            cargo test --all-features --verbose
            echo "‚úÖ All tests passed"

      - name: üîç Run Clippy (with Retry)
        if: steps.analyze.outputs.has_changes == 'true'
        uses: nick-invision/retry@v3
        working-directory: ${{ steps.worktree.outputs.worktree_path }}
        with:
          timeout_minutes: 15
          max_attempts: 2
          retry_wait_seconds: 30
          command: |
            echo "Running cargo clippy..."
            cargo clippy --all-targets --all-features -- -D warnings
            echo "‚úÖ Clippy passed"

      # ============================================
      # Phase 5: PR Creation with Error Handling
      # ============================================

      - name: üíæ Commit Changes (with Retry)
        if: steps.analyze.outputs.has_changes == 'true'
        uses: nick-invision/retry@v3
        working-directory: ${{ steps.worktree.outputs.worktree_path }}
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            git config user.name "Miyabi Water Spider"
            git config user.email "bot@miyabi-society.ai"

            git add .
            git commit -m "feat: Implement Issue #${{ inputs.issue_number }}

            Autonomous implementation by Claude Code on AWS infrastructure

            - Priority: ${{ inputs.priority }}
            - Files Changed: ${{ steps.analyze.outputs.files_changed }}
            - Lines Added: ${{ steps.analyze.outputs.lines_added }}
            - Lines Deleted: ${{ steps.analyze.outputs.lines_deleted }}
            - Execution Attempts: ${{ steps.claude_execute.outputs.attempts }}
            - Runner: $(hostname)

            ü§ñ Generated with Claude Code
            Co-Authored-By: Water Spider Orchestrator <bot@miyabi-society.ai>"
            
            echo "‚úÖ Changes committed"

      - name: üöÄ Push Changes (with Retry & Force Recovery)
        if: steps.analyze.outputs.has_changes == 'true'
        working-directory: ${{ steps.worktree.outputs.worktree_path }}
        run: |
          set +e
          MAX_ATTEMPTS=5
          
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "=== Push Attempt $attempt/$MAX_ATTEMPTS ==="
            
            git push origin ${{ steps.worktree.outputs.branch_name }}
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Push succeeded"
              exit 0
            else
              echo "‚ö†Ô∏è Push failed with exit code $EXIT_CODE"
              
              if [ $attempt -lt $MAX_ATTEMPTS ]; then
                # Try to recover
                echo "üîÑ Attempting recovery..."
                
                # Pull and rebase if needed
                git pull --rebase origin main || true
                
                # Wait before retry
                sleep $((10 * attempt))
              fi
            fi
          done
          
          echo "‚ùå Push failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: üìù Create Pull Request (with Retry)
        if: steps.analyze.outputs.has_changes == 'true'
        id: create_pr
        uses: nick-invision/retry@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            # Get issue details
            ISSUE_TITLE=$(gh issue view ${{ inputs.issue_number }} --json title -q .title)

            PR_BODY="## Summary
            Autonomous implementation of Issue #${{ inputs.issue_number }} on AWS infrastructure

            ## Changes
            - üìù Files Changed: ${{ steps.analyze.outputs.files_changed }}
            - ‚ûï Lines Added: ${{ steps.analyze.outputs.lines_added }}
            - ‚ûñ Lines Deleted: ${{ steps.analyze.outputs.lines_deleted }}

            ## Execution Details
            - üîÑ Attempts: ${{ steps.claude_execute.outputs.attempts }}/${{ inputs.max_retries }}
            - üñ•Ô∏è  Runner: $(hostname)
            - ‚ö° Priority: ${{ inputs.priority }}

            ## Testing
            - ‚úÖ Unit Tests Passed
            - ‚úÖ Clippy Checks Passed

            ## Workflow
            - Workflow Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Closes #${{ inputs.issue_number }}

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
            Co-Authored-By: Water Spider Orchestrator <bot@miyabi-society.ai>"

            PR_URL=$(gh pr create \
              --title "feat: ${ISSUE_TITLE}" \
              --body "${PR_BODY}" \
              --base main \
              --head ${{ steps.worktree.outputs.branch_name }} \
              --label "priority:${{ inputs.priority }}" \
              --label "automated" \
              --label "aws-runner" \
              --label "claude-code")

            echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
            echo "‚úÖ Pull Request created: $PR_URL"

      - name: üìù Post Final Comment (Success)
        if: steps.analyze.outputs.has_changes == 'true' && steps.create_pr.outputs.pr_url != ''
        uses: nick-invision/retry@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 2
          max_attempts: 5
          retry_wait_seconds: 5
          command: |
            gh issue comment ${{ inputs.issue_number }} \
              --repo ${{ github.repository }} \
              --body "**Phase 5**: Pull Request Created üéâ

            ‚úÖ **Implementation Complete** (AWS Self-Hosted)

            **Changes:**
            - üìù Files: ${{ steps.analyze.outputs.files_changed }}
            - ‚ûï Added: ${{ steps.analyze.outputs.lines_added }} lines
            - ‚ûñ Deleted: ${{ steps.analyze.outputs.lines_deleted }} lines

            **Execution:**
            - üîÑ Attempts: ${{ steps.claude_execute.outputs.attempts }}/${{ inputs.max_retries }}
            - üñ•Ô∏è  Runner: $(hostname)

            **Quality Checks:**
            - ‚úÖ Unit Tests Passed
            - ‚úÖ Clippy Passed

            **Pull Request:** ${{ steps.create_pr.outputs.pr_url }}

            The Water Spider Orchestrator has completed this task on AWS infrastructure."

      - name: üìù Post No Changes Comment
        if: steps.analyze.outputs.has_changes == 'false'
        uses: nick-invision/retry@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            gh issue comment ${{ inputs.issue_number }} \
              --repo ${{ github.repository }} \
              --body "**Execution Complete** ‚ÑπÔ∏è

            Claude Code completed analysis but determined no code changes were needed.

            This may indicate:
            - The issue is already resolved
            - The issue requires clarification
            - The issue is not a code change request

            Please review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."

      # ============================================
      # Cleanup with Error Recovery
      # ============================================

      - name: üßπ Cleanup Worktree
        if: always()
        continue-on-error: true
        run: |
          WORKTREE_PATH="${{ steps.worktree.outputs.worktree_path }}"
          
          if [ -d "$WORKTREE_PATH" ] && [ "$WORKTREE_PATH" != "." ]; then
            echo "Cleaning up worktree: $WORKTREE_PATH"
            
            # Try graceful removal first
            git worktree remove "$WORKTREE_PATH" --force 2>/dev/null || true
            
            # Force filesystem removal if needed
            rm -rf "$WORKTREE_PATH" 2>/dev/null || true
            
            echo "‚úÖ Worktree cleaned up"
          fi
          
          # Prune any dangling worktrees
          git worktree prune 2>/dev/null || true

      - name: ‚ùå Post Failure Comment
        if: failure()
        uses: nick-invision/retry@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          timeout_minutes: 2
          max_attempts: 5
          retry_wait_seconds: 10
          command: |
            gh issue comment ${{ inputs.issue_number }} \
              --repo ${{ github.repository }} \
              --body "**Execution Failed** ‚ùå (AWS Self-Hosted)

            The autonomous execution encountered an error after retry attempts.

            **Details:**
            - üîÑ Max Retries: ${{ inputs.max_retries }}
            - üñ•Ô∏è  Runner: $(hostname)
            - **Workflow:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Recovery Actions:**
            - Task returned to queue for retry
            - Orchestrator notified for escalation
            - Error logs saved for analysis

            The Water Spider Orchestrator will retry or escalate this task." || echo "‚ö†Ô∏è Failed to post failure comment (non-fatal)"

  # ============================================
  # Orchestrator Notification with Retry
  # ============================================
  
  notify-completion:
    name: Notify Orchestrator
    needs: execute-task
    runs-on: [self-hosted, linux, aws, miyabi-worker]
    if: always()

    steps:
      - name: üì¢ Notify Task Queue (with Retry)
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 5
          retry_wait_seconds: 30
          command: |
            echo "üîî Task #${{ inputs.issue_number }} execution completed"
            echo "Status: ${{ needs.execute-task.result }}"
            echo "Runner: $(hostname)"

            # TODO: Call Task Dispatcher API to mark task as complete
            # This will unblock dependent tasks in the queue
            
            # For now, log the completion
            curl -X POST "https://api.github.com/repos/${{ github.repository }}/issues/${{ inputs.issue_number }}/comments" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -d "{\"body\": \"üîî **Orchestrator Notified**: Task execution ${{ needs.execute-task.result }}\"}" \
              || echo "‚ö†Ô∏è Notification failed (non-fatal)"
            
            echo "‚úÖ Orchestrator notification sent"
