name: Discussion Weekly Digest

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Manual trigger for testing

permissions:
  discussions: write
  contents: read

jobs:
  generate-digest:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm & Node.js
        uses: ./.github/actions/setup-pnpm

      - name: Generate Weekly Digest
        id: digest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          npx tsx scripts/github/discussion-digest.ts generate

      - name: Post Digest to Discussions
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          npx tsx scripts/github/discussion-digest.ts post

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            console.log('⚠️ Weekly digest generation failed');
            console.log('Manual trigger available: workflow_dispatch');
