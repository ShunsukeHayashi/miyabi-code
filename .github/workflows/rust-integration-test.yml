name: Rust Integration Tests

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  integration-test:
    name: Integration Tests
    runs-on: [self-hosted, macOS, arm64, miyabi-light]
    timeout-minutes: 30

    steps:
      - name: Start time tracking
        id: start-time
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          cache-key-prefix: integration

      - name: Setup sccache
        uses: ./.github/actions/setup-sccache
        with:
          cache-key-prefix: integration

      - name: Run unit tests (all packages)
        run: |
          echo "### ðŸ§ª Running Unit Tests" >> $GITHUB_STEP_SUMMARY
          cargo test --workspace --lib --all-features
          echo "âœ… Unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Run integration tests (all packages)
        run: |
          echo "### ðŸ”— Running Integration Tests" >> $GITHUB_STEP_SUMMARY
          cargo test --workspace --test '*' --all-features
          echo "âœ… Integration tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Run E2E tests (ignored by default)
        run: |
          echo "### ðŸŽ¯ Running E2E Tests" >> $GITHUB_STEP_SUMMARY
          cargo test --workspace --all-features -- --ignored
          echo "âœ… E2E tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Test miyabi CLI
        run: |
          echo "### ðŸ› ï¸ Testing CLI Binary" >> $GITHUB_STEP_SUMMARY

          # Build CLI
          cargo build --release --bin miyabi

          # Test CLI commands
          ./target/release/miyabi --version
          ./target/release/miyabi --help

          echo "âœ… CLI binary functional" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Test parallel worktree execution
        run: |
          echo "### ðŸ”„ Testing Parallel Worktree Execution" >> $GITHUB_STEP_SUMMARY

          # Create test worktrees (dry run mode)
          cargo run --bin miyabi -- parallel --issues 1,2,3 --concurrency 2 || true

          # Check worktree cleanup
          git worktree list

          echo "âœ… Worktree system functional" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Test agent execution
        run: |
          echo "### ðŸ¤– Testing Agent Execution" >> $GITHUB_STEP_SUMMARY

          # Test CoordinatorAgent (without real GitHub API)
          cargo test --package miyabi-agent-coordinator -- --test-threads=1

          # Test other agents
          cargo test --package miyabi-agent-codegen -- --test-threads=1
          cargo test --package miyabi-agent-review -- --test-threads=1

          echo "âœ… Agent execution tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Test worktree manager
        run: |
          echo "### ðŸ“ Testing Worktree Manager" >> $GITHUB_STEP_SUMMARY

          cargo test --package miyabi-worktree -- --test-threads=1

          echo "âœ… Worktree manager tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Test knowledge system
        run: |
          echo "### ðŸ§  Testing Knowledge System" >> $GITHUB_STEP_SUMMARY

          cargo test --package miyabi-knowledge -- --test-threads=1

          echo "âœ… Knowledge system tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Show sccache statistics
        if: always()
        uses: ./.github/actions/sccache-stats

      - name: Generate integration test report
        if: always()
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.start-time.outputs.start_time }}))
          minutes=$((duration / 60))
          seconds=$((duration % 60))

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${minutes}m ${seconds}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner**: Mac mini 1 (miyabi-light)" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit Tests (all packages)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration Tests (all packages)" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ E2E Tests (ignored, optional)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CLI Binary Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ Parallel Worktree Tests (optional)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Agent Execution Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Worktree Manager Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ Knowledge System Tests (optional)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Miyabi Rust Integration Tests*" >> $GITHUB_STEP_SUMMARY

  status-report:
    name: Integration Test Status Report
    runs-on: [self-hosted, macOS, arm64, miyabi-light]
    needs: [integration-test]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Report test status
        run: |
          if [ "${{ needs.integration-test.result }}" == "success" ]; then
            echo "âœ… All integration tests passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: ðŸŸ¢ PASSING" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some integration tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: ðŸ”´ FAILING" >> $GITHUB_STEP_SUMMARY
          fi
