name: Codex Autonomous Coordinator

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      coordinator:
        description: 'Coordinator to use (mugen/majin/auto)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - mugen
          - majin
  schedule:
    # Run every hour to check for pending issues
    - cron: '0 * * * *'

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Check trigger and select coordinator
  check-trigger:
    name: Check Trigger & Select Coordinator
    runs-on: [self-hosted, macOS, ARM64, miyabi-light]
    outputs:
      should_execute: ${{ steps.check.outputs.should_execute }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      coordinator: ${{ steps.check.outputs.coordinator }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          SHOULD_EXECUTE="false"
          ISSUE_NUMBER=""
          COORDINATOR="auto"

          # Workflow dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHOULD_EXECUTE="true"
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
            COORDINATOR="${{ github.event.inputs.coordinator }}"
            echo "Manual trigger: Issue #${ISSUE_NUMBER} on ${COORDINATOR}"
          fi

          # Issue with codex-execute label
          if [ "${{ github.event_name }}" = "issues" ]; then
            LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
            if echo "$LABELS" | grep -q "codex-execute"; then
              SHOULD_EXECUTE="true"
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              echo "Issue #${ISSUE_NUMBER} has codex-execute label"
            fi
          fi

          # Comment with /codex command
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            if echo "$COMMENT" | grep -q "^/codex"; then
              SHOULD_EXECUTE="true"
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              # Extract coordinator from command if specified
              if echo "$COMMENT" | grep -q "/codex mugen"; then
                COORDINATOR="mugen"
              elif echo "$COMMENT" | grep -q "/codex majin"; then
                COORDINATOR="majin"
              fi
              echo "Comment trigger: /codex command on issue #${ISSUE_NUMBER}"
            fi
          fi

          # Scheduled run - check for pending issues
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Query for issues with codex-pending label
            PENDING_ISSUE=$(gh issue list --label "codex-pending" --limit 1 --json number --jq '.[0].number' || echo "")
            if [ -n "$PENDING_ISSUE" ]; then
              SHOULD_EXECUTE="true"
              ISSUE_NUMBER="$PENDING_ISSUE"
              echo "Scheduled run: Found pending issue #${ISSUE_NUMBER}"
            fi
          fi

          echo "should_execute=$SHOULD_EXECUTE" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "coordinator=$COORDINATOR" >> $GITHUB_OUTPUT

  # Job 2: Execute on MUGEN
  execute-mugen:
    name: Execute Codex on MUGEN
    needs: check-trigger
    if: needs.check-trigger.outputs.should_execute == 'true' && (needs.check-trigger.outputs.coordinator == 'mugen' || needs.check-trigger.outputs.coordinator == 'auto')
    runs-on: [self-hosted, Linux, X64, mugen]
    env:
      ISSUE_NUMBER: ${{ needs.check-trigger.outputs.issue_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup environment
        run: |
          echo "üöÄ MUGEN Coordinator starting Codex execution"
          echo "Issue: #$ISSUE_NUMBER"
          echo "Runner: $(hostname)"
          echo "Workspace: $GITHUB_WORKSPACE"

      - name: Update Issue - Start
        run: |
          gh issue comment $ISSUE_NUMBER --body "ü§ñ **MUGEN Coordinator** started processing this issue.

          **Runner**: $(hostname)
          **Started**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Execute Codex with Claude Code
        id: codex
        run: |
          cd ~/miyabi-private

          # Create execution log
          mkdir -p .github/codex-logs
          LOG_FILE=".github/codex-logs/mugen-issue-${ISSUE_NUMBER}-$(date +%Y%m%d-%H%M%S).log"

          # Execute Claude Code with issue context
          echo "Executing Codex for issue #${ISSUE_NUMBER}..." | tee -a "$LOG_FILE"

          # Get issue details
          ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER --json title --jq '.title')
          ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body --jq '.body')

          # Run Claude Code in headless mode
          claude --print "Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          Please analyze this issue and execute the required tasks using available tools." 2>&1 | tee -a "$LOG_FILE"

          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Upload execution log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-log-mugen-issue-${{ env.ISSUE_NUMBER }}
          path: ${{ steps.codex.outputs.log_file }}

      - name: Update Issue - Complete
        if: always()
        run: |
          if [ "${{ steps.codex.outcome }}" = "success" ]; then
            STATUS="‚úÖ **Completed successfully**"
          else
            STATUS="‚ö†Ô∏è **Completed with errors**"
          fi

          gh issue comment $ISSUE_NUMBER --body "${STATUS}

          **MUGEN Coordinator** finished processing.
          **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Log**: [Download](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        env:
          GH_TOKEN: ${{ github.token }}

  # Job 3: Execute on MAJIN
  execute-majin:
    name: Execute Codex on MAJIN
    needs: check-trigger
    if: needs.check-trigger.outputs.should_execute == 'true' && needs.check-trigger.outputs.coordinator == 'majin'
    runs-on: [self-hosted, Linux, X64, majin, gpu]
    env:
      ISSUE_NUMBER: ${{ needs.check-trigger.outputs.issue_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup environment
        run: |
          echo "üöÄ MAJIN Coordinator starting Codex execution"
          echo "Issue: #$ISSUE_NUMBER"
          echo "Runner: $(hostname)"
          echo "GPU: $(nvidia-smi --query-gpu=name --format=csv,noheader || echo 'No GPU')"

      - name: Update Issue - Start
        run: |
          gh issue comment $ISSUE_NUMBER --body "ü§ñ **MAJIN Coordinator (GPU)** started processing this issue.

          **Runner**: $(hostname)
          **GPU**: $(nvidia-smi --query-gpu=name --format=csv,noheader || echo 'No GPU')
          **Started**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Execute Codex with Claude Code
        id: codex
        run: |
          cd ~/miyabi-private

          mkdir -p .github/codex-logs
          LOG_FILE=".github/codex-logs/majin-issue-${ISSUE_NUMBER}-$(date +%Y%m%d-%H%M%S).log"

          echo "Executing Codex for issue #${ISSUE_NUMBER} on MAJIN..." | tee -a "$LOG_FILE"

          ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER --json title --jq '.title')
          ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body --jq '.body')

          claude --print "Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          Please analyze this issue and execute the required tasks. You have access to GPU resources on this machine." 2>&1 | tee -a "$LOG_FILE"

          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Upload execution log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-log-majin-issue-${{ env.ISSUE_NUMBER }}
          path: ${{ steps.codex.outputs.log_file }}

      - name: Update Issue - Complete
        if: always()
        run: |
          if [ "${{ steps.codex.outcome }}" = "success" ]; then
            STATUS="‚úÖ **Completed successfully**"
          else
            STATUS="‚ö†Ô∏è **Completed with errors**"
          fi

          gh issue comment $ISSUE_NUMBER --body "${STATUS}

          **MAJIN Coordinator (GPU)** finished processing.
          **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Log**: [Download](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        env:
          GH_TOKEN: ${{ github.token }}
