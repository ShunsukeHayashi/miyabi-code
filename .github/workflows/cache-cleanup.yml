name: Cache Cleanup

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  cleanup:
    name: Clean Old Caches
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup old caches
        uses: actions/github-script@v7
        with:
          script: |
            const CACHE_RETENTION_DAYS = 7;
            const MAX_CACHE_SIZE_MB = 5000; // 5GB total limit

            console.log('ðŸ—‘ï¸ Starting cache cleanup...');

            // Get all caches
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`Found ${caches.data.total_count} caches`);

            const now = Date.now();
            const retentionMs = CACHE_RETENTION_DAYS * 24 * 60 * 60 * 1000;

            let deletedCount = 0;
            let totalSize = 0;

            for (const cache of caches.data.actions_caches) {
              const cacheAge = now - new Date(cache.created_at).getTime();
              const cacheAgeDays = Math.floor(cacheAge / (24 * 60 * 60 * 1000));

              totalSize += cache.size_in_bytes;

              // Delete caches older than retention period
              if (cacheAge > retentionMs) {
                console.log(`Deleting cache: ${cache.key} (${cacheAgeDays} days old, ${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB)`);

                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    cache_id: cache.id
                  });
                  deletedCount++;
                } catch (error) {
                  console.error(`Failed to delete cache ${cache.key}: ${error.message}`);
                }
              }
            }

            // Summary
            console.log(`\nâœ… Cleanup complete:`);
            console.log(`- Deleted: ${deletedCount} caches`);
            console.log(`- Total cache size: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
            console.log(`- Retention policy: ${CACHE_RETENTION_DAYS} days`);

            // Create summary
            const summary = `
            # ðŸ—‘ï¸ Cache Cleanup Report

            **Executed**: ${new Date().toISOString()}

            ## Statistics

            | Metric | Value |
            |--------|-------|
            | Total Caches | ${caches.data.total_count} |
            | Deleted Caches | ${deletedCount} |
            | Total Cache Size | ${(totalSize / 1024 / 1024).toFixed(2)} MB |
            | Retention Policy | ${CACHE_RETENTION_DAYS} days |

            ## Cache Strategy

            **3-Layer Cache Architecture**:
            1. **Layer 1**: Rust Toolchain (~500MB) - Rarely changes
            2. **Layer 2**: Dependencies (~1GB) - Changes with Cargo.lock
            3. **Layer 3**: Build Artifacts (~2GB) - Incremental compilation

            **Combined with sccache**: Additional 2GB compilation cache

            **Total Expected**: ~5.5GB across all jobs (check, test, build, etc.)

            ## Recommendations

            ${totalSize > MAX_CACHE_SIZE_MB * 1024 * 1024 ? 'âš ï¸ **Warning**: Total cache size exceeds 5GB limit. Consider reducing cache retention or optimizing cache keys.' : 'âœ… Cache size is within acceptable limits.'}

            ---
            _Cleanup runs weekly (Sunday 00:00 UTC) or manually via workflow_dispatch_
            `;

            await core.summary.addRaw(summary).write();

      - name: Report cache status
        run: |
          echo "### Cache Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cache cleanup job finished successfully." >> $GITHUB_STEP_SUMMARY
          echo "Check the summary above for detailed statistics." >> $GITHUB_STEP_SUMMARY
