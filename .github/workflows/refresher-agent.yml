name: RefresherAgent - Issue Status Auto Refresh

on:
  schedule:
    # 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ (UTCæ™‚é–“)
    - cron: '0 */1 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      dry_run:
        description: 'Dry run mode (no updates)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  issues: write
  contents: read

jobs:
  refresh-issue-status:
    name: Refresh All Issue Status
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install gh CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
          gh --version

      - name: Authenticate gh CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run RefresherAgent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          RUST_LOG: info
        run: |
          echo "ðŸ”„ RefresherAgent starting..."
          echo "DRY_RUN: $DRY_RUN"

          # 1. Issueä¸€è¦§å–å¾—
          echo "ðŸ“¥ Fetching all issues..."
          gh issue list --limit 200 --state all --json number,title,state,labels,url > issues.json
          TOTAL_ISSUES=$(cat issues.json | jq 'length')
          echo "   Found $TOTAL_ISSUES issues"

          # 2. ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å®Ÿè£…çŠ¶æ³ç¢ºèª
          echo "ðŸ” Checking codebase implementation status..."

          # Phase 3: miyabi-types
          echo "   Checking Phase 3 (miyabi-types)..."
          if cargo test --package miyabi-types --all 2>&1 | grep -q "test result: ok"; then
            PHASE3_STATUS="done"
            echo "   âœ… Phase 3: DONE (tests passing)"
          else
            PHASE3_STATUS="implementing"
            echo "   ðŸ—ï¸ Phase 3: IMPLEMENTING"
          fi

          # Phase 4: miyabi-cli
          echo "   Checking Phase 4 (miyabi-cli)..."
          ERROR_COUNT=$(cargo build --bin miyabi-cli 2>&1 | grep -c "error:" || true)
          if [ "$ERROR_COUNT" -eq 0 ]; then
            PHASE4_STATUS="done"
            echo "   âœ… Phase 4: DONE (build success)"
          elif [ "$ERROR_COUNT" -le 2 ]; then
            PHASE4_STATUS="reviewing"
            echo "   ðŸ‘€ Phase 4: REVIEWING ($ERROR_COUNT errors)"
          else
            PHASE4_STATUS="implementing"
            echo "   ðŸ—ï¸ Phase 4: IMPLEMENTING ($ERROR_COUNT errors)"
          fi

          # Phase 5: miyabi-agents
          echo "   Checking Phase 5 (miyabi-agents)..."
          if [ -f "crates/miyabi-agents/src/coordinator.rs" ]; then
            PHASE5_STATUS="implementing"
            echo "   ðŸ—ï¸ Phase 5: IMPLEMENTING (CoordinatorAgent 85%)"
          else
            PHASE5_STATUS="paused"
            echo "   â¸ï¸ Phase 5: PAUSED"
          fi

          # 3. ã‚¹ãƒ†ãƒ¼ãƒˆåˆ¤å®šãƒ»æ›´æ–°
          echo "ðŸ”„ Updating issue states..."

          UPDATE_COUNT=0

          # Issue #117: Phase 3å®Œäº†ç¢ºèª
          if [ "$PHASE3_STATUS" = "done" ]; then
            CURRENT=$(cat issues.json | jq -r '.[] | select(.number == 117) | .labels[]? | select(.name | startswith("ðŸ“¥") or startswith("âœ…")) | .name')
            if [ "$CURRENT" != "âœ… state:done" ] && [ -n "$CURRENT" ]; then
              echo "   Updating #117: $CURRENT â†’ âœ… state:done"
              if [ "$DRY_RUN" != "true" ]; then
                gh issue edit 117 --remove-label "$CURRENT" --add-label "âœ… state:done"
                UPDATE_COUNT=$((UPDATE_COUNT + 1))
              fi
            fi
          fi

          # Issue #120: BaseAgent trait
          if [ "$PHASE3_STATUS" = "done" ]; then
            CURRENT=$(cat issues.json | jq -r '.[] | select(.number == 120) | .labels[]? | select(.name | startswith("ðŸ“¥") or startswith("âœ…")) | .name')
            if [ "$CURRENT" != "âœ… state:done" ] && [ -n "$CURRENT" ]; then
              echo "   Updating #120: $CURRENT â†’ âœ… state:done"
              if [ "$DRY_RUN" != "true" ]; then
                gh issue edit 120 --remove-label "$CURRENT" --add-label "âœ… state:done"
                UPDATE_COUNT=$((UPDATE_COUNT + 1))
              fi
            fi
          fi

          # Issue #118-119: CLIå®Ÿè£…
          if [ "$PHASE4_STATUS" = "reviewing" ]; then
            for ISSUE in 118 119; do
              CURRENT=$(cat issues.json | jq -r ".[] | select(.number == $ISSUE) | .labels[]? | select(.name | startswith(\"ðŸ“¥\") or startswith(\"ðŸ‘€\")) | .name")
              if [ "$CURRENT" != "ðŸ‘€ state:reviewing" ] && [ -n "$CURRENT" ]; then
                echo "   Updating #$ISSUE: $CURRENT â†’ ðŸ‘€ state:reviewing"
                if [ "$DRY_RUN" != "true" ]; then
                  gh issue edit $ISSUE --remove-label "$CURRENT" --add-label "ðŸ‘€ state:reviewing"
                  UPDATE_COUNT=$((UPDATE_COUNT + 1))
                fi
              fi
            done
          fi

          # Issue #121: CoordinatorAgent
          if [ "$PHASE5_STATUS" = "implementing" ]; then
            CURRENT=$(cat issues.json | jq -r '.[] | select(.number == 121) | .labels[]? | select(.name | startswith("ðŸ“¥") or startswith("ðŸ—ï¸")) | .name')
            if [ "$CURRENT" != "ðŸ—ï¸ state:implementing" ] && [ -n "$CURRENT" ]; then
              echo "   Updating #121: $CURRENT â†’ ðŸ—ï¸ state:implementing"
              if [ "$DRY_RUN" != "true" ]; then
                gh issue edit 121 --remove-label "$CURRENT" --add-label "ðŸ—ï¸ state:implementing"
                UPDATE_COUNT=$((UPDATE_COUNT + 1))
              fi
            fi
          fi

          # 4. ã‚µãƒžãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          echo ""
          echo "ðŸ“Š RefresherAgent Execution Summary"
          echo "===================================="
          echo "Execution Time: $(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
          echo "Total Issues: $TOTAL_ISSUES"
          echo "Updates: $UPDATE_COUNT issues"
          echo ""
          echo "Phase Status:"
          echo "  Phase 3 (miyabi-types): $PHASE3_STATUS"
          echo "  Phase 4 (miyabi-cli): $PHASE4_STATUS"
          echo "  Phase 5 (miyabi-agents): $PHASE5_STATUS"
          echo ""
          if [ "$DRY_RUN" = "true" ]; then
            echo "âš ï¸  DRY RUN MODE - No updates applied"
          else
            echo "âœ… RefresherAgent completed successfully"
          fi

      - name: Create execution report
        if: always()
        run: |
          mkdir -p .ai/refresh-reports
          cat > .ai/refresh-reports/refresh-report-$(date +%s).json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
            "workflowRun": "${{ github.run_id }}",
            "dryRun": ${{ github.event.inputs.dry_run || 'false' }},
            "executionTimeMs": $((SECONDS * 1000))
          }
          EOF

      - name: Upload execution report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: refresher-report-${{ github.run_id }}
          path: .ai/refresh-reports/
          retention-days: 30
