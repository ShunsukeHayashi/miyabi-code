# Miyabi PR Merge Rules - Pull Requestè‡ªå‹•ãƒãƒ¼ã‚¸åˆ¤å®šãƒ«ãƒ¼ãƒ«
# Version: 1.0.0
# Description: PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒãƒ¼ã‚¸ã™ã‚‹ãŸã‚ã®å®šé‡çš„é–¾å€¤ãƒ«ãƒ¼ãƒ«
# Philosophy: "Quality gates ensure system integrity while enabling rapid iteration"

pr_merge_rules:
  version: "1.1.0"
  last_updated: "2025-10-31"

  # === Phase 1: å¿…é ˆãƒã‚§ãƒƒã‚¯ (Mandatory Gates) ===
  # ã“ã‚Œã‚‰ãŒå…¨ã¦é€šéã—ãªã„ã¨ãƒãƒ¼ã‚¸ä¸å¯
  mandatory_checks:

    github_status:
      description: "GitHub Actions CI/CDã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
      rules:
        - check: "All GitHub Actions workflows passed"
          threshold: "100% success"
          blocking: true
          priority: "P.1-Critical"

        - check: "No merge conflicts"
          threshold: "0 conflicts"
          blocking: true
          priority: "P.1-Critical"

        - check: "Branch up-to-date with main"
          threshold: "0 commits behind"
          blocking: true
          priority: "P.1-Critical"

    label_requirements:
      description: "å¿…é ˆãƒ©ãƒ™ãƒ«ä»˜ä¸ç¢ºèª"
      rules:
        - check: "State label exists"
          required_labels:
            - "state:reviewing"
            - "state:done"
          blocking: true
          priority: "P.1-Critical"

        - check: "Agent label exists"
          required_one_of:
            - "agent:coordinator"
            - "agent:codegen"
            - "agent:review"
            - "agent:deployment"
            - "agent:issue"
            - "agent:pr"
          blocking: true
          priority: "P.2-High"

        - check: "Type label exists"
          required_one_of:
            - "type:feature"
            - "type:bug"
            - "type:refactor"
            - "type:docs"
            - "type:test"
            - "type:chore"
            - "type:security"
          blocking: true
          priority: "P.2-High"

    code_quality:
      description: "ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–"
      rules:
        - check: "No ESLint errors"
          threshold: "0 errors"
          blocking: true
          priority: "P.1-Critical"
          command: "pnpm lint"

        - check: "TypeScript compilation success"
          threshold: "0 type errors"
          blocking: true
          priority: "P.1-Critical"
          command: "pnpm typecheck"

        - check: "All tests pass"
          threshold: "100% pass rate"
          blocking: true
          priority: "P.1-Critical"
          command: "pnpm test"

        - check: "Test coverage maintained"
          threshold: ">= 80%"
          blocking: true
          priority: "P.2-High"
          command: "pnpm test:coverage"

    security:
      description: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæº–"
      rules:
        - check: "No Sev.1-Critical vulnerabilities"
          threshold: "0 critical"
          blocking: true
          priority: "P.1-Critical"
          command: "pnpm audit --audit-level=critical"

        - check: "No Sev.2-High vulnerabilities"
          threshold: "0 high"
          blocking: true
          priority: "P.2-High"
          command: "pnpm audit --audit-level=high"

        - check: "No secrets leaked"
          threshold: "0 secrets"
          blocking: true
          priority: "P.1-Critical"
          tools:
            - "git-secrets"
            - "trufflehog"

  # === Phase 2: å“è³ªã‚¹ã‚³ã‚¢è©•ä¾¡ (Quality Score Assessment) ===
  # ç·åˆã‚¹ã‚³ã‚¢80ç‚¹ä»¥ä¸Šã§ãƒãƒ¼ã‚¸æ¨å¥¨
  quality_score:
    description: "ReviewAgentã«ã‚ˆã‚‹å“è³ªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆE6_QualityReportï¼‰"
    total_points: 100
    passing_threshold: 80

    components:
      eslint_score:
        weight: 0.40  # 40%
        calculation: "100 - (errors * 10 + warnings * 2)"
        thresholds:
          excellent: ">= 95"  # 0-1 warnings
          good: ">= 85"       # 2-7 warnings
          acceptable: ">= 70" # 8-15 warnings
          poor: "< 70"        # 16+ warnings

      typescript_score:
        weight: 0.30  # 30%
        calculation: "100 - (type_errors * 20)"
        thresholds:
          excellent: "100"    # 0 errors
          good: ">= 80"       # 1 error
          acceptable: ">= 60" # 2 errors
          poor: "< 60"        # 3+ errors

      security_score:
        weight: 0.20  # 20%
        calculation: "100 - (critical * 50 + high * 20 + medium * 5)"
        thresholds:
          excellent: "100"    # 0 vulnerabilities
          good: ">= 80"       # 1-4 medium
          acceptable: ">= 60" # 5-8 medium or 1 high
          poor: "< 60"        # 2+ high or 1+ critical

      coverage_score:
        weight: 0.10  # 10%
        calculation: "coverage_percentage"
        thresholds:
          excellent: ">= 90"
          good: ">= 80"
          acceptable: ">= 70"
          poor: "< 70"

    quality_labels:
      excellent:
        score_range: ">= 95"
        label: "quality:excellent"
        auto_merge: true

      good:
        score_range: "85-94"
        label: "quality:good"
        auto_merge: true

      needs_improvement:
        score_range: "70-84"
        label: "quality:needs-improvement"
        auto_merge: false
        action: "Request changes with improvement suggestions"

      poor:
        score_range: "< 70"
        label: "quality:poor"
        auto_merge: false
        action: "Reject PR and escalate to Guardian"

  # === Phase 3: PRå±æ€§ãƒã‚§ãƒƒã‚¯ (PR Attribute Checks) ===
  pr_attributes:
    description: "PRã®æ§‹é€ çš„å“è³ªãƒã‚§ãƒƒã‚¯"

    size_limits:
      files_changed:
        warning: "> 20 files"
        blocking: "> 50 files"
        action_on_exceed: "Split into multiple PRs"

      lines_changed:
        warning: "> 500 lines"
        blocking: "> 2000 lines"
        action_on_exceed: "Split into multiple PRs"

      commits_count:
        warning: "> 10 commits"
        recommendation: "Squash before merge"

  # === Phase 4: ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—é‹ç”¨ãƒ«ãƒ¼ãƒ« (Cleanup Policies) ===
  cleanup_policy:
    description: "ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰ã«å¿…ãšéµå®ˆã™ã¹ãã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—é‹ç”¨ãƒ«ãƒ¼ãƒ«"

    rules:
      - check: "ç”Ÿæˆç‰©ã‚³ãƒŸãƒƒãƒˆç¦æ­¢"
        details: |
          `.cargo/registry`ã€`target/`ã€`dist/`ã€`.cache/`ã€ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã€ãƒã‚¤ãƒŠãƒªã‚¢ã‚»ãƒƒãƒˆã€`.env.*` ã‚’å«ã‚€ç”Ÿæˆç‰©ã‚„ç§˜å¯†æƒ…å ±ã¯ãƒªãƒã‚¸ãƒˆãƒªã«å«ã‚ãªã„ã€‚å¿…è¦ã«å¿œã˜ã¦ `.gitignore` ã‚’æ›´æ–°ã—ã€æ¤œå‡ºã—ãŸå ´åˆã¯å‰Šé™¤ã—ã¦ã‹ã‚‰å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ã™ã‚‹ã€‚
        blocking: true
        priority: "P.1-Critical"

      - check: "çµ±åˆ¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æœ€å°æ›´æ–°"
        details: |
          `CLAUDE.md` ã‚„ `.codex/context/**` ãªã©ã®çµ±åˆ¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯æœ€æ–°ç‰ˆã‚’ç¶­æŒã—ã€å·®åˆ†ã¯å¿…è¦æœ€å°é™ã«ç•™ã‚ã‚‹ã€‚å·»ãæˆ»ã—ã‚„ç©ºç™½åŒ–ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å³æ™‚ä¿®æ­£ã—ãªã„é™ã‚Šãƒãƒ¼ã‚¸ä¸å¯ã€‚
        blocking: true
        priority: "P.1-Critical"

      - check: "ãƒ†ã‚¹ãƒˆãƒ»Lintã®å®Ÿè¡Œè¨¼è·¡"
        details: |
          `cargo fmt` / `cargo clippy` / `cargo test`ï¼ˆå¿…è¦ã«å¿œã˜ã¦ `pnpm lint` ç­‰ï¼‰ã®ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œçµæœã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã«æ˜è¨˜ã™ã‚‹ã€‚æœªå®Ÿè¡Œã¾ãŸã¯å¤±æ•—çŠ¶æ…‹ã®ã¾ã¾ã®PRã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡å¤–ã¨ã™ã‚‹ã€‚
        blocking: true
        priority: "P.1-Critical"

      - check: "äº’æ›æ€§å¤‰æ›´ã®èª¬æ˜è²¬ä»»"
        details: |
          æ—¢å­˜æ©Ÿèƒ½ã®å‰Šé™¤ã‚„æŒ™å‹•å¤‰æ›´ã‚’è¡Œã†å ´åˆã¯ã€PRæœ¬æ–‡ã«ç†ç”±ã¨ä»£æ›¿æ‰‹æ®µãƒ»ç§»è¡Œæ‰‹é †ã‚’æ˜è¨˜ã™ã‚‹ã€‚èª¬æ˜ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å·®ã—æˆ»ã™ã€‚
        blocking: true
        priority: "P.2-High"

      - check: "ç§˜å¯†æƒ…å ±ã®å³æ™‚ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"
        details: |
          ç§˜å¯†æƒ…å ±ã‚’èª¤ã£ã¦ã‚³ãƒŸãƒƒãƒˆã—ãŸå ´åˆã¯å³åº§ã«å‰Šé™¤ã—ã€ã‚­ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ãŸä¸Šã§å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼æ™‚ã«å¯¾å¿œçŠ¶æ³ã‚’å…±æœ‰ã™ã‚‹ã€‚ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã™ã‚‹ã¾ã§ã¯ãƒãƒ¼ã‚¸ç¦æ­¢ã€‚
        blocking: true
        priority: "P.1-Critical"

      - check: "PRã‚µã‚¤ã‚ºã¨å·®åˆ†ã®ç®¡ç†"
        details: |
          1 PR = 1 æ©Ÿèƒ½/ä¿®æ­£ã‚’å¾¹åº•ã—ã€å·¨å¤§å·®åˆ†ï¼ˆ>500è¡Œã€>20ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¯ã‚¿ã‚¹ã‚¯åˆ†å‰²ã‚’è¡Œã†ã€‚åˆ†å‰²ã›ãšã«æå‡ºã•ã‚ŒãŸå ´åˆã¯Q&Aå‰ã«ãƒªã‚¹ã‚³ãƒ¼ãƒ—ã™ã‚‹ã€‚
        blocking: false
        priority: "P.2-High"

      - check: "äº‹å‰è‡ªå·±ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"
        details: |
          ç”Ÿæˆç‰©å‰Šé™¤ï¼ãƒ†ã‚¹ãƒˆçµæœï¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼BREAKING CHANGE ã®æœ‰ç„¡ã‚’PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¾“ã£ã¦è‡ªå·±ãƒã‚§ãƒƒã‚¯ã—ã€çµæœã‚’æœ¬æ–‡ã«è¨˜è¼‰ã™ã‚‹ã€‚
        blocking: true
        priority: "P.2-High"

      - check: "ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—æœªå®Œäº†æ™‚ã®åœæ­¢æ¡ä»¶"
        details: |
          ä¸Šè¨˜ãƒ«ãƒ¼ãƒ«é•åãŒè¦‹ã¤ã‹ã£ãŸPRã¯ã€Œã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—å®Œäº†ã€ã‚³ãƒ¡ãƒ³ãƒˆã¨ä¿®æ­£ã®å†ãƒ—ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹ã¾ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒãƒ¼ã‚¸ã‚’åœæ­¢ã™ã‚‹ã€‚
        blocking: true
        priority: "P.1-Critical"

    description_quality:
      rules:
        - check: "PR title follows Conventional Commits"
          pattern: "^(feat|fix|refactor|docs|test|chore|security)(\\(.+\\))?: .+"
          blocking: false
          priority: "P.3-Medium"

        - check: "PR body contains summary"
          min_length: 50
          blocking: false
          priority: "P.3-Medium"

        - check: "PR body contains test plan"
          keywords: ["test", "testing", "verified"]
          blocking: false
          priority: "P.3-Medium"

    review_status:
      rules:
        - check: "At least 1 approval"
          threshold: ">= 1 approval"
          blocking: true
          priority: "P.2-High"
          exceptions:
            - condition: "author = Guardian"
              required_approvals: 0
            - condition: "quality:excellent AND agent:codegen"
              required_approvals: 0  # Auto-approve for CodeGenAgent excellent work

        - check: "No requested changes"
          threshold: "0 change requests"
          blocking: true
          priority: "P.2-High"

  # === Phase 4: è‡ªå‹•ãƒãƒ¼ã‚¸åˆ¤å®š (Auto-Merge Decision) ===
  auto_merge_criteria:
    description: "è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œã®æœ€çµ‚åˆ¤å®š"

    fast_track:
      description: "é«˜é€Ÿãƒãƒ¼ã‚¸ãƒˆãƒ©ãƒƒã‚¯ï¼ˆå³åº§ã«ãƒãƒ¼ã‚¸ï¼‰"
      conditions:
        all_of:
          - "All mandatory_checks passed"
          - "quality_score >= 95"
          - "quality:excellent label"
          - "No merge conflicts"
          - "files_changed <= 20"
          - "agent:codegen OR agent:deployment"
      action: "Auto-merge immediately with squash"

    standard_track:
      description: "æ¨™æº–ãƒãƒ¼ã‚¸ãƒˆãƒ©ãƒƒã‚¯ï¼ˆ1æ‰¿èªå¾Œã«ãƒãƒ¼ã‚¸ï¼‰"
      conditions:
        all_of:
          - "All mandatory_checks passed"
          - "quality_score >= 80"
          - "quality:good OR quality:excellent label"
          - "At least 1 approval"
      action: "Auto-merge after approval with squash"

    manual_review_required:
      description: "æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆï¼ˆGuardianæ‰¿èªå¿…è¦ï¼‰"
      conditions:
        any_of:
          - "quality_score < 80"
          - "Sev.2-High OR Sev.1-Critical label"
          - "files_changed > 50"
          - "type:security"
          - "phase:production"
      action: "Wait for Guardian approval"

    blocked:
      description: "ãƒãƒ¼ã‚¸ä¸å¯ï¼ˆæ”¹å–„å¿…é ˆï¼‰"
      conditions:
        any_of:
          - "Any mandatory_checks failed"
          - "quality_score < 70"
          - "quality:poor label"
          - "Merge conflicts exist"
      action: "Request changes, return to implementing"

  # === Phase 5: ãƒãƒ¼ã‚¸æˆ¦ç•¥ (Merge Strategy) ===
  merge_strategy:
    default: "squash"

    strategies:
      squash:
        description: "å…¨ã‚³ãƒŸãƒƒãƒˆã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹ï¼ˆæ¨å¥¨ï¼‰"
        use_when:
          - "Most PRs (default)"
          - "feature branches"
          - "bug fixes"
        commit_message_format: |
          {pr_title}

          {pr_body}

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: {agent_name} <noreply@anthropic.com>

      merge_commit:
        description: "ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆï¼ˆå±¥æ­´ä¿æŒï¼‰"
        use_when:
          - "Long-running feature branches"
          - "Release branches"
        preserve_history: true

      rebase:
        description: "ãƒªãƒ™ãƒ¼ã‚¹ã—ã¦ãƒãƒ¼ã‚¸ï¼ˆç·šå½¢å±¥æ­´ï¼‰"
        use_when:
          - "Small PRs with clean history"
          - "Single commit PRs"
        requires: "Clean commit history"

  # === Phase 6: ãƒã‚¹ãƒˆãƒãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Post-Merge Actions) ===
  post_merge_actions:
    required:
      - action: "Delete feature branch"
        timing: "Immediately after merge"

      - action: "Update Issue state to 'done'"
        timing: "Immediately after merge"
        label_change: "state:reviewing â†’ state:done"

      - action: "Close linked Issues"
        timing: "Immediately after merge"
        condition: "PR body contains 'Closes #N' or 'Fixes #N'"

      - action: "Trigger deployment workflow"
        timing: "After merge to main"
        workflow: "W5_Deployment"

      - action: "Notify Discord/Slack"
        timing: "After merge"
        message: "âœ… PR #{pr_number} merged: {pr_title}"

    optional:
      - action: "Update CHANGELOG.md"
        timing: "Weekly batch update"

      - action: "Generate release notes"
        timing: "On version tag"

  # === Phase 7: ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Escalation Rules) ===
  escalation:
    triggers:
      quality_failure:
        condition: "quality_score < 70 after 2 retries"
        escalate_to: "Guardian"
        action: "Manual review and guidance"

      security_issue:
        condition: "Sev.1-Critical OR Sev.2-High vulnerability"
        escalate_to: "CISO + TechLead"
        action: "Immediate remediation plan"

      deployment_failure:
        condition: "W5_Deployment failed on staging"
        escalate_to: "DevOps + TechLead"
        action: "Rollback and root cause analysis"

      complexity_too_high:
        condition: "files_changed > 100 OR lines_changed > 5000"
        escalate_to: "TechLead"
        action: "Architecture review and PR split"

  # === Phase 8: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨KPI (Metrics & KPIs) ===
  metrics:
    track:
      - metric: "Merge success rate"
        target: ">= 90%"

      - metric: "Average quality score"
        target: ">= 85"

      - metric: "Average PR review time"
        target: "<= 2 hours"

      - metric: "Auto-merge rate"
        target: ">= 70%"

      - metric: "Security issues caught pre-merge"
        target: "100%"

  # === Integration with Workflows ===
  workflow_integration:
    W4_Code_Review_QA:
      stage: 8
      decision_point: "Approval / Rejection"
      uses_rules:
        - "mandatory_checks"
        - "quality_score"
        - "auto_merge_criteria"
      output: "QualityReport (E6)"

    W5_Deployment:
      precondition: "PR merged to main"
      trigger: "post_merge_actions.trigger_deployment_workflow"

# Summary
summary:
  total_rule_categories: 8
  total_checks: 25
  quality_score_weight: 100
  passing_threshold: 80
  auto_merge_rate_target: 70

  philosophy: |
    "Quality gates ensure system integrity while enabling rapid iteration.
    Automate what can be measured. Escalate what requires judgment."
