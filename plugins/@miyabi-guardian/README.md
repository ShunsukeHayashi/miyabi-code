# Miyabi Guardian Plugin

**Version**: 2.0.0
**Category**: Security
**License**: Apache-2.0

**Guardian Agent** - æ‰‹å‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«éšœå®³å¯¾å¿œã€‚è‡ªå‹•åŒ–ã§ã¯å¯¾å¿œã§ããªã„é‡å¤§ãªå•é¡Œã«å¯¾ã—ã¦ã€é©åˆ‡ãªäººé–“ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹Agentã€‚

## Concept

Guardianï¼ˆå®ˆè­·è€…ï¼‰ã¯ã€Miyabiã‚·ã‚¹ãƒ†ãƒ ã®æœ€å¾Œã®ç ¦ã§ã™ã€‚

è‡ªå‹•åŒ–ã•ã‚ŒãŸAgentã§ã¯å¯¾å¿œã§ããªã„:
- ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«éšœå®³
- ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
- âš–ï¸ é‡è¦ãªæ„æ€æ±ºå®š
- ğŸ†˜ ç·Šæ€¥å¯¾å¿œ

ã‚’é©åˆ‡ãªäººé–“ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

## Installation

```bash
# ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹è¿½åŠ 
/plugin marketplace add customer-cloud/miyabi-private

# ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
/plugin install miyabi-guardian@miyabi-official-plugins

# Claude Code å†èµ·å‹•
```

## Escalation Matrix

### Severity Levels

| Level | åç§° | å¯¾å¿œæ™‚é–“ | ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…ˆ |
|-------|------|---------|------------------|
| **Sev.1** | Critical | å³åº§ | CTO + On-call |
| **Sev.2** | High | 1æ™‚é–“ä»¥å†… | TechLead |
| **Sev.3** | Medium | 24æ™‚é–“ä»¥å†… | æ‹…å½“é–‹ç™ºè€… |
| **Sev.4** | Low | 1é€±é–“ä»¥å†… | ãƒãƒƒã‚¯ãƒ­ã‚° |
| **Sev.5** | Trivial | å„ªå…ˆåº¦ä½ | ãƒãƒƒã‚¯ãƒ­ã‚° |

### Escalation Triggers

| ã‚«ãƒ†ã‚´ãƒª | ãƒˆãƒªã‚¬ãƒ¼ | Severity |
|---------|---------|----------|
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | ç§˜å¯†æƒ…å ±æ¼æ´©æ¤œå‡º | Sev.1 |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡º | Sev.1 |
| **ã‚¤ãƒ³ãƒ•ãƒ©** | æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ | Sev.1 |
| **ã‚¤ãƒ³ãƒ•ãƒ©** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹éšœå®³ | Sev.2 |
| **é–‹ç™º** | CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³éšœå®³ | Sev.2 |
| **é–‹ç™º** | ãƒ†ã‚¹ãƒˆå…¨å¤±æ•— | Sev.3 |
| **ãƒ“ã‚¸ãƒã‚¹** | é¡§å®¢å ±å‘Šã®ãƒã‚° | Sev.2 |
| **ãƒ“ã‚¸ãƒã‚¹** | SLAé•åãƒªã‚¹ã‚¯ | Sev.2 |

---

## Features

### 1. è‡ªå‹•æ¤œå‡º & ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Guardian Detection Flow                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Water Spiderâ”‚â”€â”€â”€â”€â–¶â”‚  Guardian   â”‚â”€â”€â”€â”€â–¶â”‚   Human     â”‚   â”‚
â”‚  â”‚ (Detection) â”‚     â”‚ (Escalation)â”‚     â”‚  (Response) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                   â”‚                   â”‚           â”‚
â”‚         â”‚                   â–¼                   â”‚           â”‚
â”‚         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚           â”‚
â”‚         â”‚            â”‚ Notificationâ”‚            â”‚           â”‚
â”‚         â”‚            â”‚ ãƒ»Lark      â”‚            â”‚           â”‚
â”‚         â”‚            â”‚ ãƒ»Phone     â”‚            â”‚           â”‚
â”‚         â”‚            â”‚ ãƒ»Email     â”‚            â”‚           â”‚
â”‚         â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚           â”‚
â”‚         â”‚                                       â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                    (Feedback Loop)                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å¤šãƒãƒ£ãƒãƒ«é€šçŸ¥

| ãƒãƒ£ãƒãƒ« | Sev.1 | Sev.2 | Sev.3+ |
|---------|-------|-------|--------|
| Lark | âœ… | âœ… | âœ… |
| é›»è©± | âœ… | âŒ | âŒ |
| SMS | âœ… | âœ… | âŒ |
| Email | âœ… | âœ… | âœ… |
| GitHub Issue | âœ… | âœ… | âœ… |

### 3. å¯¾å¿œè¿½è·¡

```
ğŸ“Š Incident #INC-2025-001
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Status: ğŸŸ¡ Investigating
Severity: Sev.1 Critical
Detected: 2025-11-29 09:15:00 UTC
Duration: 15 minutes

Timeline:
09:15 - Detected by WaterSpider
09:16 - Guardian escalated to On-call
09:18 - Acknowledged by @engineer
09:25 - Root cause identified
09:30 - Fix deployed (pending)

Current Assignee: @engineer
Next Escalation: CTO (if not resolved in 15m)
```

### 4. Post-Incident Review

ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè§£æ±ºå¾Œã®è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ:

```
ğŸ“‹ Post-Incident Report
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## Summary
- Incident: Database connection exhaustion
- Duration: 45 minutes
- Impact: 15% of users affected

## Timeline
[è©³ç´°ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³]

## Root Cause
Connection pool configuration issue

## Resolution
Increased pool size, added monitoring

## Action Items
- [ ] Add connection pool alerts
- [ ] Review pool sizing monthly
- [ ] Update runbook
```

---

## Usage

### æ‰‹å‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```
subagent_type: "GuardianAgent"
prompt: "æœ¬ç•ªç’°å¢ƒã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚Sev.2ã§ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„"
```

### è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼

GuardianAgentã¯é€šå¸¸ã€WaterSpiderã‹ã‚‰è‡ªå‹•çš„ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™:

```rust
// WaterSpiderå†…éƒ¨
if severity >= Sev2 {
    guardian.escalate(incident).await?;
}
```

---

## Configuration

### ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š

```json
{
  "guardian": {
    "escalation": {
      "sev1": {
        "channels": ["lark", "phone", "sms", "email"],
        "timeout_minutes": 5,
        "auto_escalate_to": "CTO"
      },
      "sev2": {
        "channels": ["lark", "email"],
        "timeout_minutes": 60,
        "auto_escalate_to": "TechLead"
      }
    },
    "on_call": {
      "primary": "@engineer1",
      "secondary": "@engineer2",
      "rotation": "weekly"
    }
  }
}
```

### On-call ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

```yaml
on_call_schedule:
  - week: 1
    primary: "@alice"
    secondary: "@bob"
  - week: 2
    primary: "@bob"
    secondary: "@charlie"
  - week: 3
    primary: "@charlie"
    secondary: "@alice"
```

---

## Runbooks

### Sev.1 å¯¾å¿œæ‰‹é †

```
ğŸš¨ Sev.1 Critical Incident Runbook
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Acknowledge (5åˆ†ä»¥å†…)
   - Larkã§ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç¢ºèª
   - æ‹…å½“ã‚’è¡¨æ˜

2. Assess (10åˆ†ä»¥å†…)
   - å½±éŸ¿ç¯„å›²ã‚’ç¢ºèª
   - æ ¹æœ¬åŸå› ã®ä»®èª¬

3. Communicate
   - ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã«é€šçŸ¥
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒšãƒ¼ã‚¸æ›´æ–°

4. Mitigate
   - ä¸€æ™‚çš„ãªå›é¿ç­–ã‚’å®Ÿæ–½
   - å½±éŸ¿ã‚’æœ€å°åŒ–

5. Resolve
   - æ ¹æœ¬çš„ãªä¿®æ­£ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
   - æ­£å¸¸æ€§ã‚’ç¢ºèª

6. Post-Incident
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
   - æŒ¯ã‚Šè¿”ã‚ŠãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°
```

---

## Metrics

| Metric | ç›®æ¨™ |
|--------|------|
| MTTA (Mean Time to Acknowledge) | <5åˆ† |
| MTTR (Mean Time to Resolve) | <1æ™‚é–“ (Sev.1) |
| ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ­£ç¢ºæ€§ | >95% |
| èª¤å ±ç‡ | <5% |

---

## Integration

### WaterSpideré€£æº

```
WaterSpider (æ¤œå‡º)
    â†“
Guardian (ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
    â†“
Human (å¯¾å¿œ)
    â†“
Guardian (è¿½è·¡)
    â†“
WaterSpider (ç›£è¦–ç¶™ç¶š)
```

### å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹

- **PagerDuty**: On-callç®¡ç†
- **Slack/Lark**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
- **Jira**: ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒã‚±ãƒƒãƒˆ
- **Statuspage**: å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

---

## Related Plugins

- [miyabi-water-spider](../miyabi-water-spider/) - ç›£è¦–Agent
- [miyabi-hooks](../miyabi-hooks/) - ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒƒã‚¯

---

**Author**: Shunsuke Hayashi
**Created**: 2025-11-29
**Version**: 2.0.0
