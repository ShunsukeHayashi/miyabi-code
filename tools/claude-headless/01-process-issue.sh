#!/bin/bash
# Miyabi Headless Mode: Issue è‡ªå‹•å‡¦ç†
# Usage: ./01-process-issue.sh <issue_number>

set -e

ISSUE_NUM="${1:-}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_DIR="/tmp/miyabi-headless"
mkdir -p "$LOG_DIR"

# ã‚«ãƒ©ãƒ¼å‡ºåŠ›
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# å¼•æ•°ãƒã‚§ãƒƒã‚¯
if [ -z "$ISSUE_NUM" ]; then
    log_error "Issueç•ªå·ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
    echo "Usage: $0 <issue_number>"
    exit 1
fi

log_info "=========================================="
log_info "Miyabi Headless Agent - Issue Processor"
log_info "=========================================="
log_info "Issueç•ªå·: #$ISSUE_NUM"
log_info "ãƒ¢ãƒ¼ãƒ‰: Headless (è‡ªå‹•å®Ÿè¡Œ)"
log_info "æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
log_info ""

# GitHub Issue å–å¾—
log_info "Issue æƒ…å ±ã‚’å–å¾—ä¸­..."
if ! gh issue view "$ISSUE_NUM" --json title,body,labels > "$LOG_DIR/issue-$ISSUE_NUM.json" 2>/dev/null; then
    log_error "Issue #$ISSUE_NUM ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    exit 1
fi

ISSUE_TITLE=$(jq -r '.title' "$LOG_DIR/issue-$ISSUE_NUM.json")
ISSUE_BODY=$(jq -r '.body' "$LOG_DIR/issue-$ISSUE_NUM.json")

log_success "Issueå–å¾—å®Œäº†: $ISSUE_TITLE"
log_info ""

# Claude Code Headless Mode ã§å‡¦ç†
log_info "Claude Code Headless Mode ã§åˆ†æä¸­..."

PROMPT="Analyze and process GitHub Issue #${ISSUE_NUM}:

Title: ${ISSUE_TITLE}

Description:
${ISSUE_BODY}

Instructions:
1. Analyze the issue and determine the required changes
2. List the files that need to be modified
3. Provide a step-by-step implementation plan
4. Estimate the complexity (Low/Medium/High)

Please respond with:
- Summary of the issue
- Required changes
- Implementation plan
- Complexity estimation
"

# Headless Mode å®Ÿè¡Œ
if ! claude -p "$PROMPT" \
    --output-format json \
    --allowedTools "Read,Grep,Bash(git log),Bash(cargo tree)" \
    > "$LOG_DIR/analysis-$ISSUE_NUM.json" 2>&1; then
    log_error "Claude Code Headless å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
    cat "$LOG_DIR/analysis-$ISSUE_NUM.json"
    exit 1
fi

log_success "åˆ†æå®Œäº†"
log_info ""

# çµæœã‚’è§£æ
RESULT=$(jq -r '.result' "$LOG_DIR/analysis-$ISSUE_NUM.json" 2>/dev/null || echo "")
COST=$(jq -r '.total_cost_usd' "$LOG_DIR/analysis-$ISSUE_NUM.json" 2>/dev/null || echo "0")
DURATION=$(jq -r '.duration_ms' "$LOG_DIR/analysis-$ISSUE_NUM.json" 2>/dev/null || echo "0")

if [ -z "$RESULT" ]; then
    log_error "çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
    cat "$LOG_DIR/analysis-$ISSUE_NUM.json"
    exit 1
fi

log_info "=========================================="
log_info "åˆ†æçµæœ"
log_info "=========================================="
echo "$RESULT"
log_info ""
log_info "å®Ÿè¡Œæ™‚é–“: ${DURATION}ms"
log_info "ã‚³ã‚¹ãƒˆ: \$${COST}"
log_info ""

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
REPORT_FILE="$LOG_DIR/report-$ISSUE_NUM.md"
cat > "$REPORT_FILE" << EOF
# Issue #${ISSUE_NUM} åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**Issue**: ${ISSUE_TITLE}
**åˆ†ææ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S')
**å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: Headless (è‡ªå‹•)
**å®Ÿè¡Œæ™‚é–“**: ${DURATION}ms
**ã‚³ã‚¹ãƒˆ**: \$${COST}

---

## åˆ†æçµæœ

${RESULT}

---

## ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

- Issueç•ªå·: #${ISSUE_NUM}
- åˆ†æãƒ­ã‚°: \`$LOG_DIR/analysis-$ISSUE_NUM.json\`
- Issueæƒ…å ±: \`$LOG_DIR/issue-$ISSUE_NUM.json\`

ğŸ¤– Generated by Miyabi Headless Agent
EOF

log_success "ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: $REPORT_FILE"

# Interactive Mode ã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if command -v osascript &> /dev/null; then
    osascript -e "display notification \"Issue #${ISSUE_NUM} ã®åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ\" with title \"Miyabi Headless Agent\" sound name \"Glass\""
fi

# VOICEVOX é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if [ -f "$PROJECT_ROOT/tools/voicevox_enqueue.sh" ]; then
    "$PROJECT_ROOT/tools/voicevox_enqueue.sh" "Issue ${ISSUE_NUM} ã®åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ"
fi

log_success "=========================================="
log_success "å‡¦ç†å®Œäº†"
log_success "=========================================="
log_info "ãƒ¬ãƒãƒ¼ãƒˆ: $REPORT_FILE"

exit 0
