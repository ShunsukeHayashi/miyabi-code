#!/usr/bin/env python3
"""
video-generator.py

éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆWAVï¼‰ã‹ã‚‰å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆMP4ï¼‰ã‚’ç”Ÿæˆ

ä½¿ç”¨ä¾‹:
    python video-generator.py --audio-dir ./output/audio --output ./output/video.mp4
"""

import argparse
import json
import subprocess
import sys
from pathlib import Path
from typing import List


class VideoGenerator:
    """VOICEVOXéŸ³å£°ã‹ã‚‰å‹•ç”»ã‚’ç”Ÿæˆ"""

    def __init__(self, audio_dir: Path, output_file: Path, thumbnail: Path = None):
        self.audio_dir = audio_dir
        self.output_file = output_file
        self.thumbnail = thumbnail or self._create_default_thumbnail()
        self.temp_dir = audio_dir.parent / "temp"
        self.temp_dir.mkdir(exist_ok=True)

    def _create_default_thumbnail(self) -> Path:
        """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’ç”Ÿæˆï¼ˆ1920x1080ã®å˜è‰²èƒŒæ™¯ï¼‰

        BytePlus ARK APIã§ç”Ÿæˆã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        """
        output_dir = self.audio_dir.parent
        thumbnail_path = output_dir / "thumbnail.png"

        if thumbnail_path.exists():
            # BytePlus ARK APIã§ç”Ÿæˆã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ä½¿ç”¨
            print(f"ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ä½¿ç”¨: {thumbnail_path}")
            return thumbnail_path

        # ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ç”Ÿæˆ
        print(f"âš ï¸  ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ç”Ÿæˆã—ã¾ã™...")

        # ffmpegã§å˜è‰²èƒŒæ™¯ç”»åƒã‚’ç”Ÿæˆ
        cmd = [
            "ffmpeg",
            "-f", "lavfi",
            "-i", "color=c=0x1a1a2e:s=1920x1080:d=1",
            "-frames:v", "1",
            "-y",
            str(thumbnail_path)
        ]
        subprocess.run(cmd, capture_output=True, check=True)
        print(f"âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ ãƒã‚¤ãƒ«ã‚’ç”Ÿæˆ: {thumbnail_path}")

        return thumbnail_path

    def collect_audio_files(self) -> List[Path]:
        """éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ã—ã¦ã‚½ãƒ¼ãƒˆ"""
        audio_files = sorted(self.audio_dir.glob("speaker*.wav"))
        if not audio_files:
            raise FileNotFoundError(f"éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {self.audio_dir}")

        print(f"ğŸ¤ {len(audio_files)}ä»¶ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º")
        return audio_files

    def concatenate_audio(self, audio_files: List[Path]) -> Path:
        """è¤‡æ•°ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã«é€£çµ"""
        concat_list = self.temp_dir / "concat_list.txt"
        merged_audio = self.temp_dir / "merged_audio.wav"

        # ffmpeg concatç”¨ã®ãƒªã‚¹ãƒˆä½œæˆ
        with open(concat_list, "w") as f:
            for audio_file in audio_files:
                f.write(f"file '{audio_file.absolute()}'\n")

        # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€£çµ
        cmd = [
            "ffmpeg",
            "-f", "concat",
            "-safe", "0",
            "-i", str(concat_list),
            "-c", "copy",
            "-y",
            str(merged_audio)
        ]

        subprocess.run(cmd, capture_output=True, check=True)
        print(f"âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€£çµ: {merged_audio}")

        return merged_audio

    def generate_video(self, merged_audio: Path) -> None:
        """éŸ³å£°ã¨ç”»åƒã‹ã‚‰å‹•ç”»ã‚’ç”Ÿæˆ"""
        print(f"ğŸ¬ å‹•ç”»ç”Ÿæˆé–‹å§‹: {self.output_file}")

        cmd = [
            "ffmpeg",
            "-loop", "1",                          # ç”»åƒã‚’ãƒ«ãƒ¼ãƒ—
            "-i", str(self.thumbnail),             # å…¥åŠ›ç”»åƒ
            "-i", str(merged_audio),               # å…¥åŠ›éŸ³å£°
            "-c:v", "libx264",                     # H.264ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€
            "-tune", "stillimage",                 # é™æ­¢ç”»æœ€é©åŒ–
            "-c:a", "aac",                         # AACã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
            "-b:a", "192k",                        # ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ
            "-pix_fmt", "yuv420p",                 # ãƒ”ã‚¯ã‚»ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            "-shortest",                           # éŸ³å£°ã®é•·ã•ã«åˆã‚ã›ã‚‹
            "-movflags", "+faststart",             # Webå†ç”Ÿæœ€é©åŒ–
            "-metadata", "title=Miyabié–‹ç™ºé€²æ— - ã‚†ã£ãã‚Šè§£èª¬",
            "-metadata", "artist=NarrationAgent",
            "-metadata", "comment=Generated by Miyabi NarrationAgent",
            "-y",
            str(self.output_file)
        ]

        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode != 0:
            print(f"âŒ å‹•ç”»ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {result.stderr}", file=sys.stderr)
            raise RuntimeError("ffmpeg execution failed")

        print(f"âœ… å‹•ç”»ç”Ÿæˆå®Œäº†: {self.output_file}")

    def get_video_info(self) -> dict:
        """ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã®æƒ…å ±ã‚’å–å¾—"""
        cmd = [
            "ffprobe",
            "-v", "quiet",
            "-print_format", "json",
            "-show_format",
            "-show_streams",
            str(self.output_file)
        ]

        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        info = json.loads(result.stdout)

        duration = float(info["format"]["duration"])
        size_mb = int(info["format"]["size"]) / (1024 * 1024)

        video_stream = next(s for s in info["streams"] if s["codec_type"] == "video")
        audio_stream = next(s for s in info["streams"] if s["codec_type"] == "audio")

        return {
            "file": str(self.output_file),
            "duration_sec": round(duration, 2),
            "size_mb": round(size_mb, 2),
            "resolution": f"{video_stream['width']}x{video_stream['height']}",
            "video_codec": video_stream["codec_name"],
            "audio_codec": audio_stream["codec_name"],
            "audio_bitrate": audio_stream.get("bit_rate", "N/A")
        }

    def cleanup(self) -> None:
        """ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        import shutil
        if self.temp_dir.exists():
            shutil.rmtree(self.temp_dir)
            print(f"ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤: {self.temp_dir}")

    def generate(self) -> dict:
        """å‹•ç”»ç”Ÿæˆã®å…¨å·¥ç¨‹ã‚’å®Ÿè¡Œ"""
        print("============================================================")
        print("ğŸ¬ Miyabié–‹ç™ºé€²æ— â†’ å‹•ç”»ç”Ÿæˆ")
        print("============================================================")

        # Step 1: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«åé›†
        audio_files = self.collect_audio_files()

        # Step 2: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«é€£çµ
        merged_audio = self.concatenate_audio(audio_files)

        # Step 3: å‹•ç”»ç”Ÿæˆ
        self.generate_video(merged_audio)

        # Step 4: å‹•ç”»æƒ…å ±å–å¾—
        info = self.get_video_info()

        # Step 5: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        self.cleanup()

        print("\n============================================================")
        print("âœ… å®Œäº†ï¼å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
        print("============================================================")
        print(f"ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: {info['file']}")
        print(f"â±ï¸  å†ç”Ÿæ™‚é–“: {info['duration_sec']}ç§’")
        print(f"ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: {info['size_mb']}MB")
        print(f"ğŸ“º è§£åƒåº¦: {info['resolution']}")
        print(f"ğŸï¸  Video Codec: {info['video_codec']}")
        print(f"ğŸ¤ Audio Codec: {info['audio_codec']}")
        print("\nğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
        print("  1. å‹•ç”»ã‚’ç¢ºèª: open", info['file'])
        print("  2. YouTubeã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
        print()

        return info


def main():
    parser = argparse.ArgumentParser(
        description="VOICEVOXéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‹•ç”»ã‚’ç”Ÿæˆ"
    )
    parser.add_argument(
        "-a", "--audio-dir",
        type=Path,
        default=Path("./output/audio"),
        help="éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ./output/audioï¼‰"
    )
    parser.add_argument(
        "-o", "--output",
        type=Path,
        default=Path("./output/miyabi-progress.mp4"),
        help="å‡ºåŠ›å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ./output/miyabi-progress.mp4ï¼‰"
    )
    parser.add_argument(
        "-t", "--thumbnail",
        type=Path,
        help="ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãƒ‘ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€æŒ‡å®šãªã—ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ç”Ÿæˆï¼‰"
    )

    args = parser.parse_args()

    # éŸ³å£°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
    if not args.audio_dir.exists():
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: éŸ³å£°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: {args.audio_dir}", file=sys.stderr)
        sys.exit(1)

    # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    args.output.parent.mkdir(parents=True, exist_ok=True)

    try:
        generator = VideoGenerator(args.audio_dir, args.output, args.thumbnail)
        info = generator.generate()

        # JSONå½¢å¼ã§æƒ…å ±ã‚’å‡ºåŠ›ï¼ˆCI/CDçµ±åˆç”¨ï¼‰
        print(json.dumps(info, indent=2, ensure_ascii=False))

    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
