# CloudWatch Dashboard for 200-Agent Experiment
# Issue: #883 - Phase 3: 200-Agent Live Experiment & Production Readiness
#
# Usage:
#   aws cloudformation deploy \
#     --template-file agent-dashboard.yaml \
#     --stack-name miyabi-agent-dashboard \
#     --capabilities CAPABILITY_IAM \
#     --parameter-overrides Environment=production

AWSTemplateFormatVersion: '2010-09-09'
Description: Miyabi 200-Agent Experiment Monitoring Dashboard

Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues:
      - staging
      - production
    Description: Environment name

  AlarmEmail:
    Type: String
    Default: ''
    Description: Email address for alarm notifications

  MaxAgents:
    Type: Number
    Default: 200
    Description: Maximum number of concurrent agents

Conditions:
  HasAlarmEmail: !Not [!Equals [!Ref AlarmEmail, '']]
  IsProduction: !Equals [!Ref Environment, 'production']

Resources:
  # =============================================================================
  # SNS Topic for Agent Alerts
  # =============================================================================
  AgentAlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'miyabi-${Environment}-agent-alarms'
      DisplayName: !Sub 'Miyabi Agent Alarms (${Environment})'
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: Miyabi-Orchestra

  AgentEmailSubscription:
    Type: AWS::SNS::Subscription
    Condition: HasAlarmEmail
    Properties:
      TopicArn: !Ref AgentAlarmTopic
      Protocol: email
      Endpoint: !Ref AlarmEmail

  # =============================================================================
  # Log Groups for Agents
  # =============================================================================
  AgentExecutionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/miyabi/${Environment}/agents/execution'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Component
          Value: agent-execution

  AgentMetricsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/miyabi/${Environment}/agents/metrics'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Component
          Value: agent-metrics

  OrchestratorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/miyabi/${Environment}/orchestrator'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Component
          Value: orchestrator

  # =============================================================================
  # Custom Metrics Namespace
  # =============================================================================
  # Note: Custom metrics are published via SDK/CLI, not created here

  # =============================================================================
  # CloudWatch Alarms - Agent Performance
  # =============================================================================
  AgentErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'miyabi-${Environment}-agent-error-rate'
      AlarmDescription: Agent error rate exceeds 5%
      MetricName: AgentErrorCount
      Namespace: !Sub 'Miyabi/${Environment}/Agents'
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: !If [IsProduction, 10, 5]
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AgentAlarmTopic
      OKActions:
        - !Ref AgentAlarmTopic

  AgentSpawnTimeAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'miyabi-${Environment}-agent-spawn-time'
      AlarmDescription: Agent spawn time exceeds 30 seconds
      MetricName: AgentSpawnTime
      Namespace: !Sub 'Miyabi/${Environment}/Agents'
      Statistic: Average
      Period: 60
      EvaluationPeriods: 3
      Threshold: 30000
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AgentAlarmTopic

  ConcurrentAgentsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'miyabi-${Environment}-concurrent-agents'
      AlarmDescription: Concurrent agents exceeds limit
      MetricName: ConcurrentAgents
      Namespace: !Sub 'Miyabi/${Environment}/Agents'
      Statistic: Maximum
      Period: 60
      EvaluationPeriods: 1
      Threshold: !Ref MaxAgents
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AgentAlarmTopic

  TaskQueueDepthAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'miyabi-${Environment}-task-queue-depth'
      AlarmDescription: Task queue depth exceeds threshold
      MetricName: TaskQueueDepth
      Namespace: !Sub 'Miyabi/${Environment}/Agents'
      Statistic: Average
      Period: 60
      EvaluationPeriods: 5
      Threshold: 500
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AgentAlarmTopic

  # =============================================================================
  # Log Metric Filters
  # =============================================================================
  AgentStartedMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AgentExecutionLogGroup
      FilterPattern: '[timestamp, level="INFO", msg="Agent started", ...]'
      MetricTransformations:
        - MetricName: AgentStarted
          MetricNamespace: !Sub 'Miyabi/${Environment}/Agents'
          MetricValue: '1'
          DefaultValue: 0

  AgentCompletedMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AgentExecutionLogGroup
      FilterPattern: '[timestamp, level="INFO", msg="Agent completed", ...]'
      MetricTransformations:
        - MetricName: AgentCompleted
          MetricNamespace: !Sub 'Miyabi/${Environment}/Agents'
          MetricValue: '1'
          DefaultValue: 0

  AgentFailedMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AgentExecutionLogGroup
      FilterPattern: '[timestamp, level="ERROR", ...]'
      MetricTransformations:
        - MetricName: AgentErrorCount
          MetricNamespace: !Sub 'Miyabi/${Environment}/Agents'
          MetricValue: '1'
          DefaultValue: 0

  # =============================================================================
  # Agent Monitoring Dashboard
  # =============================================================================
  AgentDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub 'Miyabi-Agents-${Environment}'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "text",
              "x": 0,
              "y": 0,
              "width": 24,
              "height": 2,
              "properties": {
                "markdown": "# Miyabi 200-Agent Experiment Dashboard\n**Environment:** ${Environment} | **Max Agents:** ${MaxAgents} | **Status:** Real-time (5s polling)"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 2,
              "width": 6,
              "height": 4,
              "properties": {
                "title": "Active Agents",
                "view": "singleValue",
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "ConcurrentAgents", {"stat": "Maximum", "period": 5}]
                ],
                "setPeriodToTimeRange": false
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 2,
              "width": 6,
              "height": 4,
              "properties": {
                "title": "Tasks Completed",
                "view": "singleValue",
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "AgentCompleted", {"stat": "Sum", "period": 3600}]
                ],
                "setPeriodToTimeRange": true
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 2,
              "width": 6,
              "height": 4,
              "properties": {
                "title": "Error Rate",
                "view": "singleValue",
                "region": "${AWS::Region}",
                "metrics": [
                  [{"expression": "errors/total*100", "label": "Error %", "id": "e1"}],
                  ["Miyabi/${Environment}/Agents", "AgentErrorCount", {"stat": "Sum", "period": 3600, "id": "errors", "visible": false}],
                  [".", "AgentStarted", {"stat": "Sum", "period": 3600, "id": "total", "visible": false}]
                ],
                "setPeriodToTimeRange": true
              }
            },
            {
              "type": "metric",
              "x": 18,
              "y": 2,
              "width": 6,
              "height": 4,
              "properties": {
                "title": "Avg Spawn Time",
                "view": "singleValue",
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "AgentSpawnTime", {"stat": "Average", "period": 300}]
                ],
                "setPeriodToTimeRange": true
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Agent Activity Over Time",
                "view": "timeSeries",
                "stacked": true,
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "AgentStarted", {"stat": "Sum", "period": 60, "color": "#2ca02c", "label": "Started"}],
                  [".", "AgentCompleted", {"stat": "Sum", "period": 60, "color": "#1f77b4", "label": "Completed"}],
                  [".", "AgentErrorCount", {"stat": "Sum", "period": 60, "color": "#d62728", "label": "Failed"}]
                ],
                "period": 60
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Concurrent Agents",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "ConcurrentAgents", {"stat": "Maximum", "period": 5, "color": "#9467bd"}]
                ],
                "annotations": {
                  "horizontal": [
                    {
                      "label": "Max Limit",
                      "value": ${MaxAgents},
                      "color": "#d62728"
                    },
                    {
                      "label": "Warning",
                      "value": 150,
                      "color": "#ff7f0e"
                    }
                  ]
                },
                "period": 5
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "Agent Spawn Time Distribution",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "AgentSpawnTime", {"stat": "Average", "period": 60, "label": "Average"}],
                  ["...", {"stat": "p50", "period": 60, "label": "p50"}],
                  ["...", {"stat": "p95", "period": 60, "label": "p95"}],
                  ["...", {"stat": "p99", "period": 60, "label": "p99"}]
                ],
                "period": 60,
                "annotations": {
                  "horizontal": [
                    {
                      "label": "Target (10s)",
                      "value": 10000,
                      "color": "#2ca02c"
                    },
                    {
                      "label": "Warning (30s)",
                      "value": 30000,
                      "color": "#d62728"
                    }
                  ]
                }
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "Task Execution Time",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "TaskExecutionTime", {"stat": "Average", "period": 60, "label": "Average"}],
                  ["...", {"stat": "p95", "period": 60, "label": "p95"}]
                ],
                "period": 60
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "Task Queue Depth",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "TaskQueueDepth", {"stat": "Average", "period": 60}]
                ],
                "period": 60
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "Agent Types Distribution",
                "view": "pie",
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "AgentTypeCount", "AgentType", "IssueAgent", {"stat": "Sum", "period": 3600}],
                  ["...", "CodeGenAgent", {"stat": "Sum", "period": 3600}],
                  ["...", "ReviewAgent", {"stat": "Sum", "period": 3600}],
                  ["...", "TestAgent", {"stat": "Sum", "period": 3600}],
                  ["...", "DocsAgent", {"stat": "Sum", "period": 3600}]
                ],
                "setPeriodToTimeRange": true
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "Resource Usage (CPU)",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["AWS/EC2", "CPUUtilization", "InstanceId", "i-mugen", {"stat": "Average", "period": 60, "label": "MUGEN"}],
                  ["...", "i-majin", {"stat": "Average", "period": 60, "label": "MAJIN"}]
                ],
                "period": 60,
                "annotations": {
                  "horizontal": [
                    {
                      "label": "Target (70%)",
                      "value": 70,
                      "color": "#2ca02c"
                    }
                  ]
                }
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "Cost per Task",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["Miyabi/${Environment}/Agents", "CostPerTask", {"stat": "Average", "period": 300, "color": "#17becf"}]
                ],
                "period": 300,
                "annotations": {
                  "horizontal": [
                    {
                      "label": "Target ($0.50)",
                      "value": 0.50,
                      "color": "#2ca02c"
                    }
                  ]
                }
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 24,
              "width": 24,
              "height": 6,
              "properties": {
                "title": "Recent Agent Errors",
                "region": "${AWS::Region}",
                "query": "SOURCE '/miyabi/${Environment}/agents/execution' | fields @timestamp, @message | filter @message like /ERROR/ | sort @timestamp desc | limit 20"
              }
            },
            {
              "type": "alarm",
              "x": 0,
              "y": 30,
              "width": 24,
              "height": 3,
              "properties": {
                "title": "Alarm Status",
                "alarms": [
                  "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:miyabi-${Environment}-agent-error-rate",
                  "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:miyabi-${Environment}-agent-spawn-time",
                  "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:miyabi-${Environment}-concurrent-agents",
                  "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:miyabi-${Environment}-task-queue-depth"
                ]
              }
            }
          ]
        }

Outputs:
  DashboardUrl:
    Description: URL to the Agent Monitoring Dashboard
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=Miyabi-Agents-${Environment}'

  AgentAlarmTopicArn:
    Description: ARN of the SNS topic for agent alarms
    Value: !Ref AgentAlarmTopic
    Export:
      Name: !Sub 'miyabi-${Environment}-agent-alarm-topic-arn'

  AgentExecutionLogGroupName:
    Description: Name of the agent execution log group
    Value: !Ref AgentExecutionLogGroup
    Export:
      Name: !Sub 'miyabi-${Environment}-agent-execution-log-group'

  AgentMetricsLogGroupName:
    Description: Name of the agent metrics log group
    Value: !Ref AgentMetricsLogGroup
    Export:
      Name: !Sub 'miyabi-${Environment}-agent-metrics-log-group'

  OrchestratorLogGroupName:
    Description: Name of the orchestrator log group
    Value: !Ref OrchestratorLogGroup
    Export:
      Name: !Sub 'miyabi-${Environment}-orchestrator-log-group'
