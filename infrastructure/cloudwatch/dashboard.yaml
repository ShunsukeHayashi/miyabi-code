# CloudWatch Dashboard CloudFormation Template
# Issue: #847 - CloudWatch監視ダッシュボード構築
#
# Usage:
#   aws cloudformation deploy \
#     --template-file dashboard.yaml \
#     --stack-name miyabi-cloudwatch-dashboard \
#     --parameter-overrides Environment=production

AWSTemplateFormatVersion: '2010-09-09'
Description: Miyabi CloudWatch Dashboard, Alarms, and Log Groups

Parameters:
  Environment:
    Type: String
    Default: staging
    AllowedValues:
      - staging
      - production
    Description: Environment name

  AlarmEmail:
    Type: String
    Default: ''
    Description: Email address for alarm notifications (optional)

  ApiServiceName:
    Type: String
    Default: miyabi-web-api
    Description: Name of the API service

  WebAppBucketName:
    Type: String
    Default: pantheon-webapp
    Description: Base name of the S3 bucket for webapp

  CloudFrontDistributionId:
    Type: String
    Default: ''
    Description: CloudFront distribution ID

Conditions:
  HasAlarmEmail: !Not [!Equals [!Ref AlarmEmail, '']]
  HasCloudFront: !Not [!Equals [!Ref CloudFrontDistributionId, '']]
  IsProduction: !Equals [!Ref Environment, 'production']

Resources:
  # =============================================================================
  # SNS Topic for Alarms
  # =============================================================================
  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'miyabi-${Environment}-alarms'
      DisplayName: !Sub 'Miyabi ${Environment} Alarms'
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: Miyabi

  AlarmEmailSubscription:
    Type: AWS::SNS::Subscription
    Condition: HasAlarmEmail
    Properties:
      TopicArn: !Ref AlarmTopic
      Protocol: email
      Endpoint: !Ref AlarmEmail

  # =============================================================================
  # Log Groups
  # =============================================================================
  ApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/miyabi/${Environment}/api'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ApiServiceName

  WebAppLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/miyabi/${Environment}/webapp'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: pantheon-webapp

  # =============================================================================
  # CloudWatch Alarms - API
  # =============================================================================
  ApiErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'miyabi-${Environment}-api-error-rate'
      AlarmDescription: API error rate exceeds threshold
      MetricName: HTTPCode_Target_5XX_Count
      Namespace: AWS/ApplicationELB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic
      Dimensions:
        - Name: LoadBalancer
          Value: !Sub 'miyabi-${Environment}-alb'

  ApiLatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'miyabi-${Environment}-api-latency'
      AlarmDescription: API latency exceeds threshold
      MetricName: TargetResponseTime
      Namespace: AWS/ApplicationELB
      Statistic: Average
      Period: 300
      EvaluationPeriods: 3
      Threshold: 2.0
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      Dimensions:
        - Name: LoadBalancer
          Value: !Sub 'miyabi-${Environment}-alb'

  # =============================================================================
  # CloudWatch Alarms - CloudFront
  # =============================================================================
  CloudFrontErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasCloudFront
    Properties:
      AlarmName: !Sub 'miyabi-${Environment}-cloudfront-error-rate'
      AlarmDescription: CloudFront 5xx error rate exceeds threshold
      MetricName: 5xxErrorRate
      Namespace: AWS/CloudFront
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      Dimensions:
        - Name: DistributionId
          Value: !Ref CloudFrontDistributionId
        - Name: Region
          Value: Global

  # =============================================================================
  # CloudWatch Dashboard
  # =============================================================================
  MiyabiDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub 'Miyabi-${Environment}'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "text",
              "x": 0,
              "y": 0,
              "width": 24,
              "height": 1,
              "properties": {
                "markdown": "# Miyabi ${Environment} Dashboard\n**API Service:** ${ApiServiceName} | **Environment:** ${Environment}"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 1,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "API Request Count",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["AWS/ApplicationELB", "RequestCount", "LoadBalancer", "miyabi-${Environment}-alb", {"stat": "Sum", "period": 60}]
                ],
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 1,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "API Response Time",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["AWS/ApplicationELB", "TargetResponseTime", "LoadBalancer", "miyabi-${Environment}-alb", {"stat": "Average", "period": 60}],
                  ["...", {"stat": "p95", "period": 60}],
                  ["...", {"stat": "p99", "period": 60}]
                ],
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 1,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "API Error Rate",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["AWS/ApplicationELB", "HTTPCode_Target_5XX_Count", "LoadBalancer", "miyabi-${Environment}-alb", {"stat": "Sum", "period": 60, "color": "#d62728"}],
                  [".", "HTTPCode_Target_4XX_Count", ".", ".", {"stat": "Sum", "period": 60, "color": "#ff7f0e"}]
                ],
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 7,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "CloudFront Requests",
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "metrics": [
                  ["AWS/CloudFront", "Requests", "DistributionId", "${CloudFrontDistributionId}", "Region", "Global", {"stat": "Sum", "period": 60}]
                ],
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 7,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "CloudFront Error Rate",
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "metrics": [
                  ["AWS/CloudFront", "4xxErrorRate", "DistributionId", "${CloudFrontDistributionId}", "Region", "Global", {"stat": "Average", "period": 60, "color": "#ff7f0e"}],
                  [".", "5xxErrorRate", ".", ".", ".", ".", {"stat": "Average", "period": 60, "color": "#d62728"}]
                ],
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 7,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "CloudFront Cache Hit Rate",
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "metrics": [
                  ["AWS/CloudFront", "CacheHitRate", "DistributionId", "${CloudFrontDistributionId}", "Region", "Global", {"stat": "Average", "period": 60}]
                ],
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 13,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "S3 Bucket Requests",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["AWS/S3", "AllRequests", "BucketName", "${WebAppBucketName}-${Environment}", "FilterId", "EntireBucket", {"stat": "Sum", "period": 60}]
                ],
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 13,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "RDS Database Connections",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "metrics": [
                  ["AWS/RDS", "DatabaseConnections", "DBInstanceIdentifier", "miyabi-${Environment}", {"stat": "Average", "period": 60}]
                ],
                "period": 300
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 19,
              "width": 24,
              "height": 6,
              "properties": {
                "title": "API Error Logs",
                "region": "${AWS::Region}",
                "query": "SOURCE '/miyabi/${Environment}/api' | fields @timestamp, @message | filter @message like /ERROR/ | sort @timestamp desc | limit 50"
              }
            },
            {
              "type": "alarm",
              "x": 0,
              "y": 25,
              "width": 24,
              "height": 3,
              "properties": {
                "title": "Alarm Status",
                "alarms": [
                  "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:miyabi-${Environment}-api-error-rate",
                  "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:miyabi-${Environment}-api-latency"
                ]
              }
            }
          ]
        }

  # =============================================================================
  # Log Metric Filters
  # =============================================================================
  ApiErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ApiLogGroup
      FilterPattern: 'ERROR'
      MetricTransformations:
        - MetricName: ApiErrorCount
          MetricNamespace: !Sub 'Miyabi/${Environment}'
          MetricValue: '1'
          DefaultValue: 0

  ApiWarningMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ApiLogGroup
      FilterPattern: 'WARN'
      MetricTransformations:
        - MetricName: ApiWarningCount
          MetricNamespace: !Sub 'Miyabi/${Environment}'
          MetricValue: '1'
          DefaultValue: 0

Outputs:
  DashboardUrl:
    Description: URL to the CloudWatch Dashboard
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=Miyabi-${Environment}'

  AlarmTopicArn:
    Description: ARN of the SNS topic for alarms
    Value: !Ref AlarmTopic
    Export:
      Name: !Sub 'miyabi-${Environment}-alarm-topic-arn'

  ApiLogGroupName:
    Description: Name of the API log group
    Value: !Ref ApiLogGroup
    Export:
      Name: !Sub 'miyabi-${Environment}-api-log-group'

  WebAppLogGroupName:
    Description: Name of the webapp log group
    Value: !Ref WebAppLogGroup
    Export:
      Name: !Sub 'miyabi-${Environment}-webapp-log-group'
