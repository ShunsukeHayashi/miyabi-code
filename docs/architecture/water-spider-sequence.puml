@startuml Water Spider Orchestrator - Task Flow Sequence
!theme materia-outline
title Water Spider Orchestrator - Task Flow Sequence\n<size:14>Issueä½œæˆ â†’ å®Œäº†ã¾ã§ã®å®Œå…¨ãƒ•ãƒ­ãƒ¼</size>

skinparam backgroundColor #f6f8fa
skinparam shadowing false
skinparam sequenceMessageAlign center

' ============================================
' Participants
' ============================================
actor "Developer" as dev #lightblue
participant "GitHub\nIssue" as issue #24292e
participant "Task Scheduler\nService" as scheduler #0366d6
participant "Priority\nCalculator" as calc #0366d6
participant "Task Queue" as queue #0366d6
participant "Task\nDispatcher" as dispatch #0366d6
participant "GitHub\nActions" as actions #24292e
participant "Self-hosted\nRunner" as runner #28a745
participant "Claude Code\nSession" as claude #6f42c1
participant "Git\nWorktree" as worktree #28a745
participant "Session Log\nManager" as logger #28a745
participant "PR" as pr #24292e

' ============================================
' 1. Issue Creation
' ============================================
group Issue Creation & Labeling
    dev -> issue : Create Issue #443\n"CI/CDåŸºç›¤æ§‹ç¯‰"
    activate issue

    dev -> issue : Add Labels\nP0-Critical\nstate:pending\ntype:infrastructure

    issue -> scheduler : Webhook Event\nissue.created
    activate scheduler

    scheduler -> scheduler : Parse Issue #443
    note right
        - ã‚¿ã‚¤ãƒˆãƒ«: CI/CDåŸºç›¤æ§‹ç¯‰
        - Priority: P0-Critical
        - State: pending
        - Dependencies: ãªã—
    end note
end

' ============================================
' 2. Priority Calculation
' ============================================
group Priority Calculation
    scheduler -> calc : Calculate Priority\nIssue #443
    activate calc

    calc -> calc : Check Labels\nP0-Critical = å„ªå…ˆåº¦100

    calc -> calc : Check Dependencies\nä¾å­˜ãªã— = å³å®Ÿè¡Œå¯èƒ½

    calc -> calc : Estimate Time\næ¨å®š45åˆ†

    calc -> scheduler : Priority Score: 100\nBlocked: false
    deactivate calc

    scheduler -> queue : Enqueue to\nPriority Queue
    activate queue

    note right of queue
        **Priority Queue**
        1. Issue #443 (P0, score:100)
        2. Issue #448 (P1, score:80)
        3. Issue #449 (P1, score:75)
    end note
end

' ============================================
' 3. Task Dispatch
' ============================================
group Task Dispatch
    queue -> dispatch : Dequeue\nIssue #443
    activate dispatch

    dispatch -> dispatch : Check Load\nç¾åœ¨: 2/5 ä¸¦åˆ—å®Ÿè¡Œä¸­

    dispatch -> dispatch : Assign to\nSelf-hosted Runner

    dispatch -> actions : workflow_dispatch\ntask-execute.yml\nwith: issue_number=443
    deactivate dispatch
    activate actions

    actions -> runner : Trigger Job
    deactivate actions
    activate runner

    runner -> runner : Setup Environment
    note right
        - Git clone/pull
        - .claude/ è¨­å®šèª­ã¿è¾¼ã¿
        - ç’°å¢ƒå¤‰æ•°è¨­å®š
    end note
end

' ============================================
' 4. Worktree Creation
' ============================================
group Worktree Creation
    runner -> worktree : Create Worktree\n.worktrees/issue-443
    activate worktree

    worktree -> worktree : git worktree add\n--track -b feature/issue-443

    worktree -> runner : Worktree Ready
end

' ============================================
' 5. Claude Code Session
' ============================================
group Claude Code Execution (æ™‚é–“æœ€å°åŒ–)
    runner -> claude : Start Headless Session
    activate claude

    note right of claude
        **å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**
        ```
        claude code --headless \
          --execute-command "/agent-run --issue 443" \
          --cwd .worktrees/issue-443 \
          --no-human-in-loop
        ```

        **åŸå‰‡**
        - 1 Session = 1 Issue
        - Human-in-the-loopç¦æ­¢
        - ãƒ­ã‚°ã¯Issue commentã«è¨˜éŒ²
    end note

    claude -> claude : Phase 1/4\nIssueåˆ†æãƒ»DAGæ§‹ç¯‰
    claude -> logger : Log Progress
    activate logger
    logger -> issue : Post Comment\n"âœ… Phase 1/4å®Œäº†:\nIssueåˆ†æãƒ»DAGæ§‹ç¯‰"
    deactivate logger

    claude -> claude : Phase 2/4\nã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
    claude -> logger : Log Progress
    activate logger
    logger -> issue : Post Comment\n"ğŸš§ Phase 2/4å®Ÿè¡Œä¸­:\nã‚³ãƒ¼ãƒ‰ç”Ÿæˆ..."
    deactivate logger

    claude -> worktree : git add .\ngit commit -m "feat: implement CI/CD..."
    worktree -> worktree : Commit\nfeature/issue-443

    claude -> claude : Phase 3/4\nãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    claude -> logger : Log Progress
    activate logger
    logger -> issue : Post Comment\n"ğŸ§ª Phase 3/4å®Ÿè¡Œä¸­:\nãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
    deactivate logger

    claude -> claude : Phase 4/4\nPRä½œæˆ
    claude -> worktree : git push origin\nfeature/issue-443

    claude -> pr : Create PR #123\ntitle: "feat: implement CI/CD foundation"\nbody: "Closes #443"
    activate pr

    claude -> logger : Log Completion
    activate logger
    logger -> issue : Post Comment\n"âœ… å®Œäº†: PR #123ä½œæˆ\n4ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ï¼ˆ+293/-1ï¼‰"
    deactivate logger

    claude -> runner : Session Complete\nExit Code: 0
    deactivate claude
end

' ============================================
' 6. Cleanup & Merge
' ============================================
group Cleanup & Integration
    runner -> worktree : Cleanup Worktree\ngit worktree remove
    deactivate worktree

    runner -> scheduler : Report Success\nIssue #443 completed
    deactivate runner

    scheduler -> queue : Update Queue\nRemove from Running
    deactivate queue
    deactivate scheduler

    pr -> issue : PR Merged
    pr -> issue : Close Issue #443\nstate:done
    deactivate pr
    deactivate issue

    note right of issue
        **Issue #443**
        State: done âœ…
        Closed via PR #123
    end note
end

' ============================================
' 7. Dependency Unblock
' ============================================
group Dependency Resolution
    scheduler -> scheduler : Scan Blocked Queue
    activate scheduler

    scheduler -> calc : Re-check Dependencies\nIssue #471 (depends on #443)
    activate calc

    calc -> calc : Check Status\nIssue #443: done âœ…

    calc -> scheduler : Dependencies Resolved\nIssue #471 ready
    deactivate calc

    scheduler -> queue : Move to Priority Queue\nIssue #471
    activate queue

    note right of queue
        **Priority Queue (Updated)**
        1. Issue #471 (P1, unblocked)
        2. Issue #448 (P1)
        3. Issue #449 (P1)
    end note

    queue -> dispatch : Trigger Next Task\nIssue #471
    activate dispatch

    dispatch -> actions : workflow_dispatch\nIssue #471
    deactivate dispatch
    deactivate queue
    deactivate scheduler

    note right of actions
        æ¬¡ã®ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé–‹å§‹...
        å®Œå…¨éåŒæœŸã§ç¶™ç¶š
    end note
end

@enduml
