# Miyabi Multi-Tenant Sandbox Architecture

## ğŸ¯ æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ç‹¬ç«‹ã—ãŸã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‚’è‡ªå‹•ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã™ã‚‹
ã€ŒMiyabié–‹ç™ºOSã€ã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã€‚

## ğŸ“Š è¨­è¨ˆæ–¹é‡

| é …ç›® | é¸æŠ | ç†ç”± |
|-----|------|------|
| ã‚¹ã‚±ãƒ¼ãƒ«ç›®æ¨™ | 10äºº â†’ 100äºº â†’ 1000äºº+ | æ®µéšçš„æ‹¡å¼µ |
| ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ | å€‹åˆ¥ãƒªãƒã‚¸ãƒˆãƒª | æ¨©é™åˆ†é›¢ãƒ»äº‹æ•…ãƒªã‚¹ã‚¯ä½ |
| ã‚¤ãƒ³ãƒ•ãƒ© | AWS ECS Fargate | ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ« |
| èªè¨¼ | GitHub OAuth + Cognito | ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå¯¾å¿œ |

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Layer                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¤ User A    ğŸ‘¤ User B    ğŸ‘¤ User C    ...    ğŸ‘¤ User N        â”‚
â”‚      â”‚            â”‚            â”‚                   â”‚            â”‚
â”‚      â–¼            â–¼            â–¼                   â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Miyabi Portal (Next.js)                     â”‚   â”‚
â”‚  â”‚         https://portal.miyabi-world.com                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Authentication Layer                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Cognito    â”‚  â”‚GitHub OAuth  â”‚  â”‚  OIDC/SAML   â”‚          â”‚
â”‚  â”‚  User Pool   â”‚â—„â”€â”¤   Provider   â”‚  â”‚ (Enterprise) â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚         User Registry (DynamoDB)                  â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚
â”‚  â”‚  â”‚ user_id â”‚ github_user â”‚ sandbox_repo â”‚ ... â”‚  â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Provisioning Layer                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚         Sandbox Provisioner (Lambda)              â”‚           â”‚
â”‚  â”‚                                                    â”‚           â”‚
â”‚  â”‚  1. Create GitHub repo from template              â”‚           â”‚
â”‚  â”‚  2. Generate GitHub App token                     â”‚           â”‚
â”‚  â”‚  3. Spin up ECS Task                              â”‚           â”‚
â”‚  â”‚  4. Inject environment variables                  â”‚           â”‚
â”‚  â”‚  5. Register sandbox in DynamoDB                  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                    â”‚                    â”‚              â”‚
â”‚         â–¼                    â–¼                    â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  GitHub    â”‚      â”‚    AWS     â”‚      â”‚  Secrets   â”‚        â”‚
â”‚  â”‚    API     â”‚      â”‚    ECS     â”‚      â”‚  Manager   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Sandbox Layer (per User)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ECS Cluster                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚  Sandbox A  â”‚ â”‚  Sandbox B  â”‚ â”‚  Sandbox C  â”‚ ...   â”‚   â”‚
â”‚  â”‚  â”‚ (Fargate)   â”‚ â”‚ (Fargate)   â”‚ â”‚ (Fargate)   â”‚       â”‚   â”‚
â”‚  â”‚  â”‚             â”‚ â”‚             â”‚ â”‚             â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ Miyabi  â”‚ â”‚ â”‚ â”‚ Miyabi  â”‚ â”‚ â”‚ â”‚ Miyabi  â”‚ â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â”‚  CLI    â”‚ â”‚ â”‚ â”‚  CLI    â”‚ â”‚ â”‚ â”‚  CLI    â”‚ â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â”‚  .env   â”‚ â”‚ â”‚ â”‚  .env   â”‚ â”‚ â”‚ â”‚  .env   â”‚ â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ User A  â”‚ â”‚ â”‚ â”‚ User B  â”‚ â”‚ â”‚ â”‚ User C  â”‚ â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    GitHub Repos                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ miyabi-    â”‚ â”‚ miyabi-    â”‚ â”‚ miyabi-    â”‚ ...       â”‚   â”‚
â”‚  â”‚  â”‚ sandbox-   â”‚ â”‚ sandbox-   â”‚ â”‚ sandbox-   â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ user-a     â”‚ â”‚ user-b     â”‚ â”‚ user-c     â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  User Onboarding Flow                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Authentication
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚â”€â”€â”€â–¶â”‚  Portal  â”‚â”€â”€â”€â–¶â”‚ Cognito  â”‚
â”‚  Login   â”‚    â”‚          â”‚    â”‚ + GitHub â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚ user_id  â”‚
                               â”‚ github   â”‚
                               â”‚ token    â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Check Existing Sandbox
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lambda   â”‚â”€â”€â”€â–¶â”‚ DynamoDB â”‚â”€â”€â”€â–¶â”‚ Sandbox  â”‚
â”‚ Check    â”‚    â”‚  Query   â”‚    â”‚ Exists?  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â–¼                         â–¼
                    [EXISTS]                  [NOT EXISTS]
                         â”‚                         â”‚
                         â–¼                         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Return URL   â”‚         â”‚ Provision    â”‚
                â”‚ + Status     â”‚         â”‚ New Sandbox  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: Provision New Sandbox (if needed)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  3a. Create GitHub Repo                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ GitHub  â”‚â”€â”€â”€â–¶â”‚ Fork/Create â”‚â”€â”€â”€â–¶â”‚ miyabi-sandbox- â”‚  â”‚
â”‚  â”‚   API   â”‚    â”‚ from Templateâ”‚   â”‚ {user_id}       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  3b. Generate Secrets                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Secrets â”‚â”€â”€â”€â–¶â”‚ Store Token â”‚â”€â”€â”€â–¶â”‚ /miyabi/users/  â”‚  â”‚
â”‚  â”‚ Manager â”‚    â”‚ & Configs   â”‚    â”‚ {user_id}/env   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  3c. Spin Up ECS Task                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ECS   â”‚â”€â”€â”€â–¶â”‚ Run Task    â”‚â”€â”€â”€â–¶â”‚ sandbox-{user}  â”‚  â”‚
â”‚  â”‚ Fargate â”‚    â”‚ Definition  â”‚    â”‚ container       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  3d. Register in DynamoDB                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚DynamoDB â”‚â”€â”€â”€â–¶â”‚ Put Item    â”‚                          â”‚
â”‚  â”‚         â”‚    â”‚ user_id,    â”‚                          â”‚
â”‚  â”‚         â”‚    â”‚ repo, ecs,  â”‚                          â”‚
â”‚  â”‚         â”‚    â”‚ status      â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: Return Sandbox Access
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚â—€â”€â”€â”€â”‚ Sandbox URL / SSH / WebIDE Access    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰
```
miyabi-infra/
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ cognito/           # èªè¨¼åŸºç›¤
â”‚   â”‚   â”œâ”€â”€ ecs-cluster/       # ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼
â”‚   â”‚   â”œâ”€â”€ sandbox-task/      # ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚¿ã‚¹ã‚¯å®šç¾©
â”‚   â”‚   â”œâ”€â”€ dynamodb/          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç®¡ç†
â”‚   â”‚   â””â”€â”€ secrets/           # Secrets Manager
â”‚   â”œâ”€â”€ environments/
â”‚   â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â””â”€â”€ production/
â”‚   â””â”€â”€ main.tf
â”œâ”€â”€ lambda/
â”‚   â”œâ”€â”€ sandbox-provisioner/   # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°Lambda
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ github.ts
â”‚   â”‚   â”œâ”€â”€ ecs.ts
â”‚   â”‚   â””â”€â”€ dynamodb.ts
â”‚   â””â”€â”€ sandbox-cleanup/       # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—Lambda
â””â”€â”€ docker/
    â””â”€â”€ miyabi-sandbox/        # ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠ
        â”œâ”€â”€ Dockerfile
        â””â”€â”€ entrypoint.sh
```

### ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```
miyabi-sandbox-template/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ miyabi-agents.yml
â”œâ”€â”€ .miyabi/
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ agents/
â”œâ”€â”€ src/
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

---

## ğŸ” ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠç”¨ (.env)
```bash
# ===== User Identity =====
MIYABI_USER_ID={{user_id}}
MIYABI_USER_EMAIL={{user_email}}
MIYABI_USER_GITHUB={{github_username}}

# ===== Repository Context =====
MIYABI_REPO_OWNER=customer-cloud
MIYABI_REPO_NAME=miyabi-sandbox-{{user_id}}
MIYABI_REPO_URL=https://github.com/customer-cloud/miyabi-sandbox-{{user_id}}

# ===== GitHub Authentication =====
GITHUB_TOKEN={{from_secrets_manager}}
GITHUB_APP_ID={{github_app_id}}
GITHUB_APP_PRIVATE_KEY={{from_secrets_manager}}

# ===== AWS Context =====
AWS_REGION=ap-northeast-1
MIYABI_SANDBOX_ID={{sandbox_id}}
MIYABI_ECS_TASK_ARN={{ecs_task_arn}}

# ===== Miyabi Config =====
MIYABI_ENV=sandbox
MIYABI_LOG_LEVEL=info
MIYABI_AGENT_TIMEOUT=300
```

---

## ğŸ“Š DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### miyabi-users
```
PK: user_id (String)
Attributes:
  - email: String
  - github_username: String
  - cognito_sub: String
  - created_at: String (ISO8601)
  - last_login: String (ISO8601)
  - plan: String (free/pro/enterprise)
```

### miyabi-sandboxes
```
PK: sandbox_id (String)
SK: user_id (String)
Attributes:
  - repo_name: String
  - repo_url: String
  - ecs_task_arn: String
  - ecs_task_id: String
  - status: String (provisioning/running/stopped/terminated)
  - created_at: String
  - last_active: String
  - cpu: Number
  - memory: Number
  - storage_gb: Number
GSI: user_id-index (user_id â†’ sandbox_id)
```

---

## ğŸ³ Dockerfile (miyabi-sandbox)

```dockerfile
FROM ubuntu:24.04

# System dependencies
RUN apt-get update && apt-get install -y \
    curl git vim tmux htop \
    build-essential pkg-config libssl-dev \
    nodejs npm \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update && apt-get install -y gh

# Install Miyabi CLI
RUN npm install -g @miyabi/cli

# Workspace setup
WORKDIR /workspace
ENV HOME=/workspace

# Entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]
```

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Phase 1**: åŸºç›¤æ§‹ç¯‰ (1-2é€±é–“)
   - [ ] Terraform ã§ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰
   - [ ] DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
   - [ ] Cognito + GitHub OAuth è¨­å®š

2. **Phase 2**: ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° (1é€±é–“)
   - [ ] Lambdaé–¢æ•°å®Ÿè£…
   - [ ] GitHub repo è‡ªå‹•ç”Ÿæˆ
   - [ ] ECS Task èµ·å‹•ãƒ­ã‚¸ãƒƒã‚¯

3. **Phase 3**: ãƒãƒ¼ã‚¿ãƒ«UI (1é€±é–“)
   - [ ] Next.js ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
   - [ ] ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç®¡ç†ç”»é¢
   - [ ] WebIDE / Terminal çµ±åˆ

4. **Phase 4**: æœ¬ç•ªåŒ– (1é€±é–“)
   - [ ] ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
   - [ ] ã‚³ã‚¹ãƒˆæœ€é©åŒ–
   - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
