@startuml command-hook-agent-integration
!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultFontName "Helvetica Neue"
skinparam shadowing false
skinparam linetype ortho

title Miyabi Complete Integration - Commands, Hooks, and 21 Agents

' ============================================
' Legend
' ============================================
legend top
  |= Symbol |= Meaning |
  | ğŸ¯ | Slash Command (Entry Point) |
  | ğŸª | Git Hook (Pre/Post Event) |
  | ğŸ¤– | Coding Agent (7) |
  | ğŸ’¼ | Business Agent (14) |
  | âš™ï¸ | Core System |
  | ğŸ“Š | Data Store |
  | ğŸ”” | Notification |
endlegend

' ============================================
' Actors & External Systems
' ============================================
actor "Developer" as dev #FFE0B2
cloud "GitHub" as github #B3E5FC
cloud "Anthropic API\n(Claude)" as anthropic #E1BEE7
cloud "VoiceVox" as voicevox #C5E1A5

' ============================================
' Slash Commands (18)
' ============================================
package "ğŸ¯ Slash Commands (18)" as commands #E8F4F8 {
  ' Development
  rectangle "/create-issue" as cmd_create #90CAF9
  rectangle "/test" as cmd_test #90CAF9
  rectangle "/verify" as cmd_verify #90CAF9
  rectangle "/review" as cmd_review #90CAF9

  ' Agent Execution
  rectangle "/agent-run" as cmd_agent #81C784
  rectangle "/miyabi-auto" as cmd_auto #81C784
  rectangle "/miyabi-infinity" as cmd_infinity #81C784
  rectangle "/miyabi-todos" as cmd_todos #81C784

  ' Deployment
  rectangle "/deploy" as cmd_deploy #FFB74D

  ' Documentation
  rectangle "/generate-docs" as cmd_docs #CE93D8
  rectangle "/generate-lp" as cmd_lp #CE93D8

  ' Reports
  rectangle "/daily-update" as cmd_daily #FFCC80
  rectangle "/check-benchmark" as cmd_benchmark #FFCC80

  ' Notifications
  rectangle "/session-end" as cmd_session #FFAB91

  ' VoiceVox
  rectangle "/voicevox" as cmd_voice #AED581
  rectangle "/narrate" as cmd_narrate #AED581
  rectangle "/watch-sprint" as cmd_watch #AED581

  ' Security
  rectangle "/security-scan" as cmd_security #EF9A9A
}

' ============================================
' Git Hooks (5)
' ============================================
package "ğŸª Git Hooks (5)" as hooks #FFF4E6 {
  rectangle "pre-commit" as hook_pre #FFE082
  rectangle "commit-msg" as hook_msg #FFE082
  rectangle "post-commit" as hook_post #FFE082
  rectangle "pre-push" as hook_push #FFE082
  rectangle "post-merge" as hook_merge #FFE082
}

' ============================================
' Coding Agents (7)
' ============================================
package "ğŸ¤– Coding Agents (7)" as coding_agents #E8F5E9 {
  rectangle "CoordinatorAgent\n(ã—ãã‚‹ã‚“)\nDAGåˆ†è§£ãƒ»çµ±æ‹¬" as agent_coord #66BB6A
  rectangle "IssueAgent\n(ã¿ã¤ã‘ã‚‹ã‚“)\nAI Labelæ¨è«–" as agent_issue #66BB6A
  rectangle "CodeGenAgent\n(ã¤ãã‚‹ã‚“)\nã‚³ãƒ¼ãƒ‰ç”Ÿæˆ" as agent_codegen #66BB6A
  rectangle "ReviewAgent\n(ã‚ã ã¾ã‚“)\nå“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼\n100ç‚¹æº€ç‚¹" as agent_review #66BB6A
  rectangle "PRAgent\n(ã¾ã¨ã‚ã‚‹ã‚“)\nPRè‡ªå‹•ä½œæˆ" as agent_pr #66BB6A
  rectangle "DeploymentAgent\n(ã¯ã“ã¶ã‚“)\nCI/CDãƒ‡ãƒ—ãƒ­ã‚¤" as agent_deploy #66BB6A
  rectangle "RefresherAgent\n(ã¤ãªãã‚“)\nIssueçŠ¶æ…‹ç›£è¦–" as agent_refresh #66BB6A
}

' ============================================
' Business Agents (14)
' ============================================
package "ğŸ’¼ Business Agents (14)" as business_agents #F3E5F5 {

  package "Strategy (6)" as strategy #EDE7F6 {
    rectangle "AIEntrepreneurAgent\nèµ·æ¥­å®¶æ”¯æ´" as agent_entrepreneur #BA68C8
    rectangle "ProductConceptAgent\nãƒ—ãƒ­ãƒ€ã‚¯ãƒˆæ§‹æƒ³" as agent_concept #BA68C8
    rectangle "ProductDesignAgent\nã‚µãƒ¼ãƒ“ã‚¹è©³ç´°è¨­è¨ˆ" as agent_design #BA68C8
    rectangle "PersonaAgent\nãƒšãƒ«ã‚½ãƒŠè¨­å®š" as agent_persona #BA68C8
    rectangle "SelfAnalysisAgent\nè‡ªå·±åˆ†æ" as agent_self #BA68C8
    rectangle "FunnelDesignAgent\nå°ç·šè¨­è¨ˆ" as agent_funnel #BA68C8
  }

  package "Marketing (5)" as marketing #E1BEE7 {
    rectangle "MarketResearchAgent\nå¸‚å ´èª¿æŸ»20ç¤¾+" as agent_market #AB47BC
    rectangle "MarketingAgent\nåºƒå‘Šãƒ»SEOæˆ¦ç•¥" as agent_marketing #AB47BC
    rectangle "ContentCreationAgent\nã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶ä½œ" as agent_content #AB47BC
    rectangle "SNSStrategyAgent\nSNSæˆ¦ç•¥" as agent_sns #AB47BC
    rectangle "YouTubeAgent\nYouTubeé‹ç”¨" as agent_youtube #AB47BC
  }

  package "Sales & CRM (3)" as sales #CE93D8 {
    rectangle "SalesAgent\nã‚»ãƒ¼ãƒ«ã‚¹æœ€é©åŒ–" as agent_sales #9C27B0
    rectangle "CRMAgent\né¡§å®¢ç®¡ç†" as agent_crm #9C27B0
    rectangle "AnalyticsAgent\nãƒ‡ãƒ¼ã‚¿åˆ†æ\nPDCAå®Ÿè¡Œ" as agent_analytics #9C27B0
  }
}

' ============================================
' Core Systems
' ============================================
package "âš™ï¸ Core Systems" as core #FFEBEE {
  rectangle "Water Spider\nOrchestrator\n24/7 Daemon" as orchestrator #EF5350
  rectangle "Git Worktree\nManager\nä¸¦åˆ—å®Ÿè¡Œ" as worktree #EF5350
  rectangle "LLM Gateway\nGPT-OSS-20B\nGroq/vLLM/Ollama" as llm #EF5350
  rectangle "Knowledge\nManager\nRAG System" as knowledge #EF5350
  rectangle "MCP Server\nJSON-RPC 2.0" as mcp #EF5350
}

' ============================================
' Data Stores
' ============================================
package "ğŸ“Š Data Stores" as datastores #ECEFF1 {
  database "GitHub Issues\nGitHub OS" as gh_issues #78909C
  database "Qdrant\nVector Store" as qdrant #78909C
  database "SQLite\nState DB" as sqlite #78909C
}

' ============================================
' Outputs & Notifications
' ============================================
package "ğŸ“¤ Outputs & Notifications" as outputs #FFF9C4 {
  rectangle "Pull Request" as out_pr #FFF176
  rectangle "Documentation" as out_docs #FFF176
  rectangle "Deployment" as out_deploy #FFF176
  rectangle "Voice Narration" as out_voice #FFF176
  rectangle "Daily Report" as out_report #FFF176
  rectangle "macOS Notification" as out_macos #FFF176
}

' ============================================
' Flow 1: Developer â†’ Commands
' ============================================
dev --> cmd_create : "1. Issueä½œæˆ"
dev --> cmd_agent : "2. Agentå®Ÿè¡Œ"
dev --> cmd_auto : "3. å…¨è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰"
dev --> cmd_infinity : "4. ç„¡é™Sprint"
dev --> cmd_test : "5. ãƒ†ã‚¹ãƒˆ"
dev --> cmd_deploy : "6. ãƒ‡ãƒ—ãƒ­ã‚¤"

' ============================================
' Flow 2: Commands â†’ GitHub
' ============================================
cmd_create --> github : "Issueä½œæˆ"
cmd_agent --> orchestrator : "Agentèµ·å‹•"
cmd_auto --> orchestrator : "å…¨è‡ªå‹•é–‹å§‹"
cmd_infinity --> orchestrator : "Infinity Sprint"
cmd_test --> hook_pre : "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
cmd_deploy --> agent_deploy : "ãƒ‡ãƒ—ãƒ­ã‚¤"

' ============================================
' Flow 3: GitHub â†’ Orchestrator
' ============================================
github --> orchestrator : "Webhook\n(issue.opened)"
github --> agent_refresh : "Issueç›£è¦–"

' ============================================
' Flow 4: Orchestrator â†’ IssueAgent
' ============================================
orchestrator --> agent_issue : "Issueåˆ†æ"
agent_issue --> anthropic : "AIæ¨è«–"
agent_issue --> github : "Labelä»˜ä¸"
agent_issue --> orchestrator : "åˆ†æçµæœ"

' ============================================
' Flow 5: Orchestrator â†’ CoordinatorAgent
' ============================================
orchestrator --> agent_coord : "ã‚¿ã‚¹ã‚¯çµ±æ‹¬"
agent_coord --> anthropic : "DAGåˆ†è§£"
agent_coord --> worktree : "Worktreeä½œæˆ"
agent_coord --> sqlite : "Taskä¿å­˜"

' ============================================
' Flow 6: CoordinatorAgent â†’ CodeGenAgent
' ============================================
agent_coord --> agent_codegen : "ä¸¦åˆ—å®Ÿè¡Œ\n(3ä¸¦åˆ—)"
agent_codegen --> llm : "ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ"
agent_codegen --> hook_pre : "git add"

' ============================================
' Flow 7: Git Hooks â†’ Agents
' ============================================
hook_pre --> cmd_test : "cargo test"
hook_pre --> cmd_security : "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³"
hook_pre --> agent_review : "Clippy check"

hook_msg --> agent_review : "Conventional\nCommitsæ¤œè¨¼"

hook_post --> voicevox : "éŸ³å£°é€šçŸ¥"
hook_post --> out_voice

hook_push --> cmd_test : "Full test suite"
hook_push --> agent_review : "æœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯"

hook_merge --> agent_deploy : "ãƒãƒ¼ã‚¸å¾Œ\nãƒ‡ãƒ—ãƒ­ã‚¤"

' ============================================
' Flow 8: ReviewAgent â†’ Feedback
' ============================================
agent_review --> anthropic : "å“è³ªåˆ†æ"
agent_review --> agent_codegen : "Feedback\n(score < 80)"
agent_review --> github : "ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿"

' ============================================
' Flow 9: CodeGenAgent â†’ PRAgent
' ============================================
agent_codegen --> agent_pr : "ã‚¿ã‚¹ã‚¯å®Œäº†"
agent_pr --> github : "PRä½œæˆ"
agent_pr --> out_pr

' ============================================
' Flow 10: DeploymentAgent
' ============================================
agent_pr --> hook_merge : "PR merge"
hook_merge --> agent_deploy
agent_deploy --> out_deploy : "Firebase/Cloud Run"

' ============================================
' Flow 11: Documentation Commands
' ============================================
cmd_docs --> agent_codegen : "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ"
agent_codegen --> out_docs : "Markdownç”Ÿæˆ"

cmd_lp --> agent_marketing : "LPç”Ÿæˆ"
agent_marketing --> out_docs : "HTMLç”Ÿæˆ"

' ============================================
' Flow 12: Report Commands
' ============================================
cmd_daily --> agent_analytics : "é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ"
agent_analytics --> qdrant : "ãƒ‡ãƒ¼ã‚¿åé›†"
agent_analytics --> out_report : "note.comæŠ•ç¨¿ç”¨"

' ============================================
' Flow 13: VoiceVox Commands
' ============================================
cmd_voice --> voicevox : "å˜ç™ºèª­ã¿ä¸Šã’"
cmd_narrate --> voicevox : "Git commitãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
cmd_watch --> voicevox : "Sprintãƒ­ã‚°ç›£è¦–"

voicevox --> out_voice

' ============================================
' Flow 14: Notification Commands
' ============================================
cmd_session --> out_macos : "ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†é€šçŸ¥"
out_macos --> dev : "ğŸ®éŸ³å£°é€šçŸ¥"

' ============================================
' Flow 15: Business Agents (On-Demand)
' ============================================
cmd_agent --> agent_persona : "/agent-run persona"
cmd_agent --> agent_market : "/agent-run market-research"
cmd_agent --> agent_entrepreneur : "/agent-run ai-entrepreneur"
cmd_agent --> agent_sales : "/agent-run sales"

agent_persona --> anthropic
agent_market --> anthropic
agent_entrepreneur --> anthropic
agent_sales --> anthropic

agent_persona --> out_docs : "ãƒšãƒ«ã‚½ãƒŠå®šç¾©æ›¸"
agent_market --> out_report : "å¸‚å ´èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ"
agent_entrepreneur --> out_docs : "ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³"
agent_sales --> out_report : "ã‚»ãƒ¼ãƒ«ã‚¹æˆ¦ç•¥"

' ============================================
' Flow 16: Knowledge & MCP Integration
' ============================================
agent_codegen --> knowledge : "Contextæ¤œç´¢"
agent_review --> knowledge : "ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢"
agent_issue --> knowledge : "é¡ä¼¼Issueæ¤œç´¢"

knowledge --> qdrant : "Vectoræ¤œç´¢"
knowledge --> mcp : "MCP ServerçµŒç”±"
mcp --> knowledge : "Context7ç­‰"

' ============================================
' Flow 17: RefresherAgent Monitoring
' ============================================
agent_refresh --> gh_issues : "IssueçŠ¶æ…‹ç›£è¦–"
agent_refresh --> orchestrator : "å†ãƒˆãƒªã‚¬ãƒ¼\n(staleæ™‚)"

' ============================================
' Flow 18: All Agents â†’ Data Stores
' ============================================
agent_coord --> sqlite : "TaskçŠ¶æ…‹ä¿å­˜"
agent_codegen --> sqlite : "å®Ÿè¡Œãƒ­ã‚°"
agent_review --> sqlite : "å“è³ªã‚¹ã‚³ã‚¢"
agent_deploy --> sqlite : "ãƒ‡ãƒ—ãƒ­ã‚¤å±¥æ­´"

agent_issue --> qdrant : "Issue Embedding"
agent_codegen --> qdrant : "Code Embedding"
agent_review --> qdrant : "Review Embedding"

' ============================================
' Notes
' ============================================
note right of commands
  **18 Slash Commands**

  Development: 4
  Agent: 4
  Deployment: 1
  Documentation: 2
  Reports: 2
  Notifications: 1
  VoiceVox: 3
  Security: 1

  **Metrics**
  â€¢ Avg execution: 30s-5min
  â€¢ Success rate: 95%
  â€¢ Daily usage: ~50 calls
end note

note right of hooks
  **5 Git Hooks**

  â€¢ pre-commit: Test + Security
  â€¢ commit-msg: Conventional Commits
  â€¢ post-commit: Voice notification
  â€¢ pre-push: Full test + Review
  â€¢ post-merge: Deploy

  **Metrics**
  â€¢ Trigger rate: 100% (commits)
  â€¢ Abort rate: 5% (pre-commit fail)
  â€¢ Avg hook time: 15-45s
end note

note bottom of coding_agents
  **7 Coding Agents**

  1. Coordinator: DAGåˆ†è§£ (1-2min)
  2. Issue: AI Labelæ¨è«– (30s)
  3. CodeGen: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (3-5min)
  4. Review: å“è³ªãƒã‚§ãƒƒã‚¯ (2-3min)
  5. PR: PRè‡ªå‹•ä½œæˆ (1min)
  6. Deployment: CI/CD (5-10min)
  7. Refresher: ç›£è¦–ãƒ»å†å®Ÿè¡Œ (10s)

  **Metrics**
  â€¢ Avg issue resolution: 15-25min
  â€¢ Success rate: 87%
  â€¢ Retry rate: 13%
  â€¢ Parallel capacity: 3 concurrent
  â€¢ Quality threshold: 80/100
end note

note bottom of business_agents
  **14 Business Agents**

  Strategy (6):
  - AIEntrepreneur, ProductConcept,
    ProductDesign, Persona,
    SelfAnalysis, FunnelDesign

  Marketing (5):
  - MarketResearch, Marketing,
    ContentCreation, SNSStrategy,
    YouTube

  Sales & CRM (3):
  - Sales, CRM, Analytics

  **å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼**: /agent-run æ˜ç¤ºçš„å®Ÿè¡Œ
  **ç”¨é€”**: ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥ãƒ»æˆé•·æ”¯æ´
end note

note left of orchestrator
  **Water Spider Orchestrator**

  â€¢ 24/7 Daemonå‹•ä½œ
  â€¢ GitHub Webhookå—ä¿¡
  â€¢ Agentä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡
  â€¢ Worktreeç®¡ç†
  â€¢ çŠ¶æ…‹DBç®¡ç†
  â€¢ å¤±æ•—æ™‚ãƒªãƒˆãƒ©ã‚¤
end note

note right of worktree
  **Git Worktreeä¸¦åˆ—å®Ÿè¡Œ**

  Issue #270 â†’ .worktrees/issue-270
  Issue #271 â†’ .worktrees/issue-271
  Issue #272 â†’ .worktrees/issue-272

  å„Worktreeç‹¬ç«‹
  â†’ ãƒ•ã‚¡ã‚¤ãƒ«ç«¶åˆãªã—
  â†’ å®Œå…¨ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½
end note

note left of llm
  **LLM Gateway**

  Primary: GPT-OSS-20B
  Fallback:
  - Groq (é€Ÿåº¦å„ªå…ˆ)
  - vLLM (ã‚³ã‚¹ãƒˆå„ªå…ˆ)
  - Ollama (ãƒ­ãƒ¼ã‚«ãƒ«)

  è‡ªå‹•Retry + Fallback
end note

note right of knowledge
  **Knowledge Manager**

  â€¢ RAG System
  â€¢ Vector Search (Qdrant)
  â€¢ Similar Issueæ¤œç´¢
  â€¢ Code Patternæ¤œç´¢
  â€¢ Context7çµ±åˆ (MCP)
end note

note bottom of datastores
  **3ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢**

  1. GitHub Issues: GitHub OS
     - ã‚¿ã‚¹ã‚¯ç®¡ç†
     - Labelä½“ç³» (53å€‹)

  2. Qdrant: Vector Store
     - Issue Embedding
     - Code Embedding
     - RAGæ¤œç´¢

  3. SQLite: State DB
     - TaskçŠ¶æ…‹
     - å®Ÿè¡Œãƒ­ã‚°
     - å“è³ªã‚¹ã‚³ã‚¢
end note

note bottom of outputs
  **5ã¤ã®å‡ºåŠ›**

  1. Pull Request
  2. Documentation (Markdown/HTML)
  3. Deployment (Firebase/Cloud)
  4. Voice Narration (VoiceVox)
  5. Daily Report (note.com)
  6. macOS Notification (ğŸ®éŸ³å£°)
end note

@enduml
