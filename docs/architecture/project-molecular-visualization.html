<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miyabi Molecular Project Visualization (Protein-like)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #000;
      color: #0f0;
      overflow: hidden;
    }

    #canvas-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Scientific HUD */
    .hud {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 100;
    }

    .hud-corner {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #0f0;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      pointer-events: auto;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }

    .hud-top-left {
      top: 20px;
      left: 20px;
      min-width: 300px;
    }

    .hud-top-right {
      top: 20px;
      right: 20px;
      min-width: 250px;
    }

    .hud-bottom-left {
      bottom: 20px;
      left: 20px;
      max-width: 400px;
      max-height: 250px;
      overflow-y: auto;
    }

    .hud-bottom-right {
      bottom: 20px;
      right: 20px;
      min-width: 300px;
    }

    .hud-title {
      color: #0ff;
      font-size: 1.1rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-bottom: 1px solid #0f0;
      padding-bottom: 5px;
    }

    .hud-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(0, 255, 0, 0.2);
    }

    .hud-label {
      color: #0f0;
    }

    .hud-value {
      color: #0ff;
      font-weight: bold;
    }

    .residue-list {
      max-height: 150px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .residue-item {
      padding: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .residue-item:hover {
      background: rgba(0, 255, 0, 0.2);
    }

    .residue-item.active {
      background: rgba(0, 255, 255, 0.3);
      border-left: 3px solid #0ff;
    }

    .activity-log {
      font-size: 0.75rem;
      line-height: 1.6;
    }

    .log-line {
      padding: 3px 0;
      animation: blink 0.5s;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .log-line.error { color: #f00; }
    .log-line.warning { color: #ff0; }
    .log-line.info { color: #0ff; }
    .log-line.success { color: #0f0; }

    /* Representation controls */
    .repr-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .repr-btn {
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid #0f0;
      color: #0f0;
      padding: 8px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      transition: all 0.3s;
      text-align: center;
    }

    .repr-btn:hover {
      background: rgba(0, 255, 0, 0.3);
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    .repr-btn.active {
      background: rgba(0, 255, 255, 0.3);
      border-color: #0ff;
      color: #0ff;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
    }

    /* B-factor scale */
    .bfactor-scale {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .scale-gradient {
      flex: 1;
      height: 20px;
      background: linear-gradient(90deg, #00f 0%, #0ff 25%, #0f0 50%, #ff0 75%, #f00 100%);
      border: 1px solid #0f0;
    }

    .scale-label {
      font-size: 0.7rem;
      color: #0f0;
    }

    /* Chain selector */
    .chain-selector {
      display: flex;
      gap: 5px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .chain-btn {
      width: 30px;
      height: 30px;
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid #0f0;
      color: #0f0;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: all 0.2s;
    }

    .chain-btn:hover,
    .chain-btn.active {
      background: rgba(0, 255, 255, 0.3);
      border-color: #0ff;
      color: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 255, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 255, 0, 0.5);
    }

    /* Loading */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1000;
    }

    .loading-text {
      font-size: 1.5rem;
      color: #0f0;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Measurement line */
    .measurement-info {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #0ff;
      padding: 15px;
      font-family: 'Courier New', monospace;
      color: #0ff;
      display: none;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- Canvas -->
  <div id="canvas-container"></div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="loading-text">
      &gt; LOADING MOLECULAR STRUCTURE...<br>
      &gt; INITIALIZING VMD RENDERER...<br>
      &gt; CALCULATING COORDINATES...
    </div>
  </div>

  <!-- HUD Panels -->
  <div class="hud">
    <!-- Top Left: Structure Info -->
    <div class="hud-corner hud-top-left">
      <div class="hud-title">▶ STRUCTURE INFO</div>
      <div class="hud-row">
        <span class="hud-label">PDB ID:</span>
        <span class="hud-value">MIYB</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">CHAINS:</span>
        <span class="hud-value" id="chainCount">0</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">RESIDUES:</span>
        <span class="hud-value" id="residueCount">0</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">ATOMS:</span>
        <span class="hud-value" id="atomCount">0</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">BONDS:</span>
        <span class="hud-value" id="bondCount">0</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">RESOLUTION:</span>
        <span class="hud-value">1.0 Å</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">TEMP (AVG):</span>
        <span class="hud-value" id="avgTemp">0.0</span>
      </div>

      <div class="chain-selector" id="chainSelector"></div>
    </div>

    <!-- Top Right: Representation -->
    <div class="hud-corner hud-top-right">
      <div class="hud-title">▶ REPRESENTATION</div>
      <div class="repr-controls">
        <button class="repr-btn active" onclick="setRepresentation('ball-stick')">Ball & Stick</button>
        <button class="repr-btn" onclick="setRepresentation('spacefill')">Spacefill</button>
        <button class="repr-btn" onclick="setRepresentation('ribbon')">Ribbon</button>
        <button class="repr-btn" onclick="setRepresentation('cartoon')">Cartoon</button>
        <button class="repr-btn" onclick="setRepresentation('surface')">Surface</button>
        <button class="repr-btn" onclick="setRepresentation('trace')">Trace</button>
      </div>

      <div style="margin-top: 15px;">
        <div class="hud-title" style="font-size: 0.9rem;">▶ COLORING</div>
        <div class="repr-controls">
          <button class="repr-btn" onclick="setColoring('chain')">By Chain</button>
          <button class="repr-btn active" onclick="setColoring('bfactor')">By B-factor</button>
          <button class="repr-btn" onclick="setColoring('activity')">By Activity</button>
          <button class="repr-btn" onclick="setColoring('type')">By Type</button>
        </div>
      </div>

      <div class="bfactor-scale">
        <span class="scale-label">LOW</span>
        <div class="scale-gradient"></div>
        <span class="scale-label">HIGH</span>
      </div>
    </div>

    <!-- Bottom Left: Residue List -->
    <div class="hud-corner hud-bottom-left">
      <div class="hud-title">▶ RESIDUE LIST</div>
      <div class="residue-list" id="residueList"></div>
    </div>

    <!-- Bottom Right: Activity Log -->
    <div class="hud-corner hud-bottom-right">
      <div class="hud-title">▶ SIMULATION LOG</div>
      <div class="activity-log" id="activityLog"></div>
    </div>
  </div>

  <!-- Measurement Info -->
  <div class="measurement-info" id="measurementInfo">
    Distance: <span id="distanceValue">0.0</span> Å
  </div>

  <script>
    // Three.js globals
    let scene, camera, renderer, controls;
    let atoms = [];
    let bonds = [];
    let currentRepresentation = 'ball-stick';
    let currentColoring = 'bfactor';

    // Molecular data (simulating protein structure)
    const chains = [
      {
        id: 'A',
        name: 'Core',
        residues: [
          { id: 1, name: 'miyabi-core', type: 'GLY', bfactor: 45.2, activity: 0.9 },
          { id: 2, name: 'miyabi-types', type: 'ALA', bfactor: 32.1, activity: 0.6 },
          { id: 3, name: 'miyabi-cli', type: 'VAL', bfactor: 28.5, activity: 0.3 },
        ]
      },
      {
        id: 'B',
        name: 'Agents',
        residues: [
          { id: 4, name: 'miyabi-agents', type: 'LEU', bfactor: 52.8, activity: 0.95 },
          { id: 5, name: 'miyabi-agent-codegen', type: 'ILE', bfactor: 48.3, activity: 0.85 },
          { id: 6, name: 'miyabi-agent-review', type: 'PRO', bfactor: 41.7, activity: 0.7 },
        ]
      },
      {
        id: 'C',
        name: 'Infrastructure',
        residues: [
          { id: 7, name: 'miyabi-web-api', type: 'PHE', bfactor: 49.5, activity: 0.88 },
          { id: 8, name: 'miyabi-llm', type: 'TYR', bfactor: 38.9, activity: 0.65 },
          { id: 9, name: 'miyabi-github', type: 'TRP', bfactor: 25.3, activity: 0.4 },
          { id: 10, name: 'miyabi-worktree', type: 'SER', bfactor: 36.4, activity: 0.58 },
        ]
      }
    ];

    // Initialize
    function init() {
      // Scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      scene.fog = new THREE.Fog(0x000000, 50, 200);

      // Camera
      camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        500
      );
      camera.position.set(50, 30, 50);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // Lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 3);
      scene.add(ambientLight);

      const pointLight1 = new THREE.PointLight(0x00ff00, 1, 150);
      pointLight1.position.set(50, 50, 50);
      scene.add(pointLight1);

      const pointLight2 = new THREE.PointLight(0x00ffff, 0.8, 150);
      pointLight2.position.set(-50, 30, -50);
      scene.add(pointLight2);

      // Create molecular structure
      createMolecularStructure();

      // UI
      updateChainSelector();
      updateResidueList();
      updateStats();

      // Events
      window.addEventListener('resize', onWindowResize);

      // Hide loading
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        addLog('success', '&gt; STRUCTURE LOADED SUCCESSFULLY');
        addLog('info', `&gt; TOTAL RESIDUES: ${chains.reduce((sum, c) => sum + c.residues.length, 0)}`);
        addLog('info', '&gt; READY FOR ANALYSIS');
      }, 2000);

      // Start simulation
      startMolecularDynamics();

      // Animate
      animate();
    }

    // Create molecular structure
    function createMolecularStructure() {
      const radius = 25;

      chains.forEach((chain, chainIndex) => {
        const angleOffset = (chainIndex / chains.length) * Math.PI * 2;

        chain.residues.forEach((residue, resIndex) => {
          const angle = angleOffset + (resIndex / chain.residues.length) * Math.PI * 0.5;
          const r = radius + chainIndex * 10;

          const x = Math.cos(angle) * r;
          const y = resIndex * 8 - 20;
          const z = Math.sin(angle) * r;

          // Create atom (sphere)
          const atomRadius = 2 + (residue.bfactor / 100) * 2;
          const geometry = new THREE.SphereGeometry(atomRadius, 32, 32);

          const color = getBFactorColor(residue.bfactor);
          const material = new THREE.MeshPhongMaterial({
            color: color,
            emissive: color,
            emissiveIntensity: residue.activity * 0.5,
            shininess: 100
          });

          const atom = new THREE.Mesh(geometry, material);
          atom.position.set(x, y, z);
          atom.userData = {
            residue: residue,
            chain: chain,
            originalColor: color
          };
          scene.add(atom);
          atoms.push(atom);

          // Create bond to previous atom
          if (resIndex > 0) {
            const prevAtom = atoms[atoms.length - 2];
            createBond(prevAtom.position, atom.position);
          }

          // Inter-chain bonds (simulating interactions)
          if (chainIndex > 0 && resIndex === 0) {
            const prevChainLastAtom = atoms[atoms.length - chain.residues.length - 1];
            if (prevChainLastAtom) {
              createBond(prevChainLastAtom.position, atom.position, 0x00ffff, true);
            }
          }
        });
      });

      console.log(`Created ${atoms.length} atoms and ${bonds.length} bonds`);
    }

    // Create bond
    function createBond(start, end, color = 0x00ff00, dashed = false) {
      const points = [start, end];
      const geometry = new THREE.BufferGeometry().setFromPoints(points);

      let material;
      if (dashed) {
        material = new THREE.LineDashedMaterial({
          color: color,
          linewidth: 1,
          dashSize: 1,
          gapSize: 0.5,
          transparent: true,
          opacity: 0.6
        });
      } else {
        material = new THREE.LineBasicMaterial({
          color: color,
          linewidth: 2,
          transparent: true,
          opacity: 0.8
        });
      }

      const bond = new THREE.Line(geometry, material);
      if (dashed) bond.computeLineDistances();

      scene.add(bond);
      bonds.push(bond);
    }

    // Get B-factor color (blue -> cyan -> green -> yellow -> red)
    function getBFactorColor(bfactor) {
      const normalized = Math.min(bfactor / 100, 1);

      if (normalized < 0.25) {
        return new THREE.Color().setHSL(0.66, 1, 0.5); // Blue
      } else if (normalized < 0.5) {
        return new THREE.Color().setHSL(0.5, 1, 0.5); // Cyan
      } else if (normalized < 0.75) {
        return new THREE.Color().setHSL(0.33, 1, 0.5); // Green-Yellow
      } else {
        return new THREE.Color().setHSL(0.16, 1, 0.5); // Yellow-Red
      }
    }

    // Set representation
    function setRepresentation(repr) {
      currentRepresentation = repr;

      // Update button states
      document.querySelectorAll('.repr-controls .repr-btn').forEach((btn, idx) => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Apply representation
      atoms.forEach(atom => {
        switch(repr) {
          case 'ball-stick':
            atom.scale.set(1, 1, 1);
            break;
          case 'spacefill':
            atom.scale.set(2, 2, 2);
            break;
          case 'ribbon':
            atom.scale.set(0.5, 0.5, 0.5);
            break;
          case 'cartoon':
            atom.scale.set(0.3, 0.3, 0.3);
            break;
          default:
            atom.scale.set(1, 1, 1);
        }
      });

      addLog('info', `&gt; REPRESENTATION: ${repr.toUpperCase()}`);
    }

    // Set coloring
    function setColoring(coloring) {
      currentColoring = coloring;

      atoms.forEach(atom => {
        let color;
        switch(coloring) {
          case 'chain':
            const chainColors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00];
            const chainIndex = chains.findIndex(c => c.id === atom.userData.chain.id);
            color = chainColors[chainIndex % chainColors.length];
            break;

          case 'bfactor':
            color = getBFactorColor(atom.userData.residue.bfactor);
            break;

          case 'activity':
            const activity = atom.userData.residue.activity;
            color = new THREE.Color().setHSL((1 - activity) * 0.33, 1, 0.5);
            break;

          case 'type':
            // Color by residue type
            color = 0x00ff00;
            break;
        }

        atom.material.color.setHex(color);
        atom.material.emissive.setHex(color);
      });

      addLog('info', `&gt; COLORING: ${coloring.toUpperCase()}`);
    }

    // Update chain selector
    function updateChainSelector() {
      const container = document.getElementById('chainSelector');
      container.innerHTML = chains.map(chain => `
        <button class="chain-btn active" onclick="toggleChain('${chain.id}')">${chain.id}</button>
      `).join('');
    }

    // Toggle chain visibility
    function toggleChain(chainId) {
      const btn = event.target;
      btn.classList.toggle('active');

      atoms.forEach(atom => {
        if (atom.userData.chain.id === chainId) {
          atom.visible = btn.classList.contains('active');
        }
      });
    }

    // Update residue list
    function updateResidueList() {
      const container = document.getElementById('residueList');
      let html = '';

      chains.forEach(chain => {
        html += `<div style="color: #0ff; margin-top: 10px;">CHAIN ${chain.id}: ${chain.name}</div>`;
        chain.residues.forEach(res => {
          html += `
            <div class="residue-item" onclick="selectResidue(${res.id})">
              ${res.type}${res.id} ${res.name} B=${res.bfactor.toFixed(1)}
            </div>
          `;
        });
      });

      container.innerHTML = html;
    }

    // Select residue
    function selectResidue(resId) {
      // Highlight in list
      document.querySelectorAll('.residue-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');

      // Highlight in 3D
      atoms.forEach(atom => {
        if (atom.userData.residue.id === resId) {
          atom.material.emissiveIntensity = 1;

          // Focus camera
          const pos = atom.position;
          camera.position.set(pos.x + 30, pos.y + 20, pos.z + 30);
          controls.target.copy(pos);
        } else {
          atom.material.emissiveIntensity = atom.userData.residue.activity * 0.5;
        }
      });
    }

    // Update stats
    function updateStats() {
      document.getElementById('chainCount').textContent = chains.length;
      document.getElementById('residueCount').textContent = chains.reduce((sum, c) => sum + c.residues.length, 0);
      document.getElementById('atomCount').textContent = atoms.length;
      document.getElementById('bondCount').textContent = bonds.length;

      const avgBFactor = atoms.reduce((sum, a) => sum + a.userData.residue.bfactor, 0) / atoms.length;
      document.getElementById('avgTemp').textContent = avgBFactor.toFixed(1);
    }

    // Add log
    function addLog(level, message) {
      const container = document.getElementById('activityLog');
      const line = document.createElement('div');
      line.className = `log-line ${level}`;
      line.textContent = message;

      container.insertBefore(line, container.firstChild);

      // Keep only last 20 lines
      while (container.children.length > 20) {
        container.removeChild(container.lastChild);
      }
    }

    // Molecular dynamics simulation
    function startMolecularDynamics() {
      let step = 0;

      setInterval(() => {
        // Simulate B-factor changes (temperature fluctuations)
        atoms.forEach(atom => {
          const residue = atom.userData.residue;
          residue.bfactor += (Math.random() - 0.5) * 5;
          residue.bfactor = Math.max(10, Math.min(100, residue.bfactor));

          if (currentColoring === 'bfactor') {
            const color = getBFactorColor(residue.bfactor);
            atom.material.color.copy(color);
            atom.material.emissive.copy(color);
          }

          // Thermal motion
          atom.position.x += (Math.random() - 0.5) * 0.1;
          atom.position.y += (Math.random() - 0.5) * 0.1;
          atom.position.z += (Math.random() - 0.5) * 0.1;
        });

        // Update stats
        updateStats();

        // Log events
        if (step % 5 === 0) {
          const agents = ['CodeGen', 'Review', 'Coordinator'];
          const actions = ['MODIFYING', 'ANALYZING', 'OPTIMIZING'];
          const agent = agents[Math.floor(Math.random() * agents.length)];
          const action = actions[Math.floor(Math.random() * actions.length)];
          const residue = chains[Math.floor(Math.random() * chains.length)].residues[0];

          addLog('info', `&gt; ${agent}: ${action} ${residue.name}`);
        }

        step++;
      }, 2000);
    }

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);

      // Gentle rotation
      scene.rotation.y += 0.001;

      controls.update();
      renderer.render(scene, camera);
    }

    // Window resize
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // Initialize
    init();
  </script>
</body>
</html>
