# ğŸ–ï¸ Miyabi Sandbox & Worktree ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆCodex/Claude Codeï¼‰ã®ä½œæ¥­ç’°å¢ƒã‚’åˆ†é›¢ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ç«¶åˆã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã€‚

## ğŸ¯ è¨­è¨ˆæ€æƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Main Repository                       â”‚
â”‚                 /home/ubuntu/miyabi-private              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                   â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Worktree 1  â”‚   â”‚   Worktree 2  â”‚   â”‚   Worktree 3  â”‚
â”‚  codex-001    â”‚   â”‚  kaede-agent  â”‚   â”‚  sakura-agent â”‚
â”‚  Issue #123   â”‚   â”‚  Issue #456   â”‚   â”‚  Issue #789   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â†“                   â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sandbox 1    â”‚   â”‚  Sandbox 2    â”‚   â”‚  Sandbox 3    â”‚
â”‚  Metadata     â”‚   â”‚  Metadata     â”‚   â”‚  Metadata     â”‚
â”‚  Temp Files   â”‚   â”‚  Temp Files   â”‚   â”‚  Temp Files   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
/home/ubuntu/
â”œâ”€â”€ miyabi-private/          # ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª
â”œâ”€â”€ sandboxes/               # ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ codex-001/
â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â”œâ”€â”€ kaede-agent/
â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â””â”€â”€ ...
â””â”€â”€ worktrees/               # Git Worktrees
    â”œâ”€â”€ codex-001/
    â”‚   â””â”€â”€ sandbox-codex-001-123/
    â”œâ”€â”€ kaede-agent/
    â”‚   â””â”€â”€ sandbox-kaede-agent-456/
    â””â”€â”€ ...
```

## ğŸš€ ä½¿ã„æ–¹

### ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ä½œæˆ

```bash
# åŸºæœ¬çš„ãªä½œæˆ
./scripts/agent-sandbox.sh create <agent-name> [issue-number]

# ä¾‹: codex-worker-1 ç”¨ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ï¼ˆIssue #123ï¼‰
./scripts/agent-sandbox.sh create codex-worker-1 123

# ä¾‹: ã‚«ã‚¨ãƒ‡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨
./scripts/agent-sandbox.sh create kaede-agent 456
```

### ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§

```bash
./scripts/agent-sandbox.sh list
```

å‡ºåŠ›ä¾‹:
```
ğŸ“¦ Active Sandboxes:

  ğŸ¤– codex-worker-1
     Branch: sandbox/codex-worker-1-123
     Created: 2025-11-29T12:00:00+00:00
     Status: âœ… Active

  ğŸ¤– kaede-agent
     Branch: sandbox/kaede-agent-456
     Created: 2025-11-29T11:30:00+00:00
     Status: âœ… Active

ğŸ“‚ Git Worktrees:
/home/ubuntu/worktrees/codex-worker-1/sandbox-codex-worker-1-123
/home/ubuntu/worktrees/kaede-agent/sandbox-kaede-agent-456
```

### ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å‰Šé™¤

```bash
# ç‰¹å®šã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
./scripts/agent-sandbox.sh destroy <agent-name>

# ä¾‹
./scripts/agent-sandbox.sh destroy codex-worker-1
```

### å¤ã„ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# 24æ™‚é–“ä»¥ä¸Šå‰ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
./scripts/agent-sandbox.sh cleanup

# 12æ™‚é–“ä»¥ä¸Šå‰ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
./scripts/agent-sandbox.sh cleanup 12
```

## ğŸ¤– ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµ±åˆ

### Codex/Claude Codeèµ·å‹•æ™‚

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«çµ„ã¿è¾¼ã¿:

```bash
#!/bin/bash
# start-agent.sh

AGENT_NAME="$1"
ISSUE_NUM="$2"

# 1. ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ä½œæˆ
./scripts/agent-sandbox.sh create "${AGENT_NAME}" "${ISSUE_NUM}"

# 2. Worktreeãƒ‘ã‚¹ã‚’å–å¾—
WORKTREE_PATH=$(jq -r '.worktree_path' "/home/ubuntu/sandboxes/${AGENT_NAME}/metadata.json")

# 3. Worktreeå†…ã§Claude Codeèµ·å‹•
cd "${WORKTREE_PATH}"
claude
```

### è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (cron)

```bash
# /etc/cron.d/miyabi-sandbox-cleanup
0 */6 * * * ubuntu /home/ubuntu/miyabi-private/scripts/agent-sandbox.sh cleanup 24
```

## ğŸ“‹ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å½¢å¼

`/home/ubuntu/sandboxes/<agent-name>/metadata.json`:

```json
{
    "agent_name": "codex-worker-1",
    "issue_number": "123",
    "branch_name": "sandbox/codex-worker-1-123",
    "worktree_path": "/home/ubuntu/worktrees/codex-worker-1/sandbox-codex-worker-1-123",
    "sandbox_path": "/home/ubuntu/sandboxes/codex-worker-1",
    "created_at": "2025-11-29T12:00:00+00:00",
    "status": "active"
}
```

## âš ï¸ æ³¨æ„äº‹é …

1. **ãƒ•ã‚¡ã‚¤ãƒ«ç«¶åˆé˜²æ­¢**: å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ç‹¬ç«‹ã—ãŸWorktreeã§ä½œæ¥­ã™ã‚‹ãŸã‚ã€åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«ç·¨é›†ã—ã¦ã‚‚ç«¶åˆã—ã¾ã›ã‚“

2. **ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡**: `sandbox/<agent-name>-<issue-number>` ã®å½¢å¼

3. **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: 24æ™‚é–“ä»¥ä¸Šæ”¾ç½®ã•ã‚ŒãŸã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã¯è‡ªå‹•å‰Šé™¤ã®å¯¾è±¡ã§ã™

4. **ãƒãƒ¼ã‚¸**: ä½œæ¥­å®Œäº†å¾Œã¯é€šå¸¸ã®PRãƒ•ãƒ­ãƒ¼ã§mainã«ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### WorktreeãŒä½œæˆã§ããªã„

```bash
# æ—¢å­˜ã®Worktreeã‚’ç¢ºèª
git worktree list

# å£Šã‚ŒãŸWorktreeã‚’å¼·åˆ¶å‰Šé™¤
git worktree remove --force /path/to/worktree
git worktree prune
```

### ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹

```bash
# å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
./scripts/agent-sandbox.sh cleanup 0
```

## ğŸ“Š miyabi-auth ã¨ã®çµ±åˆ

`crates/miyabi-auth/src/sandbox.rs` ã§æä¾›ã•ã‚Œã‚‹Rust API:

```rust
use miyabi_auth::sandbox;

// ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ä½œæˆ
let sandbox = sandbox::create_sandbox(user_id, project_id).await?;

// Worktreeä½œæˆ
let worktree_path = sandbox::create_worktree(
    repo_path,
    branch_name,
    &mut sandbox
).await?;

// ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå–å¾—
let work_dir = sandbox.working_dir();

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
sandbox::cleanup_old_sandboxes(base_path, 24).await?;
```
