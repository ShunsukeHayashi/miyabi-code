@startuml Water Spider Orchestrator - System Architecture
!theme materia-outline
title Water Spider Orchestrator - Complete Async Parallel Execution System\nv1.0.0 - å®Œå…¨éåŒæœŸä¸¦åˆ—å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ 

skinparam componentStyle rectangle
skinparam backgroundColor #f6f8fa
skinparam shadowing false
skinparam rectangleBorderColor #cccccc
skinparam rectangleBackgroundColor #ffffff

' ============================================
' GitHub OS Layer
' ============================================
package "GitHub OS (Issue Storage)" as github_layer #24292e {

    rectangle "Issues as Tasks" as issues #f0f0f0 {
        rectangle "Priority Labels" as priority_labels #e1f5fe
        rectangle "State Labels" as state_labels #fff3e0
        rectangle "Agent Labels" as agent_labels #f3e5f5
        rectangle "Dependencies" as dependency_meta #e8f5e9
    }

    rectangle "GitHub Webhooks" as webhooks #fce4ec {
        rectangle "issue.created" as webhook_created
        rectangle "issue.labeled" as webhook_labeled
        rectangle "issue.commented" as webhook_commented
    }

    rectangle "GitHub API" as github_api #e3f2fd {
        rectangle "REST API v4" as rest_api
        rectangle "GraphQL API" as graphql_api
    }

    rectangle "GitHub Actions" as github_actions #e8eaf6 {
        rectangle "task-execute.yml" as workflow_execute
        rectangle "task-monitor.yml" as workflow_monitor
    }
}

' ============================================
' Task Scheduler Service Layer
' ============================================
package "Task Scheduler Service\n(ç‹¬ç«‹ã‚µãƒ¼ãƒ“ã‚¹ 24/7å¸¸é§)" as scheduler_layer #0366d6 {

    rectangle "1. Issue Collector" as collector #bbdefb {
        rectangle "GitHub API Polling\n(10ç§’ã”ã¨)" as polling
        rectangle "Webhook Receiver" as webhook_receiver
        rectangle "Issue Parser" as parser
    }

    rectangle "2. Priority Calculator" as calculator #90caf9 {
        rectangle "Label-based Priority\nP0>P1>P2>P3" as label_priority
        rectangle "Dependency Resolution" as dep_resolver
        rectangle "Time Estimator" as time_estimator
    }

    rectangle "3. Task Queue\n(å„ªå…ˆé †ä½ä»˜ãã‚­ãƒ¥ãƒ¼)" as task_queue #64b5f6 {
        rectangle "Priority Queue\nIssue #443 (P0)\nIssue #448 (P1)" as priority_queue
        rectangle "Blocked Queue\nIssue #471 (depends on #448)" as blocked_queue
        rectangle "Running Queue\nIssue #490 (in progress)" as running_queue
    }

    rectangle "4. Task Dispatcher" as dispatcher #42a5f5 {
        rectangle "Task Assignment" as task_assign
        rectangle "Load Balancing\n(max 5 parallel)" as load_balance
        rectangle "workflow_dispatch Trigger" as workflow_trigger
    }
}

' ============================================
' Self-hosted Runner Layer
' ============================================
package "Self-hosted Runner\n(Mac mini / Local Machine)" as runner_layer #28a745 {

    rectangle "GitHub Actions\nRunner Process" as runner_process #c8e6c9 {
        rectangle "Taskå—ä¿¡\n(workflow_dispatch)" as task_receive
        rectangle "ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—" as env_setup
    }

    rectangle "Headless Claude Code\nSessions" as claude_sessions #a5d6a7 {
        note right
            **åŸå‰‡: 1 Session = 1 Issue**
            å³å¯†ãª1å¯¾1å¯¾å¿œ
        end note

        rectangle "Session #1\nIssue #443\nWorktree: .worktrees/issue-443/\nBranch: feature/issue-443" as session1 #6f42c1

        rectangle "Session #2\nIssue #448\nWorktree: .worktrees/issue-448/\nBranch: feature/issue-448" as session2 #6f42c1

        rectangle "Session #N\nIssue #449\nWorktree: .worktrees/issue-449/\n..." as sessionN #6f42c1
    }

    rectangle "Session Log Manager" as log_manager #81c784 {
        rectangle "git commitç›£è¦–" as git_monitor
        rectangle "Issue commentè¨˜éŒ²" as comment_logger
        rectangle "@mention ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³" as escalation
    }
}

' ============================================
' GitHub Results Layer
' ============================================
package "GitHub (Results)" as results_layer #24292e {

    rectangle "Issue Comments\n(ãƒ­ã‚°è¨˜éŒ²)" as issue_comments #fff9c4 {
        rectangle "âœ… Phase 1/4å®Œäº†" as comment1
        rectangle "ğŸš§ Phase 2/4å®Ÿè¡Œä¸­" as comment2
        rectangle "âš ï¸ @mention ã‚¨ãƒ©ãƒ¼é€šçŸ¥" as comment3
        rectangle "âœ… å®Œäº†: PRä½œæˆ" as comment4
    }

    rectangle "PR Creation" as pr_creation #c5e1a5 {
        rectangle "è‡ªå‹•PRä½œæˆ" as auto_pr
        rectangle "Worktreeãƒãƒ¼ã‚¸" as worktree_merge
    }

    rectangle "Issue Close" as issue_close #aed581 {
        rectangle "è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º" as auto_close
        rectangle "Milestoneçµ±åˆ" as milestone_integration
    }
}

' ============================================
' Relationships
' ============================================

' GitHub â†’ Scheduler
issues -down-> webhooks
webhooks -down-> collector : trigger
github_api -down-> collector : poll (10s)

' Scheduler Internal Flow
collector -down-> calculator
calculator -down-> task_queue
task_queue -down-> dispatcher

' Scheduler â†’ GitHub Actions
dispatcher -down-> github_actions : workflow_dispatch

' GitHub Actions â†’ Runner
github_actions -down-> runner_process : dispatch job

' Runner Internal Flow
runner_process -down-> claude_sessions : spawn sessions
claude_sessions -down-> log_manager : monitor

' Runner â†’ GitHub
log_manager -up-> issue_comments : POST logs
claude_sessions -up-> pr_creation : create PR
pr_creation -up-> issue_close : close issue

' Feedback Loop
issue_close -up-> issues : update state
issue_comments -up-> collector : re-scan

' ============================================
' Notes
' ============================================
note right of task_queue
    **Task Queue 3ç¨®é¡**

    1. Priority Queue
       - P0-Critical â†’ P1-High â†’ P2-Medium
       - ä¾å­˜é–¢ä¿‚ãªã—
       - å³å®Ÿè¡Œå¯èƒ½

    2. Blocked Queue
       - depends-onæœªè§£æ±º
       - å¾…æ©Ÿä¸­

    3. Running Queue
       - å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯
       - æœ€å¤§5ä¸¦åˆ—
end note

note right of claude_sessions
    **ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“æœ€å°åŒ–**

    ç›®æ¨™: å¯èƒ½ãªé™ã‚ŠçŸ­ç¸®
    ç¾çŠ¶: 15-30åˆ†/Issue

    **å®Œå…¨éåŒæœŸå®Ÿè¡Œ**
    - ãƒ¡ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãªã—
    - å…¨ã‚¿ã‚¹ã‚¯ä¸¦åˆ—å®Œäº†
    - ä¾å­˜é–¢ä¿‚è‡ªå‹•è§£æ±º

    **ã‚³ãƒãƒ³ãƒ‰ä¾‹**
    ```
    claude code --headless
      --execute-command "/agent-run --issue 443"
      --cwd .worktrees/issue-443
      --no-human-in-loop
    ```

    ğŸš« Human-in-the-loop: ç¦æ­¢
    ğŸ“ ãƒ­ã‚°è¨˜éŒ²: Issue commentã«è¨˜éŒ²
    ğŸ”” ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: @mention
end note

legend bottom
    **Water Spider Orchestrator - è¨­è¨ˆåŸå‰‡**

    1. ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“æœ€å°åŒ– (å¯èƒ½ãªé™ã‚ŠçŸ­ç¸®)
    2. å®Œå…¨éåŒæœŸä¸¦åˆ—å®Ÿè¡Œ (ç„¡åˆ¶é™)
    3. GitHub OSä¸­å¿ƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
    4. Self-hosted Runnerã«ã‚ˆã‚‹ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ
    5. 1 Session = 1 Issue (å³å¯†å¯¾å¿œ)
    6. ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹é€šä¿¡ (Human-in-the-loopç¦æ­¢)
end legend

@enduml
