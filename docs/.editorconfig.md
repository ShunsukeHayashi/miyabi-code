# EditorConfig 運用ガイド

**作成日**: 2025-11-29
**目的**: プロジェクト全体でコードスタイルを統一

---

## 📋 設定ファイル

### 1. `.editorconfig`
全ての言語・ファイルタイプに対するエディタ設定

**主要設定**:
- **Rust (.rs)**: 4スペースインデント、最大行長120文字
- **TOML (.toml)**: 2スペースインデント
- **YAML (.yml, .yaml)**: 2スペースインデント
- **JSON (.json)**: 2スペースインデント
- **Markdown (.md)**: 2スペースインデント
- **TypeScript/JavaScript**: 2スペースインデント
- **Python (.py)**: 4スペースインデント
- **Shell (.sh)**: 2スペースインデント

**全ファイル共通**:
- 改行: LF (Unix-style)
- 文字コード: UTF-8
- 行末空白: 削除
- ファイル末尾: 改行を挿入

### 2. `rustfmt.toml`
Rustコード専用のフォーマット設定

**主要設定**:
- 最大行幅: 120文字
- インデント: 4スペース（ハードタブ不使用）
- インポート整理: 有効
- コメントの折り返し: 有効
- Edition: 2021

### 3. `.ecignore`
EditorConfigチェックから除外するファイル・ディレクトリ

**除外対象**:
- `target/` (ビルド出力)
- `node_modules/` (npm依存)
- `.git/` (Git内部)
- `*.lock` (ロックファイル)
- ログファイル

---

## 🔧 エディタ設定

### VSCode
自動的にEditorConfigを認識（拡張機能不要）

**推奨拡張機能**:
- `EditorConfig.EditorConfig` (明示的サポート)
- `rust-lang.rust-analyzer` (Rust LSP)

### Vim/Neovim
プラグインが必要:
```vim
Plug 'editorconfig/editorconfig-vim'
```

### IntelliJ IDEA / CLion
デフォルトでサポート（設定不要）

### Emacs
パッケージが必要:
```elisp
(use-package editorconfig)
```

---

## ✅ コンプライアンスチェック

### editorconfig-checker の使用

**インストール**:
```bash
curl -sSfL https://github.com/editorconfig-checker/editorconfig-checker/releases/latest/download/ec-linux-amd64.tar.gz | tar xz -C /tmp
sudo mv /tmp/bin/ec-linux-amd64 /usr/local/bin/editorconfig-checker
```

**チェック実行**:
```bash
# プロジェクト全体
editorconfig-checker

# 特定ディレクトリ
editorconfig-checker crates/miyabi-agent-business/

# 特定ファイル
editorconfig-checker src/main.rs
```

**CI統合** (GitHub Actions例):
```yaml
- name: Check EditorConfig
  run: |
    curl -sSfL https://github.com/editorconfig-checker/editorconfig-checker/releases/latest/download/ec-linux-amd64.tar.gz | tar xz
    ./bin/ec-linux-amd64
```

---

## 🔄 自動フォーマット

### Rustコード (rustfmt)

**チェックのみ**:
```bash
cargo fmt --all -- --check
```

**自動修正**:
```bash
cargo fmt --all
```

**pre-commit hook**:
```bash
#!/bin/sh
# .git/hooks/pre-commit
cargo fmt --all -- --check
if [ $? -ne 0 ]; then
  echo "Error: Code is not formatted. Run 'cargo fmt --all'"
  exit 1
fi
```

---

## 📊 現状の問題点

**2025-11-29時点**:
- 一部のRustファイルで120文字を超える行が存在
- 主に長いコメントやURL、長い文字列リテラル

**対処方法**:
1. `cargo fmt --all` で自動修正（推奨）
2. 手動で行を分割
3. 例外的に長い行は `#[rustfmt::skip]` でスキップ

---

## 🎯 ベストプラクティス

### 1. コミット前の確認
```bash
# フォーマットチェック
cargo fmt --all -- --check

# EditorConfigチェック
editorconfig-checker
```

### 2. エディタの自動保存時フォーマット
VSCode設定例 (`.vscode/settings.json`):
```json
{
  "editor.formatOnSave": true,
  "rust-analyzer.rustfmt.extraArgs": ["--config-path", "rustfmt.toml"]
}
```

### 3. CI/CDでの強制
Pull Request時に自動チェックを実行

---

## 🚨 トラブルシューティング

### エディタでEditorConfigが効かない
1. エディタを再起動
2. プラグイン/拡張機能をインストール
3. `.editorconfig`がプロジェクトルートにあることを確認
4. `root = true` が設定されていることを確認

### rustfmtとEditorConfigの設定が衝突
- **rustfmt.toml が優先されます**
- 両方の設定を一致させることを推奨

### チェッカーが大量のエラーを報告
- `.ecignore` に除外パターンを追加
- 段階的に修正（まずは新規ファイルから適用）

---

## 📚 参考リソース

- [EditorConfig 公式](https://editorconfig.org/)
- [rustfmt ドキュメント](https://rust-lang.github.io/rustfmt/)
- [editorconfig-checker](https://github.com/editorconfig-checker/editorconfig-checker)

---

**最終更新**: 2025-11-29
**メンテナー**: Miyabi DevOps Team
