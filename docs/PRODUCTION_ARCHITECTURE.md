# Miyabi Production Architecture - å®Œå…¨è‡ªå‹•åŒ–ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆ

**ä½œæˆæ—¥**: 2025-11-18
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚º
**ç›®çš„**: ãƒ¢ãƒƒã‚¯ãªã—ãƒ»å®Œå…¨è‡ªå‹•åŒ–ãƒ»MCPçµ±åˆãƒ»tmuxé€šä¿¡é›†ç´„

---

## ğŸ“‹ è¦ä»¶å®šç¾©

### 1. å®Œå…¨è‡ªå‹•åŒ–ã‚µãƒ¼ãƒ“ã‚¹
- âœ… ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨é™¤å»
- âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ã‚«ãƒ‹ã‚ºãƒ å®Ÿè£…
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- âœ… è‡ªå‹•å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ 

### 2. MCPçµ±åˆ
- âœ… miyabi-rules ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®MCPé€£æº
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«MCPã‚µãƒ¼ãƒãƒ¼å®Ÿè£…
- âœ… ã‚¯ãƒ©ã‚¦ãƒ‰miyabi-rulesã¨ã®é€šä¿¡
- âœ… Agentå‘ã‘MCPãƒ„ãƒ¼ãƒ«æä¾›

### 3. tmuxé€šä¿¡é›†ç´„
- âœ… ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰åŒæœŸ
- âœ… é€šä¿¡ã®ä¸€å…ƒç®¡ç†
- âœ… æ•´åˆæ€§ä¿è¨¼ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
- âœ… ã„ã¤ã§ã‚‚joinå¯èƒ½ãªMCPã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Miyabi Production System                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          tmux Communication Hub (çµ±åˆãƒãƒ–)            â”‚  â”‚
â”‚  â”‚  - ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“åŒæœŸ                                   â”‚  â”‚
â”‚  â”‚  - ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰æ•´åˆæ€§ç®¡ç†                           â”‚  â”‚
â”‚  â”‚  - ã‚¤ãƒ™ãƒ³ãƒˆãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†• MCP Protocol                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Miyabi MCP Server (ãƒ­ãƒ¼ã‚«ãƒ«/ã‚¯ãƒ©ã‚¦ãƒ‰)          â”‚  â”‚
â”‚  â”‚  - miyabi-rules é€£æº                                  â”‚  â”‚
â”‚  â”‚  - Agentå‘ã‘ãƒ„ãƒ¼ãƒ«æä¾›                                â”‚  â”‚
â”‚  â”‚  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†•                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         miyabi-web-api (ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç‰ˆ)             â”‚  â”‚
â”‚  â”‚  - ãƒ¢ãƒƒã‚¯ãªã—å®Ÿè£…                                     â”‚  â”‚
â”‚  â”‚  - è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯                                 â”‚  â”‚
â”‚  â”‚  - ã‚¨ãƒ©ãƒ¼è‡ªå‹•å¾©æ—§                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†•                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         External Services (å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹)              â”‚  â”‚
â”‚  â”‚  - GitHub API                                         â”‚  â”‚
â”‚  â”‚  - PostgreSQL / Firebase                              â”‚  â”‚
â”‚  â”‚  - Cloud miyabi-rules                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ–°è¦ä½œæˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 1. `crates/miyabi-mcp-server`
**å½¹å‰²**: MCP Protocolå®Ÿè£…ã‚µãƒ¼ãƒãƒ¼

```rust
// MCPã‚µãƒ¼ãƒãƒ¼ã‚³ã‚¢å®Ÿè£…
pub struct MiyabiMcpServer {
    // miyabi-rulesé€£æº
    rules_client: RulesClient,

    // tmuxé€šä¿¡ãƒãƒ–
    tmux_hub: TmuxCommunicationHub,

    // Agentå‘ã‘ãƒ„ãƒ¼ãƒ«
    agent_tools: Vec<McpTool>,
}

// æä¾›ã™ã‚‹MCPãƒ„ãƒ¼ãƒ«
- get_session_state: ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹å–å¾—
- broadcast_message: å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡
- sync_with_cloud: ã‚¯ãƒ©ã‚¦ãƒ‰miyabi-rulesã¨åŒæœŸ
- execute_rule: ãƒ«ãƒ¼ãƒ«å®Ÿè¡Œ
- get_agent_context: Agentå®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
```

### 2. `crates/miyabi-tmux-hub`
**å½¹å‰²**: tmuxé€šä¿¡é›†ç´„ã‚·ã‚¹ãƒ†ãƒ 

```rust
pub struct TmuxCommunicationHub {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
    sessions: HashMap<String, SessionState>,

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹
    event_bus: EventBus,

    // æ•´åˆæ€§ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
    consistency_manager: ConsistencyManager,
}

// æ©Ÿèƒ½
- multi_session_sync(): ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³åŒæœŸ
- broadcast_event(): ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡
- ensure_consistency(): æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
- allow_join(): æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å‚åŠ è¨±å¯
```

### 3. `crates/miyabi-rules-client`
**å½¹å‰²**: miyabi-rulesã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

```rust
pub struct RulesClient {
    // ãƒ­ãƒ¼ã‚«ãƒ«/ã‚¯ãƒ©ã‚¦ãƒ‰è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
    mode: ConnectionMode,

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç®¡ç†
    fallback: FallbackManager,

    // è‡ªå‹•å†æ¥ç¶š
    reconnect: ReconnectManager,
}

enum ConnectionMode {
    Local,          // ãƒ­ãƒ¼ã‚«ãƒ«miyabi-rules
    Cloud,          // ã‚¯ãƒ©ã‚¦ãƒ‰miyabi-rules
    Hybrid,         // ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰
}
```

---

## ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ»è‡ªå‹•å¾©æ—§æˆ¦ç•¥

### ãƒ¬ãƒ™ãƒ«1: ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
```
GitHub API éšœå®³
  â†“
ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨
  â†“
ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ç¶™ç¶š
  â†“
å¾©æ—§æ¤œçŸ¥å¾Œã€è‡ªå‹•å†æ¥ç¶š
```

### ãƒ¬ãƒ™ãƒ«2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
```
PostgreSQL æ¥ç¶šå¤±æ•—
  â†“
Firebase Fallback
  â†“
ãƒ­ãƒ¼ã‚«ãƒ«SQLite (ç·Šæ€¥æ™‚)
  â†“
è‡ªå‹•åŒæœŸå†é–‹
```

### ãƒ¬ãƒ™ãƒ«3: MCPé€šä¿¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
```
ã‚¯ãƒ©ã‚¦ãƒ‰miyabi-rules æ¥ç¶šå¤±æ•—
  â†“
ãƒ­ãƒ¼ã‚«ãƒ«miyabi-rulesä½¿ç”¨
  â†“
ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç¶™ç¶š
  â†“
å¾©æ—§æ™‚è‡ªå‹•åŒæœŸ
```

---

## ğŸ› ï¸ å®Ÿè£…è¨ˆç”»

### Phase 1: MCPåŸºç›¤æ§‹ç¯‰ (1-2æ—¥)
1. `miyabi-mcp-server` crateä½œæˆ
2. MCPãƒ—ãƒ­ãƒˆã‚³ãƒ«å®Ÿè£…
3. åŸºæœ¬ãƒ„ãƒ¼ãƒ«å®šç¾©

### Phase 2: tmuxé€šä¿¡ãƒãƒ– (1-2æ—¥)
1. `miyabi-tmux-hub` crateä½œæˆ
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³åŒæœŸå®Ÿè£…
3. ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹æ§‹ç¯‰

### Phase 3: miyabi-rulesé€£æº (2-3æ—¥)
1. `miyabi-rules-client` crateä½œæˆ
2. ãƒ­ãƒ¼ã‚«ãƒ«/ã‚¯ãƒ©ã‚¦ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
3. MCPçµ±åˆ

### Phase 4: miyabi-web-apiæ”¹ä¿® (2-3æ—¥)
1. ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿é™¤å»
2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
3. è‡ªå‹•å¾©æ—§ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### Phase 5: çµ±åˆãƒ†ã‚¹ãƒˆ (1-2æ—¥)
1. ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
3. è² è·ãƒ†ã‚¹ãƒˆ

---

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. â³ Phase 1é–‹å§‹: `miyabi-mcp-server` ä½œæˆ
3. â³ MCP Protocolå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
4. â³ ãƒ­ãƒ¼ã‚«ãƒ«MCPã‚µãƒ¼ãƒãƒ¼èµ·å‹•

---

**è³ªå•ãƒ»ç¢ºèªäº‹é …**:
- miyabi-rulesã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯?
- ã‚¯ãƒ©ã‚¦ãƒ‰miyabi-rulesã®URL/èªè¨¼æ–¹æ³•ã¯?
- tmuxé€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è©³ç´°ä»•æ§˜ã¯?
