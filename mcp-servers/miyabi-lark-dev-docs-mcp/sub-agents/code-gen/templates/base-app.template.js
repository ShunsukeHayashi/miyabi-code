#!/usr/bin/env node
/**
 * {{PROJECT_NAME}} - Lark Bot Application
 *
 * Auto-generated by Miyabi Lark Dev App Automation System
 * Generated at: {{GENERATED_AT}}
 */

import express from 'express';
import axios from 'axios';
import crypto from 'crypto';

// Configuration
const APP_ID = process.env.APP_ID || '{{APP_ID}}';
const APP_SECRET = process.env.APP_SECRET || '{{APP_SECRET}}';
const PORT = process.env.PORT || {{PORT}};
const LARK_DOMAIN = process.env.LARK_DOMAIN || 'https://open.larksuite.com';

// Express app
const app = express();
app.use(express.json());

// In-memory token cache
let tenantAccessToken = null;
let tokenExpiry = 0;

/**
 * Get Tenant Access Token
 */
async function getTenantAccessToken() {
  if (tenantAccessToken && Date.now() < tokenExpiry) {
    return tenantAccessToken;
  }

  try {
    const response = await axios.post(
      `${LARK_DOMAIN}/open-apis/auth/v3/tenant_access_token/internal`,
      {
        app_id: APP_ID,
        app_secret: APP_SECRET,
      }
    );

    if (response.data.code === 0) {
      tenantAccessToken = response.data.tenant_access_token;
      tokenExpiry = Date.now() + response.data.expire * 1000 - 60000; // Refresh 1 min before expiry
      console.log('âœ… Tenant access token refreshed');
      return tenantAccessToken;
    } else {
      throw new Error(`Failed to get token: ${response.data.msg}`);
    }
  } catch (error) {
    console.error('âŒ Token fetch error:', error.message);
    throw error;
  }
}

/**
 * Event Subscription Endpoint
 */
app.post('/webhook/events', async (req, res) => {
  const { type, challenge, header, event } = req.body;

  // URL Verification
  if (type === 'url_verification') {
    console.log('âœ… URL verification received');
    return res.json({ challenge });
  }

  // Event received
  if (header?.event_type) {
    console.log(`ðŸ“¨ Event received: ${header.event_type}`);

    try {
      await handleEvent(header.event_type, event);
      res.json({ code: 0 });
    } catch (error) {
      console.error('âŒ Event handling error:', error.message);
      res.json({ code: 1, msg: error.message });
    }
  } else {
    res.json({ code: 0 });
  }
});

/**
 * Event Handler
 */
async function handleEvent(eventType, event) {
  {{EVENT_HANDLERS}}
}

{{API_WRAPPERS}}

{{HELPER_FUNCTIONS}}

/**
 * Health Check
 */
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    app_id: APP_ID,
    port: PORT,
    uptime: process.uptime(),
    timestamp: new Date().toISOString(),
  });
});

/**
 * Start Server
 */
app.listen(PORT, () => {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸš€ {{PROJECT_NAME}}');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log(`ðŸ“¡ Server running on port ${PORT}`);
  console.log(`ðŸ”— Webhook: http://localhost:${PORT}/webhook/events`);
  console.log(`ðŸ’š Health: http://localhost:${PORT}/health`);
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('ðŸ›‘ SIGTERM received, shutting down gracefully');
  process.exit(0);
});
