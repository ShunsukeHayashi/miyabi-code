#!/usr/bin/env node
/**
 * CodeGenAgent - å®Œå…¨ãªLark Appã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
 *
 * Input: Project Specification (from CoordinatorAgent)
 * Output: Complete application code + package.json + README
 */

import { generateApplication } from './template-engine.js';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * CodeGenAgentãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
 * @param {Object} projectSpec - Project specification from Coordinator
 * @returns {Promise<Object>} Generated application metadata
 */
export async function generateLarkApp(projectSpec) {
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ› ï¸  CodeGenAgent - Lark App Code Generation');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  const projectName = projectSpec.task_graph.project_name;
  console.log(`ğŸ“¦ Generating: ${projectName}\n`);

  // Step 1: Create project directory
  const outputDir = await createProjectDirectory(projectName);

  // Step 2: Generate main application code
  console.log('â•â•â• Step 1/4: Generate Application Code â•â•â•');
  const appCode = await generateApplication(projectSpec);
  await fs.writeFile(path.join(outputDir, 'index.js'), appCode);
  console.log('âœ… index.js created');

  // Step 3: Generate package.json
  console.log('\nâ•â•â• Step 2/4: Generate package.json â•â•â•');
  const packageJson = generatePackageJson(projectSpec);
  await fs.writeFile(
    path.join(outputDir, 'package.json'),
    JSON.stringify(packageJson, null, 2)
  );
  console.log('âœ… package.json created');

  // Step 4: Generate .env.example
  console.log('\nâ•â•â• Step 3/4: Generate .env.example â•â•â•');
  const envExample = generateEnvExample(projectSpec);
  await fs.writeFile(path.join(outputDir, '.env.example'), envExample);
  console.log('âœ… .env.example created');

  // Step 5: Generate README.md
  console.log('\nâ•â•â• Step 4/4: Generate README.md â•â•â•');
  const readme = generateReadme(projectSpec);
  await fs.writeFile(path.join(outputDir, 'README.md'), readme);
  console.log('âœ… README.md created');

  const result = {
    project_name: projectName,
    output_directory: outputDir,
    generated_files: [
      'index.js',
      'package.json',
      '.env.example',
      'README.md',
    ],
    api_count: projectSpec.api_selection.total_apis_selected,
    task_count: projectSpec.task_graph.total_tasks,
    generated_at: new Date().toISOString(),
  };

  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('âœ… Code Generation Complete!');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  printSummary(result);

  return result;
}

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
 */
async function createProjectDirectory(projectName) {
  const baseDir = path.join(__dirname, '../../output/generated-apps');
  const projectDir = path.join(baseDir, projectName);

  await fs.mkdir(projectDir, { recursive: true });

  console.log(`ğŸ“ Project directory: ${projectDir}\n`);

  return projectDir;
}

/**
 * package.jsonç”Ÿæˆ
 */
function generatePackageJson(projectSpec) {
  const projectName = projectSpec.task_graph.project_name;

  return {
    name: projectName,
    version: '1.0.0',
    description: `Auto-generated Lark Bot - ${projectSpec.intent_analysis.intent_type}`,
    main: 'index.js',
    type: 'module',
    scripts: {
      start: 'node index.js',
      dev: 'nodemon index.js',
    },
    keywords: ['lark', 'bot', 'automation', 'miyabi'],
    author: 'Miyabi Lark Dev Automation',
    license: 'MIT',
    dependencies: {
      express: '^4.18.2',
      axios: '^1.6.0',
      dotenv: '^16.3.1',
    },
    devDependencies: {
      nodemon: '^3.0.1',
    },
    engines: {
      node: '>=18.0.0',
    },
  };
}

/**
 * .env.exampleç”Ÿæˆ
 */
function generateEnvExample(projectSpec) {
  return `# Lark Application Credentials
APP_ID=your_app_id_here
APP_SECRET=your_app_secret_here

# Server Configuration
PORT=3000
LARK_DOMAIN=https://open.larksuite.com

# Optional: Logging
LOG_LEVEL=info
`;
}

/**
 * README.mdç”Ÿæˆ
 */
function generateReadme(projectSpec) {
  const projectName = projectSpec.task_graph.project_name;
  const apis = projectSpec.api_selection.selected_apis;

  return `# ${projectName}

**Auto-generated Lark Bot Application**

Generated by: Miyabi Lark Dev App Automation System
Generated at: ${new Date().toISOString()}

---

## æ¦‚è¦

${projectSpec.user_request}

## æ©Ÿèƒ½

${projectSpec.intent_analysis.functional_requirements
  .map((req, i) => `${i + 1}. ${req}`)
  .join('\n')}

## ä½¿ç”¨ã—ã¦ã„ã‚‹Lark APIs

${apis.map(api => `- \`${api}\``).join('\n')}

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

\`\`\`bash
npm install
\`\`\`

### 2. ç’°å¢ƒå¤‰æ•°è¨­å®š

\`\`\`bash
cp .env.example .env
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã€APP_ID ã¨ APP_SECRET ã‚’è¨­å®š
\`\`\`

### 3. Lark Open Platformã§è¨­å®š

1. [Lark Open Platform](${projectSpec.api_selection.api_specifications[Object.keys(projectSpec.api_selection.api_specifications)[0]]?.documentation_url?.split('/').slice(0, 3).join('/')}) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
3. ä»¥ä¸‹ã®æ¨©é™ã‚’æœ‰åŠ¹åŒ–:

${Array.from(
  new Set(
    Object.values(projectSpec.api_selection.api_specifications).flatMap(
      spec => spec.required_permissions || []
    )
  )
)
  .map(perm => `   - \`${perm}\``)
  .join('\n')}

4. Event Subscriptionã‚’è¨­å®š:
   - Request URL: \`https://your-domain.com/webhook/events\`
   - Events to subscribe: \`im.message.receive_v1\`

### 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•

\`\`\`bash
npm start
\`\`\`

---

## ä½¿ã„æ–¹

1. Larkã‚°ãƒ«ãƒ¼ãƒ—ã« Bot ã‚’è¿½åŠ 
2. Bot ã‚’ @mention ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡
3. Bot ãŒå¿œç­”ã—ã¾ã™

### ã‚³ãƒãƒ³ãƒ‰ä¾‹

- \`@Bot help\` - ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
- \`@Bot status\` - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª

---

## ãƒ‡ãƒ—ãƒ­ã‚¤

### ngrokã‚’ä½¿ç”¨ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ

\`\`\`bash
ngrok http 3000
\`\`\`

ngrokãŒæä¾›ã™ã‚‹URLã‚’ Lark Event Subscription ã® Request URL ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

### ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤

- Heroku
- AWS Lambda
- Google Cloud Run
- ãã®ä»–ã®Node.jså¯¾å¿œãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### BotãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åå¿œã—ãªã„

1. Event SubscriptionãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. Bot ã«å¿…è¦ãªæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. Request URLãŒæœ‰åŠ¹ã§ã€200ã‚’è¿”ã—ã¦ã„ã‚‹ã‹ç¢ºèª

### Tokenå–å¾—ã‚¨ãƒ©ãƒ¼

1. APP_ID ã¨ APP_SECRET ãŒæ­£ã—ã„ã‹ç¢ºèª
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## é–‹ç™º

\`\`\`bash
npm run dev  # nodemon ã§è‡ªå‹•å†èµ·å‹•
\`\`\`

---

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT

---

**Generated by Miyabi Lark Dev App Automation System**
`;
}

/**
 * ã‚µãƒãƒªãƒ¼è¡¨ç¤º
 */
function printSummary(result) {
  console.log('ğŸ“Š Generated Application Summary:\n');
  console.log(`  Project Name:     ${result.project_name}`);
  console.log(`  Output Directory: ${result.output_directory}`);
  console.log(`  Generated Files:  ${result.generated_files.length}`);
  console.log(`  API Count:        ${result.api_count}`);
  console.log(`  Task Count:       ${result.task_count}\n`);

  console.log('ğŸ“ Files:');
  for (const file of result.generated_files) {
    console.log(`  âœ… ${file}`);
  }

  console.log('\nğŸ’¡ Next Steps:');
  console.log(`  1. cd ${result.output_directory}`);
  console.log('  2. npm install');
  console.log('  3. Configure .env file');
  console.log('  4. npm start');
  console.log('  5. Deploy via DeploymentAgent\n');
}

// CLIå®Ÿè¡Œ
if (import.meta.url === `file://${process.argv[1]}`) {
  const specFile = process.argv[2];

  if (!specFile) {
    console.error('âŒ Usage: node index.js <project-spec.json>');
    process.exit(1);
  }

  import('fs/promises').then(async fs => {
    const specContent = await fs.readFile(specFile, 'utf-8');
    const projectSpec = JSON.parse(specContent);

    generateLarkApp(projectSpec).then(() => {
      console.log('âœ… Code generation complete!');
      process.exit(0);
    });
  }).catch(error => {
    console.error('âŒ Code generation failed:', error);
    process.exit(1);
  });
}
