#!/bin/bash
# Claude Code Session Manager
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã§å¼•ãç¶™ããŸã‚ã®ãƒ„ãƒ¼ãƒ«

set -e

# è¨­å®š
MANAGER_DIR="$HOME/.claude-sessions"
SESSION_DB="$MANAGER_DIR/sessions.json"
LOG_DIR="$MANAGER_DIR/logs"

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆæœŸåŒ–
init_manager() {
    mkdir -p "$MANAGER_DIR"
    mkdir -p "$LOG_DIR"

    if [ ! -f "$SESSION_DB" ]; then
        echo '{"sessions": []}' > "$SESSION_DB"
        echo "âœ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ"
    fi
}

# ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²
register_current_session() {
    local agent_name="$1"
    local purpose="$2"

    if [ -z "$agent_name" ] || [ -z "$purpose" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã¨ç›®çš„ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ã„æ–¹: csm register <agent_name> <purpose>"
        return 1
    fi

    # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã‚’è©¦è¡Œï¼‰
    local session_id=""

    # Method 1: claude session ã‚³ãƒãƒ³ãƒ‰
    session_id=$(claude session --format json 2>/dev/null | jq -r '.id // empty')

    # Method 2: ç’°å¢ƒå¤‰æ•°
    if [ -z "$session_id" ] && [ -n "$CLAUDE_SESSION_ID" ]; then
        session_id="$CLAUDE_SESSION_ID"
    fi

    # Method 3: UUIDç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    if [ -z "$session_id" ]; then
        session_id=$(uuidgen | tr '[:upper:]' '[:lower:]')
        echo "âš ï¸  ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ: $session_id"
        echo "   ç’°å¢ƒå¤‰æ•° CLAUDE_SESSION_ID ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
    fi

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¨˜éŒ²
    local timestamp=$(date -Iseconds)
    local log_file="$LOG_DIR/${session_id}.log"

    # æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
    local exists=$(jq --arg id "$session_id" '.sessions[] | select(.id == $id) | .id' "$SESSION_DB")

    if [ -n "$exists" ]; then
        echo "âš ï¸  ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™: $session_id"
        return 0
    fi

    # æ–°è¦ç™»éŒ²
    jq --arg id "$session_id" \
       --arg agent "$agent_name" \
       --arg purpose "$purpose" \
       --arg timestamp "$timestamp" \
       --arg log "$log_file" \
       '.sessions += [{
           id: $id,
           agent: $agent,
           purpose: $purpose,
           created_at: $timestamp,
           last_accessed: $timestamp,
           status: "active",
           log_file: $log,
           handoff_history: []
       }]' "$SESSION_DB" > "$SESSION_DB.tmp"

    mv "$SESSION_DB.tmp" "$SESSION_DB"

    echo "âœ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã—ã¾ã—ãŸ"
    echo "  ID: $session_id"
    echo "  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: $agent_name"
    echo "  ç›®çš„: $purpose"
}

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
list_sessions() {
    local filter="$1"

    echo "=== Claude Code ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ ==="
    echo ""

    if [ "$filter" == "active" ]; then
        jq -r '.sessions[] | select(.status == "active") |
               "[\(.status)] \(.id)\n  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: \(.agent)\n  ç›®çš„: \(.purpose)\n  ä½œæˆ: \(.created_at)\n"' "$SESSION_DB"
    else
        jq -r '.sessions[] |
               "[\(.status)] \(.id)\n  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: \(.agent)\n  ç›®çš„: \(.purpose)\n  ä½œæˆ: \(.created_at)\n"' "$SESSION_DB"
    fi
}

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç§»å‹•(ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ)
teleport_session() {
    local session_id="$1"

    if [ -z "$session_id" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ã„æ–¹: csm teleport <session_id>"
        return 1
    fi

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
    local exists=$(jq --arg id "$session_id" '.sessions[] | select(.id == $id) | .id' "$SESSION_DB")

    if [ -z "$exists" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $session_id"
        return 1
    fi

    # æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ™‚åˆ»ã‚’æ›´æ–°
    local timestamp=$(date -Iseconds)
    jq --arg id "$session_id" \
       --arg timestamp "$timestamp" \
       '(.sessions[] | select(.id == $id) | .last_accessed) = $timestamp' "$SESSION_DB" > "$SESSION_DB.tmp"
    mv "$SESSION_DB.tmp" "$SESSION_DB"

    echo "ğŸš€ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç§»å‹•ã—ã¾ã™: $session_id"
    claude --teleport "$session_id"
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼•ãç¶™ã
handoff_session() {
    local session_id="$1"
    local target_agent="$2"
    local handoff_note="$3"

    if [ -z "$session_id" ] || [ -z "$target_agent" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ã„æ–¹: csm handoff <session_id> <target_agent> [note]"
        return 1
    fi

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
    local current_agent=$(jq -r --arg id "$session_id" '.sessions[] | select(.id == $id) | .agent' "$SESSION_DB")

    if [ -z "$current_agent" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $session_id"
        return 1
    fi

    echo "ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼•ãç¶™ãã¾ã™"
    echo "  From: $current_agent"
    echo "  To: $target_agent"
    echo "  Note: ${handoff_note:-ãªã—}"

    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã‚’æ›´æ–°
    local timestamp=$(date -Iseconds)
    jq --arg id "$session_id" \
       --arg current "$current_agent" \
       --arg agent "$target_agent" \
       --arg note "${handoff_note:-ã‚»ãƒƒã‚·ãƒ§ãƒ³å¼•ãç¶™ã}" \
       --arg timestamp "$timestamp" \
       '(.sessions[] | select(.id == $id)) |= {
           id: .id,
           agent: $agent,
           purpose: .purpose,
           created_at: .created_at,
           last_accessed: $timestamp,
           last_handoff: $timestamp,
           handoff_note: $note,
           status: .status,
           log_file: .log_file,
           handoff_history: (.handoff_history + [{
               from: $current,
               to: $agent,
               timestamp: $timestamp,
               note: $note
           }])
       }' "$SESSION_DB" > "$SESSION_DB.tmp"

    mv "$SESSION_DB.tmp" "$SESSION_DB"

    echo "âœ“ å¼•ãç¶™ããŒå®Œäº†ã—ã¾ã—ãŸ"
    echo ""
    echo "æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç§»å‹•ã§ãã¾ã™:"
    echo "  csm teleport $session_id"
}

# ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã‚’è¡¨ç¤º
show_session() {
    local session_id="$1"

    if [ -z "$session_id" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ã„æ–¹: csm show <session_id>"
        return 1
    fi

    echo "=== ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´° ==="
    jq --arg id "$session_id" '.sessions[] | select(.id == $id)' "$SESSION_DB"
}

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒ­ãƒ¼ã‚º
close_session() {
    local session_id="$1"

    if [ -z "$session_id" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ã„æ–¹: csm close <session_id>"
        return 1
    fi

    jq --arg id "$session_id" \
       '(.sessions[] | select(.id == $id) | .status) = "closed"' "$SESSION_DB" > "$SESSION_DB.tmp"

    mv "$SESSION_DB.tmp" "$SESSION_DB"
    echo "âœ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ: $session_id"
}

# ä½¿ã„æ–¹ã‚’è¡¨ç¤º
show_usage() {
    cat << 'EOF'
Claude Code Session Manager (CSM)

ä½¿ã„æ–¹:
  csm init                              - ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
  csm register <agent> <purpose>        - ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²
  csm list [active]                     - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
  csm teleport <session_id>             - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç§»å‹•
  csm handoff <session_id> <agent> [note] - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼•ãç¶™ã
  csm show <session_id>                 - ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã‚’è¡¨ç¤º
  csm close <session_id>                - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒ­ãƒ¼ã‚º

ä¾‹:
  # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²
  csm register "é–‹ç™ºã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ" "APIã®å®Ÿè£…"

  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ç¢ºèª
  csm list active

  # åˆ¥ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å¼•ãç¶™ã
  csm handoff abc123 "ãƒ†ã‚¹ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ" "APIå®Ÿè£…å®Œäº†ã€ãƒ†ã‚¹ãƒˆä¾é ¼"

  # ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç§»å‹•
  csm teleport abc123

Miyabi Agentçµ±åˆ:
  # CoordinatorAgentç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³
  csm register "CoordinatorAgent" "Issue #567 ã‚¿ã‚¹ã‚¯åˆ†è§£"

  # CodeGenAgentç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³
  csm register "CodeGenAgent" "Issue #567 å®Ÿè£…"

  # ReviewAgentç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³
  csm register "ReviewAgent" "Issue #567 ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼"

EOF
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local command="$1"
    shift || true

    # åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
    if [ "$command" != "init" ] && [ ! -f "$SESSION_DB" ]; then
        echo "âš ï¸  ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§åˆæœŸåŒ–ã—ã¦ãã ã•ã„: csm init"
        exit 1
    fi

    case "$command" in
        init)
            init_manager
            ;;
        register)
            register_current_session "$1" "$2"
            ;;
        list)
            list_sessions "$1"
            ;;
        teleport)
            teleport_session "$1"
            ;;
        handoff)
            handoff_session "$1" "$2" "$3"
            ;;
        show)
            show_session "$1"
            ;;
        close)
            close_session "$1"
            ;;
        help|--help|-h|"")
            show_usage
            ;;
        *)
            echo "âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $command"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
