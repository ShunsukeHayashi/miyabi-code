{
  "kb_id": "kb-secrets-manager-exists",
  "title": "Secrets Manager Secret Already Exists",
  "category": "deployment",
  "tags": ["cdk", "secrets-manager", "aws", "deployment"],
  "problem": {
    "description": "CDK deploy fails because Secrets Manager secret already exists",
    "symptoms": [
      "Resource handler returned message: 'The operation failed because the secret miyabi/github-token already exists.'",
      "HandlerErrorCode: AlreadyExists",
      "CloudFormation rollback triggered"
    ],
    "occurrences": 1,
    "first_seen": "2025-11-15T19:37:00+09:00",
    "last_seen": "2025-11-15T19:37:00+09:00"
  },
  "solution": {
    "root_cause": "CDK trying to create a secret that already exists in Secrets Manager",
    "fix_steps": [
      "Option 1: Import existing secret in CDK stack",
      "Option 2: Delete existing secret and redeploy",
      "Option 3: Use different secret name"
    ],
    "auto_fix": true,
    "commands": [
      "# Option 1: Modify CDK stack to import existing secret",
      "# Change: new secretsmanager.Secret(...)",
      "# To: secretsmanager.Secret.fromSecretNameV2(this, 'MiyabiGitHubToken', 'miyabi/github-token')",
      "",
      "# Option 2: Delete and recreate",
      "aws secretsmanager delete-secret --secret-id miyabi/github-token --force-delete-without-recovery --region us-west-2",
      "npx cdk deploy --require-approval never"
    ],
    "prevention": "Always check if resources exist before creating them in CDK. Use CDK construct's `fromXxx` methods to import existing resources."
  },
  "code_examples": [
    {
      "language": "typescript",
      "description": "Import existing secret instead of creating new one",
      "before": "const githubToken = new secretsmanager.Secret(this, 'MiyabiGitHubToken', {\n  secretName: 'miyabi/github-token',\n  description: 'GitHub Personal Access Token for Miyabi',\n});",
      "after": "// Import existing secret\nconst githubToken = secretsmanager.Secret.fromSecretNameV2(\n  this,\n  'MiyabiGitHubToken',\n  'miyabi/github-token'\n);"
    }
  ],
  "related_kb": [],
  "confidence": 1.0,
  "status": "validated"
}
