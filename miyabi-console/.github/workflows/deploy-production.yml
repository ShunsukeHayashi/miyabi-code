name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'
  AWS_REGION: 'ap-northeast-1'

jobs:
  build-and-deploy:
    name: Build and Deploy to AWS
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write # Required for OIDC

    steps:
      # ========================================
      # 1. Checkout Code
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 2. Setup Node.js
      # ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ========================================
      # 3. Install Dependencies
      # ========================================
      - name: Install dependencies
        run: npm ci

      # ========================================
      # 4. Type Check
      # ========================================
      - name: TypeScript type check
        run: npm run type-check || true
        # Continue on error (pre-existing TS errors in unused files)

      # ========================================
      # 5. Build Production Bundle
      # ========================================
      - name: Build production bundle
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}

      # ========================================
      # 6. Verify Build Output
      # ========================================
      - name: Verify build output
        run: |
          ls -lh dist/
          echo "Build size:"
          du -sh dist/
          echo "Assets:"
          du -h dist/assets/* | sort -h

      # ========================================
      # 7. Configure AWS Credentials
      # ========================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          # OR use access keys:
          # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # ========================================
      # 8. Upload to S3
      # ========================================
      - name: Upload build files to S3
        run: |
          # Sync assets with long cache
          aws s3 sync dist/ s3://miyabi-console-production/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html"

          # Upload index.html with no cache
          aws s3 cp dist/index.html s3://miyabi-console-production/index.html \
            --cache-control "public, max-age=0, must-revalidate"

      # ========================================
      # 9. Invalidate CloudFront Cache
      # ========================================
      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='Miyabi Console Production Distribution'].Id" \
            --output text)

          echo "Distribution ID: $DISTRIBUTION_ID"

          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*"

      # ========================================
      # 10. Wait for Invalidation
      # ========================================
      - name: Wait for CloudFront invalidation
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='Miyabi Console Production Distribution'].Id" \
            --output text)

          INVALIDATION_ID=$(aws cloudfront list-invalidations \
            --distribution-id $DISTRIBUTION_ID \
            --query "InvalidationList.Items[0].Id" \
            --output text)

          echo "Waiting for invalidation $INVALIDATION_ID..."

          aws cloudfront wait invalidation-completed \
            --distribution-id $DISTRIBUTION_ID \
            --id $INVALIDATION_ID

      # ========================================
      # 11. Verify Deployment
      # ========================================
      - name: Verify deployment
        run: |
          echo "Deployment complete!"
          echo "URL: https://miyabi-world.com"

          # Check if site is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://miyabi-world.com)
          echo "HTTP Status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment verification failed"
            exit 1
          fi

      # ========================================
      # 12. Post Deployment Notification
      # ========================================
      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to production succeeded"
            # Optional: Send Slack/Discord notification
          else
            echo "❌ Deployment to production failed"
            # Optional: Send failure notification
          fi

  # Optional: Smoke Tests
  smoke-tests:
    name: Run Smoke Tests
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test homepage
        run: |
          curl -f https://miyabi-world.com || exit 1

      - name: Test agents page
        run: |
          curl -f https://miyabi-world.com/agents || exit 1

      - name: Test deployment page
        run: |
          curl -f https://miyabi-world.com/deployment || exit 1

      - name: Test infrastructure page
        run: |
          curl -f https://miyabi-world.com/infrastructure || exit 1

      - name: Test database page
        run: |
          curl -f https://miyabi-world.com/database || exit 1

      - name: All smoke tests passed
        run: echo "✅ All pages accessible"
