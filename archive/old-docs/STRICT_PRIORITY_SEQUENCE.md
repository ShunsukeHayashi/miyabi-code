# Miyabi DevOPS å³æ ¼å„ªå…ˆé †ä½ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

**åˆ¤æ–­ã®ä½™åœ°ãªã—ã€‚ä¾‹å¤–ãªã—ã€‚å¿…ãšã“ã®é †åºã§å®Ÿè¡Œã€‚**

---

## çµ¶å¯¾å„ªå…ˆé †ä½ (Absolute Priority Sequence)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: æ‰¿èªæ¸ˆã¿PRãƒãƒ¼ã‚¸                        â”‚
â”‚  â†“ ãªã‘ã‚Œã°æ¬¡ã¸                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STEP 2: CIã‚¨ãƒ©ãƒ¼ä¿®æ­£                            â”‚
â”‚  â†“ ãªã‘ã‚Œã°æ¬¡ã¸                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STEP 3: P0 (Critical) Issueå¯¾å¿œ                â”‚
â”‚  â†“ ãªã‘ã‚Œã°æ¬¡ã¸                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STEP 4: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡PRã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½             â”‚
â”‚  â†“ ãªã‘ã‚Œã°æ¬¡ã¸                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STEP 5: P1 (High) Issueå¯¾å¿œ                    â”‚
â”‚  â†“ ãªã‘ã‚Œã°æ¬¡ã¸                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STEP 6: P2 (Medium) Issueå¯¾å¿œ                  â”‚
â”‚  â†“ ãªã‘ã‚Œã°æ¬¡ã¸                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STEP 7: P3 (Low) Issueå¯¾å¿œ                     â”‚
â”‚  â†“ ãªã‘ã‚Œã°æ¬¡ã¸                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STEP 8: æŠ€è¡“çš„è² å‚µè§£æ¶ˆ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Ÿè¡Œãƒ«ãƒ¼ãƒ«ï¼ˆä¾‹å¤–ãªã—ï¼‰

### RULE 1: ä¸Šä½ã‚¹ãƒ†ãƒƒãƒ—ãŒå­˜åœ¨ã™ã‚‹é™ã‚Šã€ä¸‹ä½ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚“ã§ã¯ãªã‚‰ãªã„

```
âŒ ç¦æ­¢: P1 IssueãŒã‚ã‚‹ã®ã«ã€P2 Issueã«ç€æ‰‹
âŒ ç¦æ­¢: æ‰¿èªæ¸ˆã¿PRãŒã‚ã‚‹ã®ã«ã€æ–°è¦Issueä½œæ¥­é–‹å§‹
âŒ ç¦æ­¢: CIãŒå£Šã‚Œã¦ã„ã‚‹ã®ã«ã€æ–°æ©Ÿèƒ½é–‹ç™º
```

### RULE 2: å„ã‚¹ãƒ†ãƒƒãƒ—ã¯å®Œäº†ã™ã‚‹ã¾ã§æ¬¡ã«é€²ã¾ãªã„

```
âŒ ç¦æ­¢: PRãƒãƒ¼ã‚¸ã‚’é€”ä¸­ã§ä¸­æ–­ã—ã¦åˆ¥ä½œæ¥­
âŒ ç¦æ­¢: P0å¯¾å¿œä¸­ã«ã€Œå¾Œã§æˆ»ã‚‹ã€ã¨è¨€ã£ã¦åˆ¥ä½œæ¥­
```

### RULE 3: ä¸¦åˆ—ä½œæ¥­ã¯åŒä¸€å„ªå…ˆåº¦å†…ã®ã¿è¨±å¯

```
âœ… è¨±å¯: P2 Issue #100 ã¨ P2 Issue #101 ã‚’ä¸¦åˆ—å®Ÿè¡Œ
âŒ ç¦æ­¢: P1 Issue #50 ã¨ P2 Issue #100 ã‚’ä¸¦åˆ—å®Ÿè¡Œ
```

---

## å„ã‚¹ãƒ†ãƒƒãƒ—ã®åˆ¤å®šåŸºæº–

### STEP 1: æ‰¿èªæ¸ˆã¿PRãƒãƒ¼ã‚¸

**åˆ¤å®šã‚³ãƒãƒ³ãƒ‰:**
```bash
gh pr list --state open --search "review:approved" --json number | jq length
```

**åˆ¤å®š:**
- çµæœ > 0 â†’ **ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ**
- çµæœ = 0 â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸

**å®Ÿè¡Œ:**
```bash
gh pr list --state open --search "review:approved" --json number --jq '.[].number' | while read pr; do
    gh pr merge $pr --merge
done
git checkout main && git pull origin main
```

---

### STEP 2: CIã‚¨ãƒ©ãƒ¼ä¿®æ­£

**åˆ¤å®šã‚³ãƒãƒ³ãƒ‰:**
```bash
gh run list --status failure --limit 1 --json databaseId | jq length
```

**åˆ¤å®š:**
- çµæœ > 0 â†’ **ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ**
- çµæœ = 0 â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸

**å®Ÿè¡Œ:**
1. å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç‰¹å®š
2. ã‚¨ãƒ©ãƒ¼åŸå› èª¿æŸ»
3. ä¿®æ­£ã‚³ãƒŸãƒƒãƒˆ
4. CIå†å®Ÿè¡Œç¢ºèª

---

### STEP 3: P0 (Critical) Issueå¯¾å¿œ

**åˆ¤å®šã‚³ãƒãƒ³ãƒ‰:**
```bash
gh issue list --state open --label "priority/critical" --json number | jq length
```

**åˆ¤å®š:**
- çµæœ > 0 â†’ **ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ**
- çµæœ = 0 â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸

**å®Ÿè¡Œ:**
```bash
issue=$(gh issue list --state open --label "priority/critical" --json number --jq '.[0].number')
mwork-start $issue
```

---

### STEP 4: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡PRã®ãƒ¬ãƒ“ãƒ¥ãƒ¼

**åˆ¤å®šã‚³ãƒãƒ³ãƒ‰:**
```bash
gh pr list --state open --search "review:required" --json number | jq length
```

**åˆ¤å®š:**
- çµæœ > 0 â†’ **ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ**
- çµæœ = 0 â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸

**å®Ÿè¡Œ:**
1. PRã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. ã‚³ãƒ¡ãƒ³ãƒˆ or æ‰¿èª

---

### STEP 5: P1 (High) Issueå¯¾å¿œ

**åˆ¤å®šã‚³ãƒãƒ³ãƒ‰:**
```bash
gh issue list --state open --label "priority/high" --json number | jq length
```

**åˆ¤å®š:**
- çµæœ > 0 â†’ **ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ**
- çµæœ = 0 â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸

---

### STEP 6: P2 (Medium) Issueå¯¾å¿œ

**åˆ¤å®šã‚³ãƒãƒ³ãƒ‰:**
```bash
gh issue list --state open --label "priority/medium" --json number | jq length
```

---

### STEP 7: P3 (Low) Issueå¯¾å¿œ

**åˆ¤å®šã‚³ãƒãƒ³ãƒ‰:**
```bash
gh issue list --state open --label "priority/low" --json number | jq length
```

---

### STEP 8: æŠ€è¡“çš„è² å‚µè§£æ¶ˆ

**åˆ¤å®š:**
- ä¸Šè¨˜ã™ã¹ã¦ãŒ0ã®å ´åˆã®ã¿å®Ÿè¡Œå¯èƒ½

---

## è‡ªå‹•åˆ¤å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# miyabi-priority-check.sh
# æ¬¡ã«å®Ÿè¡Œã™ã¹ãã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•åˆ¤å®š

set -e

echo "ğŸ” Miyabi DevOPS å„ªå…ˆé †ä½ãƒã‚§ãƒƒã‚¯"
echo "=================================="

# STEP 1: æ‰¿èªæ¸ˆã¿PR
approved_prs=$(gh pr list --state open --search "review:approved" --json number | jq length)
if [ "$approved_prs" -gt 0 ]; then
    echo "ğŸ”´ STEP 1: æ‰¿èªæ¸ˆã¿PRãƒãƒ¼ã‚¸ ($approved_prsä»¶)"
    echo "ã‚³ãƒãƒ³ãƒ‰: mwork-merge-all-approved"
    exit 1
fi

# STEP 2: CIã‚¨ãƒ©ãƒ¼
ci_failures=$(gh run list --status failure --limit 1 --json databaseId 2>/dev/null | jq length || echo 0)
if [ "$ci_failures" -gt 0 ]; then
    echo "ğŸ”´ STEP 2: CIã‚¨ãƒ©ãƒ¼ä¿®æ­£"
    echo "ã‚³ãƒãƒ³ãƒ‰: gh run list --status failure"
    exit 2
fi

# STEP 3: P0 Critical
p0_issues=$(gh issue list --state open --label "priority/critical" --json number | jq length)
if [ "$p0_issues" -gt 0 ]; then
    echo "ğŸ”´ STEP 3: P0 Critical Issue ($p0_issuesä»¶)"
    gh issue list --state open --label "priority/critical"
    exit 3
fi

# STEP 4: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡PR
review_required=$(gh pr list --state open --search "review:required" --json number 2>/dev/null | jq length || echo 0)
if [ "$review_required" -gt 0 ]; then
    echo "ğŸŸ¡ STEP 4: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡PR ($review_requiredä»¶)"
    gh pr list --state open --search "review:required"
    exit 4
fi

# STEP 5: P1 High
p1_issues=$(gh issue list --state open --label "priority/high" --json number | jq length)
if [ "$p1_issues" -gt 0 ]; then
    echo "ğŸŸ¡ STEP 5: P1 High Issue ($p1_issuesä»¶)"
    gh issue list --state open --label "priority/high"
    exit 5
fi

# STEP 6: P2 Medium
p2_issues=$(gh issue list --state open --label "priority/medium" --json number | jq length)
if [ "$p2_issues" -gt 0 ]; then
    echo "ğŸŸ¢ STEP 6: P2 Medium Issue ($p2_issuesä»¶)"
    gh issue list --state open --label "priority/medium"
    exit 6
fi

# STEP 7: P3 Low
p3_issues=$(gh issue list --state open --label "priority/low" --json number | jq length)
if [ "$p3_issues" -gt 0 ]; then
    echo "ğŸŸ¢ STEP 7: P3 Low Issue ($p3_issuesä»¶)"
    gh issue list --state open --label "priority/low"
    exit 7
fi

# STEP 8: æŠ€è¡“çš„è² å‚µ
echo "âœ… STEP 8: æŠ€è¡“çš„è² å‚µè§£æ¶ˆãƒ•ã‚§ãƒ¼ã‚º"
echo "ã™ã¹ã¦ã®å„ªå…ˆã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦ã„ã¾ã™"
exit 0
```

---

## å¼·åˆ¶ãƒã‚§ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰

### ä½œæ¥­é–‹å§‹å‰ã®å¿…é ˆãƒã‚§ãƒƒã‚¯

```bash
# ã“ã®ã‚³ãƒãƒ³ãƒ‰ãŒOKã‚’è¿”ã•ãªã„é™ã‚Šã€æ–°è¦ä½œæ¥­ã‚’é–‹å§‹ã—ã¦ã¯ãªã‚‰ãªã„
miyabi-priority-check
```

### è¿”ã‚Šå€¤ã®æ„å‘³

| Exit Code | æ„å‘³ | æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|-----------|------|---------------|
| 0 | å…¨å„ªå…ˆã‚¿ã‚¹ã‚¯å®Œäº† | æŠ€è¡“çš„è² å‚µè§£æ¶ˆå¯èƒ½ |
| 1 | æ‰¿èªæ¸ˆã¿PRã‚ã‚Š | PRãƒãƒ¼ã‚¸å®Ÿè¡Œ |
| 2 | CIã‚¨ãƒ©ãƒ¼ã‚ã‚Š | CIä¿®æ­£ |
| 3 | P0 Issueã‚ã‚Š | P0å¯¾å¿œ |
| 4 | ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡PRã‚ã‚Š | ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½ |
| 5 | P1 Issueã‚ã‚Š | P1å¯¾å¿œ |
| 6 | P2 Issueã‚ã‚Š | P2å¯¾å¿œ |
| 7 | P3 Issueã‚ã‚Š | P3å¯¾å¿œ |

---

## Hook ã«ã‚ˆã‚‹å¼·åˆ¶

### Pre-Worktree-Create Hook

Worktreeä½œæˆå‰ã«å„ªå…ˆé †ä½ãƒã‚§ãƒƒã‚¯ã‚’å¼·åˆ¶:

```bash
# .claude/hooks.json ã«è¿½åŠ 
{
  "PreToolCall": [
    {
      "description": "å„ªå…ˆé †ä½ãƒã‚§ãƒƒã‚¯å¼·åˆ¶",
      "enabled": true,
      "matcher": {
        "tool_name": "Bash",
        "tool_input": "git worktree add"
      },
      "command": "bash",
      "args": [
        "-c",
        "~/Dev/01-miyabi/_core/miyabi-private/scripts/miyabi-priority-check.sh || (echo 'âŒ å„ªå…ˆã‚¿ã‚¹ã‚¯ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚å…ˆã«å®Œäº†ã—ã¦ãã ã•ã„ã€‚' && exit 1)"
      ]
    }
  ]
}
```

---

## é•åæ™‚ã®å¯¾å¿œ

### é•åãƒ‘ã‚¿ãƒ¼ãƒ³

1. **å„ªå…ˆé †ä½ã‚¹ã‚­ãƒƒãƒ—**: P1ãŒã‚ã‚‹ã®ã«P2ã«ç€æ‰‹
2. **æœªãƒãƒ¼ã‚¸PRæ”¾ç½®**: æ‰¿èªæ¸ˆã¿PRã‚’æ”¾ç½®ã—ã¦æ–°è¦ä½œæ¥­
3. **CIç„¡è¦–**: CIãŒå£Šã‚ŒãŸã¾ã¾é–‹ç™ºç¶™ç¶š

### å¯¾å¿œ

- **è‡ªå‹•æ¤œå‡º**: Hook/CIã§æ¤œå‡º
- **ä½œæ¥­ãƒ–ãƒ­ãƒƒã‚¯**: é•åçŠ¶æ…‹ã§ã¯æ–°è¦ä½œæ¥­ä¸å¯
- **å¼·åˆ¶ä¿®æ­£**: å„ªå…ˆã‚¿ã‚¹ã‚¯å®Œäº†ã¾ã§é€²è¡Œç¦æ­¢

---

## ã¾ã¨ã‚

```
åˆ¤æ–­ã™ã‚‹ãªã€‚ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«å¾“ãˆã€‚
ä¸Šã‹ã‚‰é †ã«å®Ÿè¡Œã€‚é£›ã°ã™ãªã€‚
å®Œäº†ã™ã‚‹ã¾ã§æ¬¡ã«é€²ã‚€ãªã€‚
```

**ã“ã‚ŒãŒMiyabi DevOPSã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã§ã‚ã‚‹ã€‚**
