# Miyabi Relation Definitions - 39 Relations
# Version: 1.0.0
# Source: docs/architecture/ENTITY_RELATION_MODEL.md
# Notation: N1/N2/N3 (Cardinality: 1:1, 1:N, N:N)

relations:
  # Issue Relations (R1-R4, R36)
  R1_Issue_analyzed_by_Agent:
    id: "R1"
    name: "analyzed-by"
    source: "E1_Issue"
    target: "E3_Agent"
    cardinality: "1:1"
    notation: "N1"
    description: "IssueãŒIssueAgentã«ã‚ˆã‚Šåˆ†æã•ã‚Œã‚‹"

    implementation:
      trigger: "Issueä½œæˆæ™‚ã€ã¾ãŸã¯Labelå¤‰æ›´æ™‚"
      method: "issueAgent.analyzeIssue(issue)"
      actions:
        - "Labelè‡ªå‹•ä»˜ä¸: type, priority, severity"
        - "é–¢é€£Issueæ¤œç´¢"
        - "good-first-issueåˆ¤å®š"
      file: ".claude/agents/specs/issue-agent.md"

    example: |
      const analysis = await issueAgent.analyzeIssue(issue);
      await issueAgent.addLabels(issue.number, analysis.suggestedLabels);

  R2_Issue_decomposed_into_Task:
    id: "R2"
    name: "decomposed-into"
    source: "E1_Issue"
    target: "E2_Task"
    cardinality: "1:N"
    notation: "N2"
    description: "IssueãŒCoordinatorAgentã«ã‚ˆã‚ŠTaské…åˆ—ã«åˆ†è§£ã•ã‚Œã‚‹"

    implementation:
      agent: "CoordinatorAgent"
      method: "coordinator.decomposeIssue(issue)"
      algorithm:
        - "Issueæœ¬æ–‡è§£æï¼ˆAIã«ã‚ˆã‚‹æ„å›³ç†è§£ï¼‰"
        - "ã‚¿ã‚¹ã‚¯æŠ½å‡ºï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼ã€ã¾ãŸã¯è‡ªå‹•æ¨å®šï¼‰"
        - "ä¾å­˜é–¢ä¿‚æŠ½å‡ºï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: after, requires, depends onï¼‰"
        - "DAGæ§‹ç¯‰ï¼ˆãƒˆãƒãƒ­ã‚¸ã‚«ãƒ«ã‚½ãƒ¼ãƒˆï¼‰"
        - "å¾ªç’°ä¾å­˜ãƒã‚§ãƒƒã‚¯"
      file: ".claude/agents/specs/coordinator-agent.md"

    example: |
      const decomposition: TaskDecomposition = await coordinator.decomposeIssue(issue);
      const tasks: Task[] = decomposition.tasks;
      const dag: DAG = decomposition.dag;

  R3_Issue_tagged_with_Label:
    id: "R3"
    name: "tagged-with"
    source: "E1_Issue"
    target: "E5_Label"
    cardinality: "1:N"
    notation: "N2"
    description: "Issueã«Labelé…åˆ—ãŒä»˜ä¸ã•ã‚Œã‚‹"

    implementation:
      method: "GitHub API (octokit.issues.addLabels)"
      auto_assignment_timing:
        - "Issueä½œæˆæ™‚: state:pending"
        - "Agentèµ·å‹•æ™‚: agent:coordinator, state:analyzing"
        - "ã‚¿ã‚¹ã‚¯å‰²ã‚Šå½“ã¦æ™‚: agent:codegen, state:implementing"
        - "PRä½œæˆæ™‚: state:reviewing"
        - "ãƒãƒ¼ã‚¸æ™‚: state:done"
      file: "docs/guides/LABEL_SYSTEM_GUIDE.md"

    example: |
      await octokit.issues.addLabels({
        owner, repo,
        issue_number: issue.number,
        labels: ['ğŸ¤– agent:codegen', 'âœ¨ type:feature']
      });

  R4_Issue_creates_PR:
    id: "R4"
    name: "creates"
    source: "E1_Issue"
    target: "E4_PR"
    cardinality: "1:1 (or 1:N)"
    notation: "N1/N2"
    description: "Issueã‹ã‚‰PRãŒä½œæˆã•ã‚Œã‚‹ï¼ˆè¤‡æ•°PRå¯èƒ½æ€§ã‚ã‚Šï¼‰"

    implementation:
      agent: "PRAgent"
      method: "prAgent.createPR"
      pr_title_format: "Conventional Commits"
      pr_body_includes:
        - "Closes #{issue.number}"
        - "Summary"
        - "Test plan"
        - "ğŸ¤– Generated with Claude Code"
        - "Co-Authored-By: Claude <noreply@anthropic.com>"
      file: ".claude/agents/specs/pr-agent.md"

    example: |
      const prResult = await prAgent.createPR({
        title: generateConventionalCommitTitle(issue),
        body: generatePRBody(issue, tasks, metrics),
        issueNumber: issue.number,
        draft: true
      });

  R36_Issue_parent_of_SubIssue:
    id: "R36"
    name: "parent-of"
    source: "E1_Issue"
    target: "E14_SubIssue"
    cardinality: "1:N"
    notation: "N2"
    description: "IssueãŒSubIssueï¼ˆå­Issueï¼‰ã‚’æŒã¤"

    implementation:
      method: "issueAgent.createSubIssue"
      labels: ["ğŸŒ³ hierarchy:root", "ğŸ“‚ hierarchy:parent"]
      auto_tracking:
        - "å­Issueã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†"
        - "å®Œäº†ç‡ã®è‡ªå‹•è¨ˆç®—"
        - "è¦ªIssueæœ¬æ–‡ã«ã€Œ## Child Issuesã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ "
      file: "packages/coding-agents/issue/issue-agent.ts"

    example: |
      const subIssue = await issueAgent.createSubIssue({
        title: "å­ã‚¿ã‚¹ã‚¯",
        body: "è©³ç´°",
        parentIssueNumber: 100,
        labels: ["type:feature"]
      });

  # Task Relations (R5-R8)
  R5_Task_assigned_to_Agent:
    id: "R5"
    name: "assigned-to"
    source: "E2_Task"
    target: "E3_Agent"
    cardinality: "N:1"
    notation: "N1"
    description: "TaskãŒAgentã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹"

    implementation:
      agent: "CoordinatorAgent"
      assignment_logic: |
        switch (task.type) {
          case 'feature':
          case 'bug':
          case 'refactor':
            return 'CodeGenAgent';
          case 'deployment':
            return 'DeploymentAgent';
          case 'docs':
            return 'CodeGenAgent';
          default:
            return 'CoordinatorAgent';
        }
      file: "agents/coordinator/coordinator-agent.ts"

    example: |
      task.assignedAgent = assignAgent(task);

  R6_Task_depends_on_Task:
    id: "R6"
    name: "depends-on"
    source: "E2_Task"
    target: "E2_Task"
    cardinality: "N:N"
    notation: "N3"
    description: "TaskãŒTaskï¼ˆä¾å­˜é–¢ä¿‚ï¼‰ã«ä¾å­˜ã™ã‚‹"

    implementation:
      representation: "dependencies: string[] (ä¾å­˜TaskIDãƒªã‚¹ãƒˆ)"
      dag_construction: "buildDAG(tasks)"
      topological_sort: "sortedLevels = topologicalSort(dag)"
      file: "agents/types/index.ts:37-52"

    example: |
      const tasks = [
        { id: 'T1', title: 'ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ', dependencies: [] },
        { id: 'T2', title: 'APIå®Ÿè£…', dependencies: ['T1'] },
        { id: 'T3', title: 'UIå®Ÿè£…', dependencies: ['T2'] },
        { id: 'T4', title: 'ãƒ†ã‚¹ãƒˆä½œæˆ', dependencies: ['T2', 'T3'] }
      ];

  R7_Task_part_of_DAG:
    id: "R7"
    name: "part-of"
    source: "E2_Task"
    target: "E11_DAG"
    cardinality: "N:1"
    notation: "N1"
    description: "TaskãŒDAGã«å«ã¾ã‚Œã‚‹"

    implementation:
      structure: |
        DAG {
          nodes: Task[]
          edges: Array<{ from: string; to: string }>
          levels: string[][]  // ä¸¦åˆ—å®Ÿè¡Œãƒ¬ãƒ™ãƒ«
        }
      file: "agents/types/index.ts:66-70"

    example: |
      const dag: DAG = {
        nodes: [T1, T2, T3, T4],
        edges: [
          { from: 'T1', to: 'T2' },
          { from: 'T2', to: 'T3' },
          { from: 'T2', to: 'T4' },
          { from: 'T3', to: 'T4' }
        ],
        levels: [['T1'], ['T2'], ['T3'], ['T4']]
      };

  R8_Task_runs_in_Worktree:
    id: "R8"
    name: "runs-in"
    source: "E2_Task"
    target: "E12_Worktree"
    cardinality: "1:1"
    notation: "N1"
    description: "TaskãŒWorktreeå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹"

    implementation:
      worktree_creation: "git worktree add .worktrees/issue-270 -b feature/agent-issue-270"
      execution: "cd .worktrees/issue-270 && <task execution>"
      path_convention: ".worktrees/issue-{ISSUE_NUMBER}/task-{TASK_ID}/"
      file: "CLAUDE.md (Git Worktreeä¸¦åˆ—å®Ÿè¡Œã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)"

    example: |
      cd .worktrees/issue-270
      # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
      # .claude/agents/prompts/codegen-agent-prompt.md

  # Agent Relations (R9-R15)
  R9_Agent_executes_Task:
    id: "R9"
    name: "executes"
    source: "E3_Agent"
    target: "E2_Task"
    cardinality: "1:N"
    notation: "N2"
    description: "AgentãŒTaskã‚’å®Ÿè¡Œã™ã‚‹"

    implementation:
      base_class: "BaseAgent"
      method: "execute(task: Task): Promise<AgentResult>"
      steps:
        - "Taskæ¤œè¨¼"
        - "å®Ÿè¡Œ"
        - "çµæœè¨˜éŒ²"
        - "LDDãƒ­ã‚°å‡ºåŠ›"
      file: "agents/base-agent.ts"

    example: |
      class CodeGenAgent extends BaseAgent {
        async execute(task: Task): Promise<AgentResult> {
          const code = await this.generateCode(task);
          const tests = await this.generateTests(code);
          return { status: 'success', data: { code, tests } };
        }
      }

  R10_Agent_generates_PR:
    id: "R10"
    name: "generates"
    source: "E3_Agent"
    target: "E4_PR"
    cardinality: "N:1"
    notation: "N1"
    description: "Agentï¼ˆè¤‡æ•°ï¼‰ãŒPRç”Ÿæˆã«é–¢ä¸ã™ã‚‹"

    implementation:
      involved_agents:
        - "CodeGenAgent: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€commitä½œæˆ"
        - "PRAgent: PRä½œæˆã€Conventional Commitsã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ"
        - "ReviewAgent: å“è³ªãƒ¬ãƒãƒ¼ãƒˆæ·»ä»˜"
      file: ".claude/agents/specs/pr-agent.md"

    example: |
      const pr = await prAgent.createPR({
        title: 'feat: Issue #270 - ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼å®Ÿè£…',
        body: generatePRBody(issue, qualityReport),
        draft: true,
        issueNumber: 270
      });

  R11_Agent_creates_QualityReport:
    id: "R11"
    name: "creates"
    source: "E3_Agent"
    target: "E6_QualityReport"
    cardinality: "1:1"
    notation: "N1"
    description: "Agentï¼ˆReviewAgentï¼‰ãŒQualityReportã‚’ä½œæˆã™ã‚‹"

    implementation:
      agent: "ReviewAgent"
      method: "reviewAgent.evaluateQuality"
      scoring_criteria:
        - "ESLintã‚¨ãƒ©ãƒ¼: -20ç‚¹/ä»¶"
        - "TypeScriptã‚¨ãƒ©ãƒ¼: -30ç‚¹/ä»¶"
        - "é‡å¤§ãªè„†å¼±æ€§: -40ç‚¹/ä»¶"
        - "ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸è¶³: -10ç‚¹ï¼ˆ80%æœªæº€ï¼‰"
      passing_score: 80
      file: ".claude/agents/specs/review-agent.md"

    example: |
      const qualityReport: QualityReport = await reviewAgent.evaluateQuality({
        files: changedFiles,
        branch: 'feature/agent-issue-270'
      });
      qualityReport.passed = qualityReport.score >= 80;

  R12_Agent_triggers_Escalation:
    id: "R12"
    name: "triggers"
    source: "E3_Agent"
    target: "E8_Escalation"
    cardinality: "N:1"
    notation: "N1"
    description: "AgentãŒEscalationã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹"

    implementation:
      method: "baseAgent.escalate"
      conditions:
        TechLead: "è¤‡é›‘åº¦è¶…éã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å•é¡Œ"
        CISO: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ï¼ˆSev.1-2ï¼‰"
        PO: "è¦ä»¶ä¸æ˜ç¢º"
        CTO: "ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«éšœå®³"
        DevOps: "ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
      notifications:
        - "GitHub Issue comment"
        - "Slack/Discordé€šçŸ¥"
      file: "agents/base-agent.ts (escalate ãƒ¡ã‚½ãƒƒãƒ‰)"

    example: |
      await this.escalate(
        "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¤‡é›‘åº¦è¶…é",
        "TechLead",
        "Sev.2-High",
        { complexity: 8.5, threshold: 7.0 }
      );

  R13_Agent_performs_Deployment:
    id: "R13"
    name: "performs"
    source: "E3_Agent"
    target: "E9_Deployment"
    cardinality: "1:1"
    notation: "N1"
    description: "Agentï¼ˆDeploymentAgentï¼‰ãŒDeploymentã‚’å®Ÿè¡Œã™ã‚‹"

    implementation:
      agent: "DeploymentAgent"
      method: "deploymentAgent.deploy"
      steps:
        - "Firebase/Cloudè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤"
        - "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
        - "è‡ªå‹•Rollbackï¼ˆå¤±æ•—æ™‚ï¼‰"
      file: ".claude/agents/specs/deployment-agent.md"

    example: |
      const deploymentResult = await deploymentAgent.deploy({
        environment: 'staging',
        version: '1.2.3',
        projectId: 'miyabi-staging',
        targets: ['hosting', 'functions'],
        autoRollback: true,
        healthCheckUrl: 'https://staging.example.com/health'
      });

  R14_Agent_logs_to_LDDLog:
    id: "R14"
    name: "logs-to"
    source: "E3_Agent"
    target: "E10_LDDLog"
    cardinality: "N:N"
    notation: "N3"
    description: "å…¨ã¦ã®AgentãŒLDDLogã«å‡ºåŠ›ã™ã‚‹"

    implementation:
      method: "baseAgent.logToLDD"
      log_format: "Markdown"
      output_location: ".ai/logs/YYYY-MM-DD.md"
      content:
        - "Session ID"
        - "Codex Prompt Chain (Intent, Plan, Implementation, Verification)"
        - "Tool Invocations"
        - "Memory Bank Updates"
        - "Next Steps"
      file: "agents/base-agent.ts (logToLDD ãƒ¡ã‚½ãƒƒãƒ‰)"

    example: |
      await this.logToLDD(
        codexPromptChain,
        toolInvocations
      );

  R15_Command_invokes_Agent:
    id: "R15"
    name: "invoked-by"
    source: "E7_Command"
    target: "E3_Agent"
    cardinality: "1:1 or 1:N"
    notation: "N1/N2"
    description: "CommandãŒAgentã‚’èµ·å‹•ã™ã‚‹"

    implementation:
      command_agent_mapping:
        "/agent-run": "CoordinatorAgent"
        "/deploy": "DeploymentAgent"
        "/security-scan": "ReviewAgent"
        "/generate-docs": "CodeGenAgent"
      file: ".claude/commands/*.md"

    example: |
      <!-- .claude/commands/agent-run.md -->
      ```bash
      npm run agents:parallel:exec -- --issue=$ISSUE_NUMBER
      ```

  # Label Relations (R16-R18)
  R16_Label_triggers_Agent:
    id: "R16"
    name: "triggers"
    source: "E5_Label"
    target: "E3_Agent"
    cardinality: "1:1"
    notation: "N1"
    description: "ç‰¹å®šLabelãŒAgentèµ·å‹•ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹"

    implementation:
      trigger_labels:
        "trigger:agent-execute": "CoordinatorAgent"
        "trigger:generate-report": "ReportAgent (æœªå®Ÿè£…)"
        "trigger:deploy-staging": "DeploymentAgent"
        "trigger:deploy-production": "DeploymentAgent"
      workflow: ".github/workflows/autonomous-agent.yml"
      condition: "if: contains(github.event.label.name, 'trigger:agent-execute')"
      file: "docs/guides/LABEL_SYSTEM_GUIDE.md"

    example: |
      on:
        issues:
          types: [labeled]
      jobs:
        execute:
          if: contains(github.event.label.name, 'trigger:agent-execute')
          runs-on: ubuntu-latest

  R17_Label_defines_state_Issue:
    id: "R17"
    name: "defines-state"
    source: "E5_Label"
    target: "E1_Issue"
    cardinality: "N:1"
    notation: "N1"
    description: "Labelï¼ˆè¤‡æ•°ï¼‰ãŒIssueçŠ¶æ…‹ã‚’å®šç¾©ã™ã‚‹"

    implementation:
      state_transition: |
        pending â†’ analyzing â†’ implementing â†’ reviewing â†’ done
                    â†“            â†“            â†“
                 blocked      blocked      blocked
                    â†“            â†“            â†“
                 failed       failed       failed
      method: "getIssueState(labels: string[]): string"
      file: "docs/guides/LABEL_SYSTEM_GUIDE.md"

    example: |
      const getIssueState = (labels: string[]): string => {
        if (labels.includes('state:pending')) return 'pending';
        if (labels.includes('state:analyzing')) return 'analyzing';
        if (labels.includes('state:implementing')) return 'implementing';
        if (labels.includes('state:reviewing')) return 'reviewing';
        if (labels.includes('state:done')) return 'done';
        return 'unknown';
      };

  R18_Label_categorizes_Task:
    id: "R18"
    name: "categorizes"
    source: "E5_Label"
    target: "E2_Task"
    cardinality: "N:1"
    notation: "N1"
    description: "Labelï¼ˆè¤‡æ•°ï¼‰ãŒTaskã‚’åˆ†é¡ã™ã‚‹"

    implementation:
      type_labels:
        - "type:feature"
        - "type:bug"
        - "type:refactor"
        - "type:docs"
        - "type:test"
        - "type:deployment"
      method: "getTaskType(labels: string[]): Task['type']"
      file: "agents/types/index.ts, docs/guides/LABEL_SYSTEM_GUIDE.md"

    example: |
      const getTaskType = (labels: string[]): Task['type'] => {
        if (labels.includes('type:feature')) return 'feature';
        if (labels.includes('type:bug')) return 'bug';
        return 'feature'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      };

  # PR Relations (R19-R21)
  R19_PR_reviewed_by_Agent:
    id: "R19"
    name: "reviewed-by"
    source: "E4_PR"
    target: "E3_Agent"
    cardinality: "1:1"
    notation: "N1"
    description: "PRãŒReviewAgentã«ã‚ˆã‚Šãƒ¬ãƒ“ãƒ¥ãƒ¼ã•ã‚Œã‚‹"

    implementation:
      agent: "ReviewAgent"
      method: "reviewAgent.reviewPR"
      output: "GitHub PR comment with QualityReport"
      format: |
        ## ğŸ¤– ReviewAgent Report
        ### Quality Score: 85/100 âœ…
        **Breakdown**: ESLint: 95/100, TypeScript: 100/100, ...
      file: ".claude/agents/specs/review-agent.md"

    example: |
      const reviewResult = await reviewAgent.reviewPR({
        files: pr.changedFiles,
        branch: pr.headBranch,
        context: pr.body
      });
      await octokit.issues.createComment({
        owner, repo,
        issue_number: pr.number,
        body: formatReviewComment(reviewResult)
      });

  R20_PR_has_QualityReport:
    id: "R20"
    name: "has"
    source: "E4_PR"
    target: "E6_QualityReport"
    cardinality: "1:1"
    notation: "N1"
    description: "PRãŒQualityReportã‚’æŒã¤"

    implementation:
      attachment: "GitHub PR comment"
      quality_labels:
        "â­ quality:excellent": "90-100ç‚¹"
        "âœ… quality:good": "80-89ç‚¹"
        "âš ï¸ quality:needs-improvement": "60-79ç‚¹"
        "ğŸ”´ quality:poor": "0-59ç‚¹"
      file: "agents/types/index.ts:108-130"

    example: |
      await octokit.issues.createComment({
        owner, repo,
        issue_number: pr.number,
        body: formatQualityReport(qualityReport)
      });
      const qualityLabel = getQualityLabel(qualityReport.score);
      await octokit.issues.addLabels({
        owner, repo,
        issue_number: pr.number,
        labels: [qualityLabel]
      });

  R21_PR_attached_to_Issue:
    id: "R21"
    name: "attached-to"
    source: "E4_PR"
    target: "E1_Issue"
    cardinality: "N:1"
    notation: "N1"
    description: "PRãŒIssueã«ç´ã¥ã"

    implementation:
      link_method: "PR body with 'Closes #{issue.number}'"
      auto_link: "GitHub auto-linking"
      file: ".claude/agents/specs/pr-agent.md"

    example: |
      const prBody = `
      Closes #${issue.number}

      ## Summary
      ...
      `;

  # QualityReport Relations (R22-R23)
  R22_QualityReport_evaluated_by_Agent:
    id: "R22"
    name: "evaluated-by"
    source: "E6_QualityReport"
    target: "E3_Agent"
    cardinality: "1:1"
    notation: "N1"
    description: "QualityReportãŒReviewAgentã«ã‚ˆã‚Šè©•ä¾¡ã•ã‚Œã‚‹"

    note: "Same as R11 (inverse relation)"

  R23_QualityReport_attached_to_PR:
    id: "R23"
    name: "attached-to"
    source: "E6_QualityReport"
    target: "E4_PR"
    cardinality: "1:1"
    notation: "N1"
    description: "QualityReportãŒPRã«æ·»ä»˜ã•ã‚Œã‚‹"

    note: "Same as R20 (inverse relation)"

  # DAG Relations (R24-R25)
  R24_DAG_decomposed_from_Issue:
    id: "R24"
    name: "decomposed-from"
    source: "E11_DAG"
    target: "E1_Issue"
    cardinality: "1:1"
    notation: "N1"
    description: "DAGãŒIssueã‹ã‚‰åˆ†è§£ã•ã‚Œã‚‹"

    implementation:
      agent: "CoordinatorAgent"
      method: "coordinator.decomposeIssue(issue)"
      output: |
        TaskDecomposition {
          originalIssue: Issue
          tasks: Task[]
          dag: DAG
          estimatedTotalDuration: number
          hasCycles: boolean
          recommendations: string[]
        }
      file: "agents/coordinator/coordinator-agent.ts"

    example: |
      const taskDecomposition = await coordinator.decomposeIssue(issue);
      const dag = taskDecomposition.dag;

  R25_DAG_contains_Task:
    id: "R25"
    name: "contains"
    source: "E11_DAG"
    target: "E2_Task"
    cardinality: "1:N"
    notation: "N2"
    description: "DAGãŒTaské…åˆ—ã‚’å«ã‚€"

    implementation:
      structure: |
        DAG {
          nodes: Task[]  // å…¨Task
          edges: Array<{ from: string; to: string }>
        }
      file: "agents/types/index.ts:66-70"

    example: |
      interface DAG {
        nodes: Task[];
        edges: Array<{ from: string; to: string }>;
      }

  # Worktree Relations (R26-R27)
  R26_Worktree_executes_Task:
    id: "R26"
    name: "executes"
    source: "E12_Worktree"
    target: "E2_Task"
    cardinality: "1:1"
    notation: "N1"
    description: "WorktreeãŒTaskã‚’å®Ÿè¡Œã™ã‚‹"

    implementation:
      creation: "git worktree add .worktrees/issue-270 -b feature/agent-issue-270"
      execution: "cd .worktrees/issue-270 && <agent execution>"
      cleanup: "git checkout main && git merge feature/agent-issue-270"
      file: "CLAUDE.md"

    example: |
      cd .worktrees/issue-270
      # Claude CodeãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
      # .claude/agents/prompts/codegen-agent-prompt.md

  R27_Worktree_creates_PR:
    id: "R27"
    name: "creates"
    source: "E12_Worktree"
    target: "E4_PR"
    cardinality: "1:1"
    notation: "N1"
    description: "Worktreeã‹ã‚‰PRãŒä½œæˆã•ã‚Œã‚‹"

    implementation:
      command: "gh pr create --title 'feat: Issue #270 - æ©Ÿèƒ½å®Ÿè£…' --draft"
      location: "Worktreeå†…ã§å®Ÿè¡Œ"
      file: "scripts/parallel-executor.ts"

    example: |
      cd .worktrees/issue-270
      gh pr create --title "feat: Issue #270 - æ©Ÿèƒ½å®Ÿè£…" --draft

  # Discord Community Relations (R28-R35)
  R28_Issue_notifies_to_DiscordCommunity:
    id: "R28"
    name: "notifies-to"
    source: "E1_Issue"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "IssueãŒDiscordCommunityã«é€šçŸ¥ã•ã‚Œã‚‹"

    implementation:
      channels: ["#announcements", "#dev-general"]
      trigger: "Issueä½œæˆæ™‚ã€ãƒ©ãƒ™ãƒ«å¤‰æ›´æ™‚"
      method: "discord webhook"
      file: "docs/DISCORD_COMMUNITY_PLAN.md"

    example: |
      await sendWebhook(webhook.webhookUrl, {
        content: `ğŸ“¢ **New Issue Created**\n\nIssue #${issue.number}: ${issue.title}\n${issue.url}`
      });

  R29_Agent_posts_to_DiscordCommunity:
    id: "R29"
    name: "posts-to"
    source: "E3_Agent"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "AgentãŒDiscordCommunityã«æŠ•ç¨¿ã™ã‚‹"

    implementation:
      channels: ["#dev-general", "#dev-agents"]
      trigger: "Agentå®Ÿè¡Œé–‹å§‹æ™‚ã€å®Œäº†æ™‚ã€å¤±æ•—æ™‚"
      method: "discord.post with embed"
      file: "agents/base-agent.ts (Discordé€šçŸ¥ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ äºˆå®š)"

    example: |
      await discord.post('#dev-general', {
        embed: {
          title: `ğŸ¤– ${agentType} Started`,
          description: `Task: ${task.title}`,
          color: 0x1976D2
        }
      });

  R30_QualityReport_announces_in_DiscordCommunity:
    id: "R30"
    name: "announces-in"
    source: "E6_QualityReport"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "QualityReportãŒDiscordCommunityã§ç™ºè¡¨ã•ã‚Œã‚‹"

    implementation:
      channels: ["#dev-pull-requests"]
      trigger: "QualityReportå®Œæˆæ™‚"
      format: "embed with score breakdown"
      file: "agents/review/review-agent.ts"

    example: |
      await discord.post('#dev-pull-requests', {
        embed: {
          title: `ğŸ“Š Quality Report - PR #${pr.number}`,
          description: `Score: ${qualityReport.score}/100 ${qualityReport.passed ? 'âœ…' : 'âŒ'}`,
          fields: [
            { name: 'ESLint', value: `${qualityReport.breakdown.eslintScore}/100` }
          ]
        }
      });

  R31_PR_announces_in_DiscordCommunity:
    id: "R31"
    name: "announces-in"
    source: "E4_PR"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "PRãŒDiscordCommunityã§ç™ºè¡¨ã•ã‚Œã‚‹"

    implementation:
      channels: ["#release-notes", "#dev-pull-requests"]
      trigger: "PRä½œæˆæ™‚ã€ãƒãƒ¼ã‚¸æ™‚ã€ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚"
      file: "agents/pr/pr-agent.ts"

    example: |
      await discord.post('#release-notes', {
        content: `ğŸ‰ **New Pull Request**\n\nPR #${pr.number}: ${pr.title}\n${pr.url}`
      });

  R32_Deployment_notifies_to_DiscordCommunity:
    id: "R32"
    name: "notifies-to"
    source: "E9_Deployment"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "DeploymentãŒDiscordCommunityã«é€šçŸ¥ã•ã‚Œã‚‹"

    implementation:
      channels: ["#announcements"]
      trigger: "ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸæ™‚ã€å¤±æ•—æ™‚ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚"
      format: "embed with deployment details"
      file: "agents/deployment/deployment-agent.ts"

    example: |
      await discord.post('#announcements', {
        embed: {
          title: `ğŸš€ Deployment ${deploymentResult.status === 'success' ? 'Successful' : 'Failed'}`,
          description: `Environment: ${deploymentResult.environment}\nVersion: ${deploymentResult.version}`
        }
      });

  R33_Label_triggers_notification_to_DiscordCommunity:
    id: "R33"
    name: "triggers-notification-to"
    source: "E5_Label"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "ç‰¹å®šLabelãŒDiscordCommunityé€šçŸ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹"

    implementation:
      critical_labels:
        - "priority:P0-Critical"
        - "severity:Sev.1-Critical"
        - "security"
      channels: ["#help-general", "#announcements"]
      mention: "@TechLead"
      file: "agents/issue/issue-agent.ts"

    example: |
      const criticalLabels = ['priority:P0-Critical', 'severity:Sev.1-Critical', 'security'];
      if (labels.some(l => criticalLabels.includes(l))) {
        await discord.post('#help-general', {
          content: `ğŸš¨ **Critical Issue Detected**\n\nIssue #${issue.number}\n${issue.url}`,
          mention: '@TechLead'
        });
      }

  R34_Escalation_notifies_to_DiscordCommunity:
    id: "R34"
    name: "notifies-to"
    source: "E8_Escalation"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "EscalationãŒDiscordCommunityã«é€šçŸ¥ã•ã‚Œã‚‹"

    implementation:
      channels: ["#help-general"]
      trigger: "ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç”Ÿæ™‚"
      mention: "@{escalation.target}"
      format: "embed with escalation details"
      file: "agents/base-agent.ts (escalate ãƒ¡ã‚½ãƒƒãƒ‰)"

    example: |
      await discord.post('#help-general', {
        embed: {
          title: `âš ï¸ Escalation: ${escalation.target}`,
          description: escalation.reason,
          fields: [
            { name: 'Severity', value: escalation.severity }
          ]
        },
        mention: `@${escalation.target}`
      });

  R35_Command_integrated_with_DiscordCommunity:
    id: "R35"
    name: "integrated-with"
    source: "E7_Command"
    target: "E13_DiscordCommunity"
    cardinality: "N:1"
    notation: "N1"
    description: "CommandãŒDiscordCommunityï¼ˆã‚«ã‚¹ã‚¿ãƒ Botï¼‰ã¨çµ±åˆã•ã‚Œã‚‹"

    implementation:
      bot_commands:
        "/miyabi status": "ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º"
        "/miyabi docs <query>": "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢"
        "/miyabi agent <name>": "Agentæƒ…å ±è¡¨ç¤º"
      bot: "Custom Miyabi Bot (æœªå®Ÿè£…)"
      file: "Custom Miyabi Bot (æœªå®Ÿè£…)"

    example: |
      bot.onCommand('miyabi status', async (interaction) => {
        const status = await getMiyabiStatus();
        await interaction.reply({
          embed: {
            title: 'ğŸŒ¸ Miyabi Status',
            fields: [
              { name: 'Active Agents', value: status.activeAgents.toString() }
            ]
          }
        });
      });

  # SubIssue Relations (R37-R39)
  R37_SubIssue_child_of_Issue:
    id: "R37"
    name: "child-of"
    source: "E14_SubIssue"
    target: "E1_Issue"
    cardinality: "N:1"
    notation: "N1"
    description: "SubIssueãŒIssueã®å­ã§ã‚ã‚‹"

    implementation:
      attribute: "parentIssueNumber: number"
      labels: ["ğŸ“„ hierarchy:child"]
      auto_actions:
        - "Issueæœ¬æ–‡ã«è¦ªIssueå‚ç…§ã‚’è‡ªå‹•è¿½åŠ "
        - "è¦ªIssueã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è‡ªå‹•è¿½åŠ "
        - "å®Œäº†æ™‚ã«è¦ªIssueã®å®Œäº†ç‡ã‚’æ›´æ–°"
      file: "packages/coding-agents/issue/issue-agent.ts"

    note: "Inverse of R36"

  R38_SubIssue_sibling_of_SubIssue:
    id: "R38"
    name: "sibling-of"
    source: "E14_SubIssue"
    target: "E14_SubIssue"
    cardinality: "N:N"
    notation: "N3"
    description: "SubIssueåŒå£«ãŒå…„å¼Ÿé–¢ä¿‚ã«ã‚ã‚‹"

    implementation:
      attribute: "siblingIssueNumbers: number[]"
      condition: "åŒã˜parentIssueNumberã‚’æŒã¤SubIssue"
      file: "packages/coding-agents/issue/issue-agent.ts"

    example: |
      // Issue #101 ã¨ Issue #104 ã¯å…„å¼Ÿ
      // ä¸¡æ–¹ã¨ã‚‚ parentIssueNumber: 100

  R39_SubIssue_tracked_by_Label:
    id: "R39"
    name: "tracked-by"
    source: "E14_SubIssue"
    target: "E5_Label"
    cardinality: "N:N"
    notation: "N3"
    description: "SubIssueãŒHIERARCHY Labelã«ã‚ˆã‚Šè¿½è·¡ã•ã‚Œã‚‹"

    implementation:
      hierarchy_labels:
        - "ğŸŒ³ hierarchy:root"
        - "ğŸ“‚ hierarchy:parent"
        - "ğŸ“„ hierarchy:child"
        - "ğŸƒ hierarchy:leaf"
      auto_assignment: "IssueAgent"
      file: "docs/guides/LABEL_SYSTEM_GUIDE.md (HIERARCHY Labels)"

    example: |
      // Issue #100
      labels: ["ğŸŒ³ hierarchy:root", "ğŸ“‚ hierarchy:parent"]

      // Issue #102
      labels: ["ğŸ“„ hierarchy:child", "ğŸƒ hierarchy:leaf"]

# Summary Statistics
metadata:
  total_relations: 39

  relation_categories:
    issue_workflow: 6  # R1-R4, R36, R37
    task_execution: 4  # R5-R8
    agent_operations: 7  # R9-R15
    label_control: 3  # R16-R18
    quality_management: 3  # R19-R21, R22-R23
    dag_worktree: 4  # R24-R27
    community_integration: 8  # R28-R35
    hierarchy_management: 3  # R36-R39 (overlap with issue_workflow)

  cardinality_distribution:
    "1:1 (N1)": 21
    "1:N (N2)": 12
    "N:N (N3)": 6

  implementation_status:
    implemented: 31
    partially_implemented: 5  # Discord integrations
    planned: 3  # Custom Miyabi Bot commands

  source_document: "docs/architecture/ENTITY_RELATION_MODEL.md"
  notation_standard: "N1 (1:1), N2 (1:N), N3 (N:N)"
