# Miyabi MCP Server - Lambda Deployment Guide

This guide covers deploying the Miyabi MCP Server to AWS Lambda using either AWS SAM or pure AWS CLI.

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Deployment Methods](#deployment-methods)
  - [Method 1: AWS SAM (Recommended)](#method-1-aws-sam-recommended)
  - [Method 2: Pure AWS CLI](#method-2-pure-aws-cli)
- [Configuration](#configuration)
- [Testing](#testing)
- [Monitoring](#monitoring)
- [Troubleshooting](#troubleshooting)
- [Cost Estimation](#cost-estimation)

---

## Overview

The Miyabi MCP Server is a FastAPI application that provides:
- **MCP Protocol** endpoints for AI agent orchestration
- **GitHub Integration** for issue/PR management
- **System Monitoring** tools (git, processes, network)
- **Obsidian Integration** for knowledge management
- **OAuth 2.1** authentication

This deployment packages the FastAPI app for AWS Lambda using the **Mangum** adapter.

### Architecture

```
┌─────────────────┐
│ API Gateway     │
│ (HTTP API)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Lambda Function │
│ - FastAPI       │
│ - Mangum        │
│ - Python 3.11   │
└─────────────────┘
```

---

## Prerequisites

### 1. AWS Account Setup

- AWS Account with appropriate permissions
- AWS CLI configured with credentials
- IAM permissions for:
  - Lambda (create, update, invoke)
  - API Gateway (create, update)
  - IAM (create roles, attach policies)
  - CloudWatch Logs (create log groups)
  - S3 (create buckets for SAM)

### 2. Install Required Tools

#### AWS CLI
```bash
pip install awscli
aws configure
```

#### AWS SAM CLI (for Method 1)
```bash
pip install aws-sam-cli
sam --version
```

### 3. Environment Variables

Create `server/.env` file:

```bash
# GitHub Integration
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx

# Miyabi Configuration
MIYABI_REPO_OWNER=customer-cloud
MIYABI_REPO_NAME=miyabi-private

# Authentication (auto-generated if not set)
MIYABI_ACCESS_TOKEN=

# Optional: OAuth Configuration
OAUTH_CLIENT_ID=
OAUTH_CLIENT_SECRET=
```

---

## Deployment Methods

### Method 1: AWS SAM (Recommended)

**Advantages:**
- Infrastructure as Code (CloudFormation)
- Automatic API Gateway setup
- Built-in testing and validation
- Easy rollback
- Environment-specific deployments

**Deployment Steps:**

```bash
# Navigate to app directory
cd openai-apps/miyabi-app

# Set environment variables (optional)
export STAGE=prod
export AWS_REGION=ap-northeast-1
export GITHUB_TOKEN=ghp_xxxxxxxxxxxx

# Deploy
./deploy-lambda.sh
```

**What the script does:**

1. ✅ Checks prerequisites (SAM CLI, AWS CLI, credentials)
2. ✅ Creates S3 bucket for deployment artifacts
3. ✅ Installs Python dependencies
4. ✅ Builds SAM application
5. ✅ Deploys to AWS (Lambda + API Gateway)
6. ✅ Tests endpoints
7. ✅ Displays API URLs and access token

**Custom Configuration:**

```bash
# Deploy to specific region
AWS_REGION=us-east-1 ./deploy-lambda.sh

# Deploy to staging
STAGE=staging ./deploy-lambda.sh

# Custom stack name
STACK_NAME=my-miyabi-stack ./deploy-lambda.sh

# Use existing S3 bucket
S3_BUCKET=my-deployment-bucket ./deploy-lambda.sh
```

---

### Method 2: Pure AWS CLI

**Advantages:**
- No SAM CLI required
- Direct control over resources
- Simpler for basic deployments

**Deployment Steps:**

```bash
# Navigate to app directory
cd openai-apps/miyabi-app

# Set environment variables (optional)
export STAGE=prod
export AWS_REGION=ap-northeast-1
export GITHUB_TOKEN=ghp_xxxxxxxxxxxx

# Deploy
./deploy-lambda-cli.sh
```

**What the script does:**

1. ✅ Creates IAM role for Lambda
2. ✅ Packages application code + dependencies
3. ✅ Creates/updates Lambda function
4. ✅ Creates HTTP API Gateway
5. ✅ Configures routes and integrations
6. ✅ Adds Lambda permissions
7. ✅ Tests deployment

**Custom Configuration:**

```bash
# Custom function name
FUNCTION_NAME=my-miyabi-function ./deploy-lambda-cli.sh

# Adjust Lambda settings
MEMORY=3008 TIMEOUT=300 ./deploy-lambda-cli.sh
```

---

## Configuration

### Lambda Function Settings

Default configuration (in `template.yaml`):

```yaml
Runtime: python3.11
MemorySize: 2048  # 2GB RAM
Timeout: 900      # 15 minutes (max)
```

### Environment Variables

The Lambda function has these environment variables:

```bash
MIYABI_ROOT=/tmp/miyabi-private
BASE_URL=https://<api-id>.execute-api.<region>.amazonaws.com
GITHUB_TOKEN=<your-token>
MIYABI_REPO_OWNER=customer-cloud
MIYABI_REPO_NAME=miyabi-private
MIYABI_ACCESS_TOKEN=<auto-generated>
OBSIDIAN_VAULT=/tmp/obsidian
AWS_DEFAULT_REGION=<region>
```

### Authentication

The MCP server requires a Bearer token for authentication:

```bash
# Token is auto-generated during deployment
# Save the token from deployment output!

curl -X POST https://<api-url>/mcp \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <MIYABI_ACCESS_TOKEN>" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'
```

---

## Testing

### 1. Health Check

```bash
# Replace <API_URL> with your deployment URL
curl https://<api-url>/

# Expected response:
{
  "name": "Miyabi MCP Server",
  "version": "1.0.0",
  "status": "running",
  "tools": 24
}
```

### 2. MCP Initialize

```bash
curl -X POST https://<api-url>/mcp \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {}
  }'
```

### 3. List Tools

```bash
curl -X POST https://<api-url>/mcp \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list"
  }'
```

### 4. Execute Agent

```bash
curl -X POST https://<api-url>/mcp \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "get_project_status",
      "arguments": {}
    }
  }'
```

---

## Monitoring

### CloudWatch Logs

View logs in real-time:

```bash
# Get function name from deployment output
aws logs tail /aws/lambda/miyabi-mcp-server-prod --follow
```

View specific time range:

```bash
aws logs filter-log-events \
  --log-group-name /aws/lambda/miyabi-mcp-server-prod \
  --start-time $(date -d '1 hour ago' +%s)000
```

### Lambda Metrics

View function metrics:

```bash
# Invocations
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Invocations \
  --dimensions Name=FunctionName,Value=miyabi-mcp-server-prod \
  --start-time $(date -d '1 hour ago' -u +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Sum

# Errors
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Errors \
  --dimensions Name=FunctionName,Value=miyabi-mcp-server-prod \
  --start-time $(date -d '1 hour ago' -u +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Sum
```

### API Gateway Metrics

```bash
# API requests
aws cloudwatch get-metric-statistics \
  --namespace AWS/ApiGateway \
  --metric-name Count \
  --dimensions Name=ApiId,Value=<API_ID> \
  --start-time $(date -d '1 hour ago' -u +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Sum
```

---

## Troubleshooting

### Common Issues

#### 1. "Task timed out after 900.00 seconds"

**Cause:** Lambda function timeout (15 min max)

**Solution:**
- Optimize long-running operations
- Use Step Functions for workflows > 15 min
- Consider EC2/ECS for persistent services

#### 2. "Unable to import module 'lambda_handler'"

**Cause:** Missing dependencies or incorrect handler path

**Solution:**
```bash
# Verify handler path in template.yaml
Handler: lambda_handler.lambda_handler

# Check dependencies are installed
ls .aws-sam/dependencies/python/
```

#### 3. "AccessDeniedException"

**Cause:** IAM role missing permissions

**Solution:**
```bash
# Add required permissions to role
aws iam attach-role-policy \
  --role-name miyabi-mcp-lambda-role \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
```

#### 4. "No space left on device"

**Cause:** Lambda /tmp directory limit (512MB)

**Solution:**
- Clean up temporary files in code
- Use S3 for large files
- Reduce deployment package size

#### 5. "Internal server error" from API Gateway

**Cause:** Lambda function error

**Solution:**
```bash
# Check Lambda logs
aws logs tail /aws/lambda/miyabi-mcp-server-prod --follow

# Test function directly
aws lambda invoke \
  --function-name miyabi-mcp-server-prod \
  --payload '{"httpMethod":"GET","path":"/"}' \
  response.json
cat response.json
```

---

## Cost Estimation

### Lambda Costs

**Pricing (ap-northeast-1):**
- Requests: $0.20 per 1M requests
- Duration: $0.0000166667 per GB-second

**Example Monthly Cost:**
- 100,000 requests/month
- Average duration: 2 seconds
- Memory: 2048 MB (2 GB)

```
Requests: 100,000 × $0.20 / 1,000,000 = $0.02
Duration: 100,000 × 2s × 2GB × $0.0000166667 = $6.67
Total: ~$6.69/month
```

### API Gateway Costs

**Pricing:**
- HTTP API: $1.00 per million requests

**Example:**
- 100,000 requests/month = $0.10/month

### Total Estimated Cost

**Low usage (100K requests/month):** ~$7/month
**Medium usage (1M requests/month):** ~$70/month
**High usage (10M requests/month):** ~$700/month

**Free Tier (first 12 months):**
- 1M Lambda requests/month
- 400,000 GB-seconds compute time

---

## Updating the Deployment

### Update Code Only

```bash
# SAM method
./deploy-lambda.sh

# CLI method
./deploy-lambda-cli.sh
```

### Update Configuration

```bash
# Update environment variables
aws lambda update-function-configuration \
  --function-name miyabi-mcp-server-prod \
  --environment "Variables={GITHUB_TOKEN=new_token,...}"

# Update memory/timeout
aws lambda update-function-configuration \
  --function-name miyabi-mcp-server-prod \
  --memory-size 3008 \
  --timeout 600
```

---

## Deletion

### SAM Deployment

```bash
# Delete entire stack
aws cloudformation delete-stack --stack-name miyabi-mcp-server

# Wait for deletion
aws cloudformation wait stack-delete-complete --stack-name miyabi-mcp-server
```

### CLI Deployment

```bash
# Delete Lambda function
aws lambda delete-function --function-name miyabi-mcp-server

# Delete API Gateway
aws apigatewayv2 delete-api --api-id <API_ID>

# Delete IAM role (optional)
aws iam detach-role-policy \
  --role-name miyabi-mcp-lambda-role \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

aws iam delete-role --role-name miyabi-mcp-lambda-role
```

---

## Next Steps

1. **Set up custom domain** (Route 53 + ACM certificate)
2. **Add monitoring alerts** (CloudWatch Alarms)
3. **Implement rate limiting** (API Gateway throttling)
4. **Add WAF rules** (AWS WAF for security)
5. **Enable X-Ray tracing** (distributed tracing)
6. **Set up CI/CD** (GitHub Actions or CodePipeline)

---

## Support

For issues or questions:
- Check [troubleshooting](#troubleshooting) section
- Review CloudWatch logs
- Open GitHub issue: https://github.com/customer-cloud/miyabi-private/issues

---

**Last Updated:** 2025-11-29
**Version:** 1.0.0
**Maintainer:** Miyabi Development Team
